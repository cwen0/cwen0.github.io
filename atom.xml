<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>cwen</title>
  <id>http://int64.me</id>
  <updated>2018-04-08T10:36:05+08:00</updated>
  <subtitle>Life is magic. Coding is art.</subtitle>
  <link href="http://int64.me"></link>
  <entry>
    <title>TiDB æ€§èƒ½ä¼˜åŒ–ä¹‹ç„å­¦è°ƒä¼˜</title>
    <updated>2018-04-08T00:00:00Z</updated>
    <id>tag:int64.me,2018-04-08:/2018/TiDB æ€§èƒ½ä¼˜åŒ–ä¹‹ç„å­¦è°ƒä¼˜.html</id>
    <content type="html">&lt;p&gt;TiDB ç„å­¦è°ƒä¼˜æ˜¯æˆ‘ä»¬è‡ªé»‘æ¯”è¾ƒç‹ çš„æ¢—ä¹‹ä¸€ï¼Œå½“åˆ TiKV é‡Œå¤§æŠŠçš„å‚æ•°è®©æˆ‘å¤´ç–¼äº†å¥½ä¹… ( TiKV çš„é…ç½®å‚æ•°å¤§å¤šæ•°æ˜¯å’Œ RocksDB ç›¸å…³ )ã€‚å¥½åœ¨ç°åœ¨å¾ˆå¤šå‚æ•°ç°åœ¨çš„é»˜è®¤å€¼å·²ç»å¾ˆç§‘å­¦å¤§å¤§çš„å‡å°‘äº†æˆ‘ä»¬ç„å­¦è°ƒä¼˜çš„éš¾åº¦ã€‚&#xA;ä¸€ä¸‹æ˜¯æ˜¯æˆ‘å¹³æ—¶åœ¨æµ‹è¯• TiDB æ—¶å€™ï¼Œè¿›è¡Œç“¶é¢ˆå®šä½çš„è¿‡ç¨‹&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬ä»¥ sysbench æµ‹è¯•ä¸ºä¾‹ï¼Œä½¿ç”¨çš„æµ‹è¯•è„šæœ¬ï¼š&lt;a href=&#34;https://github.com/pingcap/tidb-bench/tree/master/sysbench&#34;&gt;https://github.com/pingcap/tidb-bench/tree/master/sysbench&lt;/a&gt;&#xA;å¯ç”¨æœºå™¨å…¬å…±å››å°ï¼Œæœºå™¨é…ç½®ï¼šCPU 16 æ ¸ / Mem 110 GB  / Disk 1024GB SSD&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;ç¡¬ä»¶æ€§èƒ½æµ‹è¯•&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;æµ‹è¯•ä¹‹å‰å…ˆè¿›è¡ŒåŸºæœ¬çš„ç¡¬ä»¶æµ‹è¯•ï¼Œæ¯”å¦‚ç£ç›˜ fio æµ‹è¯•ï¼Œç½‘ç»œå»¶è¿Ÿä»¥åŠç½‘é€Ÿçš„æµ‹è¯•ï¼Œè¿™äº›æµ‹è¯•æœ‰åˆ©äºæ’é™¤ä¸€äº›å¹²æ‰°å› ç´ ã€‚&#xA;è¿™åœ°æ–¹å°±æä¾›å‡ æœ¬çš„æµ‹è¯•æ–¹æ³•ï¼Œä¹‹å‰å·²ç»æµ‹è¯•è¿‡äº†ï¼Œæ­¤å¤„å°±ä¸å®é™…æµ‹è¯•äº†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æµ‹è¯•ç£ç›˜ï¼šæ¨è fio ï¼ˆfio ä½¿ç”¨éœ€è°¨æ…ï¼Œä¸è¦ç›´æ¥å†™è£¸è®¾å¤‡ï¼Œç¬”è€…è¿ç»­å†™åå¥½å‡ å—ç›˜ï¼Œéƒ½æ˜¯è¡€æ³ªå•Šï¼‰ï¼Œddï¼Œsysbench&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;// fio&#xA;fio -ioengine=libaio -bs=32k -direct=1 -thread -rw=read  -size=10G -filename=test -name=&amp;quot;PingCAP max throughput&amp;quot; -iodepth=4 -runtime=60&#xA;&#xA;// dd&#xA;dd bs=4k count=250000 oflag=direct if=/dev/zero of=./dd_test.txt&#xA;&#xA;// sysbench&#xA;sysbench --test=fileio --file-num=16 --file-block-size=16384 --file-total-size=2G prepare&#xA;sysbench --test=fileio --file-num=16 --file-block-size=16384 --file-total-size=2G --num-threads=4 --max-requests=100000000 --max-time=180 --file-test-mode=seqwr --file-extra-flags=direct run&#xA;sysbench --test=fileio --file-num=16 --file-block-size=16384 --file-total-size=2G --num-threads=4 --max-requests=100000000 --max-time=180 --file-test-mode=seqwr --file-extra-flags=direct clean&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;æµ‹è¯•å»¶è¿Ÿï¼šç›´æ¥ ping æŸ¥çœ‹å»¶è¿Ÿä»¥åŠä¸¢åŒ…æƒ…å†µ&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æµ‹è¯•ç½‘é€Ÿ: æœ€ç®€å• dd + scpï¼Œdd + pv + nc , iperf&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;// scp&#xA;dd if=/dev/zero bs=2M count=2048 of=./test // ç”Ÿæˆ 4 GB æ–‡ä»¶&#xA;scp ./test ip ip&#xA;&#xA;// dd + pv + nc&#xA;dd if=/dev/zero bs=1M count=1024 of=./test&#xA;pv test| nc 10.0.1.8 5433 // å‘é€&#xA;nc -vv -l -p 5433 &amp;gt; test  // æ¥æ”¶&#xA;&#xA;// iperf&#xA;iperf -s            // server&#xA;iperf -c 10.0.1.4   // client&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;sysbench oltp æµ‹è¯•ç“¶é¢ˆå®šä½&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;è¿è¡Œ sysbench oltp æµ‹è¯•ï¼Œ sysbench é»˜è®¤ oltp ä¸€ä¸ªäº‹åŠ¡åŒ…å« 18 æ¡ SQL:&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;10 * point select&#xA;1 * simple range select&#xA;1 * sum range&#xA;1 * order range&#xA;1 * distinct range&#xA;1 * index update&#xA;1 * non index update&#xA;1 * insert&#xA;1 * delete&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;ä»äº‹åŠ¡çš„ç»„åˆä¸Šæ¥çœ‹åº¦å å¤§éƒ¨åˆ†ï¼Œç»éªŒå‘Šè¯‰æˆ‘ä»¬æœ€å…ˆè¯»å¤šå±äº CPU å¯†é›†å‹çš„æ“ä½œï¼ŒTiDB çš„ CPU æœ€æœ‰å¯èƒ½æˆä¸ºç“¶é¢ˆï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ 1 TiDB + 3 TiKV çš„æ¶æ„è¿›è¡Œæµ‹è¯•ï¼Œå®é™…è§‚å¯Ÿä¸€ä¸‹è¿è¡Œæƒ…å†µã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä½¿ç”¨ &lt;a href=&#34;https://github.com/pingcap/tidb-ansible&#34;&gt;tidb-ansible&lt;/a&gt; éƒ¨ç½²é›†ç¾¤&lt;/p&gt;&#xA;&#xA;&lt;p&gt;éƒ¨ç½²æ‹“æ‰‘ï¼š&lt;/p&gt;&#xA;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th&gt;ip&lt;/th&gt;&#xA;&lt;th&gt;&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;10.0.1.6&lt;/td&gt;&#xA;&lt;td&gt;tidb / pd / sysbench&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;10.0.1.7&lt;/td&gt;&#xA;&lt;td&gt;tikv&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;10.0.1.8&lt;/td&gt;&#xA;&lt;td&gt;tikv&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&#xA;&lt;tr&gt;&#xA;&lt;td&gt;10.0.1.9&lt;/td&gt;&#xA;&lt;td&gt;tikv&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;æµ‹è¯•æµç¨‹ï¼šprepare -&amp;gt; run&lt;/p&gt;&#xA;&#xA;&lt;p&gt;è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œå…ˆè§‚å¯Ÿ tidb / tikv çš„ cpu ä½¿ç”¨æƒ…å†µï¼ˆä¸€èˆ¬æ¥è¯´ oltp æµ‹è¯•ï¼Œä¸»è¦ç“¶é¢ˆä¼šé›†ä¸­åœ¨ tidb çš„ cpu ä¸Šï¼Œè¦åˆé‡ç‚¹çš„å»æ’æŸ¥é—®é¢˜ï¼‰&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%2012.16.54%20AM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ° tidb çš„æœºå™¨çš„ load å·²ç»è¾¾åˆ°äº† 20+ï¼Œè¿™æ˜¯ä¸€å° 15 æ ¸çš„æœºå™¨ï¼Œæ„Ÿè§‰è¿™å°æœºå™¨çš„ cpu å‡ ä¹å·²ç»è¢«æ¦¨å¹²äº†ï¼Œæˆ‘ä»¬éƒ½ä¸éœ€è¦å»çœ‹åˆ«çš„ç“¶é¢ˆï¼Œè¿™ tidb çš„cpu å·²ç»é™åˆ¶äº†æ•´ä½“æ€§èƒ½ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯è¦æŠŠè¿™ä¸ªç“¶é¢ˆå»æ‰ï¼Œ&lt;strong&gt;æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯å‡çº§ç¡¬ä»¶æˆ–æ˜¯åŠ æœºå™¨ï¼Œæˆ‘ä»¬å°è¯•å¢åŠ æœºå™¨ï¼ŒåŒæ—¶ä¸»è¦æ³¨æ„å¢åŠ å‹åŠ›&lt;/strong&gt;ã€‚ï¼ˆæ²¡æœ‰å¤šä½™çš„æœºå™¨å°±ä¸åšå®éªŒäº†ï¼‰ å½“æˆ‘ä»¬æŠŠ tidb æœºå™¨çš„æ•°é‡ä¹Ÿå¢åŠ åˆ° 3 å°æˆ–æ˜¯æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ç“¶é¢ˆå‘ç”Ÿäº†è½¬ç§»ï¼Œè¿™ä¸ªæ—¶å€™ç“¶é¢ˆå°±ä¼šä» tidb è½¬ç§»åˆ°äº† tikvï¼Œtikv æœ‰ä¸ª end-point-concurrency è¿™æ ·ä¸€ä¸ªä¸œè¥¿ç”¨æ¥å¤„ç† tidb çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ top -H æ¥è§‚å¯Ÿä¸€ä¸‹&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%2012.31.58%20AM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¯¹åº” grafana ç›‘æ§ä¸Šçš„å°±æ˜¯&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%2012.34.02%20AM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;end-point-concurrency ä»€ä¹ˆæ—¶å€™ç®—æ˜¯å‡ºç°ç“¶é¢ˆå‘¢ï¼Ÿ é»˜è®¤ end-point-concurrency  æ˜¯ä½¿ç”¨ 4ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œå½“ top -H çš„æ—¶å€™å‘ç°è¿™ä¸ªå››ä¸ªçº¿ç¨‹çš„ cpu ä½¿ç”¨éƒ½è¶…è¿‡äº† 90% ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸º end-point-concurrency é™åˆ¶äº†æ•´ä¸ªç³»ç»Ÿçš„ååï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯å¦‚ä½•æ¥æŠŠè¿™ä¸ªç“¶é¢ˆç»™æ¶ˆé™¤æ‰ï¼Œå¦‚æœç›®å‰ tikv çš„æœºå™¨æ•´ä½“ cpu ä½¿ç”¨è¿˜æ˜¯å¾ˆé—²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±&lt;strong&gt;å¢åŠ è¿™ä¸ª end-point-concurrency çš„çº¿ç¨‹æ•°é‡&lt;/strong&gt;ï¼Œè¿™ä¸ªå°±è¦ä¿®æ”¹ tikv çš„å¯åŠ¨å‚æ•°äº†,è¿™ä¸ªå¯ä»¥å‚è€ƒæ–‡æ¡£ï¼š&lt;a href=&#34;https://github.com/pingcap/docs-cn/blob/master/op-guide/tune-tikv.md&#34;&gt;https://github.com/pingcap/docs-cn/blob/master/op-guide/tune-tikv.md&lt;/a&gt; ã€‚&#xA;ï¼ˆgrpc çº¿ç¨‹ä¹Ÿæ˜¯ä¼šå‡ºç°ç“¶é¢ˆï¼Œæ”¹è¿›æ–¹æ³•å’Œ end-point-concurrency ç±»ä¼¼ï¼Œç›´æ¥å¢åŠ çº¿ç¨‹æ•°é‡ï¼‰&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å½“æˆ‘ä»¬è§£å†³æ‰ end-point-concurrencyï¼Œæˆ‘ä»¬ä¼šå‘ç°ç³»ç»Ÿçš„æ•´ä½“ååä¼šæœ‰æ‰€æé«˜ï¼Œä½†æ˜¯æ­¤æ—¶åˆä¼šå‡ºç°æ–°çš„ç“¶é¢ˆï¼Œä»¥æˆ‘å¾€å¸¸çš„ç»éªŒæ¥è¯´ï¼Œæ¥ä¸‹æ¥çš„ç“¶é¢ˆåº”è¯¥ä¼šå‡ºç°åœ¨  end-point-work è¿™ä¸ªçº¿ç¨‹ä¸Šï¼Œä¸ºå˜›ä¼šå‡ºç°åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šå‘¢ï¼Ÿå…¶å®è¦æ˜¯çŸ¥é“è¿™ä¸ªçº¿ç¨‹æ˜¯ç”¨æ¥å¹²å˜›çš„å°±å¾ˆå¥½ç†è§£äº†ï¼Œè¿™ä¸ªç°åœºæ˜¯ç”¨æ¥è°ƒåº¦ end-point-concurrency è¿™ä¸ªç©æ„æ‰ï¼Œå½“ end-point-concurrency çº¿ç¨‹å¤šäº†ï¼Œé‚£ä¹ˆè°ƒåº¦å°±ä¼šå‡ºç°ç“¶é¢ˆï¼Œé—æ†¾çš„æ˜¯ end-point-work æ˜¯å•çº¿ç¨‹ï¼Œæˆ‘ä»¬è¦è§£å†³è¿™ä¸ªçš„ç“¶é¢ˆï¼Œ&lt;strong&gt;åªèƒ½æå‡å•æ ¸ cpu çš„èƒ½åŠ›ï¼Œæˆ–æ˜¯å¢åŠ  tikv çš„æ•°é‡&lt;/strong&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;Summary&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç“¶é¢ˆ&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;TiDB CPU ä¸€èˆ¬ä¼šä¼˜å…ˆæˆä¸ºç“¶é¢ˆ&lt;/li&gt;&#xA;&lt;li&gt;TiKV çš„ endpoint çº¿ç¨‹&lt;/li&gt;&#xA;&lt;li&gt;grpc çº¿ç¨‹&lt;/li&gt;&#xA;&lt;li&gt;TiKV çš„ end-point-work çº¿ç¨‹&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;ä¼˜åŒ–&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åŠ  TiDB èŠ‚ç‚¹ï¼Œå¯ä»¥å°è¯•åœ¨ TiKV æœºå™¨ä¸Šæ·»åŠ ï¼ˆ TiKV CPUæ¯”è¾ƒå……è¶³ï¼‰&lt;/li&gt;&#xA;&lt;li&gt;è°ƒæ•´ end-point-concurrency å‚æ•°ï¼Œå¢å¤§ endpoint çº¿ç¨‹æ•°é‡&lt;/li&gt;&#xA;&lt;li&gt;è°ƒæ•´ grpc-concurrency å‚æ•°ï¼Œå¢åŠ  grpc çº¿ç¨‹æ•°é‡&lt;/li&gt;&#xA;&lt;li&gt;è°ƒå¤§ racksdb cache&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;sysbench oltp æ€§èƒ½ç“¶é¢ˆå®šä½å°±è¯´è¿™äº›ï¼Œå®é™…æƒ…å†µä¸­ tidb çš„ç“¶é¢ˆå¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå»ä¼˜åŒ–è°ƒæ•´ï¼Œè¦ä¸ç„¶å°±ä¸å«ç„å­¦äº†ğŸ˜„ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;sysbench insert æµ‹è¯•ç“¶é¢ˆå®šä½&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;sysbench insert è„šæœ¬å¾ˆç®€å•ï¼Œå°±æ˜¯é¡ºåºå†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆä» tikv åŸºæœ¬æ¦‚å¿µè€ƒè™‘ï¼Œtikv å†…çš„æœ€å°å‡ æœ¬å•å…ƒæ˜¯ region, å¹¶ä¸”æ˜¯æ¯ä¸ªè¡¨è‚¯å®šæ˜¯å¯¹åº”è¿™ä¸ªä¸åŒçš„ regionï¼Œé‚£ä¹ˆåŠ å…¥æˆ‘ä»¬çš„æµ‹è¯•åªæ­£å¯¹ä¸€ä¸ªè¡¨ insertï¼Œæˆ‘ä»¬æœ‰å†å¤šçš„ tikv ä¹Ÿæ˜¯æ²¡æœ‰åµç”¨ï¼Œï¼ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç›®å‰æœ‰ç›¸åº”çš„è§£å†³åŠæ³•ï¼Œå…·ä½“æˆ‘ä¹Ÿä¸æ˜¯å¤ªæ¸…æ¥šï¼‰æ‰€ä»¥æˆ‘ä»¬æµ‹è¯•è¦ä¿è¯è¡¨çš„æ•°é‡ä¸€å®šè¦å¤§äº tikv èŠ‚ç‚¹çš„æ•°é‡ï¼ˆå½“ç„¶è¶Šå¤šè¶Šå¥½äº†ï¼‰ï¼Œè¿™é‡Œå®éªŒçš„æ—¶å€™æˆ‘æ˜¯ä½¿ç”¨äº† 16ä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨é¢„å…ˆ prepare äº† 100w çš„æ•°æ®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;è¿è¡Œ insert è„šæœ¬ï¼ŒåŒæ ·æˆ‘ä¼šå…ˆ top çœ‹ tidb ï¼ tikv ï¼pd çš„ cpu ä½¿ç”¨æƒ…å†µã€‚&#xA;æˆ‘ä»¬ä¼šå¾ˆå®¹æ˜“çš„å‘ç° insert çš„æ—¶å€™æˆ‘ä»¬ TiDB çš„ CPU å¹¶ä¸ä¼šé¦–å…ˆæˆä¸ºç“¶é¢ˆï¼ˆå¹¶ä¸ç»å¯¹ï¼‰ï¼Œä½†æ˜¯å‘ç° TiKV çš„å‹åŠ›è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œæˆ‘ä»¬å°±éœ€è¦å»å®šä½ TiKV çš„ç“¶é¢ˆï¼Œå¦‚æœ TiKV å‹åŠ›ä¹Ÿæ˜¯å¾ˆå°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯ç£ç›˜ IO å­˜åœ¨é—®é¢˜ï¼ŒæŸ¥çœ‹ç£ç›˜ IO ï¼Œæ­£å¸¸æ¥è¯´æŸ¥çœ‹ç£ç›˜æƒ…å†µæˆ‘ä½¿ç”¨ iostat&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%209.58.10%20AM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹åˆ° sde ç›˜çš„ %util åœ¨ 70ï¼Œä¹Ÿå°±æ˜¯è¯´æŒºå¿™çš„ï¼Œä½†æ˜¯è¿˜å¯ä»¥è¿˜æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆï¼Œæ­£å¸¸æ¥è¯´è¶…è¿‡äº† 90 ä»¥ä¸Šï¼Œå°±å¯ä»¥è®¤ä¸ºè¿™å—ç›˜å·²ç»è¢«æˆ‘ä»¬å‹æ¦¨çš„å·®ä¸å¤šäº†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;åˆ’æ°´äº†ï¼Œinsert æµ‹è¯•çš„è¯¦ç»†å®šä½è¿‡ç¨‹åé¢åœ¨å•ç‹¬å†™ä¸€ç¯‡å§&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;h3&gt;Summary&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç“¶é¢ˆ&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;TiKV raftstore çº¿ç¨‹&lt;/li&gt;&#xA;&lt;li&gt;ç£ç›˜ IO ï¼Œå‡ºç° stall æˆ–æ˜¯å‡ºç°å¾ˆå¤š IO wait&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;ä¼˜åŒ–&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœåœ¨ç£ç›˜æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆçš„å‰æä¸‹ï¼ŒTiKV æœºå™¨çš„ CPU è¿˜å¾ˆå¯Œè£•ï¼Œå¯ä»¥å•å°å¤šéƒ¨ç½²ï¼Œä¸€èˆ¬å•ä¸ª TiKV å®ä¾‹å¯¹åº”ä¸€å—ç›˜&lt;/li&gt;&#xA;&lt;li&gt;ç£ç›˜ IO å‡ºç°ç“¶é¢ˆï¼Œå¯ä»¥è°ƒæ•´å‹ç¼©æ–¹å¼ï¼Œç”¨ CPU èµ„æºæ¢å– IO èµ„æº&lt;/li&gt;&#xA;&lt;li&gt;å‘ç°ç³»ç»Ÿçš„ IO å‹åŠ›ä¸å¤§ï¼Œä½†æ˜¯ CPUèµ„æºå·²ç»åƒå…‰äº†ï¼Œtop -H å‘ç°æœ‰å¤§é‡çš„ bg å¼€å¤´çš„çº¿ç¨‹ï¼ˆRocksDB çš„ compaction çº¿ç¨‹ï¼‰åœ¨è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘å‡å°‘å‹ç¼©ç”¨ IO èµ„æºæ¢å– CPU èµ„æº&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;ä¸€ç‚¹å°æç¤º&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Sysbench ç‰ˆæœ¬å»ºè®®ä½¿ç”¨ 1.0 åŠä»¥ä¸Šç‰ˆæœ¬&lt;/li&gt;&#xA;&lt;li&gt;å½“é›†ç¾¤ TiKV èŠ‚ç‚¹æ•°é‡å¤§äº 3 çš„æ—¶å€™ï¼Œåœ¨ prepare æ•°æ®å®Œæˆåï¼Œéœ€è¦ç­‰å¾… TiKV èŠ‚ç‚¹ä¸Šçš„ * leader ä»¥åŠ region æ•°é‡å‡åŒ€åˆ†å¸ƒåï¼Œåœ¨è¿›è¡Œå„ç§åŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡pd-ctl æˆ–æ˜¯ &lt;a href=&#34;http://hosts:port/pd/api/v1/stores&#34;&gt;http://hosts:port/pd/api/v1/stores&lt;/a&gt; æˆ–æ˜¯ Grafana ç›‘æ§æŸ¥çœ‹å„ä¸ª TiKV èŠ‚ç‚¹ä¸Š leader å’Œ region çš„åˆ†å¸ƒæƒ…å†µã€‚&lt;/li&gt;&#xA;&lt;li&gt;å½“è¿›è¡Œå¤šè½®æµ‹è¯•çš„æ—¶å€™ï¼Œå½“éœ€è¦æ¸…ç†æ•°æ®çš„æ—¶å€™ï¼Œä¸è¦æ‰§è¡Œ DROP æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ Ansible è¿›è¡Œç‰©ç†åˆ é™¤ï¼Œç„¶ååœ¨é‡å¯é›†ç¾¤ï¼Œé‡æ–° prepare æ•°æ®è¿›è¡Œæµ‹è¯•ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å½“ TiDB , TiKV éƒ½æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆçš„æ—¶å€™, å¯ä»¥ä¸æ–­å¢å¤§ Sysbench çº¿ç¨‹æ•°é‡&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;æœ€åè¯´ä¸€ç‚¹&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå°çš„ç¤ºä¾‹ï¼Œåœ¨è¿›è¡Œå®é™…æ€§èƒ½æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯ä¼šå‡ºç°å„ç§å„æ ·çš„æƒ…å†µï¼Œå‡ºç°çš„ç“¶é¢ˆçš„åœ°æ–¹ä¹Ÿä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œæˆ‘æ‰€è°“çš„ç„å­¦å¹¶ä¸æ˜¯æ²¡æœ‰æ ¹æ®çš„èƒ¡ä¹±è°ƒæ•´ï¼Œè€Œæ˜¯åˆ†ææµ‹è¯•å®é™…æƒ…å†µåŠ ä¸Šè‡ªå·±å¯¹ TiDB ç³»ç»Ÿçš„ç†è§£ï¼Œè¿›è¡Œåˆç†è°ƒæ•´éƒ¨ç½²æ‹“æ‰‘ä»¥åŠé…ç½®å‚æ•°ã€‚å½“ç„¶å¦‚æœå¯¹ TiDB / TiKV / PD ç¨‹åºçš„ä¼˜åŒ–æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆå¥½çš„åˆ©ç”¨å‹æµ‹ + Grafan ç›‘æ§ + Perf + &lt;a href=&#34;https://github.com/brendangregg/FlameGraph&#34;&gt;FlameGraph&lt;/a&gt; å®šä½ç¨‹åºå†…éƒ¨çš„ç“¶é¢ˆã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tangliu-tool-1/&#34;&gt;å·¥æ¬²æ€§èƒ½è°ƒä¼˜ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼ˆ1ï¼‰&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tangliu-tool-2/&#34;&gt;å·¥æ¬²æ€§èƒ½è°ƒä¼˜ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼ˆ2ï¼‰- ç«ç„°å›¾&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tidb-internal-1/&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´å­˜å‚¨&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://int64.me/2017/sysbench%E7%9A%84%E4%B8%80%E7%82%B9%E6%95%B4%E7%90%86.html&#34;&gt;sysbench çš„ä¸€ç‚¹æ•´ç†&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pingcap/docs-cn/blob/master/op-guide/tune-tikv.md&#34;&gt;TiKV æ€§èƒ½å‚æ•°è°ƒä¼˜&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2018/TiDB æ€§èƒ½ä¼˜åŒ–ä¹‹ç„å­¦è°ƒä¼˜.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>Percolator è®ºæ–‡ç¬”è®°</title>
    <updated>2018-02-28T00:00:00Z</updated>
    <id>tag:int64.me,2018-02-28:/2018/Percolator è®ºæ–‡ç¬”è®°.html</id>
    <content type="html">&lt;p&gt;TiDB çš„äº‹åŠ¡æ¨¡å‹æ˜¯å‚è€ƒ Google Percolator äº‹åŠ¡æ¨¡å‹ï¼Œæƒ³å»ç ”ç©¶ TiDB çš„äº‹åŠ¡æ¨¡å‹ï¼Œå­¦ä¹ ä¸€ä¸‹ Google Percolator è®ºæ–‡å¿…ä¸å¯å°‘&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;Percolator ç®€ä»‹&lt;/h2&gt;&#xA;&#xA;&lt;h3&gt;èƒŒæ™¯&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;ç®€å•æ¥è¯´ Percolator äº‹åŠ¡æ¨¡å‹çš„å‡ºç°æ˜¯å› ä¸ºä¹‹å‰é‡‡ç”¨ MapReduce è®¾è®¡çš„æ‰¹é‡åˆ›å»ºç´¢å¼•çš„ç³»ç»Ÿä¸æ”¯æŒè·¨è¡Œäº‹åŠ¡ä»¥åŠä¸æ”¯æŒéšæœºå¢é‡æ›´æ–°ã€‚äºæ˜¯ä¹ Percolator å°±è¯ç”Ÿäº†ï¼ˆ Google è¿˜çœŸæ˜¯æƒ³å•¥æœ‰å•¥å•Šï¼Œå®åŠ›çœŸä¸æ˜¯ç›–çš„ ï¼‰ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;ç‰¹æ€§&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Percolatorçš„ç‰¹ç‚¹å¦‚ä¸‹&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸ºå¢é‡å¤„ç†å®šåˆ¶&lt;/li&gt;&#xA;&lt;li&gt;å¤„ç†ç»“æœå¼ºä¸€è‡´&lt;/li&gt;&#xA;&lt;li&gt;é’ˆå¯¹å¤§æ•°æ®é‡ï¼ˆå°æ•°æ®é‡ç”¨ä¼ ç»Ÿçš„æ•°æ®åº“å³å¯ï¼‰&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Percolator ä¸ºå¯æ‰©å±•çš„å¢é‡å¤„ç†æä¾›äº†ä¸¤ä¸ªä¸»è¦æŠ½è±¡ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åŸºäºéšæœºå­˜å–åº“çš„ACIDäº‹åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;è§‚å¯Ÿè€…(observers)â€“ä¸€ç§ç”¨äºå¤„ç†å¢é‡è®¡ç®—çš„æ–¹å¼&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3&gt;å»¶è¿Ÿé—®é¢˜&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;ç”±äº Percolator åœ¨è®¾è®¡çš„æ—¶å€™è¿½æ±‚çš„æ˜¯å¤§æ•°æ®é‡è€Œå¯¹å»¶è¿Ÿæ²¡æœ‰ç‰¹å®šè¦æ±‚ï¼Œæ‰€æœ‰åŸºäº Percolator äº‹ç‰©æ¨¡å‹è®¾è®¡çš„ç³»ç»Ÿï¼Œå»¶è¿Ÿå’Œä¼ ç»Ÿ DBMS ç­‰æ•°æ®åº“ç³»ç»Ÿç›¸æ¯”è¿˜æ˜¯æœ‰å¾ˆå¤§çš„å·®è·çš„ã€‚ä¸»è¦åŸå› è¿˜æ˜¯é”çš„é—®é¢˜ã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Percolator ä½¿ç”¨ä¸€ä¸ª lazy çš„æ–¹æ³•å»æ¸…ç†é—ç•™ä¸‹æ¥çš„é”ï¼Œæ¯”å¦‚ä¸€ä¸ª transactions ç”±äºè¿è¡Œçš„æœºå™¨æŒ‚æ‰äº†ï¼Œè¿™ä¸ª transactions å¤±è´¥é—ç•™ä¸‹æ¥çš„é”å¯èƒ½ä¸ä¼šç«‹åˆ»æ¸…ç†ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªä½¿ç”¨åˆ°è¯¥æ•°æ®çš„é¥¿äº‹åŠ¡è´Ÿè´£æ¸…ç†&lt;/li&gt;&#xA;&lt;li&gt;ç¼ºå°‘å…¨å±€ deadlock æ£€æŸ¥ï¼Œè¿™æ ·å°±ä½¿äº¤æ˜“å†²çªçš„æƒ…å†µå¢å¤šï¼Œäº‹åŠ¡é‡è¯•çš„æ¬¡æ•°å°±ä¼šå˜å¤šï¼Œå»¶è¿Ÿå°±ä¼šéšä¹‹å¢å¤§ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;è®¾è®¡&lt;/h2&gt;&#xA;&#xA;&lt;h3&gt;Bigtable æ¦‚è¿°&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Percolator æ˜¯å»ºç«‹åœ¨ Bigtable åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸Šå±‚ï¼ŒBigtable&#xA;æ˜¯ä¸€ä¸ªç¨€ç–çš„ã€åˆ†å¸ƒå¼çš„ã€æŒä¹…åŒ–å­˜å‚¨çš„å¤šç»´åº¦æ’åº Mapã€‚Map çš„ç´¢å¼•æ˜¯è¡Œå…³é”®å­—ã€åˆ—å…³é”®å­—ä»¥åŠæ—¶é—´æˆ³ï¼ŒBigtable ä»¥ SSTable æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œå¹¶ä¸”è¿™äº› SSTables æ˜¯è¢«å­˜å‚¨åœ¨ GFS ä¸Šã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-27%20at%2012.44.16%20AM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;äº‹åŠ¡&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Percolator æä¾›äº†è·¨è¡Œã€è·¨è¡¨çš„ã€åŸºäºå¿«ç…§éš”ç¦»çš„ACIDäº‹åŠ¡ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h4&gt;Snapshop isolation&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-27%20at%209.34.11%20AM.png&#34; alt=&#34;sanpshop isolation&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¦‚å›¾ï¼Œæ˜¯åŸºäº Snapshop isolation  çš„ä¸‰ä¸ª transactionsï¼Œæ¯ä¸ª Transaction éƒ½æ˜¯å¼€å§‹ä¸ a start timestamp, å¹¶ä¸”ç»“æŸä¸ a commit timestampã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š&#xA;* å› ä¸º transaction 2 çš„ start timestamp æ˜¯åœ¨transaction 1 commit timestamp ä¹‹å‰çš„ï¼Œæ‰€ä»¥ transaction 2 ä¸èƒ½å¤Ÿè¯»åˆ° transaction 1 æäº¤çš„ä¿¡æ¯&#xA;* transaction 3 å¯ä»¥åŒæ—¶çœ‹åˆ° transaction 1 å’Œ transaction 2 çš„æäº¤ä¿¡æ¯&#xA;* transaction 1 å’Œ transaction 2 æ˜¯å¹¶å‘çš„æ‰§è¡Œï¼Œå¦‚æœä»–ä»¬å†™å…¥åŒä¸€é¡¹ï¼Œè¿™ä¸¤ä¸ªäº‹åŠ¡ä¸­è‡³å°‘åˆä¸€ä¸ªä¼šæ‰§è¡Œå¤±è´¥&lt;/p&gt;&#xA;&#xA;&lt;h4&gt;Lock&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;Bigtable æœ¬èº«å¹¶æ²¡æœ‰æä¾›ä¾¿æ·çš„å†²çªè§£å†³å’Œé”ç®¡ç†ï¼ŒPercolator å¿…é¡»è‡ªå·±ç»´æŠ¤ä¸€å¥—ç‹¬ç«‹çš„é”çš„ç®¡ç†æœºåˆ¶ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;è¦æ±‚ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®¹é”™ï¼Œå½“æœºå™¨å‡ºç°æ•…éšœçš„æ—¶å€™ä¸å½±å“æ­£ç¡®æ€§ï¼Œå¦‚æœåœ¨ä¸¤é˜¶æ®µæäº¤çš„è¿‡ç¨‹ä¸­é”å‡ºç°äº†ä¸¢å¤±ï¼Œå¯èƒ½å°†ä¸¤ä¸ªæœ‰å†²çªçš„äº‹ç‰©éƒ½æäº¤æˆåŠŸã€‚&lt;/li&gt;&#xA;&lt;li&gt;é«˜ååï¼Œä¸Šåƒå°æœºå™¨ä¼šåŒæ—¶è¯·æ±‚è·å–é”ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä½å»¶è¿Ÿ, æ¯ä¸ª Get() æ“ä½œéƒ½éœ€è¦è¯»å–ä¸€æ¬¡é”ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Percolator éœ€è¦åšåˆ°ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¤šå‰¯æœ¬ï¼Œå®¹é”™&lt;/li&gt;&#xA;&lt;li&gt;åˆ†å¸ƒå¼ä»¥åŠè´Ÿè½½å‡è¡¡ï¼Œå¤„ç†è´Ÿè½½&lt;/li&gt;&#xA;&lt;li&gt;æ•°æ®æŒä¹…åŒ–&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;BigTable èƒ½å¤Ÿæ»¡è¶³ä»¥ä¸Šæ‰€æœ‰è¦æ±‚ã€‚æ‰€ä»¥ Percolator åœ¨å®ç°æ—¶ï¼Œå°†å®é™…çš„æ•°æ®å­˜äºBigtableä¸­ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;Columns in Bigtable&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-27%20at%2011.32.55%20PM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Percolator åœ¨ Bigtable ä¸ŠæŠ½è±¡äº† 5 Columns å»å­˜å‚¨æ•°æ®ï¼Œå¦‚ä¸Šå›¾ï¼Œå…¶ä¸­æœ‰ 3 å’Œäº‹åŠ¡ç›¸å…³ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;c:lock&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;äº‹åŠ¡äº§ç”Ÿçš„é”ï¼Œæœªæäº¤çš„äº‹åŠ¡ä¼šå†™æœ¬é¡¹ï¼Œä¼šåŒ…å« primary lock çš„ä½ç½®ã€‚å…¶æ˜ å°„å…³ç³»ä¸º&lt;/p&gt;&#xA;&#xA;&lt;p&gt;${key,start_ts}=&amp;gt;${primary_key,lock_type,..etc}&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;${key} æ•°æ®çš„key&#xA;${start_ts} äº‹åŠ¡å¼€å§‹æ—¶é—´&#xA;${primary} è¯¥äº‹åŠ¡çš„primaryçš„å¼•ç”¨. primaryæ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œä»å¾…ä¿®æ”¹çš„ keysä¸­ é€‰æ‹©ä¸€ä¸ªä½œä¸ºprimary,å…¶ä½™çš„åˆ™ä½œä¸ºsecondary.&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;c:write&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å·²æäº¤çš„æ•°æ®ä¿¡æ¯ï¼Œå­˜å‚¨æ•°æ®æ‰€å¯¹åº”çš„æ—¶é—´æˆ³ã€‚å…¶æ˜ å°„å…³ç³»ä¸º&lt;/p&gt;&#xA;&#xA;&lt;p&gt;${key,commit_ts}=&amp;gt;${start_ts}&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;${key} æ•°æ®çš„key&#xA;${commit_ts} äº‹åŠ¡çš„æäº¤æ—¶é—´&#xA;${start_ts} è¯¥äº‹åŠ¡çš„å¼€å§‹æ—¶é—´,æŒ‡å‘è¯¥æ•°æ®åœ¨dataä¸­çš„å®é™…å­˜å‚¨ä½ç½®ã€‚&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;c:data&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å…·ä½“å­˜å‚¨æ•°æ®é›†ï¼Œæ˜ å°„å…³ç³»ä¸º&lt;/p&gt;&#xA;&#xA;&lt;p&gt;${key,start_ts} =&amp;gt; ${value}&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;${key} çœŸå®çš„key&#xA;${start_ts} å¯¹åº”äº‹åŠ¡çš„å¼€å§‹æ—¶é—´&#xA;${value} çœŸå®çš„æ•°æ®å€¼&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h3&gt;ç®€è¿° Percolator äº‹åŠ¡æµç¨‹&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;äº‹åŠ¡æäº¤é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ã€‚ä¸¤é˜¶æ®µæäº¤é€šè¿‡ client æ¥åè°ƒã€‚&lt;/p&gt;&#xA;&#xA;&lt;h4&gt;Prewrite&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/prewrite.jpg&#34; alt=&#34;prewrite&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;p&gt;åœ¨æäº¤çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼šå…¶ä» Oracle è·å–ä»£è¡¨å½“å‰ç‰©ç†æ—¶é—´çš„å…¨å±€å”¯ä¸€æ—¶é—´æˆ³ä½œä¸ºå½“å‰äº‹åŠ¡çš„ start_tsï¼Œæˆ‘ä»¬é¦–å…ˆè·å–æ‰€æœ‰éœ€è¦å†™å…¥çš„ cell çš„ lockï¼ˆè€ƒè™‘åˆ° client æ•…éšœæƒ…å†µï¼Œæˆ‘ä»¬ä¼šä»»æ„æŒ‡å®šä¸€ä¸ª lock ä¸º primaryï¼Œå…¶ä½™çš„ä½œä¸º secondaryï¼‰ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šè¯»å– meta æ•°æ®æ¥æ£€æµ‹äº‹åŠ¡æ˜¯å¦å­˜åœ¨å†²çªã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æœ‰ä¸¤ç§å†²çªçš„æƒ…å†µï¼š&lt;/p&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;p&gt;å¦‚æœä¸€ä¸ªäº‹åŠ¡ A çœ‹åˆ° cell çš„ write åˆ—ä¸­å·²ç»å­˜åœ¨ä¸€æ¡è®°å½•ï¼Œè®°å½•çš„æ—¶é—´æˆ³æ™šäºè¯¥äº‹åŠ¡å¼€å§‹çš„æ—¶é—´æˆ³ï¼Œé‚£ä¹ˆè¯´æ˜å­˜åœ¨å†™å†²çªï¼Œå³è¯´æ˜æœ‰ä¸€ä¸ªäº‹åŠ¡åœ¨ A å‘èµ·ä¹‹åæ›´æ–°äº† cell çš„å€¼ï¼Œäº‹åŠ¡ A éœ€è¦ abortedã€‚&lt;/p&gt;&lt;/li&gt;&#xA;&#xA;&lt;li&gt;&lt;p&gt;å¦‚æœäº‹åŠ¡çœ‹åˆ° cell çš„ lock åˆ—ä¸­å­˜åœ¨ä»»æ„ä¸€æ¡é”è®°å½•ï¼Œä¸ç®¡æ—¶é—´æˆ³ä¸ºå¤šå°‘ï¼Œç›´æ¥ abortedã€‚&lt;/p&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœä¸¤ç§å†²çªéƒ½ä¸å­˜åœ¨ï¼Œå‘ lock åˆ—ä¸­å†™å…¥ä¸Šé”ä¿¡æ¯ï¼Œå¹¶æ›´æ–° data åˆ—æ•°æ®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h4&gt;Commit&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/commit.jpg&#34; alt=&#34;commit&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœæ²¡æœ‰ cell å†²çªï¼Œé‚£ä¹ˆè¯´æ˜äº‹åŠ¡å¯ä»¥æäº¤ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªé˜¶æ®µ commitï¼šé¦–å…ˆ client ä¼šå‘æ—¶é—´æœåŠ¡å™¨ç”³è¯·ä¸€ä¸ª timestamp ä½œä¸º commit_tsï¼Œè¡¨ç¤º commit çš„æ—¶é—´ã€‚ç„¶å client ä¼šé‡Šæ”¾äº‹åŠ¡ä¸­æ¶‰åŠçš„æ‰€æœ‰ cell çš„é”ï¼ˆæ¸…ç©º lock åˆ—ï¼‰ï¼Œé‡Šæ”¾é¡ºåºä» primary lockå¼€å§‹ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;é‡Šæ”¾é”ä¹‹åä¾¿æ›´æ–° write åˆ—æ¥ä½¿æ–°çš„ read èƒ½å¤Ÿè¯»åˆ°æœ¬æ¬¡äº‹åŠ¡çš„æ•°æ®ã€‚write åˆ—çš„æ•°æ®è¡¨ç¤ºï¼šæœ¬æ¬¡äº‹åŠ¡çš„æ•°æ®å·²ç»æˆåŠŸæ›´æ–°è‡³ cell ä¸­ï¼Œwrite åˆ—ä¸­çš„æ•°æ®åŒ…å«äº†ä¸€ä¸ª timestampï¼Œè¯¥ timestamp è¡¨ç¤ºæœ¬æ¬¡äº‹åŠ¡æ•°æ®çš„ timestampï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¯¥ timestamp æ¥æ‰¾åˆ°æ•°æ®ã€‚ä¸€æ—¦ primary é”å¯¹åº”è®°å½•çš„ write åˆ—æ•°æ®å¯è§äº†ï¼Œä»£è¡¨è¯¥äº‹åŠ¡ä¸€å®šå·²ç» commit äº†ï¼Œreader æ­¤æ—¶èƒ½çœ‹åˆ°è¯¥äº‹åŠ¡çš„æ•°æ®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h4&gt;Get operation&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/get.jpg&#34; alt=&#34;get&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Get æ“ä½œé¦–å…ˆæ£€æŸ¥[0,start_ts]æ—¶é—´åŒºé—´å†…Lockæ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨ï¼Œè¯´æ˜å¯èƒ½æœ‰å…¶ä»– transaction æ­£åœ¨å†™è¿™ä¸ª cellï¼Œæ‰€ä»¥è¿™ä¸ªè¯» transaction éœ€è¦ç­‰å¾… lock é‡Šæ”¾æ‰ã€‚å¦‚æœä¸å­˜åœ¨æœ‰å†²çªçš„ lock,åˆ™è·å–åœ¨ write ä¸­åˆæ³•çš„æœ€æ–°æäº¤è®°å½•æŒ‡å‘çš„åœ¨ data ä¸­çš„ä½ç½®ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä» data ä¸­è·å–åˆ°ç›¸åº”çš„æ•°æ®å¹¶è¿”å›ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h4&gt;clean lock&lt;/h4&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/rollback.jpg&#34; alt=&#34;clean lock&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;p&gt;è‹¥å®¢æˆ·ç«¯åœ¨ Commit ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼ŒPrepare æ—¶äº§ç”Ÿçš„é”ä¼šè¢«ç•™ä¸‹ã€‚ä¸ºé¿å…å°†æ–°äº‹åŠ¡ hang ä½ï¼ŒPercolator å¿…é¡»æ¸…ç†è¿™äº›é”ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Percolator ç”¨ lazy æ–¹å¼å¤„ç†è¿™äº›é”ï¼šå½“äº‹åŠ¡ A åœ¨æ‰§è¡Œæ—¶ï¼Œå‘ç°äº‹åŠ¡ B é€ æˆçš„é”å†²çªï¼Œäº‹åŠ¡ A å°†å†³å®šäº‹åŠ¡ B æ˜¯å¦å¤±è´¥ï¼Œä»¥åŠæ¸…ç†äº‹åŠ¡ B çš„é‚£äº›é”ã€‚&#xA;å¯¹äº‹åŠ¡ A è€Œè¨€ï¼Œèƒ½å‡†ç¡®åœ°åˆ¤æ–­äº‹åŠ¡ B æ˜¯å¦æˆåŠŸæ˜¯å…³é”®ã€‚Percolator ä¸ºæ¯ä¸ªäº‹åŠ¡è®¾è®¡äº†ä¸€ä¸ªå…ƒç´ cellä½œä¸ºäº‹åŠ¡æ˜¯å¦æˆåŠŸçš„åŒæ­¥æ ‡å‡†ï¼Œè¯¥å…ƒç´ äº§ç”Ÿçš„ lock å³ä¸º primary lockã€‚A å’Œ B äº‹åŠ¡éƒ½èƒ½ç¡®å®šäº‹åŠ¡ B çš„ primary lockï¼ˆå› ä¸ºè¿™ä¸ªpriarmy lockè¢«å†™å…¥äº†Bäº‹åŠ¡å…¶å®ƒæ‰€æœ‰æ¶‰åŠå…ƒç´ çš„locké‡Œé¢ï¼‰ã€‚æ‰§è¡Œä¸€ä¸ªæ¸…ç† clean up æˆ–è€…æäº¤ commit æ“ä½œéœ€è¦ä¿®æ”¹è¯¥primary lockï¼Œç”±äºè¿™äº›ä¿®æ”¹æ˜¯åŸºäº Bigtable å»åšï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªæ¸…ç†æˆ–æäº¤ä¼šæˆåŠŸã€‚æ³¨æ„ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åœ¨Bæäº¤ commit ä¹‹å‰,å®ƒä¼šå…ˆç¡®ä¿å…¶ primary lock è¢« write record æ‰€æ›¿ä»£ï¼ˆå³å¾€ primary çš„ write å†™æäº¤æ•°æ®ï¼Œå¹¶åˆ é™¤å¯¹åº”çš„ lockï¼‰ã€‚&lt;/li&gt;&#xA;&lt;li&gt;åœ¨ A æ¸…ç† B çš„é”ä¹‹å‰ï¼ŒA å¿…é¡»æ£€æŸ¥ B çš„ primary ä»¥ç¡®ä¿ B æœªè¢«æäº¤ï¼Œå¦‚æœ B çš„ primary å­˜åœ¨ï¼Œåˆ™ B çš„é”å¯ä»¥è¢«å®‰å…¨çš„æ¸…ç†æ‰ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å½“å®¢æˆ·ç«¯åœ¨æ‰§è¡Œä¸¤é˜¶æ®µæäº¤çš„ commit é˜¶æ®µå¤±è´¥æ—¶ï¼Œäº‹åŠ¡ä¾æ—§ä¼šç•™ä¸‹ä¸€ä¸ªæäº¤ç‚¹ commit point(è‡³å°‘ä¸€æ¡è®°å½•ä¼šè¢«å†™å…¥ write ä¸­)ï¼Œä½†å¯èƒ½ä¼šç•™ä¸‹ä¸€äº› lock æœªè¢«å¤„ç†æ‰ã€‚ä¸€ä¸ªäº‹åŠ¡èƒ½å¤Ÿä»å…¶ primary lock ä¸­è·å–åˆ°æ‰§è¡Œæƒ…å†µï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ priarmy lock å·²è¢« write æ‰€æ›¿ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥äº‹åŠ¡å·²è¢«æäº¤ï¼Œå¯ä»¥æ”¾å¿ƒçš„æ¸…ç† B äº‹åŠ¡çš„æ‰€æœ‰ lock&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœ primary lock å­˜åœ¨ï¼Œäº‹åŠ¡è¢« roll back (å› ä¸ºæˆ‘ä»¬æ€»æ˜¯æœ€å…ˆæäº¤ primary ,æ‰€ä»¥ primary æœªè¢«æäº¤æ—¶ï¼Œå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œå›æ»š)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3&gt;æ¡ˆä¾‹&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%2012.59.40%20AM.png&#34; alt=&#34;1&#34; /&gt;&#xA;&amp;gt; åˆå§‹çŠ¶æ€ä¸‹ï¼ŒBob çš„å¸æˆ·ä¸‹æœ‰ $10ï¼ˆé¦–å…ˆæŸ¥è¯¢ column write è·å–æœ€æ–°æ—¶é—´æˆ³æ•°æ®,è·å–åˆ° data@5,ç„¶åä» column data é‡Œé¢è·å–æ—¶é—´æˆ³ä¸º5çš„æ•°æ®ï¼Œå³ $10ï¼‰ï¼ŒJoe çš„å¸æˆ·ä¸‹æœ‰ $2ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%2012.59.46%20AM.png&#34; alt=&#34;2&#34; /&gt;&#xA;&amp;gt; è½¬è´¦å¼€å§‹ï¼Œä½¿ç”¨ stat timestamp=7 ä½œä¸ºå½“å‰äº‹åŠ¡çš„å¼€å§‹æ—¶é—´æˆ³ï¼Œå°† Bob é€‰ä¸ºæœ¬äº‹åŠ¡çš„ primaryï¼Œé€šè¿‡å†™å…¥ Column Lock é”å®š Bob çš„å¸æˆ·ï¼ŒåŒæ—¶å°†æ•°æ® 7:$3 å†™å…¥åˆ° Column,data åˆ—ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%2012.59.53%20AM.png&#34; alt=&#34;3&#34; /&gt;&#xA;&amp;gt; åŒæ ·çš„ï¼Œä½¿ç”¨ stat timestamp=7ï¼Œé”å®š Joe çš„å¸æˆ·ï¼Œå¹¶å°† Joe æ”¹å˜åçš„ä½™é¢å†™å…¥åˆ° Column,data ,å½“å‰é”ä½œä¸º secondary å¹¶å­˜å‚¨ä¸€ä¸ªæŒ‡å‘ primary çš„å¼•ç”¨ï¼ˆå½“å¤±è´¥æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ° primary é”ï¼Œå¹¶æ ¹æ®å…¶çŠ¶æ€å¼‚æ­¥æ¸…ç†ï¼‰&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%201.00.00%20AM.png&#34; alt=&#34;4&#34; /&gt;&#xA;&amp;gt; äº‹åŠ¡å¸¦ç€å½“å‰æ—¶é—´æˆ³ commit timestamp=8 è¿›å…¥ commit é˜¶æ®µï¼šåˆ é™¤ primary æ‰€åœ¨çš„ lockï¼Œå¹¶åœ¨ write åˆ—ä¸­å†™å…¥ä»æäº¤æ—¶é—´æˆ³æŒ‡å‘æ•°æ®å­˜å‚¨çš„ä¸€ä¸ªæŒ‡é’ˆ commit_ts=&amp;gt;data @7ã€‚è‡³æ­¤ï¼Œè¯»è¯·æ±‚è¿‡æ¥æ—¶å°†çœ‹åˆ° Bob çš„ä½™é¢ä¸º3ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%201.00.06%20AM.png&#34; alt=&#34;5&#34; /&gt;&#xA;&amp;gt; ä¾æ¬¡åœ¨ secondary é¡¹ä¸­å†™å…¥wirteå¹¶æ¸…ç†é”ï¼Œæ•´ä¸ªäº‹åŠ¡æäº¤ç»“æŸã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Peng.pdf&#34;&gt;Large-scale Incremental Processing&#xA;Using Distributed Transactions and Notifications&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt; - å¾ˆå¤šæè¿°æ˜¯ä»é›ªå§ blog ç›´æ¥ copy è¿‡æ¥&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.jianshu.com/p/05194f4b29dd&#34;&gt;Percolatorç®€å•ç¿»è¯‘ä¸ä¸ªäººç†è§£&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2018/Percolator è®ºæ–‡ç¬”è®°.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>MVCC In TiKV</title>
    <updated>2017-11-28T00:00:00Z</updated>
    <id>tag:int64.me,2017-11-28:/2017/MVCC In TiKV.html</id>
    <content type="html">&lt;p&gt;å¾ˆå¤šæ•°æ®åº“éƒ½ä¼šå®ç°å¤šç‰ˆæœ¬æ§åˆ¶ï¼ˆMVCCï¼‰ï¼ŒTiKV ä¹Ÿä¸ä¾‹å¤–ï¼Œåˆšå¥½æœ€è¿‘åœ¨çœ‹ TiKVï¼Œå¯¹äº MVCC ä»¥åŠ TiKV å†…æ˜¯å¦‚ä½•ä½¿ç”¨ MVCC çš„åšä¸ªç®€å•ç¬”è®°&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;ä¹è§‚é”å’Œæ‚²è§‚é”&lt;/h2&gt;&#xA;&#xA;&lt;h3&gt;ä¹è§‚é”&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;ä¹è§‚é”å‘¢ï¼Œè¯»å†™äº‹åŠ¡ï¼Œåœ¨çœŸæ­£çš„æäº¤ä¹‹å‰ï¼Œä¸åŠ è¯»/å†™é”ï¼Œè€Œæ˜¯å…ˆçœ‹ä¸€ä¸‹æ•°æ®çš„ç‰ˆæœ¬/æ—¶é—´æˆ³ï¼Œç­‰åˆ°çœŸæ­£æäº¤çš„æ—¶å€™å†çœ‹ä¸€ä¸‹ç‰ˆæœ¬/æ—¶é—´æˆ³ï¼Œå¦‚æœä¸¤æ¬¡ç›¸åŒï¼Œè¯´æ˜åˆ«äººæœŸé—´æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ”¾å¿ƒæäº¤ã€‚ä¹è§‚ä½“ç°åœ¨ï¼Œè®¿é—®æ•°æ®æ—¶ä¸æå‰åŠ é”ã€‚åœ¨èµ„æºå†²çªä¸æ¿€çƒˆçš„åœºåˆï¼Œç”¨ä¹è§‚é”æ€§èƒ½è¾ƒå¥½ã€‚å¦‚æœèµ„æºå†²çªä¸¥é‡ï¼Œä¹è§‚é”çš„å®ç°ä¼šå¯¼è‡´äº‹åŠ¡æäº¤çš„æ—¶å€™ç»å¸¸çœ‹åˆ°åˆ«äººåœ¨ä»–ä¹‹å‰å·²ç»ä¿®æ”¹äº†æ•°æ®ï¼Œç„¶åè¦è¿›è¡Œå›æ»šæˆ–è€…é‡è¯•ï¼Œè¿˜ä¸å¦‚ä¸€ä¸Šæ¥å°±åŠ é”ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;æ‚²è§‚é”&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;ä¸€ä¸ªè¯»å†™äº‹åŠ¡åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­åœ¨è®¿é—®æ•°æ®ä¹‹å‰å…ˆåŠ è¯»/å†™é”è¿™ç§å®ç°å«åšæ‚²è§‚é”ï¼Œæ‚²è§‚ä½“ç°åœ¨ï¼Œå…ˆåŠ é”ï¼Œç‹¬å æ•°æ®ï¼Œé˜²æ­¢åˆ«äººåŠ é”ã€‚&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å…³äºä¹è§‚é”æ‚²è§‚é”çš„è§£é‡Š copy è‡ªï¼š&lt;a href=&#34;https://www.zhihu.com/question/27876575/answer/73330077&#34;&gt;å´é•å¤§ç¥çŸ¥ä¹çš„å›ç­”&lt;/a&gt;, æ„Ÿè§‰å›ç­”çš„æœ€ç®€æ´è´´åˆ‡&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;h2&gt;å¹¶å‘æ§åˆ¶&lt;/h2&gt;&#xA;&#xA;&lt;h3&gt;å¯ä¸²è¡ŒåŒ–&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;å¤šä¸ªäº‹åŠ¡çš„å¹¶å‘æ‰§è¡Œæ˜¯æ­£ç¡®çš„ï¼Œå½“ä¸”ä»…å½“å…¶ç»“æœä¸æŒ‰æŸä¸€æ¬¡åºä¸²è¡Œåœ°æ‰§è¡Œå®ƒä»¬æ—¶çš„ç»“æœç›¸åŒã€‚æˆ‘ä»¬ç§°è¿™ç§è°ƒåº¦ç­–ç•¥ä¸ºå¯ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰çš„è°ƒåº¦ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¯ä¸²è¡Œæ€§æ˜¯å¹¶å‘äº‹åŠ¡æ­£ç¡®æ€§çš„å‡†åˆ™ã€‚æŒ‰è¿™ä¸ªå‡†åˆ™è§„å®šï¼Œä¸€ä¸ªç»™å®šçš„å¹¶å‘è°ƒåº¦ï¼Œå½“ä¸”ä»…å½“å®ƒæ˜¯å¯ä¸²è¡ŒåŒ–çš„ï¼Œæ‰è®¤ä¸ºæ˜¯æ­£ç¡®è°ƒåº¦ã€‚DBMSçš„å¹¶å‘æ§åˆ¶æœºåˆ¶å¿…é¡»æä¾›ä¸€å®šçš„æ‰‹æ®µæ¥ä¿è¯è°ƒåº¦æ˜¯å¯ä¸²è¡ŒåŒ–çš„ï¼Œç›®å‰DBMSæ™®éé‡‡ç”¨å°é”æ–¹æ³•å®ç°å¹¶å‘æ“ä½œè°ƒåº¦çš„å¯ä¸²è¡Œæ€§ï¼Œä»è€Œä¿è¯è°ƒåº¦çš„æ­£ç¡®æ€§ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸¤æ®µé”ï¼ˆTwo-Phase Lockingï¼Œç®€ç§°2PLï¼‰åè®®å°±æ˜¯ä¿è¯å¹¶å‘è°ƒåº¦å¯ä¸²è¡Œæ€§çš„å°é”åè®®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;2PL&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;ä¸¤æ®µé”ï¼ˆTwo-Phase Lockingï¼Œç®€ç§°2PLï¼‰æ˜¯æŒ‡æ‰€æœ‰äº‹åŠ¡éƒ½å¿…é¡»åˆ†ä¸ºä¸¤é˜¶æ®µå¯¹æ•°æ®è¿›è¡ŒåŠ é”å’Œè§£é”ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;å¯¹ä»»ä½•æ•°æ®è¿›è¡Œè¯»ã€å†™æ“ä½œä¹‹å‰ï¼Œé¦–å…ˆè¦å…ˆç”³è¯·å¹¶è·å¾—å¯¹è¯¥æ•°æ®çš„å°é”&lt;/li&gt;&#xA;&lt;li&gt;åœ¨é‡Šæ”¾ä¸€ä¸ªå°é”ä»¥åï¼Œäº‹åŠ¡ä¸å†è·å¾—ä»»ä½•å…¶ä»–å°é”&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&lt;p&gt;åœ¨â€œä¸¤æ®µâ€é”åè®®ä¸­ï¼Œäº‹åŠ¡åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç¬¬ä¸€é˜¶æ®µæ˜¯è·å¾—å°é”ï¼Œä¹Ÿç§°ä¸ºæ‰©å±•é˜¶æ®µã€‚è¿™åœ¨é˜¶æ®µï¼Œäº‹åŠ¡å¯ä»¥ç”³è¯·è·å¾—ä»»ä½•æ•°æ®é¡¹ä¸Šçš„ä»»ä½•ç±»å‹çš„é”ï¼Œä½†æ˜¯ä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ç¬¬äºŒé˜¶æ®µæ˜¯é‡Šæ”¾å°é”ï¼Œä¹Ÿç§°ä¸ºæ”¶ç¼©é˜¶æ®µã€‚åœ¨è¿™é˜¶æ®µï¼Œäº‹åŠ¡å¯ä»¥é‡Šæ”¾ä»»ä½•æ•°æ®é¡¹ä¸Šçš„ä»»ä½•ç±»å‹çš„çï¼Œä½†æ˜¯ä¸èƒ½å†ç”³è¯·ä»»ä½•çã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å¦‚å›¾ï¼š&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202017-11-27%20at%2011.44.23%20PM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;2PL ä¸€äº›ç¼ºç‚¹&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è¯»é”å’Œå†™é”ä¼šç›¸äº’é˜»æ»ï¼ˆblockï¼‰ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å¤§éƒ¨åˆ†äº‹åŠ¡éƒ½æ˜¯åªè¯»ï¼ˆread-onlyï¼‰çš„ï¼Œæ‰€ä»¥ä»äº‹åŠ¡åºåˆ—ï¼ˆtransaction-orderingï¼‰çš„è§’åº¦æ¥çœ‹æ˜¯æ— å®³çš„ã€‚å¦‚æœä½¿ç”¨åŸºäºé”çš„éš”ç¦»æœºåˆ¶ï¼Œè€Œä¸”å¦‚æœæœ‰ä¸€æ®µå¾ˆé•¿çš„è¯»äº‹åŠ¡çš„è¯ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…è¿™ä¸ªå¯¹è±¡å°±æ— æ³•è¢«æ”¹å†™ï¼Œåé¢çš„äº‹åŠ¡å°±ä¼šè¢«é˜»å¡ç›´åˆ°è¿™ä¸ªäº‹åŠ¡å®Œæˆã€‚è¿™ç§æœºåˆ¶å¯¹äºå¹¶å‘æ€§èƒ½æ¥è¯´å½±å“å¾ˆå¤§ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3&gt;MVCC&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;MVCC - å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Controlï¼‰, åœ¨ MVCC ä¸­ï¼Œæ¯å½“æƒ³è¦æ›´æ”¹æˆ–è€…åˆ é™¤æŸä¸ªæ•°æ®å¯¹è±¡æ—¶ï¼ŒDBMS ä¸ä¼šåœ¨åŸåœ°å»åˆ é™¤æˆ–è¿™ä¿®æ”¹è¿™ä¸ªå·²æœ‰çš„æ•°æ®å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªè¯¥æ•°æ®å¯¹è±¡çš„æ–°çš„ç‰ˆæœ¬ï¼Œè¿™æ ·çš„è¯åŒæ—¶å¹¶å‘çš„è¯»å–æ“ä½œä»æ—§å¯ä»¥è¯»å–è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œè€Œå†™æ“ä½œå°±å¯ä»¥åŒæ—¶è¿›è¡Œã€‚è¿™ä¸ªæ¨¡å¼çš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥è®©è¯»å–æ“ä½œä¸å†é˜»å¡ï¼Œäº‹å®ä¸Šæ ¹æœ¬å°±ä¸éœ€è¦é”ã€‚è¿™æ˜¯ä¸€ç§éå¸¸è¯±äººçš„ç‰¹å‹ï¼Œä»¥è‡³äºåœ¨å¾ˆå¤šä¸»æµçš„æ•°æ®åº“ä¸­éƒ½é‡‡ç”¨äº† MVCC çš„å®ç°ï¼Œæ¯”å¦‚è¯´ PostgreSQLï¼ŒOracleï¼ŒMicrosoft SQL Server ç­‰ã€‚&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ­¤å¤„ copy è‡ª&lt;a href=&#34;https://pingcap.com/blog-cn/MVCC-in-TiKV/&#34;&gt;TiKV çš„ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰æœºåˆ¶&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;h2&gt;MVCC in TiKV&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;TiKV ç›®å‰çš„åº•å±‚å­˜å‚¨è¿˜æ˜¯ä½¿ç”¨äº† rocksdbï¼Œ ä¹Ÿå°±æ˜¯ç›®å‰æˆ‘ä»¬çš„æ‰€æœ‰æ•°æ®ä¹Ÿå°±æ˜¯å­˜åœ¨ rocksdb å†…ã€‚ç›®å‰ TiKV ä¼šå¯åŠ¨ä¸¤ä¸ª rocksdb å®ä¾‹ï¼Œé»˜è®¤ rocksdb å®ä¾‹å°† KV æ•°æ®å­˜å‚¨åœ¨å†…éƒ¨çš„ defaultã€write å’Œ lock 3 ä¸ª CF å†…ã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;default CF å­˜å‚¨çš„æ˜¯çœŸæ­£çš„æ•°æ®ï¼›&lt;/li&gt;&#xA;&lt;li&gt;write CF å­˜å‚¨çš„æ˜¯æ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆMVCCï¼‰ä»¥åŠç´¢å¼•ç›¸å…³çš„æ•°æ®ï¼›&lt;/li&gt;&#xA;&lt;li&gt;lock CF å­˜å‚¨çš„æ˜¯é”ä¿¡æ¯ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Raft RocksDB å®ä¾‹å­˜å‚¨ Raft logã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;default CF ä¸»è¦å­˜å‚¨çš„æ˜¯ raft logã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;rocksdb çš„ cf æ˜¯ä¸€ä¸ªé€»è¾‘åˆ’åˆ†æ•°æ®åº“çš„èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯è¯´åšåˆ°äº†æƒ³å¤šéš”ç¦»çš„å­˜å‚¨ï¼Œä½†æ˜¯ rocksdb æä¾›è·¨ cf çš„åŸå­å†™æ“ä½œï¼Œä¸åŒçš„ cf å…±ç”¨åŒä¸€ä¸ª WALï¼Œä½†æ˜¯ä½¿ç”¨ä¸åŒ memtable å’Œ sslã€‚ï¼ˆå…·ä½“ rocksdb ç›¸å…³çš„çŸ¥è¯†å¯ä»¥æŸ¥é˜… rocksdb ç›¸å…³æ–‡æ¡£ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„ cf ç”¨æ¥å­˜å‚¨ MVCC çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚ TiKV çš„ MVCC å®ç°æ˜¯é€šè¿‡åœ¨ Key åé¢æ·»åŠ  Version æ¥å®ç°ï¼Œç®€å•æ¥è¯´ï¼Œæ²¡æœ‰ MVCC ä¹‹å‰ï¼Œå¯ä»¥æŠŠ TiKV çœ‹åšè¿™æ ·çš„ï¼š&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;                Key1 -&amp;gt; Value&#xA;&#x9;            Key2 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&#x9;            KeyN -&amp;gt; Value&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;æœ‰äº† MVCC ä¹‹åï¼ŒTiKV çš„ Key æ’åˆ—æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;&#x9;            Key1-Version3 -&amp;gt; Value&#xA;&#x9;            Key1-Version2 -&amp;gt; Value&#xA;&#x9;            Key1-Version1 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&#x9;            Key2-Version4 -&amp;gt; Value&#xA;&#x9;            Key2-Version3 -&amp;gt; Value&#xA;&#x9;            Key2-Version2 -&amp;gt; Value&#xA;&#x9;            Key2-Version1 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&#x9;            KeyN-Version2 -&amp;gt; Value&#xA;&#x9;            KeyN-Version1 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;æ³¨æ„ï¼Œå¯¹äºåŒä¸€ä¸ª Key çš„å¤šä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬æŠŠç‰ˆæœ¬å·è¾ƒå¤§çš„æ”¾åœ¨å‰é¢ï¼Œç‰ˆæœ¬å·å°çš„æ”¾åœ¨åé¢ï¼Œè¿™æ ·å½“ç”¨æˆ·é€šè¿‡ä¸€ä¸ª Key + Version æ¥è·å– Value çš„æ—¶å€™ï¼Œå¯ä»¥å°† Key å’Œ Version æ„é€ å‡º MVCC çš„ Keyï¼Œä¹Ÿå°±æ˜¯ Key-Versionã€‚ç„¶åå¯ä»¥ç›´æ¥ Seek(Key-Version)ï¼Œå®šä½åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºè¿™ä¸ª Key-Version çš„ä½ç½®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ­¤å¤„ copy è‡ªç”³æ å“¥æ–‡ç« &lt;a href=&#34;https://pingcap.com/blog-cn/tidb-internal-1/&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´å­˜å‚¨&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;p&gt;ç°åœ¨ä»ä»£ç çœ‹èµ·ï¼š&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬æ¥çœ‹ TiKV çš„ Storage pkgï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ª pkg é‡Œé¢æœ‰ä¸ª MVCC pkgï¼Œæ²¡é”™å…·ä½“çš„ MVCC æ“ä½œå®ç°å°±æ˜¯å®šä¹‰åœ¨ MVCC è¿™ä¸ª pkg é‡Œé¢ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;å…ˆçœ‹ Storage&lt;/h3&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;pub struct Storage {&#xA;    engine: Box&amp;lt;Engine&amp;gt;,&#xA;    sendch: SyncSendCh&amp;lt;Msg&amp;gt;,&#xA;    handle: Arc&amp;lt;Mutex&amp;lt;StorageHandle&amp;gt;&amp;gt;,&#xA;    ...&#xA;}&#xA;impl Storage {&#xA; pub fn start(&amp;amp;mut self, config: &amp;amp;Config) -&amp;gt; Result&amp;lt;()&amp;gt; {&#xA;        let mut handle = self.handle.lock().unwrap();&#xA;        if handle.handle.is_some() {&#xA;            return Err(box_err!(&amp;quot;scheduler is already running&amp;quot;));&#xA;        }&#xA;&#xA;        let engine = self.engine.clone();&#xA;        let builder = thread::Builder::new().name(thd_name!(&amp;quot;storage-scheduler&amp;quot;));&#xA;        let rx = handle.receiver.take().unwrap();&#xA;        let sched_concurrency = config.scheduler_concurrency;&#xA;        let sched_worker_pool_size = config.scheduler_worker_pool_size;&#xA;        let sched_pending_write_threshold = config.scheduler_pending_write_threshold.0 as usize;&#xA;        let ch = self.sendch.clone();&#xA;        let h = builder.spawn(move || {&#xA;            let mut sched = Scheduler::new(&#xA;                engine,&#xA;                ch,&#xA;                sched_concurrency,&#xA;                sched_worker_pool_size,&#xA;                sched_pending_write_threshold,&#xA;            );&#xA;            if let Err(e) = sched.run(rx) {&#xA;                panic!(&amp;quot;scheduler run err:{:?}&amp;quot;, e);&#xA;            }&#xA;            info!(&amp;quot;scheduler stopped&amp;quot;);&#xA;        })?;&#xA;        handle.handle = Some(h);&#xA;&#xA;        Ok(())&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;å…¶å® Storage æ˜¯å®é™…æ¥å—å¤–éƒ¨æŒ‡ä»¤, Storage å†…åŒ…å«ä¸‰ä¸ªå­—æ®µï¼š&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Engineï¼Œæ•°æ®åº“æ“ä½œçš„æ¥å£ï¼Œraftkv ä»¥åŠ rocksdb å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹ engine/raftkv.rs, engine/rocksdb.rs&lt;/li&gt;&#xA;&lt;li&gt;SyncSendCh, ä¸€ä¸ª channel å†…éƒ¨ç±»å‹æ˜¯ Msg, ç”¨æ¥å­˜å‚¨ scheduler event çš„ channel&lt;/li&gt;&#xA;&lt;li&gt;StorageHanle, æ˜¯å¤„ç†ä»sench æ¥å—åˆ°æŒ‡ä»¤ï¼Œé€šè¿‡ mio æ¥å¤„ç† IO&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ° Storage æœ€åå¯åŠ¨äº†è°ƒåº¦å™¨ï¼Œç„¶åä¸æ–­çš„æ¥å—å®¢æˆ·ç«¯æŒ‡ä»¤ï¼Œç„¶ååœ¨ä¼ ç»™ scheduler, ç„¶åè°ƒåº¦å™¨æ‰§è¡Œç›¸åº”çš„è¿‡ç¨‹æˆ–è€…è°ƒç”¨ç›¸åº”çš„å¼‚æ­¥å‡½æ•°ã€‚åœ¨è°ƒåº¦å™¨ä¸­æœ‰ä¸¤ç§æ“ä½œç±»å‹ï¼Œè¯»å’Œå†™ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;MVCC MVCCReader&lt;/h3&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;pub struct MVCCReader {&#xA; ....&#xA;}&#xA;&#xA;impl MVCCReader{&#xA;    pub fn new() {...};&#xA;    pub fn get_statistics(&amp;amp;self) -&amp;gt; &amp;amp;Statistics {...}&#xA;    pub fn set_key_only(&amp;amp;mut self, key_only: bool) {...}&#xA;    pub fn load_data(&amp;amp;mut self, key: &amp;amp;Key, ts: u64) -&amp;gt; Result&amp;lt;Value&amp;gt; {...}&#xA;    pub fn load_lock(&amp;amp;mut self, key: &amp;amp;Key) -&amp;gt; Result&amp;lt;Option&amp;lt;Lock&amp;gt;&amp;gt; {...}&#xA;    pub fn get(&amp;amp;mut self, key: &amp;amp;Key, mut ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;Value&amp;gt;&amp;gt; {...}&#xA;    pub fn get_txn_commit_info(&#xA;        &amp;amp;mut self,&#xA;        key: &amp;amp;Key,&#xA;        start_ts: u64,&#xA;    ) -&amp;gt; Result&amp;lt;Option&amp;lt;(u64, WriteType)&amp;gt;&amp;gt; {...}&#xA;    pub fn seek_ts(&amp;amp;mut self, ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;Key&amp;gt;&amp;gt; {...}&#xA;    pub fn seek(&amp;amp;mut self, mut key: Key, ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;(Key, Value)&amp;gt;&amp;gt; {...}&#xA;    pub fn reverse_seek(&amp;amp;mut self, mut key: Key, ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;(Key, Value)&amp;gt;&amp;gt; {...}&#xA;    ...&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;çœ‹ MVCCReader ç»“æ„å¾ˆå®¹æ˜“ç†è§£ï¼Œå„ç§è¯»çš„æ“ä½œã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;MVCCTxn&lt;/h3&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;pub struct MVCCTxn {&#xA;    reader: MVCCReader,&#xA;    start_ts: u64,&#xA;    writes: Vec&amp;lt;Modify&amp;gt;,&#xA;    write_size: usize,&#xA;}&#xA;impl MVCCTxn {&#xA;    pub fn prewrite(&#xA;        &amp;amp;mut self,&#xA;        mutation: Mutation,&#xA;        primary: &amp;amp;[u8],&#xA;        options: &amp;amp;Options,&#xA;    ) -&amp;gt; Result&amp;lt;()&amp;gt; {...}&#xA;&#xA;    pub fn commit(&amp;amp;mut self, key: &amp;amp;Key, commit_ts: u64) -&amp;gt; Result&amp;lt;()&amp;gt; {...}&#xA;    pub fn rollback(&amp;amp;mut self, key: &amp;amp;Key) -&amp;gt; Result&amp;lt;()&amp;gt; {...}&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;MVCCTxn å®ç°äº†ä¸¤æ®µæäº¤ï¼ˆ2-Phase Commitï¼Œ2PCï¼‰ï¼Œæ•´ä¸ª TiKV äº‹åŠ¡æ¨¡å‹çš„æ ¸å¿ƒã€‚åœ¨ä¸€æ®µäº‹åŠ¡ä¸­ï¼Œç”±ä¸¤ä¸ªé˜¶æ®µç»„æˆã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Prewrite&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;é€‰æ‹©ä¸€ä¸ª row ä½œä¸º primary rowï¼Œ ä½™ä¸‹çš„ä½œä¸º secondary rowã€‚ å¯¹primary row ä¸Šé”. åœ¨ä¸Šé”ä¹‹å‰ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–åŒæ­¥çš„é”å·²ç»ä¸Šåˆ°äº†è¿™ä¸ª row ä¸Š æˆ–è€…æ˜¯æ˜¯å¦ç»æœ‰åœ¨ startTS ä¹‹åçš„æäº¤æ“ä½œã€‚è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´å†²çªï¼Œä¸€æ—¦éƒ½å†²çªå‘ç”Ÿï¼Œå°±ä¼šå›æ»šï¼ˆrollbackï¼‰ã€‚ å¯¹äº secondary row é‡å¤ä»¥ä¸Šæ“ä½œã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Commit&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;Rollback åœ¨Prewrite è¿‡ç¨‹ä¸­å‡ºç°å†²çªçš„è¯å°±ä¼šè¢«è°ƒç”¨ã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Garbage Collector&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å¾ˆå®¹æ˜“å‘ç°ï¼Œå¦‚æœæ²¡æœ‰åƒåœ¾æ”¶é›†å™¨ï¼ˆGabage Collectorï¼‰ æ¥ç§»é™¤æ— æ•ˆçš„ç‰ˆæœ¬çš„è¯ï¼Œæ•°æ®åº“ä¸­å°±ä¼šå­˜æœ‰è¶Šæ¥è¶Šå¤šçš„ MVCC ç‰ˆæœ¬ã€‚ä½†æ˜¯æˆ‘ä»¬åˆä¸èƒ½ä»…ä»…ç§»é™¤æŸä¸ª safe point ä¹‹å‰çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚å› ä¸ºå¯¹äºæŸä¸ª key æ¥è¯´ï¼Œæœ‰å¯èƒ½åªå­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬ï¼Œé‚£ä¹ˆè¿™ä¸ªç‰ˆæœ¬å°±å¿…é¡»è¢«ä¿å­˜ä¸‹æ¥ã€‚åœ¨TiKVä¸­ï¼Œå¦‚æœåœ¨ safe point å‰å­˜åœ¨Put æˆ–è€…Deleteï¼Œé‚£ä¹ˆè¯´æ˜ä¹‹åæ‰€æœ‰çš„ writes éƒ½æ˜¯å¯ä»¥è¢«ç§»é™¤çš„ï¼Œä¸ç„¶çš„è¯åªæœ‰Deleteï¼ŒRollbackå’ŒLock ä¼šè¢«åˆ é™¤ã€‚&lt;/p&gt;&#xA;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ­¤å¤„éƒ¨åˆ† copy è‡ª&lt;a href=&#34;https://pingcap.com/blog-cn/MVCC-in-TiKV/&#34;&gt;TiKV çš„ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰æœºåˆ¶&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Two-phase_locking&#34;&gt;Two-phase locking&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.zhihu.com/question/60278698&#34;&gt;OCCå’ŒMVCCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tidb-internal-1/&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´å­˜å‚¨&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/MVCC-in-TiKV/&#34;&gt;TiKV çš„ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰æœºåˆ¶&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/MVCC In TiKV.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>Spanner è®ºæ–‡ç¬”è®°</title>
    <updated>2017-11-05T00:00:00Z</updated>
    <id>tag:int64.me,2017-11-05:/2017/Spanner è®ºæ–‡ç¬”è®°.html</id>
    <content type="html">&lt;p&gt;åˆšåˆ°å…¬å¸çš„æ—¶å€™ï¼Œè®°å¾—å¥‡å“¥å°±æ¨èäº†å‡ ç¯‡åŸºç¡€è®ºæ–‡ï¼ˆå°´å°¬ï¼Œç›®å‰æˆ‘è¿˜æ²¡æœ‰å®Œå…¨çœ‹å®Œï¼‰ï¼ŒSpanner è®ºæ–‡å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼ŒåŒæ—¶ TiKV çš„è®¾è®¡æ¶æ„ä¹Ÿæ˜¯å—åˆ°äº† Spanner çš„å¯å‘ï¼Œåœ¨é˜…è¯» Spanner è®ºæ–‡çš„åŒæ—¶ï¼Œè®°å½•äº›ä¸œè¥¿ï¼Œæ–¹ä¾¿ä»¥åå›é¡¾å¤ä¹ &amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;ç»“æ„&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;ä¸€å¥— Spanner ç³»ç»Ÿç§°ä¸ºä¸€ä¸ª universe, Spanner è®ºæ–‡ä¸Šè¯´ç›®å‰ google æ€»å…±éƒ¨ç½²äº†ä¸‰å¥—  Spannerï¼Œä¸€ä¸ªå¼€å‘ï¼Œä¸€ä¸ªæµ‹è¯•ï¼Œä¸€ä¸ªçº¿ä¸Šã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-8d4d85a54036697f.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸Šå›¾æ˜¯ Spanner è®ºæ–‡ä¸Šçš„ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹å‡ºSpanner æ˜¯ç”±å¤šä¸ª zone ï¼ˆç®¡ç†éƒ¨ç½²çš„åŸºæœ¬å•å…ƒï¼‰ ç»„æˆï¼Œä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸­å¯ä»¥æœ‰å¤šä¸ª zoneã€‚ ä¸€ä¸ª zone åŒ…å«ä¸€ä¸ª zonemasterå’Œä¸€ç™¾æˆ–è€…å‡ åƒä¸ª spanserverã€‚zonemaster æŠŠæ•°æ®åˆ†é…ç»™ spanserverï¼Œspanserver æŠŠæ•°æ®æä¾›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä½¿ç”¨æ²¡ä¸ª zone ä¸Šçš„ location proxy æ¥å®šä½æä¾›æœåŠ¡çš„ spanserverï¼Œspanerver æä¾›å…·ä½“çš„æœåŠ¡ã€‚ï¼ˆTiDB çš„ PD ä¸ TiKV ä¹‹é—´çš„é…åˆè¿˜çœŸæ˜¯æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™å•Šï¼‰ã€‚Universe master ä¸»è¦æ˜¯ä¸€ä¸ªæ§åˆ¶å°ï¼Œå®ƒæ˜¾ç¤ºäº†å…³äº zone çš„å„ç§çŠ¶æ€ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºç›¸äº’ä¹‹é—´çš„è°ƒè¯•ã€‚Placement driver ä¼šå‘¨æœŸæ€§åœ°ä¸ spanserver è¿›è¡Œäº¤äº’ï¼Œæ¥å‘ç°é‚£äº›éœ€è¦è¢«è½¬ç§»çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯ä¸ºäº†æ»¡è¶³æ–°çš„å‰¯æœ¬çº¦æŸæ¡ä»¶ï¼Œæˆ–è€…æ˜¯ä¸ºäº†è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;spanserver å®ç°&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-b99c0dffe8361eb9.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ª spanserver è´Ÿè½½ç®¡ç† 100 - 1000 ä¸ªç§°ä¸º tablet çš„æ•°æ®ç»“æ„çš„å®ä¾‹ã€‚ä¸€ä¸ª tablet å°±ç±»ä¼¼äº BigTable ä¸­çš„ tabletï¼Œä¹Ÿå®ç°äº†ä¸‹é¢çš„æ˜ å°„: &lt;code&gt;(key:string, timestamp:int64)-&amp;gt;string&lt;/code&gt; ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;spanserver ä¸åŒäº bigtable çš„åœ°æ–¹åœ¨äºï¼Œspanserver å…¶å®æ›´åƒä¸€ä¸ªå®Œæ•´å…³ç³»æ•°æ®åº“ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªçº¯ç²¹çš„é”®å€¼å­˜å‚¨ï¼Œspanserver ä¼šä¸ºæ¯ä¸€ä¸ªæ•°æ®åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ï¼ˆæœ‰ç‚¹ç±»ä¼¼ MVCCï¼‰ï¼Œtablet çš„çŠ¶æ€å­˜å‚¨åœ¨ç±»ä¼¼äº B-æ ‘çš„æ–‡ä»¶é›†åˆä»¥åŠ WALï¼ˆwrite-ahead-log)ä¸­ï¼Œå¹¶ä¸”éƒ½å­˜æ”¾åœ¨ GFS çš„å‡çº§ç‰ˆ Colossus æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šã€‚ï¼ˆæ„Ÿè§‰ç»“æ„æœ‰ç‚¹å¤æ‚å•Šï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘å…ˆäº†è§£äº† TiKV çš„è®¾è®¡ï¼Œæœ‰ç‚¹å…ˆå…¥ä¸ºä¸»äº†ï¼‰ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å†è¯´ tablet çš„ä¸Šå±‚ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ç”¨ Paxos çŠ¶æ€æœºæ¥åšå‰¯æœ¬ç®¡ç†ï¼ˆPaxos ç®—é¥­æ²¡æœ‰ä»”ç»†ç ”ç©¶è¿‡ï¼Œé’¥åŒ™åˆåœ°æ–¹æè¿°çš„æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£ï¼‰ã€‚è®ºæ–‡é‡Œé¢è®²åˆ°ï¼Œç›®å‰æ¯ä¸ª tablet ä¸Šå®ç°äº†ä¸€ä¸ª Paxos çŠ¶æ€æœºï¼Œæ¯æ¬¡å†™æ“ä½œçš„æ—¶å€™éƒ½éœ€è¦å†™ä¸¤ä»½æ•°æ®ï¼Œä¸€ä»½è½åˆ° tablet çš„æ—¥å¿—ä¸­ï¼Œä¸€ä»½æ˜¯å†™å…¥ï¼ŒPaxos çš„æ—¥å¿—ä¸­ï¼Œç›®å‰Paxos çš„ leader å®ç°äº†æ”¯æŒé•¿å¯¿å‘½çš„ leader ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä½¿ç”¨äº†ç§Ÿçº¦çš„æœºåˆ¶ï¼ˆlease TiKV ä¸­ Raft leader ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚å†™æ“ä½œå¿…é¡»åœ¨é¢†å¯¼è€…ä¸Šåˆå§‹åŒ– Paxos åè®®ï¼Œè¯»æ“ä½œå¯ä»¥ç›´æ¥ä»åº•å±‚çš„ä»»ä½•å‰¯æœ¬çš„ tablet ä¸­è®¿é—®çŠ¶æ€ä¿¡æ¯ï¼Œåªè¦è¿™ä¸ªå‰¯æœ¬è¶³å¤Ÿæ–°ã€‚å‰¯æœ¬çš„é›†åˆè¢«ç§°ä¸ºä¸€ä¸ª Paxos groupã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¯¹äºæ¯ä¸ªæ˜¯é¢†å¯¼è€…çš„å‰¯æœ¬è€Œè¨€ï¼Œæ¯ä¸ª spanserver ä¼šå®ç°ä¸€ä¸ªé”è¡¨æ¥å®ç°å¹¶å‘æ§åˆ¶ã€‚è¿™ä¸ªé”è¡¨åŒ…å«äº†ä¸¤é˜¶æ®µé”æœºåˆ¶çš„çŠ¶æ€:å®ƒæŠŠé”®çš„å€¼åŸŸæ˜ å°„åˆ°é”çŠ¶æ€ä¸Šé¢ã€‚æ³¨æ„ï¼Œé‡‡ç”¨ä¸€ä¸ªé•¿å¯¿å‘½çš„ Paxos é¢†å¯¼è€…ï¼Œå¯¹äºæœ‰æ•ˆç®¡ç†é”è¡¨è€Œè¨€æ˜¯éå¸¸å…³é”®çš„ã€‚åœ¨ BigTable å’Œ Spanner ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¸“é—¨ä¸ºé•¿äº‹åŠ¡åšäº†è®¾è®¡ï¼Œæ¯”å¦‚ï¼Œå¯¹äºæŠ¥è¡¨æ“ä½œï¼Œå¯èƒ½è¦æŒç»­å‡ åˆ†é’Ÿï¼Œå½“å­˜åœ¨å†²çªæ—¶ï¼Œé‡‡ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶æœºåˆ¶ä¼šè¡¨ç°å‡ºå¾ˆå·®çš„æ€§èƒ½ã€‚å¯¹äºé‚£äº›éœ€è¦åŒæ­¥çš„æ“ä½œï¼Œæ¯”å¦‚äº‹åŠ¡å‹çš„è¯»æ“ä½œï¼Œéœ€è¦è·å¾—é”è¡¨ä¸­çš„é”ï¼Œè€Œå…¶ä»–ç±»å‹çš„æ“ä½œåˆ™å¯ä»¥ä¸ç†ä¼šé”è¡¨ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¯¹äºæ¯ä¸ªæ‰®æ¼”é¢†å¯¼è€…è§’è‰²çš„å‰¯æœ¬ï¼Œæ¯ä¸ª spanserver ä¹Ÿä¼šå®æ–½ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨æ¥æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ã€‚è¿™ä¸ªäº‹åŠ¡ç®¡ç†å™¨è¢«ç”¨æ¥å®ç°ä¸€ä¸ª participant leaderï¼Œè¯¥ç»„å†…çš„å…¶ä»–å‰¯æœ¬åˆ™æ˜¯ä½œä¸º participant slavesã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åªåŒ…å«ä¸€ä¸ª Paxos ç»„(å¯¹äºè®¸å¤šäº‹åŠ¡è€Œè¨€éƒ½æ˜¯å¦‚æ­¤)ï¼Œå®ƒå°±å¯ä»¥ç»•è¿‡äº‹åŠ¡ç®¡ç†å™¨ï¼Œå› ä¸ºé”è¡¨å’Œ Paxos äºŒè€…ä¸€èµ·å¯ä»¥ä¿è¯äº‹åŠ¡æ€§ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åŒ…å«äº†å¤š äºä¸€ä¸ª Paxos ç»„ï¼Œé‚£äº›ç»„çš„é¢†å¯¼è€…ä¹‹é—´ä¼šå½¼æ­¤åè°ƒåˆä½œå®Œæˆä¸¤é˜¶æ®µæäº¤ã€‚å…¶ä¸­ä¸€ä¸ªå‚ä¸è€…ç»„ï¼Œä¼šè¢«é€‰ä¸ºåè°ƒè€…ï¼Œè¯¥ç»„çš„ participant leader è¢«ç§°ä¸º coordinator leaderï¼Œè¯¥ç»„çš„ participant slaves è¢«ç§°ä¸º coordinator slavesã€‚æ¯ä¸ªäº‹åŠ¡ç®¡ç†å™¨çš„çŠ¶æ€ï¼Œä¼šè¢«ä¿å­˜åˆ°åº•å±‚çš„ Paxos ç»„ã€‚ç›®å‰ TiKV çš„äº‹åŠ¡å¥½åƒéƒ½èµ°çš„æ˜¯ä¸¤é˜¶æ®µæäº¤ï¼Œä¸çŸ¥åˆ°è¦æ˜¯ä¹Ÿæä¸ªäº‹åŠ¡ç®¡ç†å™¨æ•ˆæœä¼šå¦‚ä½•ï¼Ÿ&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;dictionary&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Spanner å¯¹å…·æœ‰å…¬å…±å‰ç¼€çš„é”®åšäº†ä¸€ä¸ªæŠ½è±¡ï¼Œç§°ä¸º dictionaryã€‚ç›®å‰ä¸€ä¸ª dictionary æ˜¯æ•°æ®å­˜æ”¾çš„åŸºæœ¬å•ä½ã€‚ã€‚å±äºä¸€ä¸ªç›®å½•çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½å…·æœ‰ç›¸åŒçš„å‰¯æœ¬é…ç½®ã€‚ å½“æ•°æ®åœ¨ä¸åŒçš„ Paxos ç»„ä¹‹é—´è¿›è¡Œç§»åŠ¨æ—¶ï¼Œä¼šä¸€ä¸ªç›®å½•ä¸€ä¸ªç›®å½•åœ°è½¬ç§»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚Spanner å¯èƒ½ä¼šç§»åŠ¨ä¸€ä¸ªç›®å½•ä»è€Œå‡è½»ä¸€ä¸ª Paxos ç»„çš„è´Ÿæ‹…ï¼Œä¹Ÿå¯èƒ½ä¼šæŠŠé‚£äº›è¢«é¢‘ç¹åœ°ä¸€èµ·è®¿é—®çš„ç›®å½•éƒ½æ”¾ç½®åˆ°åŒä¸€ä¸ªç»„ä¸­ï¼Œæˆ–è€…ä¼šæŠŠä¸€ä¸ªç›®å½•è½¬ç§»åˆ°è·ç¦»è®¿é—®è€…æ›´è¿‘çš„åœ°æ–¹ã€‚å½“å®¢æˆ·ç«¯æ“ä½œæ­£åœ¨è¿›è¡Œæ—¶ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç›®å½•çš„è½¬ç§»ã€‚æˆ‘ä»¬å¯ä»¥é¢„æœŸåœ¨å‡ ç§’å†…è½¬ç§» 50MB çš„ç›®å½•ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;dictionary æ˜¯æ•°æ®å¤åˆ¶å’Œplacementé…ç½®çš„åŸºæœ¬å•ä½ã€‚spannerä¸­è´Ÿè½½å‡è¡¡çš„æœ€å°å•ä½ä¹Ÿæ˜¯dictionaryï¼ŒåŒæ—¶æä¾›æ–¹æ³•MoveDirå¯ä»¥æ‰‹åŠ¨å°†ä¸€ä¸ªdictionaryç§»åŠ¨åˆ°æŒ‡å®šçš„zone&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-192ba58099b34f11.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;æ•°æ®æ¨¡å‹&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;spannerçš„è¡Œæ¨¡å‹æ˜¯ &lt;code&gt;(key:string, timestamp:int64) -&amp;gt; row content&lt;/code&gt;ï¼Œå¯ä»¥çœ‹åˆ°è·Ÿbig tableçš„æ¨¡å‹æœ€å¤§çš„ä¸åŒæ˜¯è¿™é‡Œå¼ºåŒ–äº†rowçš„æ¦‚å¿µï¼Œä¸å†çªå‡ºcolumnï¼›è¿™æ ·spannerçš„timestampæ˜¯èµ‹ç»™æ•´è¡Œæ•°æ®çš„ï¼Œæ˜¯æœ‰ç‰©ç†æ„ä¹‰çš„ï¼Œè¿™ä½¿å¾—spanneræ›´åƒä¸€ä¸ªå®ç°å¤šç‰ˆæœ¬å¹¶å‘çš„æ•°æ®åº“ï¼Œè€Œåœ¨big tableä¸­ï¼Œtimestampä»…ä»…ç”¨äºä¿å­˜å¤šä¸ªç‰ˆæœ¬çš„key-valueï¼Œè·Ÿå¹¶å‘å®Œå…¨æ— å…³ï¼›æˆ‘è§‰å¾—è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆspannerç§°è‡ªå·±ä¸ºsemi-relational æ•°æ®åº“ï¼Œè€Œbig tableåªç§°è‡ªå·±æ˜¯semi-structure æ•°æ®åº“çš„åŸå› ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-c784a00321761682.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Spanner çš„æ•°æ®æ¨¡å‹ä¸æ˜¯çº¯ç²¹å…³ç³»å‹çš„ï¼Œå®ƒçš„è¡Œå¿…é¡»æœ‰åç§°ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œæ¯ä¸ªè¡¨éƒ½éœ€ è¦æœ‰åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é”®åˆ—çš„æ’åºé›†åˆã€‚è¿™ç§éœ€æ±‚ï¼Œè®© Spanner çœ‹èµ·æ¥ä»ç„¶æœ‰ç‚¹åƒé”®å€¼å­˜å‚¨: ä¸»é”®å½¢æˆäº†ä¸€ä¸ªè¡Œçš„åç§°ï¼Œæ¯ä¸ªè¡¨éƒ½å®šä¹‰äº†ä»ä¸»é”®åˆ—åˆ°éä¸»é”®åˆ—çš„æ˜ å°„ã€‚å½“ä¸€ä¸ªè¡Œå­˜åœ¨æ—¶ï¼Œå¿…é¡»è¦æ±‚å·²ç»ç»™è¡Œçš„ä¸€äº›é”®å®šä¹‰äº†ä¸€äº›å€¼(å³ä½¿æ˜¯ NULL)ã€‚é‡‡ç”¨è¿™ç§ç»“æ„æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºè¿™å¯ä»¥è®©åº”ç”¨é€šè¿‡é€‰æ‹©é”®æ¥æ§åˆ¶æ•°æ®çš„å±€éƒ¨æ€§ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;TrueTime API&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-d1557f77c3323255.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;rueTime API æ˜¯ä¸€ä¸ªéå¸¸æœ‰åˆ›æ„çš„ä¸œè¥¿ï¼Œå¯ä»¥åŒæ­¥å…¨çƒçš„æ—¶é—´ã€‚TT.now()å¯ä»¥è·å¾—ä¸€ä¸ªç»å¯¹æ—¶é—´TTintervalï¼Œè¿™ä¸ªå€¼å’ŒUnixTimeæ˜¯ç›¸åŒçš„ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªè¯¯å·®eã€‚TT.after(t)å’ŒTT.before(t)æ˜¯åŸºäºTT.now()å®ç°çš„ã€‚é‚£è¿™ä¸ªTrueTime APIå®ç°é çš„æ˜¯GFSå’ŒåŸå­é’Ÿã€‚ä¹‹æ‰€ä»¥è¦ç”¨ä¸¤ç§æŠ€æœ¯æ¥å¤„ç†ï¼Œæ˜¯å› ä¸ºå¯¼è‡´è¿™ä¸¤ä¸ªæŠ€æœ¯çš„å¤±è´¥çš„åŸå› æ˜¯ä¸åŒçš„ã€‚GPSä¼šæœ‰ä¸€ä¸ªå¤©çº¿ï¼Œç”µæ³¢å¹²æ‰°ä¼šå¯¼è‡´å…¶å¤±çµã€‚åŸå­é’Ÿå¾ˆç¨³å®šã€‚å½“GPSå¤±çµçš„æ—¶å€™ï¼ŒåŸå­é’Ÿä»ç„¶èƒ½ä¿è¯åœ¨ç›¸å½“é•¿çš„æ—¶é—´å†…ï¼Œä¸ä¼šå‡ºç°åå·®ã€‚å®é™…éƒ¨ç½²çš„æ—¶å€™ã€‚æ¯ä¸ªæ•°æ®ä¸­å¿ƒéœ€è¦éƒ¨ç½²ä¸€äº›Masteræœºå™¨ï¼Œå…¶ä»–æœºå™¨ä¸Šéœ€è¦æœ‰ä¸€ä¸ªslaveè¿›ç¨‹æ¥ä»MasteråŒæ­¥ã€‚æœ‰çš„Masterç”¨GPSï¼Œæœ‰çš„Masterç”¨åŸå­é’Ÿã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å¹¶å‘æ§åˆ¶&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;Spannerä½¿ç”¨TrueTimeæ¥æ§åˆ¶å¹¶å‘ï¼Œå®ç°å¤–éƒ¨ä¸€è‡´æ€§ã€‚æ”¯æŒä»¥ä¸‹å‡ ç§äº‹åŠ¡ã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è¯»å†™äº‹åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;åªè¯»äº‹åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;å¿«ç…§è¯»ï¼Œå®¢æˆ·ç«¯æä¾›æ—¶é—´æˆ³&lt;/li&gt;&#xA;&lt;li&gt;å¿«ç…§è¯»ï¼Œå®¢æˆ·ç«¯æä¾›æ—¶é—´èŒƒå›´&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-91fa02b85deaedff.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸Šè¡¨æ˜¯Spannerç°åœ¨æ”¯æŒçš„äº‹åŠ¡ã€‚å•ç‹¬çš„å†™æ“ä½œéƒ½è¢«å®ç°ä¸ºè¯»å†™äº‹åŠ¡ ï¼› å•ç‹¬çš„éå¿«ç…§è¢«å®ç°ä¸ºåªè¯»äº‹åŠ¡ã€‚äº‹åŠ¡æ€»æœ‰å¤±è´¥çš„æ—¶å€™ï¼Œå¦‚æœå¤±è´¥ï¼Œå¯¹äºè¿™ä¸¤ç§æ“ä½œä¼šè‡ªå·±é‡è¯•ï¼Œæ— éœ€åº”ç”¨è‡ªå·±å®ç°é‡è¯•å¾ªç¯ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æ—¶é—´æˆ³çš„è®¾è®¡å¤§å¤§æé«˜äº†åªè¯»äº‹åŠ¡çš„æ€§èƒ½ã€‚äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œè¦å£°æ˜è¿™ä¸ªäº‹åŠ¡é‡Œæ²¡æœ‰å†™æ“ä½œï¼Œåªè¯»äº‹åŠ¡å¯ä¸æ˜¯ä¸€ä¸ªç®€å•çš„æ²¡æœ‰å†™æ“ä½œçš„è¯»å†™äº‹åŠ¡ã€‚å®ƒä¼šç”¨ä¸€ä¸ªç³»ç»Ÿæ—¶é—´æˆ³å»è¯»ï¼Œæ‰€ä»¥å¯¹äºåŒæ—¶çš„å…¶ä»–çš„å†™æ“ä½œæ˜¯æ²¡æœ‰Blockçš„ã€‚è€Œä¸”åªè¯»äº‹åŠ¡å¯ä»¥åœ¨ä»»æ„ä¸€å°å·²ç»æ›´æ–°è¿‡çš„replicaä¸Šé¢è¯»ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¯¹äºå¿«ç…§è¯»æ“ä½œï¼Œå¯ä»¥è¯»å–ä»¥å‰çš„æ•°æ®ï¼Œéœ€è¦å®¢æˆ·ç«¯æŒ‡å®šä¸€ä¸ªæ—¶é—´æˆ³æˆ–è€…ä¸€ä¸ªæ—¶é—´èŒƒå›´ã€‚Spannerä¼šæ‰¾åˆ°ä¸€ä¸ªå·²ç»å……åˆ†æ›´æ–°å¥½çš„replicaä¸Šè¯»å–ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;è¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§çš„æ˜¯ï¼Œå¯¹äºåªè¯»äº‹åŠ¡ï¼Œå¦‚æœæ‰§è¡Œåˆ°ä¸€åŠï¼Œè¯¥replicaå‡ºç°äº†é”™è¯¯ã€‚å®¢æˆ·ç«¯æ²¡æœ‰å¿…è¦åœ¨æœ¬åœ°ç¼“å­˜åˆšåˆšè¯»è¿‡çš„æ—¶é—´ï¼Œå› ä¸ºæ˜¯æ ¹æ®æ—¶é—´æˆ³è¯»å–çš„ã€‚åªè¦å†ç”¨åˆšåˆšçš„æ—¶é—´æˆ³è¯»å–ï¼Œå°±å¯ä»¥è·å¾—ä¸€æ ·çš„ç»“æœã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;Paxos é¢†å¯¼è€…ç§Ÿçº¦&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;Spanner çš„ Paxos å®ç°ä¸­ä½¿ç”¨äº†æ—¶é—´åŒ–çš„ç§Ÿçº¦ï¼Œæ¥å®ç°é•¿æ—¶é—´çš„é¢†å¯¼è€…åœ°ä½(é»˜è®¤æ˜¯ 10ç§’)ã€‚ä¸€ä¸ªæ½œåœ¨çš„é¢†å¯¼è€…ä¼šå‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚æ—¶é—´åŒ–çš„ç§Ÿçº¦æŠ•ç¥¨ï¼Œåœ¨æ”¶åˆ°æŒ‡å®šæ•°é‡çš„æŠ•ç¥¨åï¼Œè¿™ä¸ªé¢†å¯¼è€…å°±å¯ä»¥ç¡®å®šè‡ªå·±æ‹¥æœ‰äº†ä¸€ä¸ªç§Ÿçº¦ã€‚ä¸€ä¸ªå‰¯æœ¬åœ¨æˆåŠŸå®Œæˆä¸€ä¸ªå†™æ“ä½œåï¼Œä¼šéšå¼åœ°å»¶æœŸè‡ªå·±çš„ç§Ÿçº¦ã€‚å¯¹äºä¸€ä¸ªé¢†å¯¼è€…è€Œè¨€ï¼Œå¦‚æœå®ƒçš„ç§Ÿçº¦å¿«è¦åˆ°æœŸäº†ï¼Œå°±è¦æ˜¾ç¤ºåœ°è¯·æ±‚ç§Ÿçº¦å»¶æœŸã€‚å¦ä¸€ä¸ªé¢†å¯¼è€…çš„ç§Ÿçº¦æœ‰ä¸ªæ—¶é—´åŒºé—´ï¼Œè¿™ä¸ªæ—¶é—´åŒºé—´çš„èµ·ç‚¹å°±æ˜¯è¿™ä¸ªé¢†å¯¼è€…è·å¾—æŒ‡å®šæ•°é‡çš„æŠ•ç¥¨é‚£ä¸€åˆ»ï¼Œæ—¶é—´åŒºé—´çš„ç»ˆç‚¹å°±æ˜¯è¿™ä¸ªé¢†å¯¼è€…å¤±å»æŒ‡å®šæ•°é‡çš„æŠ•ç¥¨çš„é‚£ä¸€åˆ»(å› ä¸ºæœ‰äº›æŠ•ç¥¨å·²ç»è¿‡æœŸäº†)ã€‚Spanner ä¾èµ–äºä¸‹é¢è¿™äº›â€œä¸è¿è´¯æ€§â€:å¯¹äºæ¯ä¸ª Paxos ç»„ï¼Œæ¯ä¸ª Paxos é¢† å¯¼è€…çš„ç§Ÿçº¦æ—¶é—´åŒºé—´ï¼Œæ˜¯å’Œå…¶ä»–é¢†å¯¼è€…çš„æ—¶é—´åŒºé—´å®Œå…¨éš”ç¦»çš„ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Spanner å®ç°å…è®¸ä¸€ä¸ª Paxos é¢†å¯¼è€…é€šè¿‡æŠŠ slave ä»ç§Ÿçº¦æŠ•ç¥¨ä¸­é‡Šæ”¾å‡ºæ¥è¿™ç§æ–¹å¼ï¼Œå®ç°é¢†å¯¼è€…çš„é€€ä½ã€‚ä¸ºäº†ä¿æŒè¿™ç§å½¼æ­¤éš”ç¦»çš„ä¸è¿è´¯æ€§ï¼ŒSpanner ä¼šå¯¹ä»€ä¹ˆæ—¶å€™é€€ä½åšå‡ºé™åˆ¶ã€‚æŠŠ smax å®šä¹‰ä¸ºä¸€ä¸ªé¢†å¯¼è€…å¯ä»¥ä½¿ç”¨çš„æœ€å¤§çš„æ—¶é—´æˆ³ã€‚åœ¨é€€ä½ä¹‹å‰ï¼Œä¸€ä¸ªé¢†å¯¼è€…å¿…é¡»ç­‰åˆ° TT.after(smax)æ˜¯çœŸã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;ä¸ºè¯»å†™äº‹åŠ¡åˆ†é…æ—¶é—´æˆ³&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;äº‹åŠ¡è¯»å’Œå†™é‡‡ç”¨ä¸¤æ®µé”åè®®ã€‚å½“æ‰€æœ‰çš„é”éƒ½å·²ç»è·å¾—ä»¥åï¼Œåœ¨ä»»ä½•é”è¢«é‡Šæ”¾ä¹‹å‰ï¼Œå°±å¯ä»¥ç»™äº‹åŠ¡åˆ†é…æ—¶é—´æˆ³ã€‚å¯¹äºä¸€ä¸ªç»™å®šçš„äº‹åŠ¡ï¼ŒSpanner ä¼šä¸ºäº‹åŠ¡åˆ†é…æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³æ˜¯ Paxos åˆ†é…ç»™ Paxos å†™æ“ä½œçš„ï¼Œå®ƒä»£è¡¨äº†äº‹åŠ¡æäº¤çš„æ—¶é—´ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Spanner ä¾èµ–ä¸‹é¢è¿™äº›å•è°ƒæ€§:åœ¨æ¯ä¸ª Paxos ç»„å†…ï¼ŒSpanner ä¼šä»¥å•è°ƒå¢åŠ çš„é¡ºåºç»™æ¯ä¸ª Paxos å†™æ“ä½œåˆ†é…æ—¶é—´æˆ³ï¼Œå³ä½¿åœ¨è·¨è¶Šå¤šä¸ªé¢†å¯¼è€…æ—¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸€ä¸ªå•ä¸ªçš„é¢†å¯¼è€…å‰¯æœ¬ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°ä»¥å•è°ƒå¢åŠ çš„æ–¹å¼åˆ†é…æ—¶é—´æˆ³ã€‚åœ¨å¤šä¸ªé¢†å¯¼è€…ä¹‹é—´å°±ä¼šå¼ºåˆ¶å®ç°å½¼æ­¤éš”ç¦»çš„ä¸è¿ è´¯:ä¸€ä¸ªé¢†å¯¼è€…å¿…é¡»åªèƒ½åˆ†é…å±äºå®ƒè‡ªå·±ç§Ÿçº¦æ—¶é—´åŒºé—´å†…çš„æ—¶é—´æˆ³ã€‚è¦æ³¨æ„åˆ°ï¼Œä¸€æ—¦ä¸€ä¸ªæ—¶é—´æˆ³ s è¢«åˆ†é…ï¼Œsmax å°±ä¼šè¢«å¢åŠ åˆ° sï¼Œä»è€Œä¿è¯å½¼æ­¤éš”ç¦»æ€§(ä¸è¿è´¯æ€§)ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Spanner ä¹Ÿä¼šå®ç°ä¸‹é¢çš„å¤–éƒ¨ä¸€è‡´æ€§:å¦‚æœä¸€ä¸ªäº‹åŠ¡ T2 åœ¨äº‹åŠ¡ T1 æäº¤ä»¥åå¼€å§‹æ‰§è¡Œï¼Œ é‚£ä¹ˆï¼Œäº‹åŠ¡ T2 çš„æ—¶é—´æˆ³ä¸€å®šæ¯”äº‹åŠ¡ T1 çš„æ—¶é—´æˆ³å¤§ã€‚å¯¹äºä¸€ä¸ªäº‹åŠ¡ Ti è€Œè¨€ï¼Œå®šä¹‰å¼€å§‹å’Œæäº¤äº‹ä»¶eistartå’Œeicommitï¼Œäº‹åŠ¡æäº¤æ—¶é—´ä¸ºsiã€‚å¯¹å¤–éƒ¨ä¸€è‡´æ€§çš„è¦æ±‚å°±å˜æˆäº†:&#xA;tabs(e1commit )&lt;tabs(e2start ) s1&lt;s2ã€‚æ‰§è¡Œäº‹åŠ¡çš„åè®®å’Œåˆ†é…æ—¶é—´æˆ³çš„åè®®ï¼Œéµå®ˆä¸¤æ¡è§„åˆ™ï¼ŒäºŒè€…ä¸€èµ·ä¿è¯å¤–éƒ¨ä¸€è‡´æ€§ã€‚å¯¹äºä¸€ä¸ªå†™æ“ä½œ Ti è€Œè¨€ï¼Œæ‹…ä»»åè°ƒè€…çš„é¢†å¯¼è€…å‘å‡ºçš„æäº¤è¯·æ±‚çš„äº‹ä»¶ä¸ºeiserver ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Start. ä¸ºä¸€ä¸ªäº‹åŠ¡ Ti æ‹…ä»»åè°ƒè€…çš„é¢†å¯¼è€…åˆ†é…ä¸€ä¸ªæäº¤æ—¶é—´æˆ³ siï¼Œä¸ä¼šå°äº TT.now().latest çš„å€¼ï¼ŒTT.now().latestçš„å€¼æ˜¯åœ¨esierveräº‹ä»¶ä¹‹åè®¡ç®—å¾—åˆ°çš„ã€‚è¦æ³¨æ„ï¼Œæ‹…ä»»å‚ä¸è€…çš„é¢†å¯¼è€…ï¼Œ åœ¨è¿™é‡Œä¸èµ·ä½œç”¨ã€‚ç¬¬ 4.2.1 èŠ‚æè¿°äº†è¿™äº›æ‹…ä»»å‚ä¸è€…çš„é¢†å¯¼è€…æ˜¯å¦‚ä½•å‚ä¸ä¸‹ä¸€æ¡è§„åˆ™çš„å®ç°çš„ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Commit Wait. æ‹…ä»»åè°ƒè€…çš„é¢†å¯¼è€…ï¼Œå¿…é¡»ç¡®ä¿å®¢æˆ·ç«¯ä¸èƒ½çœ‹åˆ°ä»»ä½•è¢« Ti æäº¤çš„æ•°æ®ï¼Œç›´åˆ° TT.after(si)ä¸ºçœŸã€‚æäº¤ç­‰å¾…ï¼Œå°±æ˜¯è¦ç¡®ä¿ si ä¼šæ¯” Ti çš„ç»å¯¹æäº¤æ—¶é—´å°ã€‚è¯æ˜å¦‚ä¸‹:&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-fff83c4dbdc512f1.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;è¯»å†™äº‹åŠ¡&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;æ­£å¦‚BigTableä¸€æ ·ï¼ŒSpannerçš„äº‹åŠ¡æ˜¯ä¼šå°†æ‰€æœ‰çš„å†™æ“ä½œå…ˆç¼“å­˜èµ·æ¥ï¼Œåœ¨Commitçš„æ—¶å€™ä¸€æ¬¡æäº¤ã€‚è¿™æ ·çš„è¯ï¼Œå°±è¯»ä¸å‡ºåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å†™çš„æ•°æ®äº†ã€‚ä¸è¿‡è¿™æ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºSpannerçš„æ•°æ®éƒ½æ˜¯æœ‰ç‰ˆæœ¬çš„ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;åœ¨è¯»å†™äº‹åŠ¡ä¸­ä½¿ç”¨wound-waitç®—æ³•æ¥é¿å…æ­»é”ã€‚å½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯»å†™äº‹åŠ¡çš„æ—¶å€™ï¼Œé¦–å…ˆæ˜¯è¯»æ“ä½œï¼Œä»–å…ˆæ‰¾åˆ°ç›¸å…³æ•°æ®çš„leader replicaï¼Œç„¶ååŠ ä¸Šè¯»é”ï¼Œè¯»å–æœ€è¿‘çš„æ•°æ®ã€‚åœ¨å®¢æˆ·ç«¯äº‹åŠ¡å­˜æ´»çš„æ—¶å€™ä¼šä¸æ–­çš„å‘leaderå‘å¿ƒè·³ï¼Œé˜²æ­¢è¶…æ—¶ã€‚å½“å®¢æˆ·ç«¯å®Œæˆäº†æ‰€æœ‰çš„è¯»æ“ä½œï¼Œå¹¶ä¸”ç¼“å­˜äº†æ‰€æœ‰çš„å†™æ“ä½œï¼Œå°±å¼€å§‹äº†ä¸¤é˜¶æ®µæäº¤ã€‚å®¢æˆ·ç«¯é—²ç½®ä¸€ä¸ªcoordinator groupï¼Œå¹¶ç»™æ¯ä¸€ä¸ªleaderå‘é€coordinatorçš„idå’Œç¼“å­˜çš„å†™æ•°æ®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;leaderé¦–å…ˆä¼šä¸Šä¸€ä¸ªå†™é”ï¼Œä»–è¦æ‰¾ä¸€ä¸ªæ¯”ç°æœ‰äº‹åŠ¡æ™šçš„æ—¶é—´æˆ³ã€‚é€šè¿‡Paxosè®°å½•ã€‚æ¯ä¸€ä¸ªç›¸å…³çš„éƒ½è¦ç»™coordinatorå‘é€ä»–è‡ªå·±å‡†å¤‡çš„é‚£ä¸ªæ—¶é—´æˆ³ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;Coordinatorleaderä¸€å¼€å§‹ä¹Ÿä¼šä¸Šä¸ªå†™é”ï¼Œå½“å¤§å®¶å‘é€æ—¶é—´æˆ³ç»™ä»–ä¹‹åï¼Œä»–å°±é€‰æ‹©ä¸€ä¸ªæäº¤æ—¶é—´æˆ³ã€‚è¿™ä¸ªæäº¤çš„æ—¶é—´æˆ³ï¼Œå¿…é¡»æ¯”åˆšåˆšçš„æ‰€æœ‰æ—¶é—´æˆ³æ™šï¼Œè€Œä¸”è¿˜è¦æ¯”TT.now()+è¯¯å·®æ—¶é—´ è¿˜æœ‰æ™šã€‚è¿™ä¸ªCoordinatorå°†è¿™ä¸ªä¿¡æ¯è®°å½•åˆ°Paxosã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;åœ¨è®©replicaå†™å…¥æ•°æ®ç”Ÿæ•ˆä¹‹å‰ï¼Œcoordinatorè¿˜æœ‰å†ç­‰ä¸€ä¼šã€‚éœ€è¦ç­‰ä¸¤å€æ—¶é—´è¯¯å·®ã€‚è¿™æ®µæ—¶é—´ä¹Ÿåˆšå¥½è®©Paxosæ¥åŒæ­¥ã€‚å› ä¸ºç­‰å¾…ä¹‹åï¼Œåœ¨ä»»æ„æœºå™¨ä¸Šå‘èµ·çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„å¼€å§‹æ—¶é—´ï¼Œéƒ½æ¯”å¦‚ä¸ä¼šæ¯”è¿™ä¸ªäº‹åŠ¡çš„ç»“æŸæ—¶é—´æ—©äº†ã€‚ç„¶åcoordinatorå°†æäº¤æ—¶é—´æˆ³å‘é€ç»™å®¢æˆ·ç«¯è¿˜æœ‰å…¶ä»–çš„replicaã€‚ä»–ä»¬è®°å½•æ—¥å¿—ï¼Œå†™å…¥ç”Ÿæ•ˆï¼Œé‡Šæ”¾é”ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;åªè¯»äº‹åŠ¡&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;å¯¹äºåªè¯»äº‹åŠ¡ï¼ŒSpanneré¦–å…ˆè¦æŒ‡å®šä¸€ä¸ªè¯»äº‹åŠ¡æ—¶é—´æˆ³ã€‚è¿˜éœ€è¦äº†è§£åœ¨è¿™ä¸ªè¯»æ“ä½œä¸­ï¼Œéœ€è¦è®¿é—®çš„æ‰€æœ‰çš„è¯»çš„Keyã€‚Spannerå¯ä»¥è‡ªåŠ¨ç¡®å®šKeyçš„èŒƒå›´ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœKeyçš„èŒƒå›´åœ¨ä¸€ä¸ªPaxos groupå†…ã€‚å®¢æˆ·ç«¯å¯ä»¥å‘èµ·ä¸€ä¸ªåªè¯»è¯·æ±‚ç»™group leaderã€‚leaderé€‰ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³è¦æ¯”ä¸Šä¸€ä¸ªäº‹åŠ¡çš„ç»“æŸæ—¶é—´è¦å¤§ã€‚ç„¶åè¯»å–ç›¸åº”çš„æ•°æ®ã€‚è¿™ä¸ªäº‹åŠ¡å¯ä»¥æ»¡è¶³å¤–éƒ¨ä¸€è‡´æ€§ï¼Œè¯»å‡ºçš„ç»“æœæ˜¯æœ€åä¸€æ¬¡å†™çš„ç»“æœï¼Œå¹¶ä¸”ä¸ä¼šæœ‰ä¸ä¸€è‡´çš„æ•°æ®ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœKeyçš„èŒƒå›´åœ¨å¤šä¸ªPaxos groupå†…ï¼Œå°±ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ä¾‹å­æ˜¯ï¼Œå¯ä»¥éå†æ‰€æœ‰çš„group leadersï¼Œå¯»æ‰¾æœ€è¿‘çš„äº‹åŠ¡å‘ç”Ÿçš„æ—¶é—´ï¼Œå¹¶è¯»å–ã€‚å®¢æˆ·ç«¯åªè¦æ—¶é—´æˆ³åœ¨TT.now().latestä¹‹åå°±å¯ä»¥æ»¡è¶³è¦æ±‚äº†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/spanner-osdi2012.pdf&#34;&gt;Spanner: Googleâ€™s Globally-Distributed Database&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://linbingdong.com/2017/02/10/%E5%85%A8%E7%90%83%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9AGoogle%20Spanner%EF%BC%88%E8%AE%BA%E6%96%87%E7%BF%BB%E8%AF%91%EF%BC%89/&#34;&gt;spnner è®ºæ–‡ä¸­æ–‡ç‰ˆ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.voidcn.com/article/p-wxiysjtf-ho.html&#34;&gt;spannerä¸bigtable&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://blog.jobbole.com/28096/&#34;&gt;Googleå…¨çƒçº§åˆ†å¸ƒå¼æ•°æ®åº“SpanneråŸç†&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/Spanner è®ºæ–‡ç¬”è®°.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>Leader Transfer In TiKV</title>
    <updated>2017-10-28T00:00:00Z</updated>
    <id>tag:int64.me,2017-10-28:/2017/Leader Transfer In TiKV.html</id>
    <content type="html">&lt;p&gt;åœ¨ TiKV ä¸­ï¼ŒPD å½“å‘ç° TiKV å®ä¾‹ä¸Š region å‡ºç° leader ä¸å‡åŒ€çš„æ—¶å€™ï¼Œä¼šå°è¯•å°† leader ä»æ•°é‡æ¯”è¾ƒå¤šçš„åœ°æ–¹ transfer åˆ°å…¶åœ°æ–¹ï¼Œå…·ä½“è°ƒåº¦æŒ‡ä»¤ç”± PD å‘å‡ºï¼ŒTiKV æ¥æ”¶åˆ° PD çš„ transfer leader æŒ‡ä»¤ï¼Œè°ƒç”¨ raft æ“ä½œæ‰§è¡ŒçœŸæ­£æ“ä½œ&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å…ˆçœ‹ PD&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;PDï¼ˆPlacement Driverï¼‰åœ¨ TiDB é›†ç¾¤é‡Œé¢ä¸»è¦è´Ÿè´£ meta ä¿¡æ¯å­˜å‚¨ï¼Œä»¥åŠç®¡ç†å’Œè°ƒåº¦ TiKV é›†ç¾¤ï¼Œ æ‰€æœ‰å¯ä»¥æƒ³è±¡ Transfer Leader çš„å‘½ä»¤æ˜¾ç„¶æ˜¯æœ‰ PD å‘é€åˆ° TiKVã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;PD ç»™ TiKV å‘é€ Transfer Leader å‘½ä»¤ï¼Œå¯ä»¥åˆ†ä¸ºä¸€ä¸‹ä¸¤ç±»&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;äººä¸ºå¹²é¢„è°ƒåº¦&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;PD æä¾› pd-ctl å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ–æ˜¯é€šè¿‡ api æ¥å£æ˜¾ç¤ºçš„å°†ä¸€ä¸ª region çš„ leader è°ƒåº¦åˆ°æŸä¸€ä¸ª store ä¸Šã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;&amp;gt;&amp;gt; operator add transfer-leader 1 2         // æŠŠ region 1 çš„ leader è°ƒåº¦åˆ° store 2&#xA;&amp;gt;&amp;gt; operator add transfer-region 1 2 3 4     // æŠŠ region 1 è°ƒåº¦åˆ° store 2,3,4&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;pd-ctl å®é™…ä¸Šä¹Ÿæ˜¯è¯·æ±‚ PD çš„apiï¼Œå…·ä½“è¯·æ±‚è¿‡ç¨‹ç•¥ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ PD çš„æºç ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;// pd/server/coordinator.go&#xA;func (c *coordinator) sendScheduleCommand(region *core.RegionInfo, step schedule.OperatorStep) {&#xA;        log.Infof(&amp;quot;[region %v] send schedule command: %s&amp;quot;, region.GetId(), step)&#xA;        switch s := step.(type) {&#xA;        case schedule.TransferLeader:&#xA;                cmd := &amp;amp;pdpb.RegionHeartbeatResponse{&#xA;                        TransferLeader: &amp;amp;pdpb.TransferLeader{&#xA;                                Peer: region.GetStorePeer(s.ToStore),&#xA;                        },&#xA;                }&#xA;        .....&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;ä»ä¸Šè¾¹ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå…¶å® PD çš„è°ƒåº¦å‘½ä»¤æ˜¯é€šè¿‡ heartbeat æ¥è¿›è¡Œä¼ é€’çš„ï¼ŒPD å’Œ TiKV ä¹‹é—´æ˜¯é€šè¿‡ grpc é€šä¿¡ï¼Œå½“æ”¶åˆ°åˆ°è¿™ä¸ªæ“ä½œæŒ‡ä»¤çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨ grpc çš„send æ–¹æ³•ï¼Œå°†è¯·æ±‚å‘é€ç»™ TiKVã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Leader åˆ†å¸ƒä¸å‡åŒ€æˆ–æ˜¯çƒ­ç‚¹è¿‡äºé›†ä¸­ï¼ŒPD è‡ªèº«è°ƒåº¦&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;PD çš„ä¸»è¦ä½œç”¨å°±æ˜¯è´Ÿè´£ç®¡ç†å’Œè°ƒåº¦ TiKVï¼Œ å¦‚æœ TiKV å„ä¸ªèŠ‚ç‚¹ä¸Šå‡ºç°äº† leader åˆ†å¸ƒè¡¥å‡åŒ€æˆ–æ˜¯çƒ­ç‚¹ leader è¿‡äºé›†ä¸­åœ¨æŸä¸€ä¸ª TiKV èŠ‚ç‚¹ä¸Šçš„æ—¶å€™ï¼Œè¿™æ—¶å€™ PD å°±ä¼šä½œå‡ºå¹²é¢„ï¼Œè¿›è¡Œ transfer leader ç­‰æ“ä½œã€‚PD æ˜¯æ ¹æ®æ¯ä¸ª store æˆ–æ˜¯ leader peer å‘é€è¿‡æ¥çš„å¿ƒè·³åŒ…ï¼Œæ¥ä½œç»Ÿè®¡å¹¶å†³å®šæ‰§è¡Œå“ªäº›æ“ä½œï¼Œæ¯æ¬¡æ”¶åˆ° Region Leader å‘æ¥çš„å¿ƒè·³åŒ…æ—¶ï¼ŒPD éƒ½ä¼šæ£€æŸ¥æ˜¯å¦æœ‰å¯¹è¿™ä¸ª Region å¾…è¿›è¡Œçš„æ“ä½œï¼Œé€šè¿‡å¿ƒè·³åŒ…çš„å›å¤æ¶ˆæ¯ï¼Œå°†éœ€è¦è¿›è¡Œçš„æ“ä½œè¿”å›ç»™ Region Leaderï¼Œå¹¶åœ¨åé¢çš„å¿ƒè·³åŒ…ä¸­ç›‘æµ‹æ‰§è¡Œç»“æœã€‚æ³¨æ„è¿™é‡Œçš„æ“ä½œåªæ˜¯ç»™ Region Leader çš„å»ºè®®ï¼Œå¹¶ä¸ä¿è¯ä¸€å®šèƒ½å¾—åˆ°æ‰§è¡Œï¼Œå…·ä½“æ˜¯å¦ä¼šæ‰§è¡Œä»¥åŠä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œç”± Region Leader è‡ªå·±æ ¹æ®å½“å‰è‡ªèº«çŠ¶æ€æ¥å®šã€‚ï¼ˆåé¢ä¸¤å¥è¯ç›´æ¥ copy è‡ª &lt;a href=&#34;https://pingcap.com/blog-tidb-internal-3-zhï¼‰ã€‚&#34;&gt;https://pingcap.com/blog-tidb-internal-3-zhï¼‰ã€‚&lt;/a&gt;&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;// HandleRegionHeartbeat processes RegionInfo reports from client.&#xA;func (c *RaftCluster) HandleRegionHeartbeat(region *core.RegionInfo) error {&#xA;        if err := c.cachedCluster.handleRegionHeartbeat(region); err != nil {&#xA;                return errors.Trace(err)&#xA;        }&#xA;&#xA;        // If the region peer count is 0, then we should not handle this.&#xA;        if len(region.GetPeers()) == 0 {&#xA;                log.Warnf(&amp;quot;invalid region, zero region peer count - %v&amp;quot;, region)&#xA;                return errors.Errorf(&amp;quot;invalid region, zero region peer count - %v&amp;quot;, region)&#xA;        }&#xA;&#xA;        c.coordinator.dispatch(region)&#xA;        return nil&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;è¿™ä¸ªå‡½æ•°å¤„ç†æ¥è‡ª leader peer çš„heartbeatï¼Œ &lt;code&gt;handleRegionHeartbeat&lt;/code&gt; ä¸»è¦è´Ÿè´£æ›´ç›¸å…³region çš„ä¿¡æ¯ï¼Œ æˆ‘ä»¬ä¸»è¦è¿˜æ˜¯å…³ç³» å¦‚ä½•å‘é€æ“ä½œæŒ‡ä»¤ï¼Œæƒ³å½“ç„¶å°±æ˜¯ &lt;code&gt;c.coordinator.dispatch(region)&lt;/code&gt; è¿™ä¸ªå‡½æ•°å¹²çš„äº‹æƒ…äº†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;func (c *coordinator) dispatch(region *core.RegionInfo) {&#xA;       // Check existed operator.&#xA;       if op := c.getOperator(region.GetId()); op != nil {&#xA;               timeout := op.IsTimeout()&#xA;               if step := op.Check(region); step != nil &amp;amp;&amp;amp; !timeout {&#xA;                       operatorCounter.WithLabelValues(op.Desc(), &amp;quot;check&amp;quot;).Inc()&#xA;                       c.sendScheduleCommand(region, step)&#xA;                       return&#xA;               }&#xA;               if op.IsFinish() {&#xA;                       log.Infof(&amp;quot;[region %v] operator finish: %s&amp;quot;, region.GetId(), op)&#xA;                       operatorCounter.WithLabelValues(op.Desc(), &amp;quot;finish&amp;quot;).Inc()&#xA;                       c.removeOperator(op)&#xA;               } else if timeout {&#xA;                       log.Infof(&amp;quot;[region %v] operator timeout: %s&amp;quot;, region.GetId(), op)&#xA;                       operatorCounter.WithLabelValues(op.Desc(), &amp;quot;timeout&amp;quot;).Inc()&#xA;                       c.removeOperator(op)&#xA;               }&#xA;       }&#xA;    ....&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²æœ‰çš„æ“ä½œï¼Œè¿™ä¸ª operator å¯ä»¥æœ‰å¥½å¤šç§ï¼Œæ¯”å¦‚ &lt;code&gt;AddReplicaã€RemoveReplicaã€TransferLeader&lt;/code&gt;,&#xA;å¦‚æœå­˜åœ¨æ£€æŸ¥è¿™ä¸ªæ“ä½œæ˜¾ç¤ºæ˜¯åˆ°å“ªä¸€æ­¥äº†ï¼Œå¦‚æœæ˜¯æ²¡æœ‰ç»“æŸå¹¶ä¸”æ²¡æœ‰è¶…æ—¶ï¼Œå°±ä¼šä½¿ç”¨ &lt;code&gt;sendScheduleCommand&lt;/code&gt; é€šè¿‡ grpc å‘è¿™ä¸ªregion åœ¨æ­¤å‘é€æ­¤æ¬¡æ“ä½œã€‚ è¦æ˜¯ä»¥åŠå®Œæˆæˆ–æ˜¯è¶…æ—¶åˆ†åˆ«é”™å¤„å“åº”çš„å¤„ç†å¹¶åˆ é™¤è¿™ä¸ªæ“ä½œã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;åœ¨çœ‹ PD å¦‚ä½•å°† Transfer leader è¿™ä¸ª opertor åŠ åˆ° &lt;code&gt;c.operators&lt;/code&gt; é‡Œé¢çš„&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;func (l *balanceLeaderScheduler) Schedule(cluster schedule.Cluster) *schedule.Operator {&#xA;        schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;schedule&amp;quot;).Inc()&#xA;        region, newLeader := scheduleTransferLeader(cluster, l.GetName(), l.selector)&#xA;        if region == nil {&#xA;                return nil&#xA;        }&#xA;&#xA;        // Skip hot regions.&#xA;        if cluster.IsRegionHot(region.GetId()) {&#xA;                schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;region_hot&amp;quot;).Inc()&#xA;                return nil&#xA;        }&#xA;&#xA;        source := cluster.GetStore(region.Leader.GetStoreId())&#xA;        target := cluster.GetStore(newLeader.GetStoreId())&#xA;        if !shouldBalance(source, target, core.LeaderKind) {&#xA;                schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;skip&amp;quot;).Inc()&#xA;                return nil&#xA;        }&#xA;        l.limit = adjustBalanceLimit(cluster, core.LeaderKind)&#xA;        schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;new_opeartor&amp;quot;).Inc()&#xA;        step := schedule.TransferLeader{FromStore: region.Leader.GetStoreId(), ToStore: newLeader.GetStoreId()}&#xA;        return schedule.NewOperator(&amp;quot;balance-leader&amp;quot;, region.GetId(), core.LeaderKind, step)&#xA;}&#xA;&#xA;...&#xA;func (c *coordinator) runScheduler(s *scheduleController) {&#xA;        defer c.wg.Done()&#xA;        defer s.Cleanup(c.cluster)&#xA;&#xA;        timer := time.NewTimer(s.GetInterval())&#xA;        defer timer.Stop()&#xA;&#xA;        for {&#xA;                select {&#xA;                case &amp;lt;-timer.C:&#xA;                        timer.Reset(s.GetInterval())&#xA;                        if !s.AllowSchedule() {&#xA;                                continue&#xA;                        }&#xA;                        if op := s.Schedule(c.cluster); op != nil {&#xA;                                c.addOperator(op)&#xA;                        }&#xA;&#xA;                case &amp;lt;-s.Ctx().Done():&#xA;                        log.Infof(&amp;quot;%v stopped: %v&amp;quot;, s.GetName(), s.Ctx().Err())&#xA;                        return&#xA;                }&#xA;        }&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ°&lt;code&gt;Schedule&lt;/code&gt;è¿™ä¸ªå‡½æ•°æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ª &lt;code&gt;operator&lt;/code&gt; , &lt;code&gt;runScheduler&lt;/code&gt; è°ƒç”¨ &lt;code&gt;c.addOperator&lt;/code&gt; å°†è¿™ä¸ª&lt;code&gt;operator&lt;/code&gt; åŠ åˆ°&lt;code&gt;c.operators&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;åœ¨çœ‹ TiKV&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;æ¥ç€çœ‹ TiKV ä» PD æ”¶åˆ° transfer leader æŒ‡ä»¤åä¼šåšå“ªäº›æ“ä½œã€‚(åˆšå…¥å‘ Rustï¼Œçœ‹ TiKV è¿˜æœ‰ç‚¹è´¹åŠ²ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹ç†è§£çš„æœ‰é—®é¢˜ï¼Œè¿˜æœ›æŒ‡å‡ºæ¥)&lt;/p&gt;&#xA;&#xA;&lt;p&gt;TiKV é¦–å…ˆæ˜¯è¦æ¥å—åˆ° PD å‘é€çš„å‘½ä»¤ï¼Œæ¥çœ‹ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¤„ç† PD å‘é€çš„å‘½ä»¤&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;fn schedule_heartbeat_receiver(&amp;amp;mut self, handle: &amp;amp;Handle) {&#xA;        let ch = self.ch.clone();&#xA;        let store_id = self.store_id;&#xA;        let f = self.pd_client&#xA;            .handle_region_heartbeat_response(self.store_id, move |mut resp| {&#xA;                let region_id = resp.get_region_id();&#xA;                let epoch = resp.take_region_epoch();&#xA;                let peer = resp.take_target_peer();&#xA;&#xA;                if resp.has_change_peer() {&#xA;                   // more&#xA;                } else if resp.has_transfer_leader() {&#xA;                    PD_HEARTBEAT_COUNTER_VEC&#xA;                        .with_label_values(&amp;amp;[&amp;quot;transfer leader&amp;quot;])&#xA;                        .inc();&#xA;&#xA;                    let mut transfer_leader = resp.take_transfer_leader();&#xA;                    info!(&#xA;                        &amp;quot;[region {}] try to transfer leader from {:?} to {:?}&amp;quot;,&#xA;                        region_id,&#xA;                        peer,&#xA;                        transfer_leader.get_peer()&#xA;                    );&#xA;                    let req = new_transfer_leader_request(transfer_leader.take_peer());&#xA;                   send_admin_request(&amp;amp;ch, region_id, epoch, peer, req, None)&#xA;                } else {&#xA;                    PD_HEARTBEAT_COUNTER_VEC.with_label_values(&amp;amp;[&amp;quot;noop&amp;quot;]).inc();&#xA;                }&#xA;            })&#xA;    // more&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;è¿™æ®µä»£ç å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å…ˆä» resp ä¸­è¯»å–åˆ° &lt;code&gt;region_id&lt;/code&gt;ã€&lt;code&gt;peer&lt;/code&gt;ï¼Œç„¶ååœ¨åˆ¤æ–­è¦æ‰§è¡Œçš„æ“ä½œæ˜¯ä»€ä¹ˆï¼Œå½“æ‰§è¡Œçš„æ“ä½œæ˜¯ &lt;code&gt;transfer_leader&lt;/code&gt;çš„æ—¶å€™ï¼Œå…ˆæ˜¯æ›´æ–°ä¸€ä¸‹ç›‘æ§ï¼Œç„¶ååœ¨ä» resp ä¸­è·å–åˆ° &lt;code&gt;leader&lt;/code&gt; è¯¥ &lt;code&gt;transfer&lt;/code&gt; åˆ°ä»€ä¹ˆåœ°æ–¹, åœ¨ç„¶åå‘¢ï¼Œå°±æ˜¯å‘é€è¿™ä¸ªå‘½ä»¤å»æ‰§è¡Œäº†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å…ˆçœ‹å¯åŠ¨ å¯åŠ¨ &lt;code&gt;transfer_leader&lt;/code&gt; å‡½æ•°&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;pub fn transfer_leader(&amp;amp;mut self, transferee: u64) {&#xA;     let mut m = Message::new();&#xA;     m.set_msg_type(MessageType::MsgTransferLeader);&#xA;     m.set_from(transferee);&#xA;     self.raft.step(m).is_ok();&#xA; }&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;è¿™ä¸ªå‡½æ•°å…¶å®å¾ˆç®€å•ï¼Œå…ˆè®¾ç½®ä¸€ä¸‹æ¶ˆæ¯ç±»å‹ï¼Œç„¶åè·å–åˆ°ç›®æ ‡ &lt;code&gt;leader&lt;/code&gt;ï¼Œ&lt;code&gt;transferee&lt;/code&gt; å°±æ˜¯ç›®æ ‡&lt;code&gt;leader&lt;/code&gt;ï¼Œå½“ç„¶è‡ªå·±å°±æ˜¯å½“å‰ &lt;code&gt;leader&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;åœ¨çœ‹å¤„ç†è¿‡ç¨‹&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;fn handle_transfer_leader(&amp;amp;mut self, m: &amp;amp;Message) {&#xA;    let lead_transferee = m.get_from();&#xA;    let last_lead_transferee = self.lead_transferee;&#xA;    if last_lead_transferee.is_some() {&#xA;        if last_lead_transferee.unwrap() == lead_transferee {&#xA;            info!(&#xA;                &amp;quot;{} [term {}] transfer leadership to {} is in progress, ignores request \&#xA;                 to same node {}&amp;quot;,&#xA;                self.tag,&#xA;                self.term,&#xA;                lead_transferee,&#xA;                lead_transferee&#xA;            );&#xA;            return;&#xA;        }&#xA;        self.abort_leader_transfer();&#xA;        info!(&#xA;            &amp;quot;{} [term {}] abort previous transferring leadership to {}&amp;quot;,&#xA;            self.tag,&#xA;            self.term,&#xA;            last_lead_transferee.unwrap()&#xA;        );&#xA;    }&#xA;    if lead_transferee == self.id {&#xA;        debug!(&#xA;            &amp;quot;{} is already leader. Ignored transferring leadership to self&amp;quot;,&#xA;            self.tag&#xA;        );&#xA;        return;&#xA;    }&#xA;    // Transfer leadership to third party.&#xA;    info!(&#xA;        &amp;quot;{} [term {}] starts to transfer leadership to {}&amp;quot;,&#xA;        self.tag,&#xA;        self.term,&#xA;        lead_transferee&#xA;    );&#xA;    // Transfer leadership should be finished in one electionTimeout&#xA;    // so reset r.electionElapsed.&#xA;    self.election_elapsed = 0;&#xA;    self.lead_transferee = Some(lead_transferee);&#xA;    if self.prs[&amp;amp;m.get_from()].matched == self.raft_log.last_index() {&#xA;        self.send_timeout_now(lead_transferee);&#xA;        info!(&#xA;            &amp;quot;{} sends MsgTimeoutNow to {} immediately as {} already has up-to-date log&amp;quot;,&#xA;            self.tag,&#xA;            lead_transferee,&#xA;            lead_transferee&#xA;        );&#xA;    } else {&#xA;        self.send_append(lead_transferee);&#xA;    }&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;è¿™æ®µä»£ç ç¨æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ­¥ä¸€æ­¥çš„æ¥çœ‹ï¼Œ é¦–å…ˆæ˜¯è¿›è¡Œä¸€äº›æ£€æŸ¥ï¼Œç¬¬ä¸€æ­¥æ˜¯æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ &lt;code&gt;transfer leader&lt;/code&gt; åœ¨æ‰§è¡Œï¼Œå¦‚æœå·²ç»æ­£åœ¨  &lt;code&gt;transfer leader&lt;/code&gt; å¹¶ä¸”ç›®æ ‡ &lt;code&gt;leader&lt;/code&gt; ç›¸åŒçš„è¯ï¼Œå°±é€€å‡ºè¿™æ¬¡æ“ä½œï¼Œå¦‚æœç›®æ ‡ä¸åŒçš„è¯ï¼Œé‚£å°± è°ƒç”¨&lt;code&gt;self.abort_leader_transfer();&lt;/code&gt; è¿™ä¸ªå‡½æ•°æ”¾å¼ƒä¸Šä¸€æ¬¡æ­£åœ¨æ‰§è¡Œçš„ &lt;code&gt;transfer leader&lt;/code&gt;  æ“ä½œã€‚ ç´§æ¥å°±æ˜¯åˆ¤æ–­ ç›®æ ‡ &lt;code&gt;leader&lt;/code&gt;æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œè¦æ˜¯è‡ªå·±é‚£å°±ç›´æ¥é€€å‡ºå°±å¥½äº†ï¼Œå› ä¸ºä¸éœ€è¦&lt;code&gt;transfer leader&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸‹ä¸€æ­¥å°±æ˜¯å°†ç›®æ ‡leaderä¿å­˜åœ¨&lt;code&gt;leadTransferee&lt;/code&gt;ä¸­ï¼Œæ ‡ç¤ºç€æœ‰&lt;code&gt;transfer&lt;/code&gt;æ­£åœ¨è¿›è¡Œï¼Œåç»­å¦‚æœæœ‰è¯·æ±‚&lt;code&gt;propose&lt;/code&gt;è¿›æ¥ï¼Œä¼šæ£€æŸ¥è¿™ä¸ª&lt;code&gt;lead_transferee&lt;/code&gt; æ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå…¶ä»–æ“ä½œå°±æ— æ³•æˆåŠŸï¼Œä¹Ÿå°±æ˜¯æ— æ³•è¿›è¡Œå†™æ“ä½œã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸‹ä¸€æ­¥å°±æ˜¯æ£€æŸ¥ &lt;code&gt;transferee&lt;/code&gt; å’Œ&lt;code&gt;leader&lt;/code&gt;çš„&lt;code&gt;log&lt;/code&gt;æ˜¯å¦ä¸€æ ·æ–°&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ&lt;code&gt;log&lt;/code&gt; ä¸€è‡´çš„è¯å°±ä¼šç»™&lt;code&gt;transferee&lt;/code&gt;å‘é€&lt;code&gt;MsgTimeoutNow&lt;/code&gt;ç±»å‹çš„æ¶ˆæ¯ï¼Œå‘Šè¯‰&lt;code&gt;transferee&lt;/code&gt;å¯ä»¥ç«‹å³é€‰ä¸»ï¼Œä¸éœ€è¦ç­‰åˆ°&lt;code&gt;election timeout&lt;/code&gt;ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœ &lt;code&gt;log&lt;/code&gt; ä¸ä¸€è‡´ï¼Œå°±ä¼šç»™ &lt;code&gt;lead_transferee&lt;/code&gt;  å‘é€ä¸€ä¸ª&lt;code&gt;append&lt;/code&gt; çš„è¯·æ±‚ï¼Œè¿½åŠ  &lt;code&gt;log&lt;/code&gt;ã€‚ ï¼Œleaderåœ¨æ”¶åˆ°å“åº” &lt;code&gt;MsgAppResp&lt;/code&gt;å,å¦‚æœå‘ç°ç›®å‰æ­£å¤„äº&lt;code&gt;transfer leader&lt;/code&gt; è¿‡ç¨‹ä¸­å¹¶ä¸” &lt;code&gt;transferee&lt;/code&gt;å·²ç»æ—¥å¿—æœ€æ–°ï¼Œåˆ™åŒæ ·ï¼Œç»™&lt;code&gt;transferee&lt;/code&gt;å‘é€&lt;code&gt;MsgTimeoutNow&lt;/code&gt;ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/é›†ç¾¤è°ƒåº¦/blog-placement-driver-zh&#34;&gt;TiKV æºç è§£æç³»åˆ— - Placement Driver&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-tidb-internal-3-zh&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è°ˆè°ƒåº¦&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/27895034&#34;&gt;etcd raftå¦‚ä½•å®ç°leadership transfer&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pingcap/pd&#34;&gt;PD&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pingcap/tikv&#34;&gt;TiKV&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/Leader Transfer In TiKV.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œçš„æ—¶é—´ã€æ—¶é’Ÿå’Œäº‹ä»¶é¡ºåº</title>
    <updated>2017-10-22T00:00:00Z</updated>
    <id>tag:int64.me,2017-10-22:/2017/åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œçš„æ—¶é—´ã€æ—¶é’Ÿå’Œäº‹ä»¶é¡ºåº.html</id>
    <content type="html">&lt;p&gt;ä»¥å¾€ç¼–å†™å•æœºç¨‹åºçš„æ—¶å€™ï¼Œå¦‚ä½•æ¥åˆ¤æ–­å…ˆåé¡ºåºï¼Œç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å°±æ˜¯åˆ†é…ä¸€ä¸ªå”¯ä¸€æ—¶é—´æˆ³ï¼Œç„¶åæ ¹æ®æ—¶é—´æˆ³çš„å¤§å°æ¥åˆ¤æ–­äº‹ä»¶å‘ç”Ÿçš„å…ˆåé¡ºåºï¼Œ ä½†æ˜¯æ”¾åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå°±ä¸ä¸€å®šæœ‰æ•ˆ&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;é€»è¾‘æ—¶é’Ÿå’Œç‰©ç†æ—¶é’Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;ç‰©ç†æ—¶é—´å¯ä»¥ç”¨ä¸¥æ ¼çš„ç»å¯¹æ—¶é—´æ¥è¡¨ç¤ºäº‹ä»¶çš„å‘ç”Ÿé¡ºåºï¼Œä½†æ˜¯åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸­ï¼Œç”±äºç½‘ç»œç­‰å› ç´ æ— æ³•åšåˆ°å®Œå…¨çš„ä¸€è‡´çš„æ—¶é—´ï¼Œå³ä½¿ä½¿ç”¨ NTP æ—¶é—´ï¼Œä¹Ÿæ˜¯ä¼šæœ‰çº³ç§’çš„è¯¯å·®ã€‚è¿™æ ·å°±å¯¼è‡´åœ¨è¯¯å·®äº‹ä»¶å†…å‘ç”Ÿçš„äº‹ä»¶çš„å…ˆåé¡ºåºå°±å¾ˆéš¾åˆ¤æ–­äº†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;1978 å¹´ï¼ŒLeslie Lamport  åœ¨ &lt;a href=&#34;http://amturing.acm.org/p558-lamport.pdf&#34;&gt;Time, Clocks and the Ordering of Events in a Distributed System&lt;/a&gt; è®ºæ–‡ä¸­æå‡ºäº†é€»è¾‘æ—¶é’Ÿçš„æ¦‚å¿µã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé€šè¿‡ä¸€ç³»åˆ—è§„åˆ™æ¥å®šä¹‰é€»è¾‘æ—¶é’Ÿçš„å˜åŒ–ã€‚ä»è€Œèƒ½é€šè¿‡é€»è¾‘æ—¶é’Ÿæ¥å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„äº‹ä»¶çš„å…ˆåé¡ºåºè¿›è¡Œåˆ¤æ–­ã€‚é€»è¾‘æ—¶é’Ÿæœ¬è´¨ä¸Šå®šä¹‰äº†ä¸€ç§ happen before å…³ç³»ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;happen before å…³ç³»ï¼ˆååºå…³ç³»ï¼Œéƒ¨åˆ†æœ‰åºï¼‰&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹ process å†…çš„å¤šä¸ªäº‹ä»¶ï¼Œè‡ªç„¶åœ°å…·å¤‡äº‹ä»¶çš„å…ˆåé¡ºåºï¼Œæˆ–è€…è¯´ä¸€ä¸ª process æœ¬èº«å°±æ˜¯ä¸€ä¸ªæœ‰å…ˆéªŒé¡ºåºçš„å…¨åºçš„äº‹ä»¶é›†åˆã€‚é™¤äº† process å†…åœ¨çš„é¡ºåºï¼Œæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶äº‹ä»¶ä¹Ÿæ˜¯æœ‰å› æœåºçš„ã€‚åŸºäºè¿™ä¸¤ç‚¹ï¼Œæˆ‘ä»¬å®šä¹‰ happen-before å…³ç³»ï¼Œå†™ä½œ &lt;code&gt;-&amp;gt;&lt;/code&gt; ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;&lt;strong&gt;å®šä¹‰&lt;/strong&gt;: æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­äº‹ä»¶é›†åˆä¸Šæ»¡è¶³å¦‚ä¸‹æ¡ä»¶çš„æœ€å°å…³ç³»ï¼š&lt;/h3&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;å¦‚æœaå’Œbæ˜¯åŒä¸€ä¸ªprocesså†…çš„äº‹ä»¶ï¼Œä¸”aåœ¨bä¹‹å‰å‘ç”Ÿï¼Œé‚£ä¹ˆ &lt;code&gt;$$a-&amp;gt;b&lt;/code&gt;ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœaæ˜¯ä¸€ä¸ªprocesså‘é€æ¶ˆæ¯äº‹ä»¶ï¼Œbæ˜¯å¦ä¸€ä¸ªè¿›ç¨‹æ¥æ”¶è¯¥æ¶ˆæ¯çš„äº‹ä»¶ï¼Œé‚£ä¹ˆ&lt;code&gt;$$a-&amp;gt;b&lt;/code&gt;ã€‚&lt;/li&gt;&#xA;&lt;li&gt;&lt;code&gt;$$âˆ€a,b,c,aâ†’b,bâ†’câŸ¹aâ†’c&lt;/code&gt; (å³â€œåœ¨â€¦â€¦ä¹‹å‰å‘ç”Ÿâ€çš„å…³ç³»å…·å¤‡ä¼ é€’æ€§ï¼ˆtransitivityï¼‰)&#xA;å¦‚æœ &lt;code&gt;$$aâ†›b,bâ†›a&lt;/code&gt;ï¼Œ é‚£ä¹ˆç§° a å’Œ b æ˜¯å¹¶å‘ï¼ˆconcurrentï¼‰çš„ã€‚&#xA;æ ¹æ®å®šä¹‰ï¼Œå¯ä»¥çŸ¥é“happen-beforeå…³ç³» &lt;code&gt;-&amp;gt;&lt;/code&gt; æ˜¯ä¸€ä¸ªç³»ç»Ÿæ‰€æœ‰äº‹ä»¶é›†åˆä¹‹ä¸Šçš„åè‡ªåååºå…³ç³»ã€‚&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&lt;h2&gt;é€»è¾‘æ—¶é’Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;å®šä¹‰&lt;/strong&gt;ï¼šå®šä¹‰ä¸ºä¸€ä¸ªä»¥äº‹ä»¶ä¸ºè¾“å…¥ï¼Œè¾“å‡ºä¸ºæŸä¸ªæœ‰åºæ•°çš„å‡½æ•°Cã€‚è‹¥å¯¹æ‰€æœ‰äº‹ä»¶æ’æ»¡è¶³ï¼š&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code class=&#34;language-math&#34;&gt;âˆ€a,b\in E,aâ†’bâŸ¹C(a)&amp;lt;C(b)&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;åˆ™ç§°è¯¥å‡½æ•°Cæ»¡è¶³æ—¶é’Ÿçº¦æŸã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬å°†Cå‡½æ•°è¾“å‡ºçš„æœ‰åºæ•°æ„æˆçš„å…ˆåå…³ç³»ï¼Œåœ¨é€»è¾‘ä¸Šç­‰åŒäºç‰©ç†æ—¶é—´ï¼Œæˆ‘ä»¬ç§°ç”±Cå®ç°çš„è™šæ‹Ÿæ—¶é’Ÿä¸ºé€»è¾‘æ—¶é’Ÿã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;å®ç°&lt;/strong&gt;: æ»¡è¶³å¦‚ä¸‹ä¸¤æ¡è§„åˆ™ï¼š&lt;/p&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;åœ¨åŒä¸€è¿›ç¨‹å†…ï¼ŒCå•è°ƒé€’å¢ï¼›&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœäº‹ä»¶ a æ˜¯ç”±è¿›ç¨‹ Piå‘é€ä¸€ä¸ªæ¶ˆæ¯ m , æ¶ˆæ¯ m åŒ…å«ä¸€ä¸ªæ—¶é—´æˆ³ T(m) = Ci(a), è¿›ç¨‹ Pj æ”¶åˆ°ä¸€ä¸ªæ¶ˆæ¯ mï¼Œè¿™æ—¶å€™ Pj è®¾ç½® Cj ä¸€å®šå¤§äºæˆ–ç­‰äºä¹‹çš„æ—¶é—´ï¼Œä½†æ˜¯ä¸€å®šè¦æ¯”T(m) å¤§ ã€‚&#xA;å‡½æ•° C å®Œå…¨æ»¡è¶³ä¹‹å‰å®šä¹‰çš„ååºå…³ç³»ã€‚&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&#xA;&lt;h2&gt;å…¨åºå…³ç³»&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœ&lt;code&gt;$$C(a) = C(b)&lt;/code&gt;ï¼Œé‚£aã€bäº‹ä»¶çš„é¡ºåºåˆæ˜¯æ€æ ·çš„ï¼Ÿå‡è®¾aã€båˆ†åˆ«åœ¨èŠ‚ç‚¹Pã€Qä¸Šå‘ç”Ÿï¼ŒPiã€Qjåˆ†åˆ«è¡¨ç¤ºæˆ‘ä»¬ç»™Pã€Qçš„ç¼–å·ï¼Œå¦‚æœ &lt;code&gt;$$C(a) = C(b)&lt;/code&gt; å¹¶ä¸” Pi &amp;lt; Qjï¼ŒåŒæ ·å®šä¹‰ä¸ºaå‘ç”Ÿåœ¨bä¹‹å‰ï¼Œè®°ä½œ &lt;code&gt;$$a =&amp;gt; b&lt;/code&gt;ã€‚å‡å¦‚æˆ‘ä»¬å¯¹ä¸‹å›¾çš„Aã€Bã€Cåˆ†åˆ«ç¼–å·&lt;code&gt;$$Ai = 1ã€Bj = 2ã€Ck = 3&lt;/code&gt;ï¼Œå›  &lt;code&gt;$$C(B4) = C(C3)&lt;/code&gt; å¹¶ä¸”&lt;code&gt;$$Bj &amp;lt; Ck&lt;/code&gt;ï¼Œåˆ™ &lt;code&gt;$$B4 =&amp;gt; C3&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;é€šè¿‡ä»¥ä¸Šå®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æ‰€æœ‰äº‹ä»¶æ’åºã€è·å¾—äº‹ä»¶çš„å…¨åºå…³ç³»(total order)ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202017-10-22%20at%205.35.32%20PM.png&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;ç»“è®º&lt;/strong&gt;ï¼šâ†’ å…³ç³»ç¡®å®šäº†å”¯ä¸€çš„éƒ¨åˆ†æœ‰åºå…³ç³»ï¼›è€Œ â‡’ åˆ™æ˜¯äººä¸ºæŒ‡å®šçš„å®Œå…¨æ’åºå…³ç³»ï¼Œæ ¹æ®æŒ‡å®šè§„åˆ™ä¸åŒï¼Œâ‡’&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å…³ç³»å¯ä»¥æœ‰æ— ç©·å¤šä¸ªã€‚ï¼ˆåœ¨å•ä¸€æ“ä½œç³»ç»Ÿå†…çš„ä¸€ä¸ªæœ€ç®€å•çš„æŒ‡å®šè§„åˆ™å°±æ˜¯ï¼Œå½“ä¸¤äº‹ä»¶æ—¶åˆ»ç›¸ç­‰æ—¶ï¼Œç”¨è¿›ç¨‹å·æ¥åˆ†å‡ºå‰åï¼‰&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;fault model&lt;/strong&gt;ï¼šè¯¥ç»“è®ºå»ºç«‹åœ¨ä¿¡æ¯æœ‰åºåˆ°è¾¾å’Œä¿¡æ¯å§‹ç»ˆå¯è¾¾çš„åŸºç¡€ä¸Šã€‚å‰è€…è¦æ±‚ä¸€ä¸ªå¯é çš„ä¼ è¾“åè®®ï¼Œåè€…åˆ™æ³¨å®šäº†è¯¥æ¨¡å‹è¿‡äºç†æƒ³åŒ–ï¼Œä½¿å¾—ç°å®çš„å¯é å®ç°ä¸èƒ½ç›´æ¥å»ºç«‹åœ¨è¯¥ç»“è®ºä¹‹ä¸Šã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å¼ºæ—¶é’Ÿçº¦æŸ&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;åœ¨ä¸Šè¿°æ–¹æ¡ˆä¸­ï¼Œæ—¶é’Ÿçº¦æŸåªå®šä¹‰äº†ç³»ç»Ÿå†…éƒ¨çš„æœ‰åºæ€§ï¼ˆæˆ–ç§°åŒæ­¥æ€§ï¼‰ï¼Œç”±äº &lt;code&gt;$$â‡’&lt;/code&gt;&#xA;å…³ç³»çš„ä»»æ„æ€§ï¼Œç³»ç»Ÿå†…éƒ¨çš„å…ˆåå…³ç³»æœ‰å¯èƒ½å’Œç³»ç»Ÿå¤–éƒ¨ä»¥çœŸå®æ—¶é—´ä¸ºå‚è€ƒç³»çš„å…ˆåå…³ç³»ç›¸äº’çŸ›ç›¾ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è®©ç³»ç»Ÿä¹Ÿèƒ½æ¨¡æ‹Ÿç‰©ç†çš„æ—¶é’Ÿï¼Œä»è€Œå°†çœŸå®å¤–éƒ¨ä¸–ç•Œçš„å…ˆåé¡ºåºä¹Ÿè€ƒè™‘åœ¨å†…ã€‚å¤„äºç³»ç»Ÿå¤–éƒ¨çš„å…ˆåå…³ç³»ï¼Œæˆ‘ä»¬å®šä¹‰ä¸º (bold arrow, â†’â†’)ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;å®šä¹‰&lt;/strong&gt;ï¼šè‹¥å¯¹æ—¶é’Ÿå‡½æ•°Cï¼Œæ»¡è¶³ï¼š&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code class=&#34;language-math&#34;&gt;âˆ€a,b\in E,aâ†’â†’bâŸ¹C(a)&amp;lt;C(b)&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;åˆ™ç§°å‡½æ•°æ»¡è¶³å¼ºæ—¶é’Ÿçº¦æŸã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;è¯æ˜å¼ºæ—¶é’Ÿçº¦æŸå¯ä¿è¯æ—¶é—´ä¸Šçš„å…ˆåå…³ç³»ç•¥( æ•°å­¦ï¼Œæœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œåé¢åœ¨ç»†ç»†ç ”ç©¶&#xA;&lt;a href=&#34;http://blog.yangliu.online/2016/09/10/logic-clock-md&#34;&gt;http://blog.yangliu.online/2016/09/10/logic-clock-md&lt;/a&gt; )&#xA;åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºåŸºç¡€ - æ—¶é—´ã€æ—¶é’Ÿå’Œäº‹ä»¶é¡ºåº&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://amturing.acm.org/p558-lamport.pdf&#34;&gt;Time, Clocks and the Ordering of Events in a Distributed System&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://blog.yangliu.online/2016/09/10/logic-clock-md/&#34;&gt;åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é€»è¾‘æ—¶é’Ÿ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.cnblogs.com/bangerlee/p/5448766.html&#34;&gt;åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºåŸºç¡€ - æ—¶é—´ã€æ—¶é’Ÿå’Œäº‹ä»¶é¡ºåº&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œçš„æ—¶é—´ã€æ—¶é’Ÿå’Œäº‹ä»¶é¡ºåº.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>rust ç¬”è®° - æ„å»ºå¤šçº¿ç¨‹ web server</title>
    <updated>2017-10-22T00:00:00Z</updated>
    <id>tag:int64.me,2017-10-22:/2017/rust ç¬”è®° - æ„å»ºå¤šçº¿ç¨‹ web server.html</id>
    <content type="html">&lt;p&gt;å…¥å‘ rustï¼Œ å­¦ä¹ å¦‚ä½•æ¥ç”¨ rust æ„å»ºå¤šçº¿ç¨‹ web server&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å…ˆçœ‹ç»“æ„&lt;/h2&gt;&#xA;&#xA;&lt;pre&gt;&lt;code class=&#34;language-rust&#34;&gt;## main.rs&#xA;extern crate hello;&#xA;use hello::ThreadPool;&#xA;use std::io::prelude::*;&#xA;use std::net::TcpListener;&#xA;use std::net::TcpStream;&#xA;use std::fs::File;&#xA;use std::thread;&#xA;use std::time::Duration;&#xA;&#xA;fn main() {&#xA;    let listener = TcpListener::bind(&amp;quot;127.0.0.1:8080&amp;quot;).unwrap();&#xA;&#xA;    let pool = ThreadPool::new(4);&#xA;&#xA;    let mut counter = 0;&#xA;&#xA;    for stream in listener.incoming() {&#xA;        if counter == 2 {&#xA;            println!(&amp;quot;Shutting down.&amp;quot;);&#xA;            break;&#xA;        }&#xA;        counter += 1;&#xA;&#xA;        let stream = stream.unwrap();&#xA;&#xA;        pool.execute(|| {&#xA;            handle_connection(stream);&#xA;        });&#xA;    }&#xA;}&#xA;&#xA;fn handle_connection(mut stream: TcpStream) {&#xA;    let mut buffer = [0;512];&#xA;&#xA;    stream.read(&amp;amp;mut buffer).unwrap();&#xA;&#xA;    let get = b&amp;quot;GET / HTTP/1.1\r\n&amp;quot;;&#xA;    let sleep = b&amp;quot;GET /sleep HTTP/1.1\r\n&amp;quot;;&#xA;&#xA;    let (status_line, filename) = if buffer.starts_with(get) {&#xA;        (&amp;quot;HTTP/1.1 200 OK\r\n\r\n&amp;quot;, &amp;quot;html/hello.html&amp;quot;)&#xA;    } else if buffer.starts_with(sleep) {&#xA;        thread::sleep(Duration::from_secs(5));&#xA;        (&amp;quot;HTTP/1.1 200 OK\r\n\r\n&amp;quot;, &amp;quot;html/hello.html&amp;quot;)&#xA;    } else {&#xA;        (&amp;quot;HTTP/1.1 404 NOT FOUND\r\n\r\n&amp;quot;, &amp;quot;html/404.html&amp;quot;)&#xA;    };&#xA;&#xA;    let mut file = File::open(filename).unwrap();&#xA;    let mut contents = String::new();&#xA;&#xA;    file.read_to_string(&amp;amp;mut contents).unwrap();&#xA;&#xA;    let response = format!(&amp;quot;{}{}&amp;quot;, status_line, contents);&#xA;&#xA;    stream.write(response.as_bytes()).unwrap();&#xA;    stream.flush().unwrap();&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ rust æ„å»ºä¸€ä¸ª web server å¹¶ä¸éš¾ã€‚ ä»å¤´ä¸€ç‚¹ç‚¹å­¦ä¹ &#xA;å…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œè¦ç›‘å¬ TCP ç«¯å£ï¼Œrust ä½¿ç”¨ &lt;code&gt;TcpListener&lt;/code&gt; ä¸­ &lt;code&gt;bind&lt;/code&gt; å‡½æ•°ç»‘å®šç›‘å¬åœ°å€ï¼Œ&lt;code&gt;bind&lt;/code&gt; å‡½æ•°è¿”å› &lt;code&gt;Result&amp;lt;T, E&amp;gt;&lt;/code&gt;, ç»‘å®šå¯èƒ½ä¼šå¤±è´¥ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä¸æ˜¯ç®¡ç†å‘˜å°è¯•è¿æ¥ 80 ç«¯å£ã€‚å¦ä¸€ä¸ªç»‘å®šä¼šå¤±è´¥çš„æƒ…å†µæ˜¯ä¸¤ä¸ªç¨‹åºç›‘å¬ç›¸åŒçš„ç«¯å£ï¼Œè¿™å¯èƒ½å‘ç”Ÿäºè¿è¡Œä¸¤ä¸ªæœ¬ç¨‹åºçš„å®ä¾‹æ—¶ã€‚&lt;code&gt;unwrap&lt;/code&gt; å–å‡º &lt;code&gt;T&lt;/code&gt;ï¼Œ å¦‚æœå‡ºç°é”™è¯¯ç›´æ¥ &lt;code&gt;panic&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;let pool = ThreadPool::new(4);&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;ä»å­—æ¯æ„æ€å¯ä»¥çœ‹å‡ºæ¥ï¼Œ è¿™æ˜¯åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼ˆè‡ªå·±å®ç°çš„ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•å®ç°è¿™ä¸ªçº¿ç¨‹æ± ï¼‰ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;for stream in listener.incoming() {&#xA;   let stream = stream.unwrap();&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;&lt;code&gt;TcpListener&lt;/code&gt; çš„ &lt;code&gt;incoming&lt;/code&gt; æ–¹æ³•è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—çš„æµï¼ˆæ›´å‡†ç¡®çš„è¯´æ˜¯ &lt;code&gt;TcpStream&lt;/code&gt; ç±»å‹çš„æµï¼‰ã€‚æµï¼ˆ&lt;code&gt;stream&lt;/code&gt;ï¼‰ä»£è¡¨ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´æ‰“å¼€çš„è¿æ¥ã€‚ä¸ºæ­¤ï¼Œ&lt;code&gt;TcpStream&lt;/code&gt; å…è®¸æˆ‘ä»¬è¯»å–å®ƒæ¥æŸ¥çœ‹å®¢æˆ·ç«¯å‘é€äº†ä»€ä¹ˆï¼Œå¹¶å¯ä»¥ç¼–å†™å“åº”ã€‚æ‰€ä»¥è¿™ä¸ª for å¾ªç¯ä¼šä¾æ¬¡å¤„ç†æ¯ä¸ªè¿æ¥å¹¶äº§ç”Ÿä¸€ç³»åˆ—çš„æµä¾›æˆ‘ä»¬å¤„ç†ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;fn handle_connection(mut stream: TcpStream) {&#xA;    let mut buffer = [0;512];&#xA;    stream.read(&amp;amp;mut buffer).unwrap();&#xA;    let get = b&amp;quot;GET / HTTP/1.1\r\n&amp;quot;;&#xA;    let (status_line, filename) = if buffer.starts_with(get) {&#xA;        (&amp;quot;HTTP/1.1 200 OK\r\n\r\n&amp;quot;, &amp;quot;html/hello.html&amp;quot;)&#xA;    } else {&#xA;        (&amp;quot;HTTP/1.1 404 NOT FOUND\r\n\r\n&amp;quot;, &amp;quot;html/404.html&amp;quot;)&#xA;    };&#xA;    let mut file = File::open(filename).unwrap();&#xA;    let mut contents = String::new();&#xA;    file.read_to_string(&amp;amp;mut contents).unwrap();&#xA;    let response = format!(&amp;quot;{}{}&amp;quot;, status_line, contents);&#xA;    stream.write(response.as_bytes()).unwrap();&#xA;    stream.flush().unwrap();&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;&lt;code&gt;handle_connection&lt;/code&gt; è´Ÿè´£å¤„ç†è¯·æ±‚å’Œå“åº”ï¼Œåœ¨ &lt;code&gt;handle_connection&lt;/code&gt; ä¸­ï¼Œé€šè¿‡ &lt;code&gt;mut&lt;/code&gt; å…³é”®å­—å°† &lt;code&gt;stream&lt;/code&gt; å‚æ•°å˜ä¸ºå¯å˜ã€‚æˆ‘ä»¬å°†ä»æµä¸­è¯»å–æ•°æ®ï¼Œæ‰€ä»¥å®ƒéœ€è¦æ˜¯å¯ä¿®æ”¹çš„ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æ¥ä¸‹æ¥ï¼Œéœ€è¦å®é™…è¯»å–æµã€‚è¿™é‡Œåˆ†ä¸¤æ­¥è¿›è¡Œï¼šé¦–å…ˆï¼Œåœ¨æ ˆä¸Šå£°æ˜ä¸€ä¸ª &lt;code&gt;buffer&lt;/code&gt; æ¥å­˜æ”¾è¯»å–åˆ°çš„æ•°æ®ã€‚è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª 512 å­—èŠ‚çš„ç¼“å†²åŒºï¼Œå®ƒè¶³ä»¥å­˜æ”¾åŸºæœ¬è¯·æ±‚çš„æ•°æ®ã€‚è¿™å¯¹äºæœ¬ç« çš„ç›®çš„æ¥è¯´æ˜¯è¶³å¤Ÿçš„ã€‚å¦‚æœå¸Œæœ›å¤„ç†ä»»æ„å¤§å°çš„è¯·æ±‚ï¼Œç®¡ç†æ‰€éœ€çš„ç¼“å†²åŒºå°†æ›´å¤æ‚ï¼Œä¸è¿‡ç°åœ¨ä¸€åˆ‡ä»ç®€ã€‚æ¥ç€å°†ç¼“å†²åŒºä¼ é€’ç»™ &lt;code&gt;stream.read&lt;/code&gt; ï¼Œå®ƒä¼šä» &lt;code&gt;TcpStream&lt;/code&gt;ä¸­è¯»å–å­—èŠ‚å¹¶æ”¾å…¥ç¼“å†²åŒºä¸­ã€‚&#xA;æ¥ä¸‹æ¥å°±æ˜¯è¿›è¡Œè·¯ç”±åˆ¤æ–­ï¼Œå½“ç„¶è¿™é‡Œæ˜¯æœ€ç®€å•åˆ¤æ–­ï¼Œå¦‚æœè¯·æ±‚æ˜¯ &amp;ldquo;/&amp;rdquo; å°†è¿”å› hello.html é¡µé¢å¦åˆ™è¿”å› &amp;ldquo;404.html&amp;rdquo;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å®ç°çº¿ç¨‹æ± &lt;/h2&gt;&#xA;&#xA;&lt;p&gt;å…ˆçœ‹è‚¿ä¹ˆç”¨&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;let pool = ThreadPool::new(4);&#xA;&#xA;    let mut counter = 0;&#xA;&#xA;    for stream in listener.incoming() {&#xA;&#xA;        let stream = stream.unwrap();&#xA;        pool.execute(|| {&#xA;            handle_connection(stream);&#xA;        });&#xA;    }&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;é¦–å…ˆä½¿ç”¨  &lt;code&gt;new&lt;/code&gt; åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 4 çš„è¿æ¥æ± ï¼Œ å¹¶ä¸”è°ƒç”¨  &lt;code&gt;execute&lt;/code&gt; æ–¹æ³•ï¼Œ&lt;code&gt;execute&lt;/code&gt; æ–¹æ³•çš„å‚æ•°å¯ä»¥çœ‹å‡ºæ¥ä¼ å…¥çš„æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œå¹¶ä¸”è¿™ä¸ªçº¿ç¨‹åªä¼šæ‰§è¡Œé—­åŒ…ä¸€æ¬¡ã€‚æ‰€ä»¥åˆ¤æ–­ execute å‚æ•°å…·æœ‰ &lt;code&gt;FnOnce trait bound&lt;/code&gt;, åŒæ—¶å¯ä»¥ä» &lt;code&gt;thread::spawn&lt;/code&gt; å‡½æ•°çš„å®ç°æ¨æ–­å‡ºã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt; pub fn spawn&amp;lt;F, T&amp;gt;(f: F) -&amp;gt; JoinHandle&amp;lt;T&amp;gt;&#xA;    where&#xA;        F: FnOnce() -&amp;gt; T + Send + &#39;static,&#xA;        T: Send + &#39;static&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;æ‰€æœ‰æˆ‘æ²¡åˆ¶åŠ¨ï¼Œæˆ‘çš„çº¿ç¨‹æ±  lib éœ€æœ‰æœ‰ &lt;code&gt;ThreadPool&lt;/code&gt; è¿™ä¸ª struct å¹¶ä¸”ï¼Œéœ€è¦ç»‘å®š  &lt;code&gt;new&lt;/code&gt; &lt;code&gt;execute&lt;/code&gt; å‡½æ•°ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;// lib.rs åŸºæœ¬&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;pub struct ThreadPool;&#xA;&#xA;impl ThreadPool {&#xA;    pub fn new(size: u32) -&amp;gt; ThreadPool {&#xA;        ThreadPool&#xA;    }&#xA;    pub fn execute&amp;lt;F&amp;gt;(&amp;amp;self, f: F)&#xA;        where&#xA;            F: FnOnce() + Send + &#39;static&#xA;    {&#xA;&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;F æ˜¯è¿™é‡Œæˆ‘ä»¬å…³å¿ƒçš„å‚æ•°ï¼›T ä¸è¿”å›å€¼æœ‰å…³æ‰€ä»¥æˆ‘ä»¬å¹¶ä¸å…³å¿ƒã€‚è€ƒè™‘åˆ° &lt;code&gt;spawn&lt;/code&gt; ä½¿ç”¨ &lt;code&gt;FnOnce&lt;/code&gt; ä½œä¸º F çš„ &lt;code&gt;trait bound&lt;/code&gt;ï¼Œè¿™å¯èƒ½ä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦çš„ï¼Œå› ä¸ºæœ€ç»ˆä¼šå°†ä¼ é€’ç»™ &lt;code&gt;execute&lt;/code&gt; çš„å‚æ•°ä¼ ç»™ &lt;code&gt;spawn&lt;/code&gt;ã€‚å› ä¸ºå¤„ç†è¯·æ±‚çš„çº¿ç¨‹åªä¼šæ‰§è¡Œé—­åŒ…ä¸€æ¬¡ï¼Œè¿™ä¹Ÿè¿›ä¸€æ­¥ç¡®è®¤äº† &lt;code&gt;FnOnce&lt;/code&gt; æ˜¯æˆ‘ä»¬éœ€è¦çš„ &lt;code&gt;trait&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;F è¿˜æœ‰ &lt;code&gt;trait bound Send&lt;/code&gt;å’Œç”Ÿå‘½å‘¨æœŸç»‘å®š &lt;code&gt;&#39;static&lt;/code&gt;ï¼Œè¿™å¯¹æˆ‘ä»¬çš„æƒ…å†µä¹Ÿæ˜¯æœ‰æ„ä¹‰çš„ï¼šéœ€è¦ Send æ¥å°†é—­åŒ…ä»ä¸€ä¸ªçº¿ç¨‹è½¬ç§»åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œ &lt;code&gt;&#39;static&lt;/code&gt; æ˜¯å› ä¸ºå¹¶ä¸çŸ¥é“çº¿ç¨‹ä¼šæ‰§è¡Œå¤šä¹…ã€‚&#xA;&lt;code&gt;FnOnce trait&lt;/code&gt; ä»ç„¶éœ€è¦ä¹‹åçš„ ()ï¼Œå› ä¸ºè¿™é‡Œçš„ &lt;code&gt;FnOnce&lt;/code&gt; ä»£è¡¨ä¸€ä¸ªæ²¡æœ‰å‚æ•°ä¹Ÿæ²¡æœ‰è¿”å›å€¼çš„é—­åŒ…ã€‚æ­£å¦‚å‡½æ•°çš„å®šä¹‰ï¼Œè¿”å›å€¼ç±»å‹å¯ä»¥ä»ç­¾åä¸­çœç•¥ï¼Œä¸è¿‡å³ä¾¿æ²¡æœ‰å‚æ•°ä¹Ÿéœ€è¦æ‹¬å·ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æ˜¾ç„¶è¿™ä¸æ˜¯ä¸€ä¸ªå®Œæ•´è¿æ¥æ± ï¼Œæ²¡æ³•æä¾›æœåŠ¡ã€‚ æˆ‘ä»¬æ¥ç»­è¡¥å…¨ã€‚ ç»“ä¸‹æ¥æˆ‘ä»¬è¦åšçš„æ˜¯è¦å‚¨å­˜å®ƒä»¬ï¼Œæ˜¾ç„¶å°±æ˜¯å‚¨å­˜äº‹å…ˆåˆ›å»ºçš„çº¿ç¨‹ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª &lt;code&gt;Worker struct&lt;/code&gt; , &lt;code&gt;ThreadPool&lt;/code&gt; é‡Œé¢å®šä¹‰ä¸€ä¸ªå­˜æ”¾ size ä¸ªå…ƒç´ çš„ vector&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;pub struct ThreadPool {&#xA;    workers: Vec&amp;lt;Worker&amp;gt;,&#xA;}&#xA;&#xA;struct Worker {&#xA;    id: usize,&#xA;    thread: thread::JoinHandle&amp;lt;()&amp;gt;,&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;æ¥ä¸‹æ¥ç»™ &lt;code&gt;Worker&lt;/code&gt; æ·»åŠ ä¸€ä¸ª new å‡½æ•°&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;impl Worker {&#xA;    fn new(id: usize) -&amp;gt; Worker {&#xA;        let thread = thread::spawn(|| {});&#xA;&#xA;        Worker {&#xA;            id,&#xA;            thread,&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;åœ¨æ¥ä¸‹æ¥å°±æ˜¯è€ƒè™‘å¦‚ä½•é€šä¿¡çš„é—®é¢˜ï¼Œå¦‚ä½•è®© ThreodPool æ¥å—åˆ°è¯·æ±‚ç„¶åè®©worker å»æ‰§è¡Œï¼Œé¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨é€šé“äº†ï¼Œæä¸ªç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…äº†ã€‚&#xA;æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšä»€ä¹ˆ&#xA;    1. ThreadPool ä¼šåˆ›å»ºä¸€ä¸ªé€šé“å¹¶å……å½“å‘é€ç«¯ã€‚&#xA;    2. æ¯ä¸ª Worker å°†ä¼šå……å½“é€šé“çš„æ¥æ”¶ç«¯ã€‚&#xA;    3. æ–°å»ºä¸€ä¸ª Job ç»“æ„ä½“æ¥å­˜æ”¾ç”¨äºå‘é€šé“ä¸­å‘é€çš„é—­åŒ…ã€‚&#xA;    4. ThreadPool çš„ execute æ–¹æ³•ä¼šåœ¨å‘é€ç«¯å‘å‡ºæœŸæœ›æ‰§è¡Œçš„ä»»åŠ¡ã€‚&#xA;    5. åœ¨çº¿ç¨‹ä¸­ï¼ŒWorker ä¼šéå†é€šé“çš„æ¥æ”¶ç«¯å¹¶æ‰§è¡Œä»»ä½•æ¥æ”¶åˆ°çš„ä»»åŠ¡ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;// ...snip...&#xA;use std::sync::mpsc;&#xA;&#xA;pub struct ThreadPool {&#xA;    workers: Vec&amp;lt;Worker&amp;gt;,&#xA;    sender: mpsc::Sender&amp;lt;Job&amp;gt;,&#xA;}&#xA;&#xA;struct Job;&#xA;&#xA;impl ThreadPool {&#xA;    // ...snip...&#xA;    pub fn new(size: usize) -&amp;gt; ThreadPool {&#xA;        assert!(size &amp;gt; 0);&#xA;&#xA;        let (sender, receiver) = mpsc::channel();&#xA;&#xA;        let mut workers = Vec::with_capacity(size);&#xA;&#xA;        for id in 0..size {&#xA;            workers.push(Worker::new(id));&#xA;        }&#xA;&#xA;        ThreadPool {&#xA;            workers,&#xA;            sender,&#xA;        }&#xA;    }&#xA;    // ...snip...&#xA;}&#xA;&#xA;impl Worker {&#xA;    fn new(id: usize, receiver: mpsc::Receiver&amp;lt;Job&amp;gt;) -&amp;gt; Worker {&#xA;        let thread = thread::spawn(|| {&#xA;            receiver;&#xA;        });&#xA;&#xA;        Worker {&#xA;            id,&#xA;            thread,&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;&lt;code&gt;ThreadPool&lt;/code&gt; æ¥å‚¨å­˜ä¸€ä¸ªå‘é€ Job å®ä¾‹çš„é€šé“å‘é€ç«¯&lt;/p&gt;&#xA;&#xA;&lt;p&gt;åœ¨ &lt;code&gt;ThreadPool::new&lt;/code&gt; ä¸­ï¼Œæ–°å»ºäº†ä¸€ä¸ªé€šé“ï¼Œå¹¶æ¥ç€è®©çº¿ç¨‹æ± åœ¨æ¥æ”¶ç«¯ç­‰å¾…ã€‚è¿™æ®µä»£ç èƒ½å¤Ÿç¼–è¯‘ï¼Œä¸è¿‡ä»æœ‰è­¦å‘Šã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;åœ¨çº¿ç¨‹æ± åˆ›å»ºæ¯ä¸ª worker æ—¶å°†é€šé“çš„æ¥æ”¶ç«¯ä¼ é€’ç»™ä»–ä»¬ã€‚é¡»çŸ¥æˆ‘ä»¬å¸Œæœ›åœ¨ &lt;code&gt;worker&lt;/code&gt; æ‰€åˆ†é…çš„çº¿ç¨‹ä¸­ä½¿ç”¨é€šé“çš„æ¥æ”¶ç«¯ï¼Œæ‰€ä»¥å°†åœ¨é—­åŒ…ä¸­å¼•ç”¨ &lt;code&gt;receiver&lt;/code&gt; å‚æ•°ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æ˜¾ç„¶ä¸Šè¾¹çš„æ¶ˆè´¹è€…æ˜¯æœ‰é—®é¢˜ã€‚ Rust æ‰€æä¾›çš„é€šé“å®ç°æ˜¯å¤šç”Ÿäº§è€…ï¼Œå•æ¶ˆè´¹è€…çš„ï¼Œæ‰€ä»¥ä¸èƒ½ç®€å•çš„å…‹éš†é€šé“çš„æ¶ˆè´¹ç«¯æ¥è§£å†³é—®é¢˜ã€‚å³ä¾¿å¯ä»¥æˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›å…‹éš†æ¶ˆè´¹ç«¯ï¼›åœ¨æ‰€æœ‰çš„&lt;code&gt;worker&lt;/code&gt; ä¸­å…±äº«å•ä¸€ &lt;code&gt;receiver&lt;/code&gt; æ‰æ˜¯æˆ‘ä»¬å¸Œæœ›çš„åœ¨çº¿ç¨‹é—´åˆ†å‘ä»»åŠ¡çš„æœºåˆ¶ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;å¦å¤–ï¼Œä»é€šé“é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ¶‰åŠåˆ°ä¿®æ”¹ &lt;code&gt;receiver&lt;/code&gt;ï¼Œæ‰€ä»¥è¿™äº›çº¿ç¨‹éœ€è¦ä¸€ä¸ªèƒ½å®‰å…¨çš„å…±äº«å’Œä¿®æ”¹ &lt;code&gt;receiver&lt;/code&gt; çš„æ–¹å¼ã€‚å¦‚æœä¿®æ”¹ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåˆ™å¯èƒ½é‡åˆ°ç«äº‰çŠ¶æ€ï¼Œä¾‹å¦‚ä¸¤ä¸ªçº¿ç¨‹å› åŒæ—¶åœ¨é˜Ÿåˆ—ä¸­å–å‡ºç›¸åŒçš„ä»»åŠ¡å¹¶æ‰§è¡Œäº†ç›¸åŒçš„å·¥ä½œã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¿ç¨‹å®‰å…¨æ™ºèƒ½æŒ‡é’ˆï¼Œä¸ºäº†åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ‰€æœ‰æƒå¹¶å…è®¸çº¿ç¨‹ä¿®æ”¹å…¶å€¼ï¼Œéœ€è¦ä½¿ç”¨ &lt;code&gt;Arc&amp;lt;Mutex&amp;lt;T&amp;gt;&amp;gt;&lt;/code&gt;ã€‚&lt;code&gt;Arc&lt;/code&gt; ä½¿å¾—å¤šä¸ª &lt;code&gt;worker&lt;/code&gt; æ‹¥æœ‰æ¥æ”¶ç«¯ï¼Œè€Œ &lt;code&gt;Mutex&lt;/code&gt; åˆ™ç¡®ä¿ä¸€æ¬¡åªæœ‰ä¸€ä¸ª &lt;code&gt;worker&lt;/code&gt; èƒ½ä»æ¥æ”¶ç«¯å¾—åˆ°ä»»åŠ¡ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;so æˆ‘çš„ä»£ç å°±æ”¹æˆè¿™æ ·äº†&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt; use std::sync::Arc;&#xA;use std::sync::Mutex;&#xA;&#xA;// ...snip...&#xA;&#xA;impl ThreadPool {&#xA;    // ...snip...&#xA;    pub fn new(size: usize) -&amp;gt; ThreadPool {&#xA;        assert!(size &amp;gt; 0);&#xA;&#xA;        let (sender, receiver) = mpsc::channel();&#xA;&#xA;        let receiver = Arc::new(Mutex::new(receiver));&#xA;&#xA;        let mut workers = Vec::with_capacity(size);&#xA;&#xA;        for id in 0..size {&#xA;            workers.push(Worker::new(id, receiver.clone()));&#xA;        }&#xA;&#xA;        ThreadPool {&#xA;            workers,&#xA;            sender,&#xA;        }&#xA;    }&#xA;    // ...snip...&#xA;}&#xA;impl Worker {&#xA;    fn new(id: usize, receiver: Arc&amp;lt;Mutex&amp;lt;mpsc::Receiver&amp;lt;Job&amp;gt;&amp;gt;&amp;gt;) -&amp;gt; Worker {&#xA;        // ...snip...&#xA;    }&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;è®©æˆ‘ä»¬å®ç° &lt;code&gt;ThreadPool&lt;/code&gt; ä¸Šçš„ &lt;code&gt;execute&lt;/code&gt; æ–¹æ³•ã€‚åŒæ—¶ä¹Ÿè¦ä¿®æ”¹ &lt;code&gt;Job&lt;/code&gt; ç»“æ„ä½“ï¼šå®ƒå°†ä¸å†æ˜¯ç»“æ„ä½“ï¼Œ&lt;code&gt;Job&lt;/code&gt; å°†æ˜¯ä¸€ä¸ªæœ‰ç€ &lt;code&gt;execute&lt;/code&gt; æ¥æ”¶åˆ°çš„é—­åŒ…ç±»å‹çš„ &lt;code&gt;trait&lt;/code&gt; å¯¹è±¡çš„ç±»å‹åˆ«åã€‚åœ¨ worker ä¸­ï¼Œä¼ é€’ç»™ &lt;code&gt;thread::spawn&lt;/code&gt; çš„é—­åŒ…ä»ç„¶è¿˜åªæ˜¯å¼•ç”¨äº†é€šé“çš„æ¥æ”¶ç«¯ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦é—­åŒ…ä¸€ç›´å¾ªç¯ï¼Œå‘é€šé“çš„æ¥æ”¶ç«¯è¯·æ±‚ä»»åŠ¡ï¼Œå¹¶åœ¨å¾—åˆ°ä»»åŠ¡æ—¶æ‰§è¡Œä»–ä»¬ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;&#xA;type Job = Box&amp;lt;FnOnce() + Send + &#39;static&amp;gt;;&#xA;&#xA;impl ThreadPool {&#xA;    // ...snip...&#xA;&#xA;    pub fn execute&amp;lt;F&amp;gt;(&amp;amp;self, f: F)&#xA;        where&#xA;            F: FnOnce() + Send + &#39;static&#xA;    {&#xA;        let job = Box::new(f);&#xA;&#xA;        self.sender.send(job).unwrap();&#xA;    }&#xA;}&#xA;&#xA;&#xA;impl Worker {&#xA;    fn new(id: usize, receiver: Arc&amp;lt;Mutex&amp;lt;mpsc::Receiver&amp;lt;Job&amp;gt;&amp;gt;&amp;gt;) -&amp;gt; Worker {&#xA;        let thread = thread::spawn(move || {&#xA;            loop {&#xA;                let job = receiver.lock().unwrap().recv().unwrap();&#xA;&#xA;                println!(&amp;quot;Worker {} got a job; executing.&amp;quot;, id);&#xA;&#xA;                (*job)();&#xA;            }&#xA;        });&#xA;&#xA;        Worker {&#xA;            id,&#xA;            thread,&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœç°åœ¨ç¼–è¯‘æˆ‘ä»¬çš„ä»£ç ï¼Œè¿˜æ˜¯ä¼šå‡ºç°é”™è¯¯&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;error[E0161]: cannot move a value of type std::ops::FnOnce() +&#xA;std::marker::Send: the size of std::ops::FnOnce() + std::marker::Send cannot be&#xA;statically determined&#xA;  --&amp;gt; src/lib.rs:63:17&#xA;   |&#xA;63 |                 (*job)();&#xA;   |                 ^^^^^^&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;ä¸ºäº†è°ƒç”¨å‚¨å­˜åœ¨ &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt;ï¼ˆè¿™æ­£æ˜¯ Job åˆ«åçš„ç±»å‹ï¼‰ä¸­çš„ &lt;code&gt;FnOnce&lt;/code&gt; é—­åŒ…ï¼Œè¯¥é—­åŒ…éœ€è¦èƒ½å°†è‡ªå·±ç§»åŠ¨å‡º &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt;ï¼Œå› ä¸ºå½“è°ƒç”¨è¿™ä¸ªé—­åŒ…æ—¶ï¼Œå®ƒè·å– &lt;code&gt;self&lt;/code&gt; çš„æ‰€æœ‰æƒã€‚é€šå¸¸æ¥è¯´ï¼Œå°†å€¼ç§»åŠ¨å‡º &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt; æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸º Rust ä¸çŸ¥é“ &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt; ä¸­çš„å€¼å°†ä¼šæœ‰å¤šå¤§ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code&gt;self: Box&amp;lt;Self&amp;gt;&lt;/code&gt;è¯­æ³•çš„æ–¹æ³•ï¼Œè·å–äº†å‚¨å­˜åœ¨ &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt; ä¸­çš„ &lt;code&gt;Self&lt;/code&gt; å€¼çš„æ‰€æœ‰æƒã€‚è¿™æ­£æ˜¯æˆ‘ä»¬å¸Œæœ›åšçš„ï¼Œç„¶è€Œä¸å¹¸çš„æ˜¯ Rust è°ƒç”¨é—­åŒ…çš„é‚£éƒ¨åˆ†å®ç°å¹¶æ²¡æœ‰ä½¿ç”¨ &lt;code&gt;self: Box&amp;lt;Self&amp;gt;&lt;/code&gt;ã€‚æ‰€ä»¥è¿™é‡Œ Rust ä¹Ÿä¸çŸ¥é“å®ƒå¯ä»¥ä½¿ç”¨ &lt;code&gt;self: Box&amp;lt;Self&amp;gt;&lt;/code&gt; æ¥è·å–é—­åŒ…çš„æ‰€æœ‰æƒå¹¶å°†é—­åŒ…ç§»åŠ¨å‡º &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸è¿‡ç›®å‰è®©æˆ‘ä»¬ç»•è¿‡è¿™ä¸ªé—®é¢˜ã€‚æ‰€å¹¸æœ‰ä¸€ä¸ªæŠ€å·§å¯ä»¥æ˜¾å¼çš„å‘Šè¯‰ Rust æˆ‘ä»¬å¤„äºå¯ä»¥è·å–ä½¿ç”¨ &lt;code&gt;self: Box&amp;lt;Self&amp;gt;&lt;/code&gt; çš„ &lt;code&gt;Box&amp;lt;T&amp;gt;&lt;/code&gt; ä¸­å€¼çš„æ‰€æœ‰æƒçš„çŠ¶æ€ï¼Œè€Œä¸€æ—¦è·å–äº†é—­åŒ…çš„æ‰€æœ‰æƒå°±å¯ä»¥è°ƒç”¨å®ƒäº†ã€‚è¿™æ¶‰åŠåˆ°å®šä¹‰ä¸€ä¸ªæ–° &lt;code&gt;trait&lt;/code&gt;ï¼Œå®ƒå¸¦æœ‰ä¸€ä¸ªåœ¨ç­¾åä¸­ä½¿ç”¨ &lt;code&gt;self: Box&amp;lt;Self&amp;gt;&lt;/code&gt; çš„æ–¹æ³• &lt;code&gt;call_box&lt;/code&gt;ï¼Œä¸ºä»»ä½•å®ç°äº† &lt;code&gt;FnOnce()&lt;/code&gt;çš„ç±»å‹å®šä¹‰è¿™ä¸ª &lt;code&gt;trait&lt;/code&gt;ï¼Œä¿®æ”¹ç±»å‹åˆ«åæ¥ä½¿ç”¨è¿™ä¸ªæ–° &lt;code&gt;trait&lt;/code&gt;ï¼Œå¹¶ä¿®æ”¹ &lt;code&gt;Worker&lt;/code&gt; ä½¿ç”¨ &lt;code&gt;call_box&lt;/code&gt; æ–¹æ³•&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;trait FnBox {&#xA;    fn call_box(self: Box&amp;lt;Self&amp;gt;);&#xA;}&#xA;&#xA;impl&amp;lt;F: FnOnce()&amp;gt; FnBox for F {&#xA;    fn call_box(self: Box&amp;lt;F&amp;gt;) {&#xA;        (*self)()&#xA;    }&#xA;}&#xA;&#xA;type Job = Box&amp;lt;FnBox + Send + &#39;static&amp;gt;;&#xA;&#xA;// ...snip...&#xA;&#xA;impl Worker {&#xA;    fn new(id: usize, receiver: Arc&amp;lt;Mutex&amp;lt;mpsc::Receiver&amp;lt;Job&amp;gt;&amp;gt;&amp;gt;) -&amp;gt; Worker {&#xA;        let thread = thread::spawn(move || {&#xA;            loop {&#xA;                let job = receiver.lock().unwrap().recv().unwrap();&#xA;&#xA;                println!(&amp;quot;Worker {} got a job; executing.&amp;quot;, id);&#xA;&#xA;                job.call_box();&#xA;            }&#xA;        });&#xA;&#xA;        Worker {&#xA;            id,&#xA;            thread,&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;Graceful Shutdown ä¸æ¸…ç†&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;å¦‚æœæˆ‘ä»¬ç¼–è¯‘ä¸Šè¿°è¡¨ç¤ºçš„ä»£ç ï¼Œä¼šæœ‰ä¸€äº›è­¦å‘Šè¯´å­˜åœ¨ä¸€äº›å­—æ®µå¹¶æ²¡æœ‰ç›´æ¥è¢«ä½¿ç”¨ï¼Œè¿™æé†’äº†æˆ‘ä»¬å¹¶æ²¡æœ‰æ¸…ç†ä»»ä½•å†…å®¹ã€‚å½“ä½¿ç”¨ &lt;code&gt;ctrl-C&lt;/code&gt; ç»ˆæ­¢ä¸»çº¿ç¨‹ï¼Œæ‰€æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿä¼šç«‹åˆ»åœæ­¢ï¼Œå³ä¾¿ä»–ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚ç°åœ¨æˆ‘ä»¬è¦ä¸º &lt;code&gt;ThreadPool&lt;/code&gt; å®ç° &lt;code&gt;Drop trait&lt;/code&gt; å¯¹çº¿ç¨‹æ± ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ &lt;code&gt;join&lt;/code&gt;ï¼Œè¿™æ ·è¿™äº›çº¿ç¨‹å°†ä¼šæ‰§è¡Œå®Œä»–ä»¬çš„è¯·æ±‚ã€‚æ¥ç€ä¼šä¸º &lt;code&gt;ThreadPool&lt;/code&gt; å®ç°ä¸€ä¸ªæ–¹æ³•æ¥å‘Šè¯‰çº¿ç¨‹ä»–ä»¬åº”è¯¥åœæ­¢æ¥æ”¶æ–°è¯·æ±‚å¹¶ç»“æŸã€‚ä¸ºäº†å®è·µè¿™äº›ä»£ç ï¼Œä¿®æ”¹ &lt;code&gt;server&lt;/code&gt; åœ¨ &lt;code&gt;graceful Shutdown&lt;/code&gt; ä¹‹å‰åªæ¥å—ä¸¤ä¸ªè¯·æ±‚ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;enum Message {&#xA;    NewJob(Job),&#xA;    Terminate,&#xA;}&#xA;&#xA;pub struct ThreadPool {&#xA;    workers: Vec&amp;lt;Worker&amp;gt;,&#xA;    sender: mpsc::Sender&amp;lt;Message&amp;gt;,&#xA;}&#xA;&#xA;// ...snip...&#xA;&#xA;impl ThreadPool {&#xA;    // ...snip...&#xA;    pub fn new(size: usize) -&amp;gt; ThreadPool {&#xA;        assert!(size &amp;gt; 0);&#xA;&#xA;        let (sender, receiver) = mpsc::channel();&#xA;&#xA;        // ...snip...&#xA;    }&#xA;&#xA;    pub fn execute&amp;lt;F&amp;gt;(&amp;amp;self, f: F)&#xA;        where&#xA;            F: FnOnce() + Send + &#39;static&#xA;    {&#xA;        let job = Box::new(f);&#xA;&#xA;        self.sender.send(Message::NewJob(job)).unwrap();&#xA;    }&#xA;}&#xA;&#xA;// ...snip...&#xA;&#xA;impl Worker {&#xA;    fn new(id: usize, receiver: Arc&amp;lt;Mutex&amp;lt;mpsc::Receiver&amp;lt;Message&amp;gt;&amp;gt;&amp;gt;) -&amp;gt;&#xA;        Worker {&#xA;&#xA;        let thread = thread::spawn(move ||{&#xA;            loop {&#xA;                let message = receiver.lock().unwrap().recv().unwrap();&#xA;&#xA;                match message {&#xA;                    Message::NewJob(job) =&amp;gt; {&#xA;                        println!(&amp;quot;Worker {} got a job; executing.&amp;quot;, id);&#xA;&#xA;                        job.call_box();&#xA;                    },&#xA;                    Message::Terminate =&amp;gt; {&#xA;                        println!(&amp;quot;Worker {} was told to terminate.&amp;quot;, id);&#xA;&#xA;                        break;&#xA;                    },&#xA;                }&#xA;            }&#xA;        });&#xA;&#xA;        Worker {&#xA;            id,&#xA;            thread: Some(thread),&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;æ”¶å‘ &lt;code&gt;Message&lt;/code&gt; å€¼å¹¶åœ¨ Worker æ”¶åˆ° &lt;code&gt;Message::Terminate&lt;/code&gt; æ—¶é€€å‡ºå¾ªç¯&lt;/p&gt;&#xA;&#xA;&lt;p&gt;éœ€è¦å°† &lt;code&gt;ThreadPool&lt;/code&gt; å®šä¹‰ã€åˆ›å»ºé€šé“çš„ &lt;code&gt;ThreadPool::new&lt;/code&gt; å’Œ &lt;code&gt;Worker::new&lt;/code&gt; ç­¾åä¸­çš„ &lt;code&gt;Job&lt;/code&gt; æ”¹ä¸º &lt;code&gt;Message&lt;/code&gt;ã€‚&lt;code&gt;ThreadPool&lt;/code&gt; çš„ &lt;code&gt;execute&lt;/code&gt; æ–¹æ³•éœ€è¦å‘é€å°è£…è¿› &lt;code&gt;Message::NewJob&lt;/code&gt; æˆå‘˜çš„ä»»åŠ¡ï¼Œå½“è·å–åˆ° &lt;code&gt;NewJob&lt;/code&gt; æ—¶ä¼šå¤„ç†ä»»åŠ¡è€Œæ”¶åˆ° &lt;code&gt;Terminate&lt;/code&gt; æˆå‘˜æ—¶åˆ™ä¼šé€€å‡ºå¾ªç¯ã€‚&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;impl Drop for ThreadPool {&#xA;    fn drop(&amp;amp;mut self) {&#xA;        println!(&amp;quot;Sending terminate message to all workers.&amp;quot;);&#xA;&#xA;        for _ in &amp;amp;mut self.workers {&#xA;            self.sender.send(Message::Terminate).unwrap();&#xA;        }&#xA;&#xA;        println!(&amp;quot;Shutting down all workers.&amp;quot;);&#xA;&#xA;        for worker in &amp;amp;mut self.workers {&#xA;            println!(&amp;quot;Shutting down worker {}&amp;quot;, worker.id);&#xA;&#xA;            if let Some(thread) = worker.thread.take() {&#xA;                thread.join().unwrap();&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;åœ¨å¯¹æ¯ä¸ª &lt;code&gt;worker&lt;/code&gt; çº¿ç¨‹è°ƒç”¨ &lt;code&gt;join&lt;/code&gt; ä¹‹å‰å‘ &lt;code&gt;worker&lt;/code&gt; å‘é€ &lt;code&gt;Message::Terminate&lt;/code&gt;&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ç°åœ¨éå†äº† &lt;code&gt;worker&lt;/code&gt; ä¸¤æ¬¡ï¼Œä¸€æ¬¡å‘æ¯ä¸ª &lt;code&gt;worker&lt;/code&gt; å‘é€ä¸€ä¸ª &lt;code&gt;Terminate&lt;/code&gt; æ¶ˆæ¯ï¼Œä¸€ä¸ªè°ƒç”¨æ¯ä¸ª &lt;code&gt;worker&lt;/code&gt; çº¿ç¨‹ä¸Šçš„ &lt;code&gt;join&lt;/code&gt;ã€‚å¦‚æœå°è¯•åœ¨åŒä¸€å¾ªç¯ä¸­å‘é€æ¶ˆæ¯å¹¶ç«‹å³ &lt;code&gt;join&lt;/code&gt; çº¿ç¨‹ï¼Œåˆ™æ— æ³•ä¿è¯å½“å‰è¿­ä»£çš„ &lt;code&gt;worker&lt;/code&gt; æ˜¯ä»é€šé“æ”¶åˆ°ç»ˆæ­¢æ¶ˆæ¯çš„&lt;code&gt;worker&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸ºäº†æ›´å¥½çš„ç†è§£ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªåˆ†å¼€çš„å¾ªç¯ï¼Œæƒ³è±¡ä¸€ä¸‹åªæœ‰ä¸¤ä¸ª &lt;code&gt;worker&lt;/code&gt; çš„åœºæ™¯ã€‚å¦‚æœåœ¨ä¸€ä¸ªå¾ªç¯ä¸­éå†æ¯ä¸ª&lt;code&gt;worker&lt;/code&gt;ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¿­ä»£ä¸­ &lt;code&gt;worker&lt;/code&gt; æ˜¯ç¬¬ä¸€ä¸ª &lt;code&gt;worker&lt;/code&gt;ï¼Œæˆ‘ä»¬å‘é€šé“å‘å‡ºç»ˆæ­¢æ¶ˆæ¯å¹¶å¯¹ç¬¬ä¸€ä¸ª &lt;code&gt;worker&lt;/code&gt; çº¿ç¨‹è°ƒç”¨ &lt;code&gt;join&lt;/code&gt;ã€‚å¦‚æœç¬¬ä¸€ä¸ª &lt;code&gt;worker&lt;/code&gt; å½“æ—¶æ­£å¿™äºå¤„ç†è¯·æ±‚ï¼Œåˆ™ç¬¬äºŒä¸ª &lt;code&gt;worker&lt;/code&gt; ä¼šä»é€šé“æ¥æ”¶è¿™ä¸ªç»ˆæ­¢æ¶ˆæ¯å¹¶ç»“æŸã€‚è€Œæˆ‘ä»¬åœ¨ç­‰å¾…ç¬¬ä¸€ä¸ª &lt;code&gt;worker&lt;/code&gt; ç»“æŸï¼Œä¸è¿‡å®ƒæ°¸è¿œä¹Ÿä¸ä¼šç»“æŸå› ä¸ºç¬¬äºŒä¸ªçº¿ç¨‹å–èµ°äº†ç»ˆæ­¢æ¶ˆæ¯ã€‚ç°åœ¨æˆ‘ä»¬å°±é˜»å¡åœ¨äº†ç­‰å¾…ç¬¬ä¸€ä¸ª &lt;code&gt;worker&lt;/code&gt; ç»“æŸï¼Œè€Œæ— æ³•å‘å‡ºç¬¬äºŒæ¡ç»ˆæ­¢æ¶ˆæ¯ã€‚æ­»é”ï¼&lt;/p&gt;&#xA;&#xA;&lt;p&gt;ä¸ºäº†é¿å…æ­¤æƒ…å†µï¼Œé¦–å…ˆä»é€šé“ä¸­å–å‡ºæ‰€æœ‰çš„ &lt;code&gt;Terminate&lt;/code&gt; æ¶ˆæ¯ï¼Œæ¥ç€ &lt;code&gt;join&lt;/code&gt; æ‰€æœ‰çš„çº¿ç¨‹ã€‚å› ä¸ºæ¯ä¸ª &lt;code&gt;worker&lt;/code&gt; ä¸€æ—¦æ”¶åˆ°ç»ˆæ­¢æ¶ˆæ¯å³ä¼šåœæ­¢ä»é€šé“æ¥æ”¶æ¶ˆæ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç¡®ä¿å¦‚æœå‘é€åŒ &lt;code&gt;worker&lt;/code&gt; æ•°ç›¸åŒçš„ç»ˆæ­¢æ¶ˆæ¯ï¼Œåœ¨ &lt;code&gt;join&lt;/code&gt; ä¹‹å‰æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªç»ˆæ­¢æ¶ˆæ¯ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h4&gt;ç®€æ˜“çº¿ç¨‹æ± å®Œæ•´ä»£ç &lt;/h4&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;// lib.rs&#xA;use std::thread;&#xA;use std::sync::mpsc;&#xA;use std::sync::Arc;&#xA;use std::sync::Mutex;&#xA;&#xA;enum Message {&#xA;    NewJob(Job),&#xA;    Terminate,&#xA;}&#xA;&#xA;pub struct ThreadPool{&#xA;    workers: Vec&amp;lt;Worker&amp;gt;,&#xA;    sender: mpsc::Sender&amp;lt;Message&amp;gt;,&#xA;}&#xA;&#xA;type Job = Box&amp;lt;FnBox + Send + &#39;static&amp;gt;;&#xA;&#xA;impl ThreadPool {&#xA;    /// Create a new ThreadPool.&#xA;    ///&#xA;    /// The size is the number of threads in the pool.&#xA;    ///&#xA;    /// # Panics&#xA;    ///&#xA;    /// The `new` function will panic if the size is zero.&#xA;    pub fn new(size :usize) -&amp;gt;ThreadPool{&#xA;        assert!(size &amp;gt; 0);&#xA;&#xA;        let (sender, receiver) = mpsc::channel();&#xA;&#xA;        let receiver = Arc::new(Mutex::new(receiver));&#xA;&#xA;        let mut workers = Vec::with_capacity(size);&#xA;&#xA;        for id in 0..size {&#xA;            workers.push(Worker::new(id, receiver.clone()));&#xA;        }&#xA;&#xA;        ThreadPool {&#xA;            workers,&#xA;            sender,&#xA;        }&#xA;    }&#xA;&#xA;    pub fn execute&amp;lt;F&amp;gt; (&amp;amp;self, f: F)&#xA;        where&#xA;        F: FnOnce() + Send + &#39;static&#xA;    {&#xA;        let job = Box::new(f);&#xA;        self.sender.send(Message::NewJob(job)).unwrap();&#xA;    }&#xA;}&#xA;&#xA;impl Drop for ThreadPool {&#xA;    fn drop(&amp;amp;mut self) {&#xA;        println!(&amp;quot;Sending terminate message to all workers.&amp;quot;);&#xA;&#xA;        for _ in &amp;amp;mut self.workers {&#xA;            self.sender.send(Message::Terminate).unwrap();&#xA;        }&#xA;&#xA;        println!(&amp;quot;Shutting down all workers.&amp;quot;);&#xA;&#xA;        for worker in &amp;amp;mut self.workers {&#xA;            println!(&amp;quot;Shutting down worker {}&amp;quot;, worker.id);&#xA;&#xA;            if let Some(thread) = worker.thread.take() {&#xA;                thread.join().unwrap();&#xA;            }&#xA;        }&#xA;    }&#xA;}&#xA;&#xA;trait FnBox {&#xA;    fn call_box(self: Box&amp;lt;Self&amp;gt;);&#xA;}&#xA;&#xA;impl&amp;lt;F: FnOnce()&amp;gt; FnBox for F {&#xA;    fn call_box(self: Box&amp;lt;F&amp;gt;) {&#xA;        (*self)()&#xA;    }&#xA;}&#xA;&#xA;struct Worker {&#xA;    id: usize,&#xA;    thread: Option&amp;lt;thread::JoinHandle&amp;lt;()&amp;gt;&amp;gt;,&#xA;}&#xA;&#xA;impl Worker {&#xA;    fn new(id: usize, receiver: Arc&amp;lt;Mutex&amp;lt;mpsc::Receiver&amp;lt;Message&amp;gt;&amp;gt;&amp;gt;) -&amp;gt; Worker {&#xA;        let thread = thread::spawn(move || {&#xA;            loop {&#xA;                let message = receiver.lock().unwrap().recv().unwrap();&#xA;&#xA;                match message {&#xA;                    Message::NewJob(job) =&amp;gt; {&#xA;                        println!(&amp;quot;Worker {} got a job; executing.&amp;quot;, id);&#xA;&#xA;                        job.call_box();&#xA;                    },&#xA;                    Message::Terminate =&amp;gt; {&#xA;                        println!(&amp;quot;Worker {} was told to terminate.&amp;quot;, id);&#xA;&#xA;                        break;&#xA;                    },&#xA;                }&#xA;            }&#xA;        });&#xA;&#xA;        Worker {&#xA;            id,&#xA;            thread: Some(thread),&#xA;        }&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://doc.rust-lang.org/book/second-edition/ch20-00-final-project-a-web-server.html&#34;&gt;The Rust Programming Language&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://kaisery.github.io/trpl-zh-cn/&#34;&gt;Rustç¨‹åºè®¾è®¡-ä¸­æ–‡ç‰ˆ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/rust ç¬”è®° - æ„å»ºå¤šçº¿ç¨‹ web server.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>GFS ç¬”è®° - MIT-6.824</title>
    <updated>2017-08-31T00:00:00Z</updated>
    <id>tag:int64.me,2017-08-31:/2017/GFS ç¬”è®° - MIT-6.824.html</id>
    <content type="html">&lt;p&gt;GFSæ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå¤§å‹çš„ã€åˆ†å¸ƒå¼çš„ã€å¯¹å¤§é‡æ•°æ®è¿›è¡Œè®¿é—®çš„åº”ç”¨ã€‚å®ƒè¿è¡Œäºå»‰ä»·çš„æ™®é€šç¡¬ä»¶ä¸Šï¼Œå¹¶æä¾›å®¹é”™åŠŸèƒ½ã€‚å®ƒå¯ä»¥ç»™å¤§é‡çš„ç”¨æˆ·æä¾›æ€»ä½“æ€§èƒ½è¾ƒé«˜çš„æœåŠ¡&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸€ä¸ªæ­£ç¡®æ€§æ¡ä»¶&lt;/li&gt;&#xA;&lt;li&gt;å½“å­˜åœ¨å‰¯æœ¬å’Œç¨‹åºå¹¶å‘è®¿é—®çš„æ—¶å€™ï¼Œä¸€è‡´æ€§æ˜¯å¾ˆé‡è¦çš„&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœä¸€ä¸ªåº”ç”¨è¿›è¡Œå†™æ“ä½œï¼Œé‚£ä¹ˆä¹‹åçš„è¯»æ“ä½œå¯ä»¥è§‚å¯Ÿåˆ°ä»€ä¹ˆï¼Ÿå¦‚æœè¿™ä¸ªè¯»æ“ä½œæ¥è‡ªå…¶ä»–åº”ç”¨ç¨‹åºåˆä¼šçœ‹åˆ°ä»€ä¹ˆï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å¼±ä¸€è‡´æ€§&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;read() å¯èƒ½è¿”å›æ—§çš„æ•°æ® &amp;mdash; ä¸æ˜¯æœ€æ–°å†™å…¥çš„æ•°æ®&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å¼ºä¸€è‡´æ€§&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;read() æ€»æ˜¯è¿”å›æœ€æ–°å†™å…¥çš„æ•°æ®&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;ä¸€èˆ¬çš„æƒè¡¡&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¼ºä¸€è‡´æ€§å¯¹ç¨‹åºçš„å†™æ“ä½œï¼ˆapplication writersï¼‰è¡¨ç°ä¸é”™&lt;/li&gt;&#xA;&lt;li&gt;å¼ºä¸€è‡´æ€§å¯¹æ€§èƒ½æœ‰ä¸€å®šçš„å½±å“&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;æ›´å¤šçš„æ­£ç¡®æ€§æ¡ä»¶ï¼ˆé€šå¸¸è¢«ç§°ä¸ºä¸€è‡´æ€§æ¨¡å‹ï¼‰&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;&amp;ldquo;ç†æƒ³&amp;rdquo; çš„ä¸€è‡´æ€§æ¨¡å‹&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸€ä¸ªæœ‰å‰¯æœ¬çš„æ–‡ä»¶ç³»ç»Ÿå’Œä¸€ä¸ªæ²¡æœ‰å‰¯æœ¬çš„æ–‡ä»¶ç³»ç»Ÿè¡¨ç°çš„ä¸€æ ·ï¼Œå°±åƒè®¸å¤šå®¢æˆ·ç«¯è®¿é—®ç—›ä¸€å°æœºå™¨ä¸Šçš„å•ç‹¬ç£ç›˜&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœä¸€ä¸ªç¨‹åºå†™æ•°æ®ï¼Œé‚£ä¹ˆä¹‹åçš„å°±å¯ä»¥è¯»åˆ°ä¹‹å‰å†™çš„æ•°æ®&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœä¸¤ä¸ªç¨‹åºå¹¶å‘çš„å†™åŒä¸€ä¸ªæ–‡ä»¶å‘¢ï¼Ÿ&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è¿™ç§è¡Œä¸ºç»å¸¸æ˜¯æœªå®šä¹‰çš„ â€”â€” æ–‡ä»¶ä¹Ÿè®¸ä¼šæ··åˆä¸¤ä¸ªå†™æ“ä½œçš„å†…å®¹&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœä¸¤ä¸ªç¨‹åºå¹¶å‘çš„å†™åŒä¸€ä¸ªç›®å½•å‘¢ï¼Ÿ&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸€ä¸ªä¸€ä¸ªé¡ºåºæ‰§è¡Œ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å»å®ç°ç†æƒ³çš„ä¸€è‡´æ€§çš„æŒ‘æˆ˜&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¹¶å‘&lt;/li&gt;&#xA;&lt;li&gt;æœºå™¨å¤±è´¥&lt;/li&gt;&#xA;&lt;li&gt;ç½‘ç»œåˆ†å‰²&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;ä¸ºä»€ä¹ˆå»å…‹æœè¿™äº›æŒ‘æˆ˜æ˜¯å›°éš¾çš„ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;clients å’Œ servers ä¹‹å‰è¦æ±‚é€šä¿¡ï¼Œå¯èƒ½ä¼šæ¶ˆè€—æ€§èƒ½&lt;/li&gt;&#xA;&lt;li&gt;åè®®å¯èƒ½å˜å¾—å¤æ‚ &amp;mdash;  åé¢çš„è¯¾ç¨‹æˆ‘ä»¬ä¼šçœ‹åˆ°å¾ˆéš¾å®ç°æ­£ç¡®çš„ç³»ç»Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;GFS ä¸­çš„ä¸»è¦æŒ‘æˆ˜&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å­˜åœ¨è®¸å¤šæœºå™¨ï¼Œæ‰€æœ‰æœºå™¨å‡ºç°æ•…éšœæ˜¯å¾ˆå¸¸è§çš„ç°è±¡ï¼Œå‡è®¾ä¸€å°æœºå™¨ä¸€å¹´å‡ºé”™ä¸€æ¬¡ï¼Œé‚£ä¹ˆå½“å­˜åœ¨1000å°æœºå™¨çš„æ—¶å€™ï¼Œæ¯å¤©éƒ½æœ‰ä¸‰å°æœºå™¨å‡ºç°é—®é¢˜ã€‚&lt;/li&gt;&#xA;&lt;li&gt;é«˜æ€§èƒ½ï¼šå¾ˆå¤šå¹¶å‘çš„è¯»å†™æ“ä½œï¼ŒMap/Reduceå·¥ä½œä¼šä» GFS è¯»å–æ•°æ®ï¼Œç„¶åä¿å­˜æœ€åçš„ç»“æœï¼Œæ³¨æ„ï¼šä¿å­˜çš„ä¸æ˜¯ä¸­é—´ä¸´æ—¶æ–‡ä»¶ã€‚&lt;/li&gt;&#xA;&lt;li&gt;æœ‰æ•ˆçš„ä½¿ç”¨ç½‘ç»œ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;é«˜å±‚æ¬¡çš„è®¾è®¡&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®šä¹‰ç›®å½•ã€æ–‡ä»¶ã€å‘½åã€æ‰“å¼€/è¯»/å†™æ“ä½œï¼Œä½†æ˜¯ä¸æ˜¯ç¬¦åˆposixæ ‡å‡†&lt;/li&gt;&#xA;&lt;li&gt;æˆåƒä¸Šç™¾çš„å¸¦æœ‰ç¡¬ç›˜çš„ linux æœåŠ¡å™¨&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å­˜å‚¨64MBçš„å—(an ordinary Linux file for each chunk)&lt;/li&gt;&#xA;&lt;li&gt;each chunk åœ¨ä¸‰ä¸ªæœåŠ¡å™¨ä¸Šå­˜åœ¨å‰¯æœ¬&lt;/li&gt;&#xA;&lt;li&gt;Q: ä¸ºä»€ä¹ˆä¸‰å‰¯æœ¬ï¼Ÿ&lt;/li&gt;&#xA;&lt;li&gt;Qï¼šé™¤äº†æ•°æ®çš„å¯ç”¨æ€§ï¼Œä¸‰å‰¯æœ¬æ–¹æ¡ˆç»™æˆ‘ä»¬å¸¦æ¥äº†ä»€ä¹ˆï¼Ÿå¯¹çƒ­ç‚¹æ–‡ä»¶çš„è¯»å–åšè´Ÿè½½å‡è¡¡&lt;/li&gt;&#xA;&lt;li&gt;Q: ä¸ºä»€ä¹ˆä¸åªå­˜å‚¨ä¸€ä»½æ–‡ä»¶åˆ° RAID ç£ç›˜ï¼Ÿ RAID ç£ç›˜ä¸æ˜¯å¸¸ç”¨å“ï¼Œæˆ‘ä»¬æƒ³ç»™æ•´å°æœºå™¨åšå®¹é”™ï¼Œè€Œä¸æ˜¯ä»…ä»…é’ˆå¯¹å­˜å‚¨ç³»ç»Ÿã€‚&lt;/li&gt;&#xA;&lt;li&gt;Q: ä¸ºä»€ä¹ˆ chunks è¿™ä¹ˆå¤§ï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;GFS çš„ master server çŸ¥é“ç›®å½•å±‚çº§&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¯¹äºç›®å½•è€Œè¨€ï¼ŒçŸ¥é“é‡Œé¢æœ‰å“ªäº›æ–‡ä»¶&lt;/li&gt;&#xA;&lt;li&gt;å¯¹äºä¸ºéš¾è€Œè¨€ï¼ŒçŸ¥é“å“ªäº›æ•°æ®å—æœåŠ¡å™¨å­˜å‚¨äº†ç›¸å…³çš„64MBå¤§å°æ•°æ®å—&lt;/li&gt;&#xA;&lt;li&gt;master server åœ¨å†…å­˜é‡Œé¢ä¿å­˜çŠ¶æ€ä¿¡æ¯ï¼Œæ¯ä¸ªchunkåœ¨ä¸»æ§æœåŠ¡å™¨ä¸Šé¢åªä¿å­˜64byteså¤§å°çš„metadata&lt;/li&gt;&#xA;&lt;li&gt;master server æœ‰ä¸ºå…ƒæ•°æ®å‡†å¤‡çš„å¯å›æ”¶æ•°æ®åº“ï¼Œå¯ä»¥ä»æ–­ç”µæ•…éšœåå¿«é€Ÿæ¢å¤&lt;/li&gt;&#xA;&lt;li&gt;åŒæ—¶å­˜åœ¨å¤‡ä»½çš„ä¸»æ§æœåŠ¡å™¨(shadow master)ï¼Œæ•°æ®ç•¥æ¯”ä¸»æ§æœåŠ¡å™¨æœåŠ¡å™¨å»¶è¿Ÿï¼Œå¯ä»¥è¢«æå‡ä¸ºä¸»æ§æœåŠ¡å™¨&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;åŸºç¡€çš„æ–‡ä»¶æ“ä½œ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯è¯»æ“ä½œ&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯å‘é€æ–‡ä»¶åå’Œåç§»é‡åˆ° master&lt;/li&gt;&#xA;&lt;li&gt;ä¸»æ§æœåŠ¡å™¨å›å¤å¸¦æœ‰ç›¸å…³ chunk çš„æ•°æ®å—æœåŠ¡å™¨é›†åˆï¼Œç›¸åº”ä¿¡æ¯åŒ…æ‹¬ç‰ˆæœ¬ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¸´æ—¶ç¼“å­˜è¿™äº›ä¿¡æ¯ï¼Œç„¶åè®¿é—®æœ€è¿‘çš„æ•°æ®å—æœåŠ¡å™¨ï¼Œç‰ˆæœ¬æ£€æŸ¥ï¼Œå¦‚æœç‰ˆæœ¬æ˜¯ä¸æ­£ç¡®çš„ï¼Œé‡æ–°ä» master è·å–æœ€æ–°çš„æ•°æ®&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯ append&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯è¯¢é—® master å»å­˜å‚¨åœ¨ä»€ä¹ˆåœ°æ–¹&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœæ–‡ä»¶å¤§å°è¶…è¿‡64MBï¼Œmaster ä¹Ÿè®¸ä¼šé€‰æ‹©ä¸€äº›æ–°çš„æ•°æ®å—æœåŠ¡å™¨&lt;/li&gt;&#xA;&lt;li&gt;master æŠŠ chunk servers å’Œç‰ˆæœ¬ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå…¶ä¸­ä¸€ä¸ª chunk æ˜¯ primary&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯æŠŠæ•°æ®æ¨é€çš„å‰¯æœ¬&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å‰¯æœ¬æ„æˆä¸€ä¸ªé“¾è¡¨&lt;/li&gt;&#xA;&lt;li&gt;é“¾è¡¨æ¶‰åŠåˆ°ç½‘ç»œæ‹“æ‰‘&lt;/li&gt;&#xA;&lt;li&gt;å…è®¸å¿«é€Ÿå¤æ‚&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å½“æ•°æ®éƒ½åœ¨æ‰€æœ‰çš„ chunk servers æ—¶å€™å®¢æˆ·ç«¯ä¸ primary server æ²Ÿé€š&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;primary åˆ†é…åºåˆ—å·&lt;/li&gt;&#xA;&lt;li&gt;primary apply æœ¬åœ°çš„ä¿®æ”¹&lt;/li&gt;&#xA;&lt;li&gt;primary è½¬å‘è¯·æ±‚åˆ°å‰¯æœ¬&lt;/li&gt;&#xA;&lt;li&gt;å½“ primary æ”¶åˆ°æ‰€æœ‰å‰¯æœ¬çš„ ack åï¼Œè¿”å›ç»™å®¢æˆ·ç«¯&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœä¸€ä¸ªå‰¯æœ¬æ˜¯æ²¡æœ‰å“åº”ï¼Œå®¢æˆ·ç«¯å°†è¦é‡è¯•&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœ master æ²¡æœ‰é‡ç½® leaseï¼Œ master å¯ä»¥é‡æ–°æŒ‡å®šæ–°çš„ masterï¼Œ&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœå‰¯æœ¬çš„æ•°é‡å°äºæŸä¸ªå€¼çš„æ—¶å€™ï¼Œmaster ä¼šé‡æ–°æ·»åŠ å‰¯æœ¬ï¼Œé‡æ–°è´Ÿè½½å‰¯æœ¬&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;GFS è¾¾åˆ°äº†ç†æƒ³ä¸­çš„ä¸€è‡´æ€§äº†å—ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;&lt;strong&gt;ä¸¤ç§æƒ…å†µï¼šç›®å½•å’Œæ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;&#xA;&#xA;&lt;h3&gt;ç›®å½• yesï¼Œbut&amp;hellip;&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;yes: å¼ºä¸€è‡´æ€§ ï¼ˆä»…æœ‰ä¸€ä¸ªå‰¯æœ¬)&lt;/li&gt;&#xA;&lt;li&gt;but:&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Master æœ‰å¯èƒ½æŒ‚æ‰å¹¶ä¸” GFS æ˜¯ä¸å¯ç”¨çš„&lt;/li&gt;&#xA;&lt;li&gt;shadow master å¯ä»¥æä¾›åªè¯»æ“ä½œï¼Œä½†æ˜¯å®ƒè¿”å›è€çš„æ•°æ®&lt;/li&gt;&#xA;&lt;li&gt;Q: é‚£å†™æ“ä½œå‘¢ï¼Ÿ è„‘è£‚ç°è±¡&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3&gt;æ–‡ä»¶ï¼šä¸ä¸€å®š&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¸¦æœ‰åŸå­è¿½åŠ çš„çªå˜&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸€ä¸ªæ–‡ä»¶å¯ä»¥æœ‰é‡å¤çš„ enties å’Œç©ºæ´ï¼Œå¦‚æœ primary ä¸ä¸€ä¸ªå‰¯æœ¬è¿æ¥å¤±è´¥ï¼Œprimary ä¼šç»™å®¢æˆ·ç«¯æŠ¥ä¸€ä¸ªé”™è¯¯ï¼Œå®¢æˆ·ç«¯é‡è¯•å¹¶ä¸” primary é€‰æ‹©ä¸€ä¸ªæ–°çš„åç§»é‡ï¼Œè®°å½•å¯èƒ½æ˜¯é‡å¤å†™å…¥ï¼Œå…¶ä»–çš„å‰¯æœ¬å¯èƒ½å­˜åœ¨ç©ºæ´&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;ä¸€ä¸ªä¸å¹¸è¿çš„å®¢æˆ·ç«¯å¯èƒ½åœ¨çŸ­æ—¶é—´å†…è¯»åˆ°ä¸€ä¸ªè€çš„æ•°æ®&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸€ä¸ªå¤±è´¥çš„çªå˜å¯¼è‡´ chunks çš„ä¸ä¸€è‡´ï¼Œprimary chunk æ›´æ–° chunck ä½†æ˜¯å¤±è´¥äº†å¹¶ä¸”å‰¯æœ¬æ•°æ®è¿‡æ—¶äº†&lt;/li&gt;&#xA;&lt;li&gt;ä¸€ä¸ªå®¢æˆ·ç«¯å¯èƒ½å»è¯»ä¸€ä¸ªæ²¡æœ‰è·Ÿæ–°æ•°æ®çš„ chunk&lt;/li&gt;&#xA;&lt;li&gt;å½“å®¢æˆ·ç«¯åˆ·æ–° lease  çš„æ—¶å€™ï¼Œä»–å°†è·å¾—åˆ°æœ€æ–°ç‰ˆæœ¬&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;æ²¡æœ‰åŸå­è¿½åŠ çš„çªå˜&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸åŒå®¢æˆ·ç«¯çš„æ•°æ®å¯èƒ½è¢«æ··åˆ&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœä½ æ˜¯åœ¨ä½¿ç”¨åŸå­è¿½åŠ æˆ–æ˜¯ä¸´æ—¶æ–‡ä»¶å’Œè‡ªåŠ¨é‡å‘½åï¼Œå¹¶å‘çš„å†™åœ¨ä¸åŒçš„ Unix æœºå™¨ä¸Šå¯èƒ½å¯¼è‡´å¥‡æ€ªçš„ç°è±¡&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;ä½œè€…ä¸»å¼ å¼±ä¸€è‡´æ€§å¯¹appè€Œè¨€ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¤§å¤šæ•°æ–‡ä»¶æ›´æ–°æ“ä½œåªæ˜¯è¿½åŠ &#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨æ·»åŠ è®°å½•ä¸­çš„uidåˆ¤æ–­æ˜¯å¦é‡å¤&lt;/li&gt;&#xA;&lt;li&gt;åº”ç”¨ç¨‹åºä¹Ÿè®¸åªæ˜¯è¯»å–åˆ°å°‘é‡çš„æ•°æ®ï¼ˆè€Œä¸æ˜¯ä¸æ–°é²œçš„æ•°æ®ï¼‰&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å’ŒåŸå­çš„é‡å‘½åæ“ä½œ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;æ€§èƒ½&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å·¨å¤§çš„è¯»æ“ä½œæ€»ååé‡ï¼ˆ3ä¸ªå‰¯æœ¬ï¼Œstriping ï¼Ÿï¼Ÿï¼Ÿï¼‰&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;125 MB/sec&lt;/li&gt;&#xA;&lt;li&gt;æ¥è¿‘ç½‘ç»œé¥±å’ŒçŠ¶æ€&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å†™å…¥ä¸åŒçš„æ–‡ä»¶ä½äºå¯èƒ½çš„æœ€å¤§å€¼&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä½œè€…æ€ªç½‘ç»œå †æ ˆ&lt;/li&gt;&#xA;&lt;li&gt;chunkç›´æ¥çš„å¤åˆ¶æ“ä½œä¼šå¼•èµ·å»¶è¿Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å¹¶å‘è¿½åŠ åŒä¸€ä»½æ–‡ä»¶&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è¢«æœåŠ¡å™¨å­˜åœ¨çš„æœ€æ–°çš„chunkæ‰€é™åˆ¶&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;æ€»ç»“&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;GFSä½¿ç”¨çš„æ¯”è¾ƒé‡è¦çš„å®¹é”™æŠ€æœ¯riz&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ“ä½œæ—¥å¿—ã€æ£€æŸ¥ç‚¹&lt;/li&gt;&#xA;&lt;li&gt;chunkä¹‹é—´çš„ä¸»å¤‡å¤‡ä»½ï¼ˆbut with consistenciesï¼Ÿï¼Ÿï¼‰&lt;/li&gt;&#xA;&lt;li&gt;æˆ‘ä»¬å°†ä¼šåœ¨å…¶ä»–ç³»ç»Ÿä¸­ä¹Ÿçœ‹åˆ°è¿™é‡Œ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å“ªäº›åœ¨GFSä¸­å·¥ä½œå¾ˆå¥½&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å·¨å¤§çš„é¡ºåºè¯»å†™æ“ä½œ&lt;/li&gt;&#xA;&lt;li&gt;è¿½åŠ &lt;/li&gt;&#xA;&lt;li&gt;å·¨å¤§çš„ååé‡&lt;/li&gt;&#xA;&lt;li&gt;æ•°æ®ä¹‹é—´çš„å®¹é”™&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;å“ªäº›åœ¨GFSä¸­åšçš„ä¸æ€ä¹ˆå¥½&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;masteræœåŠ¡å™¨çš„å®¹é”™&lt;/li&gt;&#xA;&lt;li&gt;å°æ–‡ä»¶ï¼ˆmasteræœåŠ¡å™¨çš„ç“¶é¢ˆï¼‰&lt;/li&gt;&#xA;&lt;li&gt;å¤šä¸ªå®¢æˆ·ç«¯å¹¶å‘çš„å‘åŒä¸€ä»½æ–‡ä»¶æ›´æ–°æ“ä½œï¼ˆé™¤äº†è¿½åŠ ï¼‰&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pdos.csail.mit.edu/6.824/papers/gfs.pdf&#34;&gt;The Google File System&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pdos.csail.mit.edu/6.824/notes/l-gfs-short.txt&#34;&gt;6.824-nodes&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/feixiao/Distributed-Systems/blob/master/Lec03_GFS/GFS.md&#34;&gt;GFSæ¡ˆä¾‹å­¦ä¹ &lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/GFS ç¬”è®° - MIT-6.824.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>RPC in GO - MIT-6.824</title>
    <updated>2017-08-10T00:00:00Z</updated>
    <id>tag:int64.me,2017-08-10:/2017/RPC in GO - MIT-6.824.html</id>
    <content type="html">&lt;p&gt;RPC ç†æƒ³ä¸Šæƒ³æŠŠç½‘ç»œé€šä¿¡åšçš„è·Ÿå‡½æ•°è°ƒç”¨ä¸€æ ·&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;è¿œç¨‹è°ƒç”¨ (RPC)&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…³é”®æ¨¡å—&lt;/li&gt;&#xA;&lt;li&gt;ç›®çš„ï¼š&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®¹æ˜“ç¼–å†™ç½‘ç»œé€šä¿¡ç¨‹åº&lt;/li&gt;&#xA;&lt;li&gt;éšè—å¤§å¤šæ•° client/server ä¹‹é—´é€šä¿¡çš„ç»†èŠ‚&lt;/li&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯è°ƒç”¨æ›´åŠ åƒä¼ ç»Ÿçš„è¿‡ç¨‹è°ƒç”¨&lt;/li&gt;&#xA;&lt;li&gt;æœåŠ¡ç«¯å¤„ç†æ›´åŠ åƒä¼ ç»Ÿçš„è¿‡ç¨‹è°ƒç”¨&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;RPC å·²ç»è¢«å¹¿æ³›åº”ç”¨&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;RPC ç†æƒ³ä¸Šæƒ³æŠŠç½‘ç»œé€šä¿¡å°±å½“åšå‡½æ•°è°ƒç”¨ä¸€æ ·ç®€å•&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Client:&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;    z = fn(x,y)&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Server:&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;    fn(x, y) {&#xA;        compute&#xA;        return z&#xA;    }&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;RPC çš„ç›®æ ‡æ˜¯è¿™æ ·çš„æ°´å¹³é€æ˜&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;Go example &lt;a href=&#34;https://pdos.csail.mit.edu/6.824&#34;&gt;kv.go&lt;/a&gt;&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;client &amp;ldquo;dial&amp;rdquo; å‘ server ç«¯è¯·æ±‚è°ƒç”¨å°±åƒå¯»å¸¸å‡½æ•°è°ƒç”¨ä¸€æ ·&lt;/li&gt;&#xA;&lt;li&gt;server å¹¶å‘çš„å¤„ç†æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œå½“ç„¶ï¼Œå¯¹äºkeyvalueè¦ç”¨åˆ°é”&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;RPCæ¶ˆæ¯æµç¨‹å›¾ï¼š&lt;/h2&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;Client             Server&#xA;&#x9;request---&amp;gt;&#xA;   &#x9;&#x9;&amp;lt;---response&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;è½¯ä»¶æ¶æ„&lt;/h2&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;client app         handlers&#xA;&#x9;stubs           dispatcher&#xA;RPC lib           RPC lib&#xA; ã€€ã€€net  ------------ net&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;ä¸€äº›ç»†èŠ‚&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åº”è¯¥è°ƒç”¨å“ªä¸ªæœåŠ¡å™¨å‡½æ•°ï¼ˆhandlerï¼‰ï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å»æ‰ç”¨ Call() ä¸­æŒ‡å®šçš„å‡½æ•°&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;p&gt;åºåˆ—åŒ–æ•°æ®ï¼š æ•°åˆ—æ¢æ•°æ®åˆ°åŒ…ä¸­&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ£˜æ‰‹çš„æ•°ç»„ï¼ŒæŒ‡é’ˆï¼Œå¯¹è±¡ç­‰ã€‚&lt;/li&gt;&#xA;&lt;li&gt;Goçš„RPCåº“éå¸¸å¼ºå¤§ã€‚&lt;/li&gt;&#xA;&lt;li&gt;æœ‰äº›ä¸œè¥¿ä½ ä¸èƒ½ä¼ é€’ï¼šæ¯”å¦‚channelså’Œfunctionã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&#xA;&lt;li&gt;&lt;p&gt;ç»‘å®šï¼šclient å¦‚ä½•çŸ¥é“è¯¥å’Œè°äº¤äº’&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;client ä¹Ÿè®¸ä½¿ç”¨ server host name&lt;/li&gt;&#xA;&lt;li&gt;ä¹Ÿè®¸ä½¿ç”¨å‘½åæœåŠ¡ï¼Œå°†æœåŠ¡åå­—æ˜ å°„åˆ°æœ€å¥½çš„æœåŠ¡å™¨ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;RPC é—®é¢˜ï¼š å½“é‡åˆ°å¤±è´¥ä¼šåšä¸€äº›ä»€ä¹ˆæ“ä½œï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;eg: ä¸¢åŒ…ï¼Œç½‘ç»œä¸­æ–­, server å“åº”ç¼“æ…¢ï¼Œserver ç«¯æŒ‚æ‰&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;é”™è¯¯å¯¹RPCå®¢æˆ·ç«¯æ„å‘³ç€ä»€ä¹ˆ?&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;client æ°¸è¿œä¸ä¼šæ”¶åˆ° server çš„å“åº”&lt;/li&gt;&#xA;&lt;li&gt;clinet ä¸çŸ¥é“ server æ˜¯å¦æ”¶åˆ°è¯·æ±‚(å¯èƒ½åœ¨server å‘é€å“åº”çš„æ—¶å€™ç½‘ç»œä¸­æ–­)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;ç®€å•çš„æ–¹æ¡ˆï¼šâ€œæœ€å°‘ä¸€æ¬¡â€ æ‰§è¡Œ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;RPC client ç­‰å¾…å“åº”ä¸€å®šæ—¶é—´ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œåˆ™é‡æ–°å‘é€è¯·æ±‚ï¼ŒæŒç»­è¿™æ ·çš„æ“ä½œä¸€å®šæ¬¡æ•°åï¼Œä¾ç„¶å—æ²¡æœ‰å“åº”ï¼Œåˆ™å‘åº”ç”¨æ±‡æŠ¥é”™è¯¯&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;Q: &amp;ldquo;è‡³å°‘ä¸€æ¬¡&amp;rdquo;å®¹æ˜“è¢«åº”ç”¨ç¨‹åºå¤„ç†å—ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è‡³å°‘ä¸€æ¬¡å†™çš„ç®€å•é—®é¢˜ï¼š å®¢æˆ·ç«¯å‘é€&amp;rdquo;deduct $10 from bank account&amp;rdquo;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;Q: å®¢æˆ·ç«¯å¯èƒ½å‡ºç°ä»€ä¹ˆé”™è¯¯ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Put(&amp;ldquo;k&amp;rdquo;,10) &amp;ndash; ä¸€ä¸ªRPCè°ƒç”¨åœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸­è®¾ç½®é”®å€¼å¯¹ã€‚&lt;/li&gt;&#xA;&lt;li&gt;Put(&amp;ldquo;k&amp;rdquo;,20) &amp;ndash; å®¢æˆ·ç«¯å¯¹åŒä¸€ä¸ªé”®è®¾ç½®å…¶ä»–å€¼ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;Q: &amp;ldquo;è‡³å°‘ä¸€æ¬¡&amp;rdquo; æ˜¯å¦æ˜¯æ­£ç¡®çš„ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœåªæ˜¯è¯»æ“ä½œæ²¡æœ‰é—®é¢˜&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœåº”ç”¨å¯¹äºé‡å¤å†™åšäº†å¤„ç†ï¼Œä¹Ÿæ˜¯OK çš„&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;æ›´å¥½çš„RPCè¡Œä¸ºï¼š&amp;rdquo;æœ€å¤šä¸€æ¬¡&amp;rdquo;&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;idea:æœåŠ¡å™¨çš„RPCä»£ç å‘ç°é‡å¤çš„è¯·æ±‚ï¼Œè¿”å›ä¹‹å‰çš„å›å¤ï¼Œè€Œä¸æ˜¯é‡å†™è¿è¡Œã€‚&lt;/li&gt;&#xA;&lt;li&gt;Qï¼šå¦‚ä½•å‘ç°ç›¸åŒçš„è¯·æ±‚?&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;clientè®©æ¯ä¸€ä¸ªè¯·æ±‚å¸¦æœ‰å”¯ä¸€æ ‡ç¤ºç XID(unique ID),ç›¸åŒè¯·æ±‚ä½¿ç”¨ç›¸åŒçš„XIDé‡æ–°å‘é€ã€‚&#xA;serverï¼š&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;if seen[xid]:&#xA;    r = old[xid]&#xA;else&#xA;    r = handler()&#xA;    old[xid] = r&#xA;    seen[xid] = true&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;&amp;ldquo;æœ€å¤šä¸€æ¬¡&amp;rdquo; çš„å¤æ‚åº¦&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;p&gt;å¦‚ä½•ç¡®ä¿ XID æ˜¯å”¯ä¸€çš„ï¼Ÿ&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¾ˆå¤§çš„éšæœºæ•°?&lt;/li&gt;&#xA;&lt;li&gt;å°†å”¯ä¸€çš„å®¢æˆ·ç«¯IDï¼ˆip addressï¼Ÿï¼‰å’Œåºåˆ—å·ç»„åˆèµ·æ¥ï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&#xA;&lt;li&gt;&lt;p&gt;server æœ€åå¿…é¡»ä¸¢å¼ƒè€çš„ RPC ä¿¡æ¯&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä»€ä¹ˆæ—¶å€™çš„ç¡®æ˜¯å®‰å…¨çš„ï¼Ÿ&lt;/li&gt;&#xA;&lt;li&gt;æƒ³æ³•ï¼š&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å”¯ä¸€çš„client  IDs&lt;/li&gt;&#xA;&lt;li&gt;å‰ä¸€ä¸ªrpcè¯·æ±‚çš„åºåˆ—å·&lt;/li&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯æ¯ä¸ª RPC è¯·æ±‚éƒ½åŒ…æ‹¬ &amp;ldquo;seen all replies &amp;lt;= x&amp;rdquo;&lt;/li&gt;&#xA;&lt;li&gt;ç±»ä¼¼tcpä¸­çš„seqå’Œack&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;li&gt;æˆ–è€…æ¯æ¬¡åªå…è®¸ä¸€ä¸ªRPCè°ƒç”¨ï¼Œåˆ°è¾¾çš„æ˜¯seq+1ï¼Œé‚£ä¹ˆå¿½ç•¥å…¶ä»–å°äºseq&lt;/li&gt;&#xA;&lt;li&gt;å®¢æˆ·ç«¯æœ€å¤šå¯ä»¥å°è¯•5æ¬¡ï¼ŒæœåŠ¡å™¨ä¼šå¿½ç•¥å¤§äº5æ¬¡çš„è¯·æ±‚&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&#xA;&lt;li&gt;&lt;p&gt;å½“åŸæ¥çš„è¯·æ±‚è¿˜åœ¨æ‰§è¡Œï¼Œæ€ä¹ˆæ ·å¤„ç†ç›¸åŒseqçš„è¯·æ±‚ï¼Ÿ&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æœåŠ¡å™¨ä¸æƒ³è¿è¡Œä¸¤æ¬¡ï¼Œä¹Ÿä¸æƒ³å›å¤ã€‚&lt;/li&gt;&#xA;&lt;li&gt;æƒ³æ³•ï¼šç»™æ¯ä¸ªæ‰§è¡Œçš„RPCï¼Œpendingæ ‡è¯†ï¼›ç­‰å¾…æˆ–è€…å¿½ç•¥ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å¦‚æœä¸€ä¸ª &amp;ldquo;æœ€å¤šä¸€æ¬¡&amp;rdquo; çš„serveræŒ‚æ‰äº†æˆ–æ˜¯é‡å¯äº†è‚¿ä¹ˆåŠï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœæœåŠ¡å™¨å°†å‰¯æœ¬ä¿¡æ¯ä¿å­˜åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡å™¨ä¼šå¿˜è®°è¯·æ±‚ï¼ŒåŒæ—¶åœ¨é‡å¯ä¹‹åæ¥å—ç›¸åŒçš„è¯·æ±‚ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä¹Ÿè®¸ï¼Œä½ åº”è¯¥å°†å‰¯æœ¬ä¿¡æ¯ä¿å­˜åˆ°ç£ç›˜ï¼Ÿ&lt;/li&gt;&#xA;&lt;li&gt;ä¹Ÿè®¸ï¼Œå‰¯æœ¬æœåŠ¡å™¨åº”è¯¥ä¿å­˜å‰¯æœ¬ä¿¡æ¯ï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;&amp;ldquo;è‡³å°‘æ‰§è¡Œä¸€æ¬¡&amp;rdquo; å¦‚ä½•ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è‡³å¤šä¸€æ¬¡+æ— é™é‡è¯•+å®¹é”™æœåŠ¡&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;Go RPCå®ç°çš„â€æœ€å¤šä¸€æ¬¡â€œï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ‰“å¼€TCPè¿æ¥&lt;/li&gt;&#xA;&lt;li&gt;å‘TCPè¿æ¥å†™å…¥è¯·æ±‚&lt;/li&gt;&#xA;&lt;li&gt;TCPä¹Ÿè®¸ä¼šé‡ä¼ ï¼Œä½†æ˜¯æœåŠ¡å™¨çš„TCPåè®®æ ˆä¼šè¿‡æ»¤é‡å¤çš„ä¿¡æ¯&lt;/li&gt;&#xA;&lt;li&gt;åœ¨Goä»£ç é‡Œé¢ä¸ä¼šæœ‰é‡è¯•ï¼ˆå³ï¼šä¸ä¼šåˆ›å»ºç¬¬äºŒä¸ªTCPè¿æ¥ï¼‰&lt;/li&gt;&#xA;&lt;li&gt;Go RPCä»£ç å½“æ²¡æœ‰è·å–åˆ°å›å¤ä¹‹åå°†è¿”å›é”™è¯¯&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¹Ÿè®¸æ˜¯TCPè¿æ¥çš„è¶…æ—¶&lt;/li&gt;&#xA;&lt;li&gt;ä¹Ÿè®¸æ˜¯æœåŠ¡å™¨æ²¡æœ‰çœ‹åˆ°è¯·æ±‚&lt;/li&gt;&#xA;&lt;li&gt;ä¹Ÿè®¸æœåŠ¡å™¨å¤„ç†äº†è¯·æ±‚ï¼Œä½†æ˜¯åœ¨è¿”å›å›å¤ä¹‹å‰æœåŠ¡å™¨çš„ç½‘ç»œæ•…éšœ&lt;/li&gt;&#xA;&lt;/ul&gt;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pdos.csail.mit.edu/6.824/notes/l-rpc.txt&#34;&gt;MIT-8.624 nodes&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/feixiao/Distributed-Systems&#34;&gt;Distributed-Systems&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/RPC in GO - MIT-6.824.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>MapReduce ç¬”è®° - MIT-6.824</title>
    <updated>2017-08-04T00:00:00Z</updated>
    <id>tag:int64.me,2017-08-04:/2017/MapReduce ç¬”è®° - MIT-6.824.html</id>
    <content type="html">&lt;p&gt;MapReduce ç”±googleæå‡ºçš„è½¯ä»¶æ¶æ„ï¼Œä¸»è¦ç”¨äºå¤§è§„æ¨¡æ•°æ®é›†çš„å¹¶è¡Œè®¡ç®—&amp;hellip;&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;MapReduce æ¦‚å¿µ&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;èƒŒæ™¯ï¼šåœ¨å‡ ä¸ªå°æ—¶å†…å¤„ç†æ™šTBçº§åˆ«çš„æ•°æ®é‡ï¼Œeg: åˆ†æä¸€ä¸ªçˆ¬è¡Œç½‘ä¹Ÿçš„å›¾å½¢ç»“æ„ï¼Œç”±éåˆ†å¸ƒå¼ç³»ç»Ÿä¸“å®¶å¼€å‘çš„ç¨‹åºè¿è¡Œæˆåƒçš„æœºå™¨ä¸Šä¼šæ˜¯ä¸€ä»¶å¾ˆç—›è‹¦çš„äº‹æƒ…ï¼Œ egï¼šé”™è¯¯å¤„ç†&lt;/li&gt;&#xA;&lt;li&gt;æ€»ä½“ç›®æ ‡ï¼šéä¸“ä¸šç¨‹åºå‘˜å¯ä»¥è½»æ¾çš„åœ¨åˆç†çš„æ•ˆç‡ä¸‹è§£å†³çš„å·¨å¤§çš„æ•°æ®å¤„ç†é—®é¢˜ã€‚ç¨‹åºå‘˜å®šä¹‰Mapå‡½æ•°å’ŒReduceå‡½æ•°ã€é¡ºåºä»£ç ä¸€èˆ¬éƒ½æ¯”è¾ƒç®€å•ã€‚ MRåœ¨æˆåƒçš„æœºå™¨ä¸Šé¢è¿è¡Œå¤„ç†å¤§é‡çš„æ•°æ®è¾“å…¥ï¼Œéšè—å…¨éƒ¨åˆ†å¸ƒå¼çš„ç»†èŠ‚ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;MapReduce æŠ½è±¡&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;è¾“å…¥æ˜¯è¢«åˆ‡åˆ†æˆ M ä¸ªåˆ†ç‰‡&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt;Input1 -&amp;gt; Map -&amp;gt; a,1   b,1  c,1&#xA;Input2 -&amp;gt; Map -&amp;gt;     b,1&#xA;Input3 -&amp;gt; Map -&amp;gt; a,1      c,1&#xA;                  |   |   |&#xA;                  |   |    -&amp;gt; Reduce -&amp;gt; c,2&#xA;                  |    ----&amp;gt; Reduce -&amp;gt; b,2&#xA;                    ------&amp;gt; Reduce -&amp;gt; a,2&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;p&gt;MR åœ¨æ¯ä¸ªè¾“å…¥åˆ†ç‰‡ä¸Šè°ƒç”¨ Map() å‡½æ•°ï¼Œäº§ç”Ÿ(k2, v2)è¿™æ ·çš„ä¸­é—´æ•°æ®é›†ã€‚  æ¯ä¸€ä¸ªMap()å‡½æ•°çš„è°ƒç”¨å°±æ˜¯ä¸€ä¸ª &amp;ldquo;task&amp;rdquo;&#xA;MR æ”¶é›†æ‰€æœ‰keyä¸ºk2çš„æ‰€æœ‰å€¼, å¹¶ä¸”æŠŠä»–ä»¬ä¼ é€’ç»™Reduce è°ƒç”¨ï¼Œ æœ€åReduceè¾“å‡ºæ˜¯è¿™æ ·&lt;k2, v3&gt;è¿™æ ·çš„ä¸€å¯¹æ•°å€¼ï¼Œå¹¶å­˜å‚¨åˆ°è¾“å‡ºæ–‡ä»¶ä¸­ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;Example: å•è¯è®¡ç®—&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;è¾“å…¥æ˜¯æˆåƒæ–‡æœ¬æ–‡ä»¶&lt;/p&gt;&#xA;&#xA;&lt;pre&gt;&lt;code&gt; Map(k, v)&#xA;    split v into words&#xA;    for each word w&#xA;      emit(w, &amp;quot;1&amp;quot;)&#xA;  Reduce(k, v)&#xA;    emit(len(v))&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&#xA;&lt;h2&gt;MapReduce éšè—äº†å¾ˆå¤šè®©äººç—›è‹¦çš„ç»†èŠ‚&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨è½¯ä»¶(s/w)&lt;/li&gt;&#xA;&lt;li&gt;è·Ÿè¸ªå“ªäº›&amp;rdquo;tasks&amp;rdquo;å·²ç»å®Œæˆ&lt;/li&gt;&#xA;&lt;li&gt;æ•°æ®ä¼ é€&lt;/li&gt;&#xA;&lt;li&gt;å¤±è´¥æ¢å¤&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;MapReduce æ˜“æ‹“å±•&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;N å°è®¡ç®—æœºå…·æœ‰ Nx çš„ååé‡ï¼Œå‡è®¾ M å’Œ R éƒ½æ˜¯ å¤§äºç­‰äºN (å³ï¼Œå¤§é‡çš„è¾“å…¥æ–‡ä»¶å’Œè¾“å‡ºçš„keys), å› ä¸ºæ¯ä¸ªMap() äº’ä¸å½±å“ï¼Œæ‰€ç”¨Map() å‡½æ•°å¯ä»¥å¹¶å‘çš„æ‰§è¡Œã€‚ Reduce() åŒæ ·å¦‚æ­¤ã€‚&#xA;æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¹°æ›´å¤šçš„ç”µè„‘æ¥å¢åŠ ååã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;ä»€ä¹ˆä¼šé™åˆ¶æ€§èƒ½ï¼Ÿ&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;è¿™æ˜¯æˆ‘ä»¬å…³ç³»å»ä¼˜åŒ–çš„åœ°æ–¹ï¼Ÿ CPU? memory? disk? network?&#xA;MepReduce çš„ä½œè€…åœ¨ 2004 æ—¶å€™ï¼Œç½‘ç»œå¸¦å®½æ˜¯ä¸ªå¤§é—®é¢˜ã€‚å…³é”®æ‰€æœ‰Map()ï¼Œ Reduce() äº¤äº’è¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ç»è¿‡ç½‘ç»œçš„ï¼Œç½‘ç»œé€Ÿåº¦æ˜¯è¿œå°äºç£ç›˜å’Œå†…å­˜çš„é€Ÿåº¦ã€‚ æ‰€æœ‰å½“åˆä½œè€…å°½é‡å‡å°‘ç½‘ç»œæ¬è¿æ•°æ®ï¼ˆå¦‚ä»Šç½‘ç»œé€Ÿåº¦ç›¸æ¯”2004å¹´å¿«äº†å¾ˆå¤š)&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;æ›´å¤šç»†èŠ‚&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;master: åˆ†å‘&amp;rdquo;task&amp;rdquo;ç»™ workers;&lt;/li&gt;&#xA;&lt;li&gt;è®°å½•m Map task çš„ä¸­é—´è¾“å‡ºæ–‡ä»¶ã€r Reduce&lt;/li&gt;&#xA;&lt;li&gt;è¾“å…¥æ–‡ä»¶æ˜¯è¢«å­˜å‚¨åœ¨ GFSï¼Œæ¯ä¸ªMap è¾“å‡ºæ–‡ä»¶éƒ½æœ‰ä¸‰ä»½;&lt;/li&gt;&#xA;&lt;li&gt;æ‰€æœ‰è®¡ç®—æœºéƒ½åŒæ—¶è¿è¡Œè¿™GFS å’Œ MR workers;&lt;/li&gt;&#xA;&lt;li&gt;è¾“å…¥æ–‡ä»¶æ˜¯æ¯” workers å¤šï¼›&lt;/li&gt;&#xA;&lt;li&gt;master ç»™æ¯ä¸ª worker ä¸€ä¸ª map task, åªæœ‰å½“è€çš„ task å®Œæˆå master æ‰ä¼šåˆ†å‘æ–°çš„ä»»åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;map worker åœ¨æœ¬åœ°ç£ç›˜ä¸Šä½¿ç”¨ hash ç®—æ³•å°† ä¸­é—´ key åˆ†æˆ R ä»½&lt;/li&gt;&#xA;&lt;li&gt;ç›´è¾¾æ‰€æœ‰çš„Map tasks å…¨éƒ¨å®Œæˆï¼Œæ‰ä¼šè°ƒç”¨ Reduce&lt;/li&gt;&#xA;&lt;li&gt;master é€šçŸ¥ Reducers ä» Map workers å»å›å»ä¸­é—´æ•°æ®åˆ†åŒº&lt;/li&gt;&#xA;&lt;li&gt;Reduce worker å°†æœ€ç»ˆç»“æœå†™å…¥GFS(æ¯ä¸ª Reduce task äº§ç”Ÿä¸€ä¸ª æ–‡ä»¶)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å¦‚ä½•è®¾è®¡å»å‡å°‘æ…¢ç½‘ç»œçš„å½±å“&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Map worker çš„è¾“å…¥æ˜¯ä»æœ¬åœ°ç£ç›˜ä¸Šçš„GFSå‰¯æœ¬è¯»å–ï¼Œä¸ç»è¿‡ç½‘ç»œ&lt;/li&gt;&#xA;&lt;li&gt;ä¸­é—´æ•°æ®åªç»è¿‡ä¸€æ¬¡ç½‘ç»œ&lt;/li&gt;&#xA;&lt;li&gt;Map worker å†™æ•°æ®åˆ°æœ¬åœ°ç£ç›˜ï¼Œè€Œä¸æ˜¯ GFS&lt;/li&gt;&#xA;&lt;li&gt;æ¯ä¸ªä¸­é—´æ•°æ®åˆ‡åˆ†æˆçš„æ–‡ä»¶ä¸­éƒ½åŒ…å«è®¸å¤škeys&lt;/li&gt;&#xA;&lt;li&gt;å¤§çš„ç½‘ç»œä¼ è¾“æ˜¯æ›´åŠ æœ‰æ•ˆç‡&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å¦‚ä½•æ›´å¥½çš„è´Ÿè½½å‡è¡¡&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;è®©n-1 servers å»ç­‰å¾…ä¸€ä¸ªserver çš„ç»“æŸï¼Œè¿™æ˜¯éå¸¸ç³Ÿç³•çš„ï¼Œ ä½†æ˜¯æ€»æœ‰ tasks æ˜¯åˆ«å…¶ä»–çš„tasks è¿è¡Œçš„æ—¶é—´è¦ä¹…ã€‚&#xA;è§£å†³åŠæ³•ï¼š tasks çš„æ•°é‡è¦æ¯” workers å¤šã€‚ master æ£€æµ‹åˆ° workers çš„è€çš„tasks æ‰§è¡Œç»“æŸåï¼Œ ç»™ä»–åˆ†é…æ–°çš„ taskã€‚æ‰€ä»¥æ²¡æœ‰æ¯”è¿™ä¸ª workerè‡ªå·±æ‰€èƒ½å…è®¸çš„æœ€å¤§æ—¶é—´è¿˜é•¿çš„taskå­˜åœ¨(å¸Œæœ›è¿™æ ·) ã€‚æ‰€ä»¥è¿è¡Œé€Ÿåº¦å¿«çš„ servers æ¯”è¿è¡Œé€Ÿåº¦æ…¢çš„serversåšæ›´å¤šçš„å·¥ä½œï¼Œä½†æ˜¯èƒ½åœ¨åŒæ—¶å®Œæˆ&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;worker å¤±è´¥æ¢å¤çš„ç»†èŠ‚(å¦‚ä½•åšå®¹é”™ ï¼‰&lt;/h2&gt;&#xA;&#xA;&lt;h3&gt;Map worker å´©æºƒ&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;master æ£€æŸ¥åˆ° worker ä¸åœ¨ç›¸åº”å¿ƒè·³&lt;/li&gt;&#xA;&lt;li&gt;å´©æºƒçš„ worker çš„ map ä¸­é—´è¾“å‡ºæ•°æ®ä¸¢å¤±ï¼Œä½†æ˜¯å¯èƒ½æ¯ä¸€ä¸ª Reduce task éƒ½éœ€è¦è¿™ä¸ªæ•°æ®&lt;/li&gt;&#xA;&lt;li&gt;master é‡æ–°è°ƒåº¦ï¼Œåœ¨GFSæ‹¥æœ‰è¾“å…¥æ–‡ä»¶çš„å…¶ä»–å‰¯æœ¬çš„è®¡ç®—æœºä¸Šé‡æ–°å¯åŠ¨ task&lt;/li&gt;&#xA;&lt;li&gt;æœ‰äº› Reduce worker å¯èƒ½å·²ç»æ‹¥æœ‰äº†è¯»åˆ°äº†å´©æºƒæ‰æœºå™¨ä¸Šçš„ä¸­é—´æ•°æ®ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¾èµ– map å‡½æ•°çš„åŠŸèƒ½å’Œç¡®å®šæ€§&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœReduce ä»¥åŠè·å–åˆ°æ‰€æœ‰ä¸­é—´æ•°æ®ï¼Œé‚£ä¹ˆmasterä¸éœ€è¦é‡æ–°è¿è¡Œ Map&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3&gt;Reduce worker å´©æºƒ&lt;/h3&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å·²ç»æ‰§è¡Œç»“æŸçš„ Tasks æ˜¯æ²¡æœ‰é—®é¢˜çš„- åˆ«å­˜å‚¨åˆ°äº† GFSï¼Œå¸¦æœ‰å¤šä¸ªå‰¯æœ¬&lt;/li&gt;&#xA;&lt;li&gt;master åœ¨å…¶ä»– workers ä¸Šé‡å¯å´©æºƒæ‰çš„ worker æ²¡æœ‰å®Œæˆçš„ task&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h3&gt;Reduce worker åœ¨æ­£åœ¨å†™ä»–çš„è¾“å‡ºæ–‡ä»¶çš„æ—¶å€™å´©æºƒæ‰&lt;/h3&gt;&#xA;&#xA;&lt;p&gt;GFSä¼šè‡ªåŠ¨é‡å‘½åè¾“å‡ºï¼Œç„¶åä½¿å…¶ä¿æŒä¸å¯è§ç›´åˆ°Reduceå®Œæˆï¼Œæ‰€ä»¥masteråœ¨å…¶ä»–åœ°æ–¹å†æ¬¡è¿è¡ŒReduce workerå°†ä¼šæ˜¯å®‰å…¨çš„ã€‚&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å…¶ä»–é”™è¯¯å’Œé—®é¢˜&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ master ç»™ä¸¤ä¸ª workers åŒæ ·çš„ Map() task è‚¿ä¹ˆåŠï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å¯èƒ½ master é”™è¯¯çš„è®¤ä¸ºå…¶ä¸­ä¸€ä¸ª worker ä»¥åŠæ­»äº¡ï¼Œ å®ƒåªä¼šå‘Šè¯‰Reduce workerå…¶ä¸­çš„ä¸€ä¸ª&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ master ç»™ä¸¤ä¸ª workers åŒæ ·çš„ Reducer() task è‚¿ä¹ˆåŠï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å®ƒä»¬éƒ½ä¼šå°†åŒä¸€ä»½æ•°æ®å†™åˆ°GFSä¸Šé¢ï¼ŒGFSçš„åŸå­é‡å‘½åæ“ä½œä¼šè§¦å‘ï¼Œå…ˆå®Œæˆçš„è·èƒœå°†ç»“æœå†™åˆ°GFS.&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœæŸä¸€ä¸ªå•ç‹¬çš„ worker æ˜¯éå¸¸çš„æ…¢ &amp;ndash; ä¸€ä¸ªæ‰é˜Ÿè€…ï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;äº§ç”ŸåŸå› å¯èƒ½æ˜¯éå¸¸ç³Ÿç³•çš„ç¡¬ä»¶è®¾æ–½ã€‚ masterä¼šå¯¹è¿™äº›æœ€åçš„ä»»åŠ¡åˆ›å»ºç¬¬äºŒä»½æ‹·è´ä»»åŠ¡æ‰§è¡Œã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœç”±äºç¡¬ä»¶æˆ–æ˜¯è½¯ä»¶åŸå› é€ æˆä¸€ä¸ªworkerè®¡ç®—å‡ºä¸€ä¸ªé”™è¯¯çš„è¾“å‡ºè‚¿ä¹ˆåŠï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å¤ªç³Ÿç³•äº†ï¼MRå‡è®¾æ˜¯å»ºç«‹åœ¨&amp;rdquo;fail-stop&amp;rdquo;çš„cpuå’Œè½¯ä»¶ä¹‹ä¸Šã€‚&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ master å´©æºƒäº†è‚¿ä¹ˆåŠï¼Ÿ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;p&gt;å•ç‹¬çš„ master æŒ‚äº†ï¼Œ é‚£å°±æŒ‚äº†&lt;/p&gt;&#xA;&#xA;&lt;h2&gt;å…³äºé‚£äº›MapReduceä¸èƒ½å¾ˆå¥½æ‰§è¡Œçš„åº”ç”¨&lt;/h2&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¹¶ä¸æ˜¯æ‰€ä»¥å·¥ä½œéƒ½é€‚åˆmap/shuffle/reduceè¿™ç§æ¨¡å¼&lt;/li&gt;&#xA;&lt;li&gt;å°çš„æ•°æ®ï¼Œå› ä¸ºç®¡ç†æˆæœ¬å¤ªé«˜,å¦‚éç½‘ç«™åç«¯&lt;/li&gt;&#xA;&lt;li&gt;å¤§æ•°æ®ä¸­çš„å°æ›´æ–°ï¼Œæ¯”å¦‚æ·»åŠ ä¸€äº›æ–‡ä»¶åˆ°å¤§çš„ç´¢å¼•&lt;/li&gt;&#xA;&lt;li&gt;ä¸å¯é¢„çŸ¥çš„è¯»(Map å’Œ Reduceéƒ½ä¸èƒ½é€‰æ‹©è¾“å…¥)&lt;/li&gt;&#xA;&lt;li&gt;Multiple shuffles, e.g. page-rank (can use multiple MR but not very efficient)&lt;/li&gt;&#xA;&lt;li&gt;å¤šæ•°çµæ´»çš„ç³»ç»Ÿå…è®¸MRï¼Œä½†æ˜¯ä½¿ç”¨éå¸¸å¤æ‚çš„ræ¨¡å‹&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;æ€»ç»“&lt;/h2&gt;&#xA;&#xA;&lt;p&gt;MapReduce çš„å‡ºç°ä½¿å¾—å¤§æ•°æ®è®¡ç®—å˜å¾—æµè¡Œèµ·æ¥&lt;/p&gt;&#xA;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸æ˜¯æœ€æœ‰æ•ˆæˆ–æ˜¯çµæ´»çš„&lt;/li&gt;&#xA;&lt;li&gt;æ‹“å±•æ€§å¥½&lt;/li&gt;&#xA;&lt;li&gt;å®¹æ˜“ç¼–ç¨‹ &amp;ndash; å¤±è´¥å’Œæ•°æ®è¿ç§»è¢«éšè—èµ·æ¥&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&#xA;&lt;h2&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pdos.csail.mit.edu/6.824/notes/l01.txt&#34;&gt;MIT-8.624 nodes&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf&#34;&gt;MapReduce: Simplified Data Processing on Large Clusters&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</content>
    <link href="http://int64.me/2017/MapReduce ç¬”è®° - MIT-6.824.html"></link>
    <author>
      <name>cwen</name>
    </author>
  </entry>
</feed>