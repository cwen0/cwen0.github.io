<?xml version="1.0" encoding="UTF-8"?><feed xmlns="http://www.w3.org/2005/Atom">
  <title>cwen</title>
  <id>http://int64.me</id>
  <updated>2022-06-13T19:31:45+08:00</updated>
  <subtitle>Life is magic. Coding is art.</subtitle>
  <link href="http://int64.me"></link>
  <entry>
    <title>è®¡ç®—æœºåŸºç¡€æ¦‚å¿µï¼šçŠ¶æ€æœº</title>
    <updated>2020-08-06T00:00:00Z</updated>
    <id>tag:int64.me,2020-08-06:/2020/è®¡ç®—æœºåŸºç¡€æ¦‚å¿µï¼šçŠ¶æ€æœº.html</id>
    <link href="http://int64.me/2020/è®¡ç®—æœºåŸºç¡€æ¦‚å¿µï¼šçŠ¶æ€æœº.html" rel="alternate"></link>
    <summary type="html">&lt;hr&gt;&#xA;&lt;p&gt;æœ€è¿‘åœ¨çœ‹ Raft ç®—æ³•çš„æ—¶å€™ï¼Œåœ¨è®ºæ–‡ä¸­æåˆ°äº†çŠ¶æ€æœºçš„æ¦‚å¿µï¼Œè¯´å®è¯å…¶å®ä¸€å¼€å§‹è¿˜æ˜¯å¾ˆæ‡µé€¼ï¼Œå¹¶ä¸çŸ¥é“è¿™ä¸ªçŠ¶æ€æœºä¸ºä½•ç‰©ï¼ˆæœ‰ç‚¹ä¸¢äººï¼‰ï¼Œäºæ˜¯ä¹å°±å»å­¦ä¹ äº†ä¸€æ³¢ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„æ•´ç†å’Œè®°å½•ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;å®šä¹‰&lt;/h2&gt;&#xA;&lt;p&gt;çŠ¶æ€æœºæ˜¯æœ‰é™çŠ¶æ€æœºçš„ç®€ç§° ï¼ˆfsmï¼‰ï¼Œç”¨äºè®¾è®¡ç®—æ³•çš„æ•°å­¦æŠ½è±¡ï¼Œç®€å•æ¥è¯´ï¼ŒçŠ¶æ€æœºå°†è¯»å–ä¸€ç³»åˆ—è¾“å…¥ï¼Œå½“å®ƒè¯»å–è¾“å…¥æ—¶ï¼Œå°†åˆ‡æ¢åˆ°ä¸€ä¸ªç‰¹å®šçš„çŠ¶æ€ï¼Œå¹¶ä¸”å½“è¾“å…¥ä¸å˜çš„æ—¶å€™ï¼Œæ¯æ¬¡çš„åˆ‡æ¢åˆ°çš„çŠ¶æ€ä¹Ÿæ˜¯ä¸å˜çš„ã€‚è¿™äº›ç›¸äº’åˆ‡æ¢çš„çŠ¶æ€æ•°é‡æ˜¯æœ‰é™çš„ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-1&#34;&gt;æ¡ˆä¾‹è§£é‡Š&lt;/h2&gt;&#xA;&lt;p&gt;æƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰è¿™æ ·ä¸€ä¸ªè®¾å¤‡å¯ä»¥è¯»å–ä¸€ç³»åˆ—è¾“å…¥ï¼Œè¾“å…¥çš„å†…å®¹æ˜¯ä¸€æ®µè¿ç»­çš„å­—æ¯ï¼Œè¿™æ®µå­—æ¯ä¸­åªåŒ…å«äº† a å’Œ bã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/finite-state-machine-tape.png&#34; alt=&#34;fsm&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;æŠŠè¿™ä¸ªè®¾å¤‡çœ‹ä½œä¸€ä¸ªçŠ¶æ€æœºï¼Œå½“çŠ¶æ€æœºè¯»å–æ¯ä¸€ä¸ªå­—æ¯çš„æ—¶å€™ï¼Œå®ƒä¼šæ”¹å˜çŠ¶æ€ï¼Œå¹¶ä¸”å®ƒåªæœ‰ä¸¤ä¸ªçŠ¶æ€ s å’Œ q ã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/simple-state-machine.png&#34; alt=&#34;stm&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä¸Šå›¾ä¸­åœ†åœˆä¸­æ˜¯çŠ¶æ€æœºå¯ä»¥è¿›å…¥çš„ â€œçŠ¶æ€â€ã€‚ç®­å¤´ä»£è¡¨è¿‡åº¦ã€‚æ‰€ä»¥å¦‚æœä½ åœ¨çŠ¶æ€ s ä¸­è¯»å–åˆ° a ä½ å°±ä¼šè½¬å˜ä¸ºçŠ¶æ€ qï¼Œå¦‚æœä½ è¯»å–äº†ä¸€ä¸ª bï¼Œé‚£ä¹ˆå°±ä¼šåœç•™åœ¨ s çŠ¶æ€ã€‚è¿™æ ·å¯ä»¥çœ‹å‡ºæ¥ï¼Œç»™å®šä¸€ä¸ªè¾“å…¥ä»¥åŠçŸ¥é“å½“å‰çš„è‡ªå·±çŠ¶æ€ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æ¨ç®—å‡ºè¾“å‡ºçš„ç»“æœï¼Œè¿™é‡Œå’Œå¾ˆå¥½çš„ç¬¦åˆäº†ä¸€ä¸ªæ•°å­¦æ¨¡å‹æŠ½è±¡çš„æ¦‚å¿µã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-2&#34;&gt;ç¨‹åºä¸­çš„çŠ¶æ€æœº&lt;/h2&gt;&#xA;&lt;p&gt;ä»ä¸Šé¢å¯ä»¥å¾—çŸ¥çŠ¶æ€æœºå¹¶ä¸æ˜¯å®é™…çš„æœºå™¨è®¾å¤‡ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°å­¦æ¨¡å‹ï¼Œé€šå¸¸ä½“ç°ä¸ºä¸€ä¸ªçŠ¶æ€è½¬æ¢å›¾ã€‚åŒæ ·åœ¨æˆ‘ä»¬æ—¥å¸¸ç¼–ç¨‹ä»£ç å®ç°ä¸­ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿæ˜¯ç»å¸¸ä½¿ç”¨åˆ°çš„ï¼Œè¿™é‡Œæˆ‘æƒ³å½“ä¸€ä¸ªç»å…¸çš„æ¡ˆä¾‹å°±æ˜¯ TCP çš„çŠ¶æ€è½¬æ¢:&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/tcp-state.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ•´ä½“çš„ TPC çŠ¶æ€è½¬æ¢å›¾ä¹Ÿå¯ä»¥ç§°ä¸ºä¸€ä¸ªçŠ¶æ€æœºã€‚è¿™æ˜¯å¤åˆ¶æ¡ˆä¾‹ï¼Œåœ¨ç¼–ç¨‹ä¸­ç®€å•çš„çŠ¶æ€æœºå™¨å®ç°å…¶å®å¾ˆç®€å•ï¼Œå°±æ¯”ä½¿ç”¨ç®€å• &lt;code&gt;if...else...&lt;/code&gt; æˆ–è€… &lt;code&gt;switch&lt;/code&gt; å°±å¯ä»¥åŠåˆ°:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;// å®šä¹‰çŠ¶æ€&#xA;enum {&#xA;  GOOD,&#xA;  BAD,&#xA;}&#xA;&#xA;int main() {&#xA;  int state = GOOD;&#xA;  while (1) {&#xA;    if (state == GOOD) {&#xA;      xxx; // å…·ä½“è°ƒç”¨å‡½æ•°&#xA;      state = BADï¼›// çŠ¶æ€è½¬ç§»&#xA;    } else if (state == BAD) {&#xA;      xxx; // å…·ä½“è°ƒç”¨å‡½æ•°&#xA;      state == GOOD;&#xA;    }&#xA;  }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ä¸Šé¢å¯ä»¥è¯´æ˜¯ä¸€ä¸ªæœ€ç®€å•çš„çŠ¶æ€æœºäº†ï¼Œé‡Œé¢ä¹‹æ¶‰åŠåˆ°ä¸¤ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬ç§»ã€‚ç”±æ­¤å¯è§å…¶å®çŠ¶æ€æœºå…¶å®æ˜¯æˆ‘ä»¬ç¼–ç¨‹ä¸­æœ€æœ€åŸºæœ¬çš„ä¸€ç§ç¼–ç¨‹æ€æƒ³äº†ğŸ˜‚ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-3&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.markshead.com/869/state-machines-computer-science/&#34;&gt;State Machines â€“ Basics of Computer Science&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Finite-state_machine&#34;&gt;Wiki&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/47434856&#34;&gt;ä»€ä¹ˆæ˜¯çŠ¶æ€æœº&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>ä¸€è‡´æ€§æ¨¡å‹ç¬”è®°</title>
    <updated>2020-04-26T00:00:00Z</updated>
    <id>tag:int64.me,2020-04-26:/2020/ä¸€è‡´æ€§æ¨¡å‹ç¬”è®°.html</id>
    <link href="http://int64.me/2020/ä¸€è‡´æ€§æ¨¡å‹ç¬”è®°.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;è°ˆåˆ°åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¸€è‡´æ€§çš„é—®é¢˜å°±ä¸å¾—ä¸è¢«æåˆ°ï¼Œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªè€ç”Ÿé•¿è°ˆçš„è¯é¢˜ï¼Œè¿™å‡ å¤©åœ¨å‡†å¤‡ä¸€ä¸ªå…³äºåˆ†å¸ƒå¼æµ‹è¯•ç›¸å…³çš„åˆ†äº«çš„æ—¶å€™ï¼Œæ¶‰åŠåˆ°ä¸€äº›ä¸€è‡´æ€§å’Œä¸€è‡´æ€§éªŒè¯ç›¸å…³çš„é—®é¢˜ï¼Œä½†æ˜¯çªç„¶å‘ç°è‡ªå·±çš„è„‘å­é‡Œå·®ä¸å¤šä¸€ç‰‡ç©ºç™½ï¼Œä¹‹å‰ä¹Ÿæœ‰çœ‹è¿‡ç›¸å…³çš„è®ºæ–‡å’Œä¸€äº›å®è·µé¡¹ç›®ï¼Œå¯èƒ½æ˜¯ç”±äºæ²¡æœ‰è‡ªå·±å®é™…å»å®è·µå¯¼è‡´å¾ˆå¤šæ¦‚å¿µéƒ½ä¸å¤ªæ¸…æ¥šï¼Œå°±é‡æ–°å­¦ä¹ äº†ä¸€æ³¢ï¼Œå¹¶æ•´ç†ä¸€äº›ç›¸å…³çš„ç¬”è®°ï¼ˆæ¯•ç«Ÿå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œå¦‚æœç¬”è®°ä¸­å­˜åœ¨é”™è¯¯ï¼Œè¿˜è¯·æŒ‡å‡ºæ¥å¸®åŠ©æˆ‘æ”¹æ­£ï¼‰å¸®åŠ©æ›´å¥½çš„ç†è§£è¿™äº›æ¦‚å¿µã€‚&lt;/p&gt;&#xA;&lt;p&gt;æ•°æ®åº“å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­éƒ½æœ‰ä¸€è‡´æ€§çš„æ¦‚å¿µï¼Œå¦‚æ•°æ®åº“å››å¤§ç‰¹å¾ &lt;code&gt;ACID&lt;/code&gt; ä¸­çš„ &lt;code&gt;C&lt;/code&gt; å°±æ˜¯ &lt;code&gt;Consistency&lt;/code&gt; çš„ç®€å†™ï¼Œåªæ˜¯è¿™ä¸ªä¸€è‡´æ€§å¼ºè°ƒçš„æ˜¯æ•°æ®åº“é€»è¾‘çš„ä¸€è‡´æ€§ï¼Œä¿è¯äº‹åŠ¡å‰åçš„æ•°æ®éƒ½ç¬¦åˆä¸šåŠ¡é‡Œçš„ä¸å˜æ€§çº¦æŸï¼Œæ¯”å¦‚ä¿è¯å¤–é”®çº¦æŸç­‰ã€‚å†æ¯”å¦‚åˆ†å¸ƒå¼ç†è®º &lt;code&gt;CAP&lt;/code&gt; ä¸­çš„ &lt;code&gt;C&lt;/code&gt; ä¹Ÿæ˜¯ä¸€è‡´æ€§ï¼Œè¿™é‡Œçš„ä¸€è‡´æ€§ä¸»è¦å¼ºè°ƒæ˜¯è¯»æ“ä½œæ˜¯å¦èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä»¥åŠå¹¶å‘åœºæ™¯ä¸‹æ“ä½œæ‰§è¡Œçš„æ—¶åºå…³ç³»ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€è‡´æ€§ä»å¼ºåˆ°å¼±å¯ä»¥åˆ†ä¸ºå››ç§ï¼š&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Linearizability&#34;&gt;çº¿æ€§ä¸€è‡´æ€§ ï¼ˆLinearizabilityï¼šStrong consistency or Atomic consistency)&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Sequential_consistency&#34;&gt;é¡ºåºä¸€è‡´æ€§ï¼ˆSequential consistencyï¼‰&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Causal_consistency&#34;&gt;å› æœä¸€è‡´æ€§ï¼ˆCausal consistencyï¼‰&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Eventual_consistency&#34;&gt;æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual consistencyï¼‰&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;åœ¨è¿™ç¯‡ç¬”è®°ä¸­ä¸»è¦ä¼šæ¶‰åŠåˆ°çº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§ï¼Œå¹¶ä¸”ä¼šè®²åˆ°ä¹‹å‰æˆ‘ä¸€ç›´åˆ†ä¸æ¸…çš„çº¿æ€§ä¸€è‡´æ€§å’Œå¯åºåˆ—åŒ–ï¼ˆSerializabilityï¼‰ä¹‹é—´çš„å·®å¼‚ï¼Œæœ€åä¼šç€é‡ä»‹ç»åˆ°ç›®å‰ç”¨æ¥éªŒè¯çº¿æ€§ä¸€è‡´æ€§çš„å‡ ä¸ªå¸¸ç”¨ç®—æ³•ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;å…ˆçœ‹ä¸€å¼ å›¾&lt;/h2&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/jepsen.png&#34; alt=&#34;image.png&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;è¿™å›¾æ¥è‡ª &lt;a href=&#34;https://jepsen.io/consistency&#34;&gt;Jepesn&lt;/a&gt; å®˜ç½‘çš„åšå®¢ï¼Œç”¨æ¥å±•ç¤ºå¹¶å‘ç³»ç»Ÿä¸­ä¸€è‡´æ€§æ¨¡å‹ä¹‹é—´çš„å…³ç³»ã€‚æ¨¡å—ä¹‹é—´çš„ç®­å¤´æ˜¾ç¤ºçš„æ˜¯ä¹‹é—´çš„äº’ç›¸ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚ä¸¥æ ¼å¯åºåˆ—åŒ– (Strict Serializbleï¼ŒStrict 1SR, Strong 1SR) æ„å‘³ç€éœ€è¦åŒæ—¶æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ (Linearizability) å’Œå¯åºåˆ—åŒ–(Serializability)ã€‚å›¾ç‰‡ä¸Šä¸åŒçš„é¢œè‰²æ˜¾ç¤ºå¼‚æ­¥ç½‘ç»œä¸Šçš„åˆ†å¸ƒå¼ç³»ç»Ÿæ¯ä¸ªæ¨¡å‹çš„å¯ç”¨æ€§ã€‚ å…³äºå¯ç”¨æ€§çš„æ›´å¤šç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒè®ºæ–‡ [Highly Available Transactions: V&lt;img src=&#34;http://note.youdao.com/yws/res/8917/WEBRESOURCE0f62a29cb1a76d66329ba6f1305538d3&#34; alt=&#34;image&#34;&gt;irtues and Limitations] (&lt;a href=&#34;http://www.vldb.org/pvldb/vol7/p181-bailis.pdf&#34;&gt;http://www.vldb.org/pvldb/vol7/p181-bailis.pdf&lt;/a&gt;)ï¼Œè¿™ç¯‡è®ºæ–‡é‡Œï¼Œä½œè€…æ€»ç»“ä¸åŒæ¨¡å‹æ˜¯å¦æ»¡è¶³ Highly Available Transactions(HATs)ï¼Œåœ¨è¿™é‡Œå°±ä¸å¤šåŠ èµ˜è¿°ã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä»ä¸Šé¢å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä»æ ¹èŠ‚ç‚¹ Strict Serializble å¼€å§‹åˆ†æˆä¸¤ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªåˆ†æ”¯å¯¹åº”çš„å°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€è‡´æ€§ Consistency (CAP ä¸­ C)ï¼Œå¦ä¸€ä¸ªå¯¹åº”çš„å°±æ˜¯æ•°æ®åº“ä¸­çš„ Isolation (ACID ä¸­çš„ I)ã€‚åé¢ä¼šåˆ†åˆ«ä»‹ç»è¿™ä¸¤ä¸ªåˆ†æ”¯ï¼Œå¹¶åˆ†æä»–ä»¬ä¹‹é—´çš„å·®å¼‚ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;-linearizability&#34;&gt;çº¿æ€§ä¸€è‡´æ€§ (Linearizability)&lt;/h2&gt;&#xA;&lt;p&gt;çº¿æ€§ä¸€è‡´æ€§ (Linearizability) æ˜¯ä¸Šå›¾å³è¾¹åˆ†æ”¯çš„å¼€å§‹ï¼ŒLinearizability  åˆè¢«ç§°ä¸ºå¼ºä¸€è‡´æ€§æˆ–è€…åŸå­ä¸€è‡´æ€§ï¼Œåœ¨ &lt;a href=&#34;https://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf&#34;&gt;Linearizability: A Correctness Condition for Concurrent Objects&lt;/a&gt; è®ºæ–‡ä¸­ç»™å‡ºäº†å½¢å¼åŒ–çš„å®šä¹‰å’Œè¯æ˜ï¼Œè®ºæ–‡é‡Œé¢ä¸€è‡´æ€§æ˜¯åŸºäº single-object (eg: queue, register) ä»¥åŠ single-operation (eg: read, write, enqueue, dequeue) çš„æ¨¡å‹æ¥å®šä¹‰çš„ï¼Œä»å®šä¹‰ä¸Šæ¥çœ‹çº¿æ€§ä¸€è‡´æ€§æ˜¯ä¸€ä¸ªå•å¯¹è±¡çš„æ¨¡å‹ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡çš„èŒƒå›´æ˜¯å˜åŒ–çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä¸€ä¸ª register ä½œä¸ºä¸€ä¸ªå¯¹è±¡åŒæ ·ä¹Ÿå¯ä»¥æŠŠä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“çœ‹ä½œä¸€ä¸ªå¯¹è±¡ã€‚ç”±äºä¸Šè¿°å®šä¹‰ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨ä»»æ„çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸¥è°¨çš„è®¨è®º Linearizability, å°±éœ€è¦å°†ç³»ç»Ÿä»¥æŸç§æ–¹å¼è§„çº¦åˆ°è¿™ä¸ªæ¨¡å‹ä¸­ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Linearizability çš„åŸºæœ¬æƒ³æ³•æ˜¯è®©ä¸€ä¸ªç³»ç»Ÿçœ‹èµ·å¥½åƒåªæœ‰ä¸€ä¸ªæ•°æ®å‰¯æœ¬ï¼Œä¸”æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ã€‚åœ¨ä¸€ä¸ªå¯çº¿æ€§åŒ–çš„ç³»ç»Ÿä¸­ï¼Œä¸€æ—¦æŸä¸ªå®¢æˆ·ç«¯æˆåŠŸæäº¤å†™è¯·æ±‚ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯çš„è¯»è¯·æ±‚ä¸€å®šèƒ½å¤Ÿçœ‹åˆ°æœ€è¿‘å†™å…¥çš„å€¼ã€‚åœ¨è¿™ä¸ªè§£é‡Šé‡Œé¢éœ€è¦æ³¨æ„ä¸¤ä¸ªå…³é”®è¯ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æœ€è¿‘å†™å…¥&lt;/li&gt;&#xA;&lt;li&gt;æ‰€æœ‰å®¢æˆ·ç«¯&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;strong&gt;æœ€è¿‘å†™å…¥&lt;/strong&gt;å¼ºè°ƒçš„æ˜¯æ˜ç¡®åŸºäºå®é™…æ—¶é—´çš„å…ˆåé¡ºåºï¼Œ&lt;strong&gt;æ‰€æœ‰å®¢æˆ·ç«¯&lt;/strong&gt;å¼ºè°ƒçš„æ˜¯å¯¹ä»»åŠ¡å®¢æˆ·ç«¯çš„è¡¨ç°æ˜¯ä¸€è‡´çš„ã€‚ä¸ºäº†æ›´å¥½çš„è§£é‡Š Linearizability æƒ³æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç†æƒ³ä¸­çš„ä¾‹å­ï¼š&lt;/p&gt;&#xA;&lt;p&gt;å‡å¦‚æˆ‘ä»¬å°†åˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä½œä¸€ä¸ªæ•´ä½“ï¼Œå¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿæ»¡è¶³çº¿æ€§ä¸€è‡´æ€§å¹¶ä¸”åŒæ—¶æˆ‘ä»¬æœ‰å››ä¸ª Client è¿›è¡Œè¯»å†™æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬ç³»ç»Ÿå¤„ç†è¿™å››ä¸ªå®¢æˆ·ç«¯è¯·æ±‚çš„æµç¨‹åº”è¯¥å¦‚ä¸‹å›¾ï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/linearizability-1.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;åœ¨ä¸Šé¢æè¿°çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå‡è®¾å°±æ˜¯å‡è®¾æŠŠæˆ‘ä»¬çš„åˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä½œä¸€ä¸ªæ•´ä½“ï¼Œå¹¶ä¸”æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ¯æ¬¡æ“ä½œéƒ½æ˜¯åŸå­çš„å¹¶ä¸”ä¾æ¬¡çš„æ‰§è¡Œï¼Œä¸Šå›¾çš„æ›´åŠ ç®€åŒ–ç‰ˆæœ¬å¯ä»¥æŠŠæ¯ä¸€æ¬¡æ“ä½œçœ‹ä½œæ˜¯ä¸€ä¸ªå•ç‹¬çš„ç‚¹ï¼Œæ¯æ¬¡æ“ä½œéƒ½æ˜¯ç«‹åˆ»å‘ç”Ÿçš„:&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/linearizability-2.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸­ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿé€šå¸¸æ˜¯å¾ˆå¤šèŠ‚ç‚¹ä½œä¸ºä¸€ä¸ªæ•´ä½“å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¹¶ä¼šé‡åˆ°ç½‘ç»œå¼‚å¸¸æˆ–è€…æŸäº›èŠ‚ç‚¹å‡ºç°æ•…éšœï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯ä¸€æ¬¡æ“ä½œçš„æ—¶å€™å¹¶ä¸èƒ½åšåˆ°ç«‹å³ç›¸åº”ï¼Œå½“æˆ‘ä»¬å¤šä¸ªå®¢æˆ·ç«¯è¿›è¡Œè¯·æ±‚çš„æ—¶å€™å¤§æ¦‚ç‡æ˜¯ä¼šå‡ºç°é‡å çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„æ“ä½œæ»¡è¶³çº¦æŸï¼š&lt;strong&gt;ä¸€æ—¦æŸä¸€ä¸ªè¯»æ“ä½œè¿”å›äº†æ–°å€¼ï¼Œä¹‹åæ‰€æœ‰çš„è¯»ï¼ˆåŒ…æ‹¬ç›¸åŒæˆ–ä¸åŒçš„å®¢æˆ·ç«¯ï¼‰éƒ½å¿…é¡»è¿”å›æ–°å€¼&lt;/strong&gt;ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ¤æ–­è¿™ç»„æ“ä½œå†å²æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ã€‚è¿™æ¡çº¦æŸä¹Ÿæ˜¯åé¢æˆ‘ä»¬ç”¨æ¥éªŒè¯çº¿æ€§ä¸€è‡´æ€§çš„å…³é”®ä¹‹ä¸€ã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä¸ºäº†æ›´å¥½çš„ç†è§£ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ç»„&lt;strong&gt;ä¸æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§&lt;/strong&gt;çš„å†å²æ“ä½œï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/linearizability-3.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä¸Šå›¾ä¸­æ¯ä¸€ä¸ªå®¢æˆ·ç«¯æ‰€åœ¨çš„è¡Œä»£è¡¨è¿™ä¸ªå®¢æˆ·ç«¯æ‰€è¿›è¡Œçš„è¯·æ±‚ï¼Œæ¯ä¸€ä¸ªçŸ©å½¢æ¡†ä»£è¡¨ä¸€æ¬¡è¯·æ±‚ï¼Œ&lt;code&gt;Invoke&lt;/code&gt; ä»£è¡¨å‘èµ·è¯·æ±‚çš„æ—¶é—´ï¼Œ&lt;code&gt;Response&lt;/code&gt; ä»£è¡¨æ”¶åˆ°å“åº”ç»“æœçš„æ—¶é—´ï¼Œç”±äºç½‘ç»œå»¶è¿Ÿä¸ç¡®å®šï¼Œå®¢æˆ·ç«¯å¹¶ä¸æ¸…æ¥šç³»ç»Ÿå…·ä½“ä½•æ—¶çœŸæ­£å¤„ç†è¯·æ±‚çš„ï¼Œè€ŒåªçŸ¥é“å®ƒæ˜¯å‘ç”Ÿåœ¨å‘èµ·è¯·æ±‚ã€æ”¶åˆ°å“åº”ä¹‹å‰çš„æŸä¸€ä¸ªä¸­é—´ç‚¹ã€‚&lt;/p&gt;&#xA;&lt;p&gt;åœ¨ä¸Šå›¾ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‡è®¾æ‰€æœ‰ç‚¹çº¿æ€§åŒ–åˆ°æ—¶é—´è½´ä¸Šçš„ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ client 3 æˆåŠŸè¯»å–åˆ° x-&amp;gt;1, ä½†æ˜¯åœ¨ client3 è¯»å–ä¹‹åï¼Œclient 4 åŒæ ·ä¹Ÿå‘èµ·äº†ä¸€ä¸ªè¯»å–çš„è¯·æ±‚ï¼Œä½†æ˜¯ç¡®è¯»å–åˆ°äº† x-&amp;gt;0, client 4 çš„è¯»å–æ“ä½œè¿åäº†ä¸Šè¿°çº¿æ€§ä¸€è‡´æ€§çš„çº¦å®šï¼Œæ‰€ä»¥è¿™æ®µæ“ä½œå†å²æ˜¯ä¸æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ã€‚ä¸ºäº†æ›´å¥½çš„å¯¹æ¯”ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªæ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„å†å²çš„ç¤ºä¾‹ï¼Œå…¶å®åœ¨å›¾ä¸­å¦‚æœ client 4 è¯»å–çš„ç»“æœè¿”å›çš„æ˜¯ 1ï¼Œ è¿™æ®µå†å²å…¶å®å°±æ˜¯æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/linearizability-4.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;å…¶å®æˆ‘ä»¬åœ¨åˆ¤æ–­è¿™æ®µå†å²æ˜¯å¦ç¬¦åˆçº¿æ€§ä¸€è‡´æ€§çš„è¿‡ç¨‹æœ€åç”¨ä»£ç çš„æ–¹å¼å»å®ç°å°±æ„æˆäº†éªŒè¯çº¿æ€§ä¸€è‡´æ€§ç®—æ³•çš„æœ€åŸºæœ¬é€»è¾‘ã€‚åœ¨åç»­ä¼šæ›´åŠ è¯¦ç»†çš„ä»‹ç»åˆ°ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;-sequential-consistency&#34;&gt;é¡ºåºä¸€è‡´æ€§ (Sequential Consistency)&lt;/h2&gt;&#xA;&lt;p&gt;åœ¨ Herlihy &amp;amp; Wing æå‡ºçº¿æ€§ä¸€è‡´æ€§ä¹‹å‰ï¼ŒLamport è€çˆ·å­æ—©åœ¨ 1979 å¹´å°±æå‡ºäº†é¡ºåºä¸€è‡´æ€§ï¼ˆSequential consistency)çš„æ¦‚å¿µ:&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;A multiprocessor system is sequentially consistent if the result of any execution is the same as if the operations of all the processors were executed in some sequential order, and the operations of each individual processor appear in this sequence in the order specified by its program.&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;ä¸Šè¿°å®šä¹‰æ˜¯åŸºäº shared-memory multi-processor ç³»ç»Ÿçš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ç§ç³»ç»Ÿç†è§£æˆä¸åŒåˆ†å¸ƒå¼æ¨¡å¼ï¼Œä»è€Œæ‹“å±•åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸã€‚&lt;/p&gt;&#xA;&lt;p&gt;Lamport çš„å®šä¹‰ä¸­å¯¹ç³»ç»Ÿæå‡ºäº†ä¸¤æ¡å…±äº«å¯¹è±¡æ—¶çš„çº¦æŸï¼š&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;ä»å•ä¸ªå¤„ç†å™¨ (çº¿ç¨‹æˆ–è€…è¿›ç¨‹)çš„è§’åº¦æ¥çœ‹ï¼Œæ‰§è¡ŒæŒ‡ä»¤çš„é¡ºåºä»¥ç¼–ç¨‹ä¸­çš„é¡ºåºä¸ºå‡†ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä»æ‰€æœ‰çš„å¤„ç†å™¨(çº¿ç¨‹æˆ–è€…è¿›ç¨‹)çš„è§’åº¦æ¥çœ‹ï¼ŒæŒ‡ä»¤çš„æ‰§è¡Œä¿æŒä¸€ä¸ªå•ä¸€çš„é¡ºåºã€‚&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;çº¦æŸ 1 ä¿è¯åˆ—å•ä¸ªè¿›ç¨‹ä¸­çš„æ‰§è¡ŒæŒ‰ç…§ç¨‹åºé¡ºåºæ¥æ‰§è¡Œï¼Œçº¦æŸ2ä¿è¯äº†æ‰€æœ‰çš„å†…å­˜æ“ä½œéƒ½æ˜¯åŸå­ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°è¿™é‡Œçš„çº¦æŸå’Œçº¿æ€§ä¸€è‡´æ€§ç›¸æ¯”ï¼Œå®½æ¾äº†å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯è¦æ±‚æŒ‰ç…§ç¼–ç¨‹é¡ºåºè€Œä¸å†æ˜¯æ—¶é—´é¡ºåºäº†ã€‚ä¸ºäº†æ›´å¥½çš„ç†è§£è¿™ä¸¤ä¸ªçš„å·®å¼‚ï¼Œæˆ‘ä»¬åŒæ ·ç”¨ä¸€ç»„ç¤ºä¾‹æ¥è§£é‡Šï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/linearizability-5.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºé¡ºåºä¸€è‡´æ€§æ¥è®²ï¼Œä¸åœ¨è¦æ±‚ç»å¯¹çš„æ—¶é—´é¡ºåºï¼Œåªè¦æ»¡è¶³ç¼–ç¨‹é¡ºåºå°±å¯ä»¥ï¼Œæ‰€ä»¥é’ˆå¯¹ä¸Šå›¾ä¸­å†å² (a) æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°è¿™æ ·çš„æ‰§è¡Œåºåˆ— &lt;code&gt;Write(&amp;quot;y&amp;quot;, 1) -&amp;gt; Read(&amp;quot;x&amp;quot; -&amp;gt; 0) -&amp;gt; Write(&amp;quot;x&amp;quot;, 1) -&amp;gt; Read(&amp;quot;y&amp;quot; -&amp;gt; 1)&lt;/code&gt; æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œä½†æ˜¯å¯¹äºå†å² (a) æˆ‘ä»¬å¯ä»¥åˆ¤æ–­ä»–æ˜¯éƒ¨ç½²çº¿æ€§ä¸€è‡´æ€§ï¼Œå› ä¸º &lt;code&gt;Wriete(&amp;quot;x&amp;quot;,1)&lt;/code&gt; è¦å…ˆäº &lt;code&gt;Read(&amp;quot;x&amp;quot;) -&amp;gt; 0&lt;/code&gt; æ‰§è¡Œï¼Œä½†æ˜¯ Read å´æ²¡æœ‰è¯»å–åˆ°æœ€æ–°å€¼ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºå†å² (b) è€Œè¨€ï¼Œå·®å¼‚æ˜¯ clien2 æ‰§è¡Œ &lt;code&gt;Read(&amp;quot;x&amp;quot;)&lt;/code&gt; å¾—åˆ°çš„ç»“æœæ˜¯ 1, ä¸ºæœ€æ–°çš„å€¼ï¼Œç¬¦åˆæ—¶é—´é¡ºåºçš„ &amp;quot;å†™åè¯»&amp;quot; çš„çº¦æŸï¼Œæ‰€ä»¥æ˜¯çº¿æ€§ä¸€è‡´æ€§ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºå†å² (c) ä¸ç®¡å¦‚ä½•çš„æ’åºï¼Œéƒ½æ— æ³•æ»¡è¶³ &amp;quot;å†™åè¯»&amp;quot; çº¦æŸï¼Œæ‰€ä»¥æ—¢ä¸ç¬¦åˆçº¿æ€§ä¸€è‡´æ€§ï¼Œä¹Ÿä¸ç¬¦åˆé¡ºåºä¸€è‡´æ€§ã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä»ä¸Šè¿°çš„ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œ&lt;strong&gt;é¡ºåºä¸€è‡´æ€§å’Œçº¿æ€§ä¸€è‡´æ€§éƒ½æ˜¯è¦æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³  &amp;quot;å†™åè¯»&amp;quot; çš„ä¸€ç»„æ“ä½œå†å²ï¼Œå·®å¼‚åœ¨äºçº¿æ€§ä¸€è‡´æ€§è¦æ±‚ä¸¥æ ¼çš„æ—¶é—´åºï¼Œè€Œé¡ºåºä¸€è‡´æ€§åªè¦æ±‚æ»¡è¶³ç¼–ç¨‹é¡ºåº&lt;/strong&gt;ã€‚&lt;/p&gt;&#xA;&lt;p&gt;åœ¨å›åˆ°æœ€å¼€å§‹ Jepsen çš„é‚£å¼ å›¾ä¸Šï¼Œé¡ºåºä¸€è‡´æ€§å†å¾€ä¸‹æ˜¯å› æœä¸€è‡´æ€§ä»¥åŠ PRAM(Pipeline Random Access Memory),  è¿™äº›æ˜¯æ›´åŠ å®½æ¾çš„ä¸€è‡´æ€§ä¿è¯ï¼Œè¿™é‡Œä¸å¤šåšè§£é‡Šï¼Œæˆ‘ä»¬ç»§ç»­æ¢ç´¢å¦ä¸€åˆ†æ”¯ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;-serializability&#34;&gt;å¯ä¸²è¡ŒåŒ– (Serializability)&lt;/h2&gt;&#xA;&lt;p&gt;å¯ä¸²è¡ŒåŒ– (Serializability) æ˜¯ä¸Šå›¾ Jepsen ä¸­å·¦è¾¹åˆ†æ”¯çš„å¼€å§‹ï¼Œå¯åºåˆ—åŒ–æ˜¯äº‹åŠ¡çš„éš”ç¦»å±æ€§ï¼Œå¯ä»¥è¯»å†™å¤šä¸ªå¯¹è±¡ï¼ˆè¡Œï¼Œæ–‡æ¡£ï¼Œè®°å½•ç­‰ï¼‰ã€‚ä»–ç”¨æ¥ç¡®ä¿äº‹åŠ¡çš„æ‰§è¡Œç»“æœä¸ä¸²è¡Œï¼ˆå³æ¯æ¬¡æ‰§è¡Œä¸€æ¬¡äº‹åŠ¡ï¼‰çš„ç»“æœå®Œå…¨ç›¸åŒï¼Œå³ä½¿ä¸²è¡Œæ‰§è¡Œçš„é¡ºåºå¯èƒ½é’ºäº‹åŠ¡çš„å®é™…æ‰§è¡Œé¡ºåºä¸åŒã€‚&lt;/p&gt;&#xA;&lt;p&gt;è¿™é‡Œè¦æƒ³å¿«é€Ÿç†è§£äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œå¯ä»¥å‚è€ƒè®ºæ–‡ &lt;a href=&#34;https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf&#34;&gt;A Critique of ANSI SQL Isolation Levels&lt;/a&gt;, åœ¨è¿™ç¯‡è®ºæ–‡ä¸­è¯¦ç»†èŠ‚ä»‹ç»äº†æ•°æ®åº“å®ç°ä¸­é‡åˆ°çš„å„ç§ä¸ªæ ·çš„éš”ç¦»é—®é¢˜ï¼Œä»¥åŠè®¨è®ºä¸åŒéš”ç¦»çº§åˆ«å­˜åœ¨çš„é—®é¢˜ã€‚ä¸ºäº†æ›´å¥½ç³»ç»Ÿçš„è§£é‡Šéš”ç¦»çº§åˆ«ï¼Œä¸‹é¢ä¼šç®€è¦æè¿°ä¸‹è®ºæ–‡é‡Œé¢ç”¨æ¥åŒºåˆ†ä¸åŒéš”ç¦»çº§åˆ«çš„å„ç§å¼‚å¸¸ç°è±¡ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;åé¢å…³äºéš”ç¦»çº§åˆ«çš„æè¿°ç¤ºä¾‹å–è‡ªå”é•¿è€åšå®¢ï¼š&lt;a href=&#34;https://www.jianshu.com/p/3673e612cce2&#34;&gt;ä¸€è‡´æ€§æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h3 id=&#34;p0---dirty-write&#34;&gt;P0 - Dirty Write&lt;/h3&gt;&#xA;&lt;p&gt;Dirty Write æè¿°çš„ä¸€ä¸ªäº‹åŠ¡è¦†ç›–äº†å¦ä¸€ä¸ªä¹‹å‰æœªæäº¤äº‹åŠ¡å†™å…¥çš„å€¼ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬æœ‰ä¸¤ä¸ªäº‹åŠ¡ï¼Œä¸€ä¸ªäº‹åŠ¡å†™å…¥ T1 x=y=1, è€Œå¦ä¸€ä¸ªäº‹åŠ¡ T2 å†™å…¥ x=y=2, æœ€ç»ˆç»“æœå´å¾—åˆ°äº† x=2 y=1ï¼Œè¿™æ˜æ˜¾å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡è¦†ç›–äº†ä¸€ä¸ªæœªæäº¤çš„äº‹åŠ¡ã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+------+-------+-------+-------+-------+&#xA;| T1   | Wx(1) |       |       | Wy(1) |&#xA;+------+-------+-------+-------+-------+&#xA;| T2   |       | Wx(2) | Wy(2) |       |&#xA;+------+-------+-------+-------+-------+&#xA;| x(0) | 1     | 2     | 2     | 2     |&#xA;+------+-------+-------+-------+-------+&#xA;| y(0) | 0     | 0     | 2     | 1     |&#xA;+------+-------+-------+-------+-------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h3 id=&#34;p1---dirty-read&#34;&gt;P1 - Dirty Read&lt;/h3&gt;&#xA;&lt;p&gt;Dirty Read ç°è±¡æè¿°ï¼š T1 å¯¹æŸä¸€ä¸ªæ•°æ®é¡¹è¿›è¡Œä¿®æ”¹ï¼ŒT2 åœ¨ T1 commit æˆ–è€… rollbackä¹‹å‰è¯»å–è¿™ä¸ªæ•°æ®é¡¹ï¼Œç„¶å T1 rollback äº†ï¼Œé‚£ä¹ˆ T2 å°±è¯»å–åˆ°äº†ä¸€ä¸ªä»æœªè¢« commit æˆ–è€…ä¸€ä¸ªä»æœªå­˜åœ¨çš„æ•°æ®&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+-------+--------+--------+--------+--------+&#xA;| T1    | Wx(10) |        |        | Wy(90) |&#xA;+-------+--------+--------+--------+--------+&#xA;| T2    |        | Rx(10) | Ry(50) |        |&#xA;+-------+--------+--------+--------+--------+&#xA;| x(50) | 10     | 10     | 10     | 10     |&#xA;+-------+--------+--------+--------+--------+&#xA;| y(50) | 50     | 50     | 50     | 90     |&#xA;+-------+--------+--------+--------+--------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å¦‚ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œåˆå§‹çŠ¶æ€ x=y=50, x+y=100, ç„¶å T1 å†™å…¥äº† x=10, è¿™ä¸ªæ—¶å€™ T2 å¼€å§‹è¯»å–åˆ° x=10, y=50, è¿™ä¸ªæ—¶å€™ x+y=60, æ‰“ç ´äº†çº¦æŸæ¡ä»¶ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;p2---non-repeatable-read--fuzzy-read&#34;&gt;P2 - Non-Repeatable Read / Fuzzy Read&lt;/h3&gt;&#xA;&lt;p&gt;Non-Repeatable Read ç°è±¡æè¿°ï¼šT1 è¯»å–æŸä¸ªæ•°æ®é¡¹ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ T2 ä¿®æ”¹äº†è¿™ä¸ªæ•°æ®é¡¹ç›®å¹¶ä¸”æäº¤äº†ï¼Œç„¶å T1 å†æ¬¡è¯»å–è¿™ä¸ªæ•°æ®é¡¹ï¼Œè¯»å–åˆ°äº†ä¸€ä¸ªå·²ç»è¢« T2 æ›´æ–°è¿‡çš„æ•°æ®é¡¹ï¼ˆå¯èƒ½æ˜¯ä¿®æ”¹ä¹Ÿå¯èƒ½æ˜¯è¢«åˆ é™¤ï¼‰&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+-------+--------+--------+--------+--------+&#xA;| T1    | Rx(50) |        |        | Ry(90) |&#xA;+-------+--------+--------+--------+--------+&#xA;| T2    |        | Wx(10) | Wy(90) |        |&#xA;+-------+--------+--------+--------+--------+&#xA;| x(50) | 50     | 10     | 10     | 10     |&#xA;+-------+--------+--------+--------+--------+&#xA;| y(50) | 50     | 50     | 90     | 90     |&#xA;+-------+--------+--------+--------+--------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ä¸Šè¿°ç¤ºä¾‹ä¸­åœ¨ T1 è¿˜åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼ŒT2 å·²ç»å®Œæˆäº†è½¬è´¦ï¼Œä½† T1 è¿™æ—¶å€™èƒ½è¯»åˆ°æœ€æ–°çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ x + y = 140 äº†ï¼Œç ´åäº†çº¦æŸæ¡ä»¶ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;p3---phantom&#34;&gt;P3 - Phantom&lt;/h3&gt;&#xA;&lt;p&gt;Phantom ç°è±¡æè¿°ï¼š T1 è¯»å–æ»¡è¶³ä¸€äº›&amp;lt;æœç´¢æ¡ä»¶&amp;gt;çš„ä¸€ç»„æ•°æ®é¡¹ï¼Œäº‹åŠ¡T2ç„¶ååˆ›å»ºæ»¡è¶³ T1 çš„&amp;lt;æœç´¢æ¡ä»¶&amp;gt;å¹¶æäº¤çš„æ•°æ®é¡¹ï¼Œå¦‚æœT1ç„¶åä½¿ç”¨ç›¸åŒçš„&amp;lt;æœç´¢æ¡ä»¶&amp;gt;é‡å¤è¯»å–ï¼Œå®ƒå°†è·å¾—ä¸ç¬¬ä¸€æ¬¡è¯»å–ä¸åŒçš„ç»„æ•°æ®é¡¹&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+----------------+-----------+--------------+--------------+--------------+&#xA;| T1             | {a, b, c} |              |              | R(4)         |&#xA;+----------------+-----------+--------------+--------------+--------------+&#xA;| T2             |           | W(d)         | W(4)         |              |&#xA;+----------------+-----------+--------------+--------------+--------------+&#xA;| Employees      | {a, b, c} | {a, b, c, d} | {a, b, c, d} | {a, b, c, d} |&#xA;+----------------+-----------+--------------+--------------+--------------+&#xA;| Employee Count | 3         | 3            | 4            | 4            |&#xA;+----------------+-----------+--------------+--------------+--------------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å‡è®¾ç°åœ¨ T1 æŒ‰ç…§æŸä¸ªæ¡ä»¶è¯»å–åˆ°äº†æ‰€æœ‰é›‡å‘˜ aï¼Œbï¼Œcï¼Œè¿™æ—¶å€™ count æ˜¯ 3ï¼Œç„¶å T2 æ’å…¥äº†ä¸€ä¸ªæ–°çš„é›‡å‘˜ dï¼ŒåŒæ—¶æ›´æ–°äº† count ä¸º 4ï¼Œä½†è¿™æ—¶å€™ T1 åœ¨è¯»å– count çš„æ—¶å€™ä¼šå¾—åˆ° 4ï¼Œå·²ç»è·Ÿä¹‹å‰è¯»å–åˆ°çš„ aï¼Œbï¼Œc å†²çªäº†ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;p4---lost-update&#34;&gt;P4 - Lost Update&lt;/h3&gt;&#xA;&lt;p&gt;Lost Update æè¿°çš„ç°è±¡æ˜¯äº‹åŠ¡ T1 æ‰§è¡Œäº†è·Ÿæ–°æ“ä½œæäº¤åï¼ŒT2 ä¹Ÿæ‰§è¡Œäº†è·Ÿæ–°æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™ T1 çš„æ›´æ–°å°±ä¸¢å¤±äº†çš„ç°è±¡ã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+--------+-----+---------+---------+&#xA;| T1     |     |         | Wx(110) |&#xA;+--------+-----+---------+---------+&#xA;| T2     |     | Wx(120) |         |&#xA;+--------+-----+---------+---------+&#xA;| x(100) | 100 | 120     | 110     |&#xA;+--------+-----+---------+---------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ä»»ä½• dirty writeï¼Œå› ä¸º T2 åœ¨ T1 æ›´æ–°ä¹‹å‰å·²ç»æäº¤æˆåŠŸï¼Œä¹Ÿæ²¡æœ‰ä»»ä½• dirty readï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ write ä¹‹åæ²¡æœ‰ä»»ä½• read æ“ä½œï¼Œä½†æ˜¯ï¼Œå½“æ•´ä¸ªäº‹åŠ¡ç»“æŸä¹‹åï¼ŒT2 çš„æ›´æ–°å…¶å®ä¸¢å¤±äº†ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;p4c---cursor-lost-update&#34;&gt;P4C - Cursor Lost Update&lt;/h3&gt;&#xA;&lt;p&gt;Cursor Lost Update æ˜¯ä¸Šé¢ Lost Update çš„ä¸€ä¸ªå˜ç§ï¼Œè·Ÿ SQL çš„ cursor ç›¸å…³ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼ŒRC(x) è¡¨æ˜åœ¨ cursor ä¸‹é¢ read xï¼Œè€Œ WC(x) åˆ™è¡¨æ˜åœ¨ cursor ä¸‹é¢å†™å…¥ xã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+--------+----------+---------+----------+&#xA;| T1     | RCx(100) |         | Wx(110) |&#xA;+--------+----------+---------+----------+&#xA;| T2     |          | Wx(75) |          |&#xA;+--------+----------+---------+----------+&#xA;| x(100) | 100      | 75      | 110      |&#xA;+--------+----------+---------+----------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å¦‚æœæˆ‘ä»¬å…è®¸ T2 åœ¨ T1 RC å’Œ WC ä¹‹é—´å†™å…¥æ•°æ®ï¼Œé‚£ä¹ˆ T2 çš„æ›´æ–°ä¹Ÿä¼šä¸¢å¤±ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;a5a---read-skew&#34;&gt;A5A - Read Skew&lt;/h3&gt;&#xA;&lt;p&gt;Read Skew ç°è±¡æè¿°ï¼šå‡è®¾äº‹åŠ¡T1è¯»å–xï¼Œç„¶åç¬¬äºŒä¸ªäº‹åŠ¡T2å°†xå’Œyæ›´æ–°å¹¶æäº¤ã€‚å¦‚æœç°åœ¨T1è¯»å–yï¼Œå®ƒå¯èƒ½ä¼šçœ‹åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚å°±å†å²è€Œè¨€ï¼Œæˆ‘ä»¬æœ‰å¼‚å¸¸ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;A5Aï¼šr1 [x] ... w2 [x] ... w2 [y] ... c2 ... r1 [y] ...ï¼ˆc1 or a1ï¼‰ï¼ˆè¯»åï¼‰&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ç»“åˆå…·ä½“ç¤ºä¾‹ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+-------+--------+--------+--------+--------+&#xA;| T1    | Rx(50) |        |        | Ry(75) |&#xA;+-------+--------+--------+--------+--------+&#xA;| T2    |        | Wx(25) | Wy(75) |        |&#xA;+-------+--------+--------+--------+--------+&#xA;| x(50) | 50     | 25     | 25     | 25     |&#xA;+-------+--------+--------+--------+--------+&#xA;| y(50) | 50     | 50     | 75     | 75     |&#xA;+-------+--------+--------+--------+--------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ç¤ºä¾‹ä¸­è¿˜æ˜¯ä¼ ç»Ÿçš„è½¬è´¦ä¾‹å­ï¼Œéœ€è¦ä¿è¯ x + y = 100ï¼Œé‚£ä¹ˆ T1 å°±ä¼šçœ‹åˆ°ä¸ä¸€è‡´çš„æ•°æ®äº†ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;a5b---write-skew&#34;&gt;A5B - Write Skew&lt;/h3&gt;&#xA;&lt;p&gt;Write Skew ç°è±¡æè¿°ï¼šå‡è®¾T1è¯»å–ä¸Cï¼ˆï¼‰ä¸€è‡´çš„xå’Œyï¼Œç„¶åT2è¯»å–xå’Œyï¼Œå†™å…¥xå’Œæäº¤ã€‚ç„¶åT1å†™yã€‚å¦‚æœxå’Œyä¹‹é—´å­˜åœ¨çº¦æŸï¼Œåˆ™å¯èƒ½ä¼šè¢«è¿åã€‚åœ¨å†å²æ–¹é¢ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;A5Bï¼šr1 [x] ... r2 [y] ... w1 [y] ... w2 [x] ...ï¼ˆc1 and c2 occurï¼‰ï¼ˆå†™åï¼‰&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ç»“åˆå…·ä½“ç¤ºä¾‹ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;+-------+--------+--------+--------+--------+&#xA;| T1    | Rx(30) | Ry(10) | Wy(60) |        |&#xA;+-------+--------+--------+--------+--------+&#xA;| T2    | Rx(30) | Ry(10) |        | Wx(50) |&#xA;+-------+--------+--------+--------+--------+&#xA;| x(30) | 30     | 30     | 30     | 50     |&#xA;+-------+--------+--------+--------+--------+&#xA;| y(10) | 10     | 10     | 60     | 60     |&#xA;+-------+--------+--------+--------+--------+&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå‡è®¾ x + y &amp;lt;= 100ï¼ŒT1 å’Œ T2 åœ¨æ‰§è¡Œçš„æ—¶å€™éƒ½å‘ç°æ»¡è¶³çº¦æŸï¼Œç„¶å T1 æ›´æ–°äº† yï¼Œè€Œ T2 æ›´æ–°äº† xï¼Œç„¶åæœ€ç»ˆç»“æœæ‰“ç ´äº†çº¦æŸã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-1&#34;&gt;éš”ç¦»çº§åˆ«&lt;/h3&gt;&#xA;&lt;p&gt;ä¸Šé¢ä»¥åŠæè¿°äº†ä¸åŒçš„å¼‚å¸¸æƒ…å†µï¼Œé€šå¸¸æˆ‘ä»¬æ ¹æ®è¿™äº›å¼‚å¸¸æƒ…å†µå®šä¹‰äº†ä¸€äº›éš”ç¦»çº§åˆ«ï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/isolation.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;NP - Not Possibleï¼Œåœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹é¢ä¸å¯èƒ½å‘ç”Ÿ&lt;br&gt;&#xA;SP - Sometimes Possibleï¼Œåœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹é¢æœ‰æ—¶å€™å¯èƒ½å‘ç”Ÿ  &lt;br&gt;&#xA;P - Possibleï¼Œåœ¨è¯¥éš”ç¦»çº§åˆ«ä¸‹é¢ä¼šå‘ç”Ÿ&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;å¦å¤–éœ€è¦æ³¨æ„ï¼Œä¸Šé¢æåˆ°çš„ isolation level éƒ½ä¸ä¿è¯å®æ—¶çº¦æŸï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹ A å®Œæˆäº†ä¸€æ¬¡å†™å…¥ wï¼Œç„¶åå¦å¤–çš„è¿›ç¨‹ B å¼€å§‹äº†ä¸€æ¬¡è¯»å– rï¼Œr å¹¶ä¸èƒ½ä¿è¯è§‚å¯Ÿåˆ° w çš„ç»“æœã€‚å¦å¤–ï¼Œåœ¨ä¸åŒäº‹åŠ¡ä¹‹é—´ï¼Œè¿™äº› isolation level ä¹Ÿä¸ä¿è¯ä¸åŒè¿›ç¨‹çš„é¡ºåºã€‚ä¸€ä¸ªè¿›ç¨‹å¯èƒ½åœ¨ä¸€æ¬¡äº‹åŠ¡é‡Œé¢çœ‹åˆ°ä¸€æ¬¡å†™å…¥ wï¼Œä½†å¯èƒ½åœ¨åé¢çš„äº‹åŠ¡ä¸Šé¢æ²¡çœ‹åˆ°åŒæ ·çš„ wã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªè¿›ç¨‹ç”šè‡³å¯èƒ½çœ‹ä¸åˆ°åœ¨è¿™ä¸ªè¿›ç¨‹ä¸Šé¢ä¹‹å‰çš„å†™å…¥ï¼Œå¦‚æœè¿™äº›å†™å…¥éƒ½æ˜¯å‘ç”Ÿåœ¨ä¸åŒçš„äº‹åŠ¡é‡Œé¢ã€‚æœ‰æ—¶å€™ï¼Œä»–ä»¬è¿˜å¯èƒ½ä¼šå¯¹äº‹åŠ¡è¿›è¡Œæ’åºï¼Œè­¬å¦‚å°† write-only çš„äº‹åŠ¡æ”¾åˆ°æ‰€æœ‰çš„ read äº‹åŠ¡çš„åé¢ã€‚&lt;/p&gt;&#xA;&lt;p&gt;è¦è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦ç»“åˆå‰å‡ ä¸ªç« èŠ‚ä¸­å®šä¹‰çš„ä¸€è‡´æ€§çº¦æŸæ¥å…±åŒæ¥ç¡®ä¿æˆ‘ä»¬åˆ†å¸ƒå¼æ•°æ®åº“èƒ½å¤ŸçœŸæ­£çš„è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;linearizability-vs-serializability&#34;&gt;Linearizability vs Serializability&lt;/h2&gt;&#xA;&lt;p&gt;Linearizability å’Œ Serializability å¾ˆå¤šæ—¶å€™ä¼šå‘ç”Ÿæ··æ·†ï¼Œè¿™ä¸¤ä¸ªè¯éƒ½æ˜¯è¡¨è¾¾è¡¨è¾¾ &amp;quot;å¯ä»¥æŒ‰ç…§é¡ºåºæ’åº&amp;quot; çš„æ„æ€ï¼Œä½†æ˜¯ä»–ä»¬å®Œå…¨ä¸åŒï¼Œéœ€è¦ä»”ç»†åŒºåˆ†ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Linearizabilityï¼š å¯çº¿æ€§åŒ–æ˜¯è¯»å†™å¯„å­˜å™¨ï¼ˆå•ä¸ªå¯¹è±¡ï¼‰çš„æœ€æ–°å€¼çš„ä¿è¯ã€‚å®ƒå¹¶ä¸è¦å»åšä½œç»„åˆåˆ°äº‹åŠ¡ä¸­ï¼Œå› æ­¤æ— æ¯”é¿å…å†™å€¾æ–œç­‰é—®é¢˜ã€‚&lt;/li&gt;&#xA;&lt;li&gt;Serializability: å¯ä¸²è¡ŒåŒ–æ˜¯äº‹åŠ¡çš„éš”ç¦»å±æ€§ï¼Œå…¶ä¸­æ¯éš”äº‹åŠ¡å¯ä»¥è¯»å†™å¤šä¸ªå¯¹è±¡ï¼ˆè¡Œï¼Œæ–‡æ¡£ï¼Œè®°å½•ç­‰ï¼‰ã€‚å®ƒç”¨æ¥ç¡®ä¿äº‹åŠ¡çš„æ‰§è¡Œç»“æœå’Œä¸²è¡Œæ‰§è¡Œï¼ˆæ¯æ¬¡æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡ï¼‰çš„ç»“æœå®Œå…¨ç›¸åŒï¼Œå³ä½¿ä¸²è¡Œæ‰§è¡Œçš„é¡ºåºå¯èƒ½å’Œäº‹åŠ¡çš„å®é™…æ‰§è¡Œé¡ºåºä¸åŒã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;æ•°æ®åº“å¯ä»¥åŒæ—¶æ”¯æŒå¯ä¸²è¡ŒåŒ–å’Œå¯çº¿æ€§åŒ–ï¼Œè¿™ç§ç»„åˆåˆè¢«ç§°ä½œä¸¥æ ¼çš„å¯ä¸²è¡ŒåŒ–(Strict Serializability, strong-1SR), å°±æ˜¯æœ€å¼€å§‹ Jepsen å›¾ä¸­æ ¹èŠ‚ç‚¹ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-2&#34;&gt;å¦‚ä½•éªŒè¯çº¿æ€§ä¸€è‡´æ€§&lt;/h2&gt;&#xA;&lt;p&gt;ä¸Šé¢è®²äº†é‚£ä¹ˆå¤šï¼Œæ¥ä¸‹æ¥åœ¨æ¢³ç†ä¸€ä¸‹ï¼Œç›®å‰å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•æ¥éªŒè¯çº¿æ€§ä¸€è‡´æ€§ (Linearizability)ã€‚&lt;/p&gt;&#xA;&lt;p&gt;é€šå¸¸ä¸ºäº†åˆ¤æ–­æ˜¯å¦æ­£ç¡®æä¾›äº†ä¸€è‡´æ€§ï¼Œé¦–å…ˆåœ¨è¿è¡Œè¿‡ç¨‹ä¸­è·å¾—ä¸€ç³»åˆ—ä¸åŒçš„æ‰§è¡Œå†å²ï¼Œæ¥ç€éªŒè¯æ¯ç»„å†å²æ˜¯å¦æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸æ»¡è¶³ï¼Œä¾¿å¯ä»¥è¯´ç³»ç»Ÿä¸æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ã€‚ä½†å¦‚æœæ²¡æœ‰å‘ç°ä¸æ»¡è¶³çš„å†å²ï¼Œä¹Ÿä¸è¯æ˜ç³»ç»Ÿä¸€å®šæ˜¯ä¸€è‡´æ€§çš„ã€‚è¿™é‡ŒéªŒè¯ç³»ç»Ÿæ˜¯å¦æ»¡è¶³ä¸€è‡´æ€§å°±è½¬å˜æˆå¦‚ä½•åˆ¤æ–­ä¸€ç»„æ‰§è¡Œå†å²æ˜¯å¦æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ï¼Œåœ¨ä¸Šé¢ä»‹ç»çº¿æ€§ä¸€è‡´æ€§çš„æ˜¯ä»¥åæˆ‘ä»¬ä¹ŸèŠåˆ°éªŒè¯ä¸€è‡´æ€§ç®—æ³•çš„å…³é”®ï¼Œæ˜¯ä»è¿™ä¸ªæ‰§è¡Œå†å²ä¸­æ‰¾ä¸€æ¡åˆç†çš„çº¿æ€§æ‰§è¡Œåºåˆ—ï¼Œå¦‚ä½•èƒ½å¤Ÿæ‰¾åˆ°è¿™æ ·çš„åºåˆ—ï¼Œå°±å¯ä»¥åˆ¤æ–­è¿™ä¸ªå†å²ç¬¦åˆçº¿æ€§ä¸€è‡´æ€§ï¼Œåæ­£ï¼Œå°±å¯ä»¥åˆ¤æ–­è¿™æ®µå†å²ä¸ç¬¦åˆçº¿æ€§ä¸€è‡´æ€§ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-3&#34;&gt;é—®é¢˜å¤æ‚åº¦&lt;/h3&gt;&#xA;&lt;p&gt;æˆ‘ä»¬è¦åœ¨è¿™æ®µå†å²ä¸­å¯»æ‰¾ç¬¦åˆçº¿æ€§ä¸€è‡´æ€§çš„åºåˆ—ï¼Œç›´è§‚æ¥çœ‹ï¼Œè¿™ä¸ªé—®é¢˜å˜æˆäº†ä¸€ä¸ªæ’åºé—®é¢˜ï¼Œæç«¯çš„æƒ…å†µä¸‹æ—¶é—´å¤æ‚åº¦æ˜¯ O(N!)ã€‚äº‹å®ä¸Šï¼ŒPhillip B. Gibbons å’Œ Ephraim Korach åœ¨ &lt;a href=&#34;http://www.cs.ox.ac.uk/people/gavin.lowe/LinearizabiltyTesting/paper.pdf&#34;&gt;Testing Shared Memories&lt;/a&gt; ä¸­å·²ç»è¯æ˜å…¶æ˜¯ä¸€ä¸ª &lt;strong&gt;NP-Complete&lt;/strong&gt; é—®é¢˜ã€‚è™½ç„¶ Gavin Lowe åœ¨ Testing for Linearizability ä¸­ç»™å‡ºäº†ä¸€äº›ç‰¹æ®Šé™åˆ¶ä¸‹çš„å¤šé¡¹å¼ç”šè‡³æ˜¯çº¿æ€§å¤æ‚åº¦çš„ç®—æ³•ï¼Œä½†åœ¨é€šç”¨åœºæ™¯ä¸‹ï¼Œåˆ¤å®šçº¿æ€§ä¸€è‡´æ€§å¹¶ä¸æ˜¯ä¸€ä¸ªå®¹æ˜“è§£å†³çš„é—®é¢˜ï¼Œ&lt;strong&gt;å…¶æœç´¢ç©ºé—´ä¼šéšç€æ‰§è¡Œå†å²çš„è§„æ¨¡æ€¥é€Ÿè†¨èƒ€&lt;/strong&gt;ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-4&#34;&gt;å…·ä½“å®è·µ&lt;/h3&gt;&#xA;&lt;p&gt;å³ä½¿çº¿æ€§ä¸€è‡´æ€§éªŒè¯æ˜¯ NP å®Œå…¨çš„ï¼Œåœ¨å®é™…ä¸­ï¼Œå®ƒä»ç„¶èƒ½åœ¨ä¸€äº›å°çš„å†å²ä¸Šé¢å¾ˆå¥½çš„å·¥ä½œã€‚çº¿æ€§ä¸€è‡´æ€§éªŒè¯å™¨çš„å®ç°ä¼šç”¨ä¸€ä¸ªå¯æ‰§è¡Œçš„è§„èŒƒï¼ŒåŠ ä¸Šä¸€ä¸ªå†å²ï¼Œæ‰§è¡Œä¸€ä¸ªæœç´¢è¿‡ç¨‹å»æ„é€ ä¸€ä¸ªçº¿æ€§åŒ–ï¼Œå¹¶ä½¿ç”¨ä¸€äº›æŠ€å·§æ¥é™åˆ¶å‡å°‘æœç´¢çš„ç©ºé—´ã€‚&lt;/p&gt;&#xA;&lt;h4 id=&#34;knossos&#34;&gt;Knossos&lt;/h4&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/jepsen-io/knossos&#34;&gt;Knossos&lt;/a&gt; æ˜¯ Jepsen ä¸­ä½¿ç”¨çš„ä¸€è‡´æ€§éªŒè¯å·¥å…·ï¼Œæ˜¯åŸºäº &lt;a href=&#34;http://www.cs.cmu.edu/~wing/publications/WingGong93.pdf&#34;&gt;WGL&lt;/a&gt; ç®—æ³•å®ç°çš„,è¿™ä¸ªç®—æ³•ä¸»è¦æ˜¯åœ¨ WG&lt;br&gt;&#xA;ç®—æ³•çš„åŸºç¡€çš„ä¸€ä¸ªæ”¹è¿›ï¼Œæ”¹è¿›çš„æ–¹å¼ä¸»è¦æ˜¯&lt;strong&gt;å¯¹æœç´¢æ ‘çš„å‰ªæï¼šé€šè¿‡ç¼“å­˜å·²ç»è§è¿‡çš„é…ç½®ï¼Œæ¥å‡å°‘é‡å¤æœç´¢&lt;/strong&gt;ï¼Œå…·ä½“å…³äº Knossos å¯ä»¥å‚è€ƒ &lt;a href=&#34;https://pingcap.com/blog-cn/linearizability/#linearizability-%E4%B8%80%E8%87%B4%E6%80%A7%E9%AA%8C%E8%AF%81&#34;&gt;Linearizability ä¸€è‡´æ€§éªŒè¯&lt;/a&gt; åšå®¢ã€‚&lt;/p&gt;&#xA;&lt;h4 id=&#34;porcupine&#34;&gt;Porcupine&lt;/h4&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/anishathalye/porcupine&#34;&gt;Porcupine&lt;/a&gt;&lt;br&gt;&#xA;ä¸€ä¸ªç”¨ Go å†™çš„æ›´å¿«çš„çº¿æ€§ä¸€è‡´æ€§éªŒè¯å·¥å…·ã€‚æ˜¯åŸºäº &lt;a href=&#34;http://www.kroening.com/papers/forte2015-li.pdf&#34;&gt;P-compositionality&lt;/a&gt; ç®—æ³•ï¼ŒP-compositionality ç®—æ³•åˆ©ç”¨äº†çº¿æ€§ä¸€è‡´æ€§çš„ Locality åŸç†ï¼Œå³&lt;strong&gt;å¦‚æœä¸€ä¸ªè°ƒç”¨å†å²çš„æ‰€æœ‰å­å†å²éƒ½æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ï¼Œé‚£ä¹ˆè¿™ä¸ªå†å²æœ¬èº«ä¹Ÿæ»¡è¶³çº¿æ€§ä¸€è‡´æ€§&lt;/strong&gt;ã€‚å› æ­¤ï¼Œå¯ä»¥å°†ä¸€äº›ä¸ç›¸å…³çš„å†å²åˆ’åˆ†å¼€æ¥ï¼Œå½¢æˆå¤šä¸ªè§„æ¨¡æ›´å°çš„å­å†å²ï¼Œè½¬è€ŒéªŒè¯è¿™äº›å­å†å²çš„çº¿æ€§ä¸€è‡´æ€§ï¼Œä¾‹å¦‚kvæ•°æ®ç»“æ„ä¸­å¯¹ä¸åŒkeyçš„æ“ä½œã€‚ä¸Šé¢æåˆ°äº†ç®—æ³•çš„è®¡ç®—æ—¶é—´éšç€å†å²è§„æ¨¡çš„å¢åŠ æ€¥é€Ÿè†¨èƒ€ï¼ŒP-compositionality ç›¸å½“äºç”¨&lt;strong&gt;åˆ†æ²»&lt;/strong&gt;çš„åŠæ³•æ¥é™ä½å†å²è§„æ¨¡ï¼Œè¿™ç§æ–¹æ³•åœ¨å¯ä»¥åˆ’åˆ†å­é—®é¢˜çš„åœºæ™¯ä¸‹ä¼šéå¸¸æœ‰ç”¨ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;è¿™äº›ç®—æ³•çš„å®ç°è¿˜æœªæ·±å…¥å»ç ”ç©¶ï¼Œåé¢éœ€è¦åœ¨æŠ½å‡ºæ—¶é—´ä¸€ä¸€çš„å»å°è¯•ä¸€ä¸‹è¿™äº›ç®—æ³•çš„å®ç°ï¼Œå¯èƒ½å¯¹ç†è§£ä¸€è‡´æ€§ä¼šæ›´æœ‰å¸®åŠ©ã€‚&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;heading-5&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.jianshu.com/p/3673e612cce2&#34;&gt;ä¸€è‡´æ€§æ¨¡å‹&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://kaiyuan.me/2018/04/21/consistency-concept/&#34;&gt;åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://duanple.blog.163.com/blog/static/7097176720185963122866/&#34;&gt;çº¿æ€§ä¸€è‡´æ€§ç†è®º  &lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.lagou.com/lgeduarticle/30180.html&#34;&gt;å½“æ•°æ®åº“é‡åˆ°åˆ†å¸ƒå¼&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://catkang.github.io/2018/07/30/test-linearizability.html&#34;&gt;å¦‚ä½•éªŒè¯çº¿æ€§ä¸€è‡´æ€§&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/linearizability-and-raft/#%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7%E5%92%8C-raft&#34;&gt;çº¿æ€§ä¸€è‡´æ€§å’Œ Raft&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://jepsen.io/consistency&#34;&gt;Consistency Models&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.bailis.org/blog/linearizability-versus-serializability/&#34;&gt;Linearizability versus Serializability&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://courses.csail.mit.edu/6.852/01/papers/p91-attiya.pdf&#34;&gt;Sequential Consistency versus Linearizability&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://cs.brown.edu/~mph/HerlihyW90/p463-herlihy.pdf&#34;&gt;Linearizability: A Correctness Condition for&lt;br&gt;&#xA;Concurrent Objects &lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/tr-95-51.pdf&#34;&gt;A Critique of ANSI SQL Isolation Levels&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>åœ¨å®¹å™¨ä¸­è®©æ—¶é—´è‡ªç”±æ‘‡æ‘†</title>
    <updated>2020-03-12T00:00:00Z</updated>
    <id>tag:int64.me,2020-03-12:/2020/åœ¨å®¹å™¨ä¸­è®©æ—¶é—´è‡ªç”±æ‘‡æ‘†.html</id>
    <link href="http://int64.me/2020/åœ¨å®¹å™¨ä¸­è®©æ—¶é—´è‡ªç”±æ‘‡æ‘†.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;&lt;a href=&#34;https://github.com/pingcap/chaos-mesh&#34;&gt;Chaos Mesh&lt;/a&gt; æ˜¯æœ€è¿‘å¼€æºçš„ Kubernetes æ··æ²Œæµ‹è¯•å¹³å°ï¼Œå¹¶ä¸”æœ€è¿‘æ”¯æŒäº† TimeChaos çš„æ–°åŠŸèƒ½ï¼Œç”¨æ¥æ¨¡æ‹Ÿ Time skew çš„æƒ…å†µï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çŸ¥é“ç›´æ¥ä¿®åœ¨å®¹å™¨ä¸­ä¿®æ”¹æ—¶é—´ï¼Œä¼šå½±å“æ•´ä¸ªç‰©ç†èŠ‚ç‚¹, è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œé‚£ä¹ˆ Chaos Mesh æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä¸€ä¸‹ Chaos Mesh æ˜¯å¦‚ä½•åœ¨å®¹å™¨ä¸­è®©æ—¶é—´è‡ªç”±æ‘‡æ‘†çš„ï¼&lt;/p&gt;&#xA;&lt;h2 id=&#34;time-skew-&#34;&gt;Time skew æ˜¯ä»€ä¹ˆ?&lt;/h2&gt;&#xA;&lt;p&gt;Time Skew ç›´æ¥ç¿»è¯‘å°±æ˜¯æ—¶é—´åç§»ï¼Œç™½è¯ä¸€ç‚¹å°±æ˜¯æˆ‘ä»¬ä»èŠ‚ç‚¹ä¸Šè·å–çš„æ—¶é—´å’Œå½“å‰çœŸå®çš„æ—¶é—´å‡ºç°åå·®ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;-time-skew-&#34;&gt;ä¸ºä»€ä¹ˆéœ€è¦æ¨¡æ‹Ÿ Time skew å‘¢ï¼Ÿ&lt;/h2&gt;&#xA;&lt;p&gt;åˆ†å¸ƒå¼æ•°æ®åº“è¦å®ç°å…¨å±€ä¸€è‡´æ€§å¿«ç…§ï¼Œéœ€è¦è§£å†³ä¸åŒèŠ‚ç‚¹ä¹‹é—´æ—¶é’Ÿä¸€è‡´çš„é—®é¢˜ã€‚å·¥ä¸šç•Œç›®å‰æœ‰ä¸‰ç§è§£å†³æ–¹æ¡ˆï¼š&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;å…¨å±€é›†ä¸­å¼æˆæ—¶æœåŠ¡&lt;/li&gt;&#xA;&lt;li&gt;æ··åˆé€»è¾‘æ—¶é’Ÿï¼ˆHLCï¼‰&lt;/li&gt;&#xA;&lt;li&gt;åŸå­é’Ÿ Truetimeã€‚&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;è¿™é‡Œä¸å…·ä½“è§£é‡Šå…·ä½“çš„å®ç°åŸç†å’Œä¼˜ç¼ºç‚¹ï¼Œç®€å•æ¥è¯´éƒ½æ˜¯ä¸ºäº†ä¿è¯æ—¶é’Ÿçš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯å¾€å¾€ç‰©ç†èŠ‚ç‚¹ä¸Šçš„ç‰©ç†æ—¶é—´æ€»æ˜¯ä¼šå‡ºç°åå·®ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨ NPT æœåŠ¡åŒæ­¥ä¹Ÿå¥½ï¼Œæˆ–è€…å…¶ä»–æ–¹æ³•æ€»æ˜¯æ²¡åŠæ³•å®Œå…¨é¿å…å‡ºç°è¯¯å·®ï¼Œè¿™æ—¶å€™å¦‚æœæˆ‘ä»¬çš„åº”ç”¨ä¸èƒ½å¤Ÿå¾ˆå¥½çš„å¤„ç†è¿™æ ·çš„æƒ…å†µçš„è¯ï¼Œå°±å¯èƒ½é€ æˆæ— æ³•é¢„çŸ¥çš„é”™è¯¯ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;ç‰©ç†èŠ‚ç‚¹ä¸Šå¯ä»¥è‚¿ä¹ˆåšï¼Ÿ&lt;/h2&gt;&#xA;&lt;p&gt;åœ¨ç‰©ç†èŠ‚ç‚¹å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code&gt;date -s&lt;/code&gt; å‘½ä»¤ä¿®æ”¹æ—¶é—´, ä½†éœ€è¦æ³¨æ„çš„æ˜¯æ­¤ä¿®æ”¹ä¼šå½±å“æ•´ä¸ªèŠ‚ç‚¹ä¸Šçš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯å…¶ä»–è¿›ç¨‹ä¹Ÿä¼šå—åˆ°å½±å“ã€‚&lt;/p&gt;&#xA;&lt;p&gt;ç¤ºä¾‹ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;# å°†ç³»ç»Ÿæ—¥æœŸè®¾å®šæˆ2009å¹´ 9æœˆ3æ—¥çš„å‘½ä»¤&#xA;date -s 9/03/2009&#xA;&#xA;# å°†ç³»ç»Ÿæ—¶é—´è®¾å®šæˆä¸‹åˆ5ç‚¹55åˆ†55ç§’çš„å‘½ä»¤&#xA;date -s 17:55:55&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h2 id=&#34;jepsen-&#34;&gt;Jepsen æ˜¯è‚¿ä¹ˆåšçš„ï¼Ÿ&lt;/h2&gt;&#xA;&lt;p&gt;Jepsen æ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„éªŒè¯åˆ†å¸ƒå¼ä¸€è‡´æ€§éªŒè¯æ¡†æ¶ï¼Œé‡‡ç”¨å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ Clojure ç¼–å†™ï¼ˆä¸å¾—ä¸è¯´ä¹‹å‰æ Jepsen çš„æ—¶å€™ï¼Œå·®ç‚¹è¢« clojure æç–¯ï¼‰ã€‚Jepsen ä¹Ÿæä¾›äº† time skew åŠŸèƒ½ï¼Œåœ¨ Jepsen é‡Œæ˜¯ç›´æ¥ä½¿ç”¨äº†ä¸€æ®µ C ä»£ç æ¥æå®šçš„:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;....&#xA;    /* Set time */&#xA;    if (0 != settimeofday(&amp;amp;time, &amp;amp;tz)) {&#xA;      perror(&amp;quot;settimeofday&amp;quot;);&#xA;      return 2;&#xA;    }&#xA;....&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;è¯¦ç»†å®ç°ï¼šhttps://github.com/jepsen-io/jepsen/blob/master/jepsen/resources/bump-time.c&lt;/p&gt;&#xA;&lt;p&gt;ç®€å•è§£é‡Šä¸€ä¸‹å°±æ˜¯ä½¿ç”¨äº† &lt;code&gt;settimeofday&lt;/code&gt; æ—¶é—´å‡½æ•°æ¥è®¾ç½®ç³»ç»Ÿæ—¶é—´ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;-docker-&#34;&gt;æ¢ç´¢ Docker ä¸­çš„å®ç°æ–¹å¼&lt;/h2&gt;&#xA;&lt;p&gt;ç”±äº Jepsen å®ç°ä¸­ç›´æ¥æ˜¯è°ƒç”¨äº† &lt;code&gt;settimeofday&lt;/code&gt; æ“ä½œè®¾ç½®æ—¶é—´ï¼Œè¿™æ ·çš„æ“ä½œä¼šå¯¼è‡´æ•´ä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šçš„æ—¶é—´éƒ½å‘ç”Ÿæ”¹å˜ï¼Œä½†æ˜¯ Chaos Mesh æ˜¯è¿è¡Œåœ¨ Kubernetes ä¸Šçš„ï¼Œå¦‚æœæˆ‘ä»¬ç»™æŸä¸ªè¿›ç¨‹æ³¨å…¥ time skew å¯¼è‡´æ•´ä¸ªç‰©ç†èŠ‚ç‚¹éƒ½å‡ºç°äº†æ—¶é—´é—®é¢˜ï¼Œé‚£ä¹ˆä¼šå½±å“æ•´ä¸ª node ä¸Šå…¶ä»–çš„å®¹å™¨ï¼Œè¿™æ˜¯æˆ‘ä»¬æ— æ³•å®¹å¿ã€‚æ‰€ä»¥ç›´æ¥é€šè¿‡ &lt;code&gt;data&lt;/code&gt; å‘½ä»¤æˆ–è€…æ˜¯ç›´æ¥ä½¿ç”¨ &lt;code&gt;sttimeofday&lt;/code&gt; ä¹‹ç±»çš„æ—¶é—´å‡½æ•°æ˜¯è¡Œä¸é€šçš„ï¼Œé‚£ä¹ˆæŒ‘æˆ˜æ¥äº†ï¼Œåœ¨è¯¥è‚¿ä¹ˆå»è¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœå‘¢ï¼Ÿ&lt;/p&gt;&#xA;&lt;p&gt;é¦–å…ˆæˆ‘ä»¬æƒ³åˆ°ä½¿ç”¨ BPF é€šè¿‡å†…æ ¸çš„æ–¹å‘å¯»æ‰¾çªç ´å£ï¼Œå¹¸å¥½æˆ‘ä»¬ Team æœ‰ä¸€ä½ Kernel æ–¹é¢çš„ä¸“å®¶ï¼Œè¿™ä¸€å…‰è£æŒ‘æˆ˜æ€§çš„ä»»åŠ¡å°±è½åœ¨äº†ä»–çš„å¤´ä¸Šï¼Œæ¥ä¸‹æ¥åˆ†æå‡ ä¸ªæˆ‘ä»¬æ¢ç´¢çš„æ€è·¯&lt;/p&gt;&#xA;&lt;h3 id=&#34;-ld-preload&#34;&gt;ä½¿ç”¨ LD_PRELOAD&lt;/h3&gt;&#xA;&lt;p&gt;&lt;code&gt;LD_PRELOAD&lt;/code&gt; æ˜¯ Linux ç³»ç»Ÿçš„ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå®ƒå¯ä»¥å½±å“ç¨‹åºçš„è¿è¡Œæ—¶çš„é“¾æ¥ï¼ˆRuntime linkerï¼‰ï¼Œå®ƒå…è®¸ä½ å®šä¹‰åœ¨ç¨‹åºè¿è¡Œå‰ä¼˜å…ˆåŠ è½½çš„åŠ¨æ€é“¾æ¥åº“ã€‚è¿™ä¸ªåŠŸèƒ½ä¸»è¦å°±æ˜¯ç”¨æ¥æœ‰é€‰æ‹©æ€§çš„è½½å…¥ä¸åŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„ç›¸åŒå‡½æ•°ã€‚é€šè¿‡è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸»ç¨‹åºå’Œå…¶åŠ¨æ€é“¾æ¥åº“çš„ä¸­é—´åŠ è½½åˆ«çš„åŠ¨æ€é“¾æ¥åº“ï¼Œç”šè‡³è¦†ç›–æ­£å¸¸çš„å‡½æ•°åº“ã€‚ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æ­¤åŠŸèƒ½æ¥ä½¿ç”¨è‡ªå·±çš„æˆ–æ˜¯æ›´å¥½çš„å‡½æ•°ï¼ˆæ— éœ€åˆ«äººçš„æºç ï¼‰ï¼Œè€Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¥å‘åˆ«äººçš„ç¨‹åºæ³¨å…¥ç¨‹åºï¼Œä»è€Œè¾¾åˆ°ç‰¹å®šçš„ç›®çš„ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºä½¿ç”¨åº”ç”¨ç¨‹åºè°ƒç”¨æ—¶é—´å‡½æ•°æ˜¯ä½¿ç”¨ glibc çš„æ–¹å¼è¯ï¼Œ &lt;code&gt;LD_PRELOAD&lt;/code&gt; æ˜¯å¯ä»¥ç”Ÿæ•ˆçš„ï¼Œæ¯”å¦‚ Rust, C ï¼Œ ä½†æ˜¯å¯¹äºæœ‰äº›ç¨‹åºæ¯”å¦‚ Golngï¼ŒGolang ä¼šç›´æ¥è§£æ &lt;a href=&#34;http://man7.org/linux/man-pages/man7/vdso.7.html&#34;&gt;vDSO&lt;/a&gt; æ®µè·å–æ—¶é—´å‡½æ•°åœ°å€è·³è½¬è¿‡å»ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ &lt;code&gt;LD_PRELOAD&lt;/code&gt; çš„æ–¹å¼æ‹¦æˆª glibc æ¥å£.&lt;/p&gt;&#xA;&lt;p&gt;ä¸‹é¢ç®€å•è§£é‡Šä¸€ä¸‹ VDSO&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;VDSO (virtual dynamic share object) æ˜¯ä¸€ç§åŠ é€Ÿæ–¹æ³•ï¼Œå†…æ ¸å¼€å‘äººå‘˜å‘ç°æœ‰ä¸ªåˆ«ç³»ç»Ÿè°ƒç”¨åªä¼šäº§ç”Ÿè¯» kernel å†…å­˜æ“ä½œï¼Œè€Œä»æ¥ä¸å†™ï¼Œä½†å‡ºäºå®‰å…¨æ€§ç”¨æˆ·åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´æ˜¯åˆ†ç¦»çš„ã€‚æ¯æ¬¡è¯»éƒ½ä¼šå‘ç”Ÿç‰¹æƒçº§åˆ‡æ¢ï¼Œå¼€é”€å¾ˆå¤§ã€‚å› ä¸ºåªè¯»ï¼Œæ‰€ä»¥å†…æ ¸å¼€å‘äººå‘˜å†³å®šå¹²è„†å°†è¿™äº›åœ°å€æ”¾åœ¨ä¸€ä¸ªåŒºåŸŸï¼Œè™½ç„¶ä»åœ°å€ç©ºé—´èŒƒå›´æ¥çœ‹å±äºå†…æ ¸åœ°å€ç©ºé—´ï¼Œä½†æŠŠå®ƒç®—æˆæ˜¯ç”¨æˆ·æ€åœ°å€ç©ºé—´ï¼Œåœ°å€é‡Œé¢çš„å€¼çš„æ›´æ–°ç”±å†…æ ¸æ€æ¥è´Ÿè´£ï¼Œç”¨æˆ·æ€çš„ç¨‹åºå»è¯»åŒºè¿™æ®µå†…å­˜å’Œè®¿é—®ç”¨æˆ·æ€ç¨‹åºä¸€æ · ï¼ˆgdb å¯ä»¥ç›´æ¥ step è¿›å»ï¼‰ï¼Œè¿™æ ·å°±å¤§å¹…åº¦çš„æé«˜äº†æ€§èƒ½ã€‚&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;ç”±äº &lt;code&gt;LD_PRELOAD&lt;/code&gt; çš„å±€é™æ€§ï¼Œæ‰€ä»¥è¿™ä¸ªæ€è·¯çœ‹èµ·æ¥è¡Œä¸é€š&lt;/p&gt;&#xA;&lt;h3 id=&#34;-bpf--clock-gettime-&#34;&gt;ä½¿ç”¨ BPF ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨ clock_gettime è¿”å›å€¼&lt;/h3&gt;&#xA;&lt;p&gt;æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ BPF å¯¹ä»»åŠ¡çš„ PID è¿›è¡Œè¿‡æ»¤è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡åªå¯¹å…·ä½“çš„æŸä¸ªè¿›ç¨‹è¿›è¡Œ time skew, å¹¶ä¸”é€šè¿‡ä¿®æ”¹ç³»ç»Ÿè°ƒç”¨ clock_gettime çš„è¿”å›å€¼å®ç°æˆ‘ä»¬çš„ç›®çš„ã€‚è¿™ä¸ªæ€è·¯çœ‹ä¼¼å¾ˆå¥½ï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œclock_gettime ç»å¤§æ•°æƒ…å†µä¸‹æ˜¯é€šè¿‡ VDSO åŠ é€Ÿï¼Œå¹¶ä¸ä¼šè¿›è¡ŒçœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå‘±å”§ä¸€ä¸‹ï¼Œèµ°ä¸é€šäº†ï¼Œæœ€åæŸ¥åˆ°ï¼Œå¦‚æœæˆ‘ä»¬çš„ç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ 4.18 åŠä»¥ä¸Šçš„è¯ï¼Œå¹¶ä¸”ä½¿ç”¨ &lt;a href=&#34;https://www.kernel.org/doc/html/latest/timers/hpet.html&#34;&gt;HPET&lt;/a&gt; æ—¶é’Ÿï¼Œclock_gettime ç³»ç»Ÿè°ƒç”¨åœ¨ VDSO ä¸­æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œå¹¶ä¸”ä¼šæ­£å¸¸èµ°ç³»ç»Ÿè°ƒç”¨ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¹¶ä¸”æˆ‘ä»¬ä½¿ç”¨ä¸Šè¿°æ–¹æ¡ˆå®ç°äº†ä¸€ç‰ˆ &lt;a href=&#34;https://github.com/chaos-mesh/bpfki&#34;&gt;time skew&lt;/a&gt;, å¹¶ä¸”ç»è¿‡æµ‹è¯•å¯¹äº Rust, C è¿™æ ·çš„ç¨‹åºæ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ï¼Œä½†æ˜¯å¯¹äº Golang è¿™æ ·çš„ç¨‹åºæ¥è¯´è·å–æ—¶é—´æ˜¯æ­£å¸¸çš„ï¼Œä½†æ˜¯å‡ºç°ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¦‚æœç¨‹åºåœ¨è¢«æ³¨å…¥ time skew çš„æœŸé—´ï¼Œæ‰§è¡Œ sleep æ“ä½œçš„è¯ï¼Œsleep æ“ä½œå­˜åœ¨å¾ˆå¤§å¯èƒ½ä¼šè¢« block ä½ï¼ˆtime skew å–æ¶ˆåä¾ç„¶æ— æ³•æ¢å¤ï¼‰ï¼Œç»è¿‡æ’æŸ¥æ€€ç–‘æ˜¯å› ä¸º bpf ä¼šåœ¨ç³»ç»Ÿè°ƒç”¨è¿”å›å‰ä¿®æ”¹ç”¨æˆ·æ€åœ°å€ç©ºé—´ ï¼ˆå­˜å‚¨ timeval æˆ– timspec çš„åœ°æ–¹ï¼‰ï¼Œè€Œ golang çš„ runtime ä¸ºäº†é˜²æ­¢é˜»å¡ï¼Œä¼šæŠŠè¿™ä¸ªè°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„ G ä¸¢å‡ºå»ï¼Œæ–°çš„ G å’Œ P ç»‘å®šï¼Œé‚£ä¹ˆé‚£å—åœ°å€ç©ºé—´å¯èƒ½ä¼šè¢«æ–°ç»‘å®šçš„ G è®¿é—® ï¼Œå¯¼è‡´äº† panic æˆ– hangã€‚ï¼ˆå…·ä½“é—®é¢˜çš„åŸå› è¿˜æ²¡å®Œå…¨ç¡®å®šï¼‰&lt;/p&gt;&#xA;&lt;p&gt;å¥½äº†ä¸Šé¢ç®€å•æè¿°äº†ä¸¤ç§æˆ‘ä»¬åœ¨æ¢ç´¢ä¸­æƒ³åˆ°çš„ä¸¤ç§æ–¹æ¡ˆï¼Œéƒ½å­˜åœ¨äº›å±€é™æ€§å’Œé—®é¢˜ï¼Œé‚£ä¹ˆæœ€ååœ¨ Chaos Mesh ä¸­æ˜¯çœŸæ­£å¦‚ä½•å»å®ç°çš„å‘¢ï¼Ÿ&lt;/p&gt;&#xA;&lt;p&gt;ä¸å¾—è¯´ç°åœ¨çš„å®ä¹ ç”Ÿå¤ªå¼ºäº†ï¼Œæœ€ç»ˆæˆ‘ä»¬ä½¿ç”¨çš„æ–¹å¼æ˜¯æˆ‘ä»¬ Team ä¸€å®ä¹ ç”Ÿæå‡ºæ¥å¹¶å®ç°çš„ï¼Œå¹çˆ†ä»–ï¼Œç‰¹åˆ« hack çš„æ–¹æ¡ˆï¼Œä¸‹é¢å°±ä¸€æ¢ç©¶ç«Ÿ...&lt;/p&gt;&#xA;&lt;h2 id=&#34;chaos-meshhttpsgithubcompingcapchaos-mesh-&#34;&gt;&lt;a href=&#34;https://github.com/pingcap/chaos-mesh&#34;&gt;Chaos Mesh&lt;/a&gt; ä¸­è½åœ°&lt;/h2&gt;&#xA;&lt;p&gt;ä»ä¸Šé¢æ¢ç´¢æ–¹æ¡ˆä¸­å¯ä»¥çŸ¥é“ï¼Œæ­£å¸¸ç¨‹åºè·å–ç³»ç»Ÿæ˜¯æ—¶é—´ç»å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯é€šè¿‡ clock_gettime å®ç°çš„ï¼Œåªæ˜¯æˆ‘ä»¬çš„ clock_gettime åˆšå¥½æ˜¯ä½¿ç”¨ vDSO åŠ é€Ÿï¼Œå¯¼è‡´æˆ‘ä»¬æ²¡åŠæ³•å¥½ç›´æ¥ä½¿ç”¨ LD_PRELOAD æ–¹å¼å» hack clock_gettime çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä» VDSO ç€æ‰‹è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æŠŠ VDSO ä¸­è®°å½• clock_gettime ç»“æœçš„åœ°å€æŒ‡å‘ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±å®šä¸€ä¸ªçš„å®ç°å°±å¥½äº†ï¼Œç†æƒ³æ˜¯ç¾å¥½çš„ï¼Œä½†ç°å®æ€»æ˜¯æ®‹é…·ï¼Œè¦è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦è§£å†³å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;éœ€è¦çŸ¥é“ VDSO æ®µçš„ç”¨æˆ·æ€åœ°å€&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœè¦é€šè¿‡å†…æ ¸æ€çš„ä»»æ„åœ°å€æ›´æ”¹ vDSO æ®µä¸­ clock_gettime å‡½æ•°çš„å†…å®¹ï¼Œéœ€è¦çŸ¥é“ VDSO æ®µçš„å†…æ ¸æ€åœ°å€&lt;/li&gt;&#xA;&lt;li&gt;å¦‚ä½•å»ä¿®æ”¹ VDSO æ®µä¸­çš„æ•°æ®&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;é¦–å…ˆæˆ‘ä»¬å…ˆçœ‹çœ‹ VDSO æ˜¯ä¸ªä»€ä¹ˆæ ·å­çš„, æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹çš„ &lt;code&gt;/proc/pid/maps&lt;/code&gt; ä¸­æŸ¥çœ‹åˆ° VDSO çš„å†…å­˜åœ°å€ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;$ cat /proc/pid/maps &#xA;...&#xA;7fa931533000-7fabb1533000 r--s 00000000 08:03 13631798                   /var/lib/etcd/member/snap/db&#xA;7fabb1533000-7fabb1cf3000 rw-p 00000000 00:00 0&#xA;7fae3192b000-7fae31f33000 rw-p 00000000 00:00 0&#xA;7ffe530fc000-7ffe5311d000 rw-p 00000000 00:00 0                          [stack]&#xA;7ffe53143000-7ffe53145000 r-xp 00000000 00:00 0                          [vdso]&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;æœ€åä¸€è¡Œå°±æ˜¯ VDSO çš„ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ®µå†…å­˜ç©ºé—´çš„æƒé™æ˜¯ &lt;code&gt;r-xp&lt;/code&gt; ï¼Œå¯è¯»å¯æ‰§è¡Œä½†æ˜¯ä¸å¯å†™ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ç”¨æˆ·æ€æ²¡åŠæ³•å»ä¿®æ”¹è¿™æ®µå†…å­˜ï¼Œä¸ºäº†å®ç°å¯ä»¥å»ä¿®æ”¹ VDSO, æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ &lt;a href=&#34;http://man7.org/linux/man-pages/man2/ptrace.2.html&#34;&gt;ptrace&lt;/a&gt; æäº‹æƒ…ã€‚&lt;/p&gt;&#xA;&lt;p&gt;æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª VDSO é‡Œé¢å…·ä½“æœ‰äº›ä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ gdb dump memory ç›´æ¥æŠŠ VDSO å¯¼å‡ºæ¥ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ &lt;code&gt;objdump&lt;/code&gt; æŸ¥çœ‹ä¸€ä¸‹å…·ä½“å†…å®¹ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;(gdb) dump memory vdso.so 0x00007ffe53143000 0x00007ffe53145000 &#xA;&#xA;&#xA;$ objdump -T vdso.so&#xA;&#xA;vdso.so:     file format elf64-x86-64&#xA;&#xA;DYNAMIC SYMBOL TABLE:&#xA;ffffffffff700600  w   DF .text&#x9;0000000000000545  LINUX_2.6   clock_gettime&#xA;0000000000000000 g    DO *ABS*&#x9;0000000000000000  LINUX_2.6   LINUX_2.6&#xA;ffffffffff700b50 g    DF .text&#x9;00000000000002b4  LINUX_2.6   __vdso_gettimeofday&#xA;ffffffffff700e30 g    DF .text&#x9;000000000000003d  LINUX_2.6   __vdso_getcpu&#xA;ffffffffff700b50  w   DF .text&#x9;00000000000002b4  LINUX_2.6   gettimeofday&#xA;ffffffffff700e10  w   DF .text&#x9;0000000000000016  LINUX_2.6   time&#xA;ffffffffff700e30  w   DF .text&#x9;000000000000003d  LINUX_2.6   getcpu&#xA;ffffffffff700600 g    DF .text&#x9;0000000000000545  LINUX_2.6   __vdso_clock_gettime&#xA;ffffffffff700e10 g    DF .text&#x9;0000000000000016  LINUX_2.6   __vdso_time&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å…¶å®æ•´ä¸ª VDSO å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ª &lt;code&gt;.so&lt;/code&gt; çš„æ–‡ä»¶ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code&gt;ELF&lt;/code&gt; æ–‡ä»¶å¤„ç†æ–¹å¼ï¼Œæ¥æ ¼å¼åŒ– VDSOã€‚è¯´åˆ°è¿™é‡Œæˆ‘ä»¬å®ç° time skew çš„åŸºæœ¬æ€è·¯å·²ç»æœ‰äº†ï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/timechaos.png&#34; alt=&#34;image&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä¸Šè¿°æµç¨‹å›¾å³ä¸º Chaos Mesh ä¸­ TimeChaos çš„å®ç°åŸºæœ¬æµç¨‹&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç¬¬ä¸€æ­¥æˆ‘ä»¬ä¼šå…ˆä½¿ç”¨ ptrace attach æŒ‡å®šçš„ pid è¿›ç¨‹ï¼Œè®©å½“å‰è¿›ç¨‹å¤„äº stop çŠ¶æ€&lt;/li&gt;&#xA;&lt;li&gt;æ¥ç€ä½¿ç”¨ ptrace åœ¨è¿›ç¨‹å†…å­˜ä¸­æ˜ å°„å‡ºä¸€æ®µå†…å­˜ç©ºé—´å°†æˆ‘ä»¬è‡ªå·±çš„ &lt;code&gt;fake_clock_gettime&lt;/code&gt; ä½¿ç”¨ &lt;code&gt;process_vm_writev&lt;/code&gt; å†™åˆ°å†…å­˜ç©ºé—´ä¸­&lt;/li&gt;&#xA;&lt;li&gt;å°†æŒ‡å®šçš„å‚æ•°é€šè¿‡ &lt;code&gt;process_vm_writev&lt;/code&gt; å†™åˆ° &lt;code&gt;fake_clock_gettime&lt;/code&gt; ä¸­ï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯æŒ‡æˆ‘ä»¬çœŸæ­£æƒ³è¦æ³¨å…¥çš„æ—¶é—´ï¼Œæ¯”å¦‚å¾€å‰ 2h, å¾€å 2d ä¹‹ç±»çš„å‚æ•°&lt;/li&gt;&#xA;&lt;li&gt;æ¥ç€ä½¿ç”¨ ptrace ä¿®æ”¹ VDSO ä¸­ &lt;code&gt;clock_gettime&lt;/code&gt; å‡½æ•°éƒ¨åˆ†ï¼Œç›´æ¥è·³è½¬åˆ° &lt;code&gt;fake_clock_gettime&lt;/code&gt; å‡½æ•°ä¸Šã€‚&lt;/li&gt;&#xA;&lt;li&gt;æœ€å ptrace detch&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å…·ä½“å®ç°å¯ä»¥å‚è€ƒï¼šhttps://github.com/pingcap/chaos-mesh/blob/master/pkg/time/time_linux.go&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-1&#34;&gt;çœ‹ä¸€ä¸‹æ•ˆæœ&lt;/h2&gt;&#xA;&lt;p&gt;è¿™é‡Œæˆ‘ç›´æ¥æ‹¿ TiDB ä½œä¸ºå°ç™½é¼ ï¼Œåœ¨ TiDB ä¸­é‡‡ç”¨é›†ä¸­å¼çš„æœåŠ¡ TSO æ¥è·å–å…¨å±€ä¸€ç›´çš„ç‰ˆæœ¬å·ï¼Œå¹¶ä¿è¯äº‹åŠ¡çš„ç‰ˆæœ¬å·å•è°ƒé€’å¢çš„ã€‚&lt;br&gt;&#xA;å¹¶ä¸” TSO æœåŠ¡æ˜¯ç”± PD è´Ÿè´£çš„ï¼Œè¿™é‡Œæˆ‘ä¼šéšæœºé€‰æ‹©ä¸€ PD èŠ‚ç‚¹ï¼Œå®šæœŸæ³¨å…¥ TimeChaos, å°†æ—¶é—´å¾€å‰è°ƒæ•´ 10m, æ¥æ£€éªŒä¸€ä¸‹ TiDB æ˜¯å¦è¿˜èƒ½æ­£å¸¸å·¥ä½œğŸ˜ã€‚&lt;br&gt;&#xA;ä¸ºäº†æ›´å¥½è§‚å¯Ÿå®éªŒæ•ˆæœï¼Œå®éªŒä¸­ä½¿ç”¨ &lt;a href=&#34;https://github.com/cwen0/bank&#34;&gt;bank&lt;/a&gt; ä½œä¸º TiDB çš„ Workload, bank ç¨‹åºæ¨¡æ‹Ÿé“¶è¡Œè½¬è´¦, å¸¸ç”¨æ¥éªŒè¯äº‹åŠ¡çš„æ­£ç¡®æ€§ã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/pingcap/chaos-mesh/wiki&#34;&gt;Chaos Mesh&lt;/a&gt; å’Œ &lt;a href=&#34;https://pingcap.com/docs/stable/tidb-in-kubernetes/tidb-operator-overview/&#34;&gt;TiDB&lt;/a&gt; çš„å®‰è£…æµç¨‹å¯ä»¥å‚è€ƒå…·ä½“æ–‡æ¡£ï¼Œè¿™é‡Œä¸åœ¨å¤šåŠ èµ˜è¿°ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å…ˆçœ‹ä¸€ä¸‹å…·ä½“å®éªŒé…ç½®ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;apiVersion: pingcap.com/v1alpha1&#xA;kind: TimeChaos&#xA;metadata:&#xA;  name: time-skew-example&#xA;  namespace: tidb-demo&#xA;spec:&#xA;  mode: one&#xA;  selector:&#xA;    labelSelectors:&#xA;      &amp;quot;app.kubernetes.io/component&amp;quot;: &amp;quot;pd&amp;quot;&#xA;  timeOffset:&#xA;    sec: -600&#xA;  clockIds:&#xA;    - CLOCK_REALTIME&#xA;  duration: &amp;quot;10s&amp;quot;&#xA;  scheduler:&#xA;    cron: &amp;quot;@every 1m&amp;quot;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;æ‰§è¡Œä¸Šè¿°å®éªŒï¼ŒChaos Mesh ä¼šæ¯éš” 1m é€‰ä¸­ä¸€ä¸ª PD pod æ³¨å…¥ TimeChaos å¹¶æŒç»­ 10s, åœ¨è¿™ 10s å†…ï¼Œ&lt;br&gt;&#xA;PD è·å–çš„æ—¶é—´ä¼šå’ŒçœŸå®çš„æ—¶é—´ç›¸å·® 600sã€‚å…·ä½“å®éªŒå®šä¹‰å¯ä»¥å‚è€ƒ Chaos Mesh &lt;a href=&#34;https://github.com/pingcap/chaos-mesh/wiki/Time-Chaos&#34;&gt;Wiki&lt;/a&gt;.&lt;/p&gt;&#xA;&lt;p&gt;æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code&gt;kubectl apply&lt;/code&gt; å‘½ä»¤åˆ›å»º TimeChaos å®éªŒï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl apply -f pd-time.yaml&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;æˆåŠŸåˆ›å»ºå®éªŒåï¼Œå°±åˆ°äº†æ£€éªŒç»“æœçš„æ—¶å€™äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹åˆ—å‘½ä»¤å»æ£€ç´¢ PD çš„æ—¥å¿—:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;kubectl logs -n tidb-demo tidb-app-pd-0 | grep &amp;quot;system time jump backward&amp;quot;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å¾—åˆ°å¦‚ä¸‹è¾“å‡ºï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code class=&#34;language-bash&#34;&gt;[2020/03/24 09:06:23.164 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585041383060109693]&#xA;[2020/03/24 09:16:32.260 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585041992160476622]&#xA;[2020/03/24 09:20:32.059 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585042231960027622]&#xA;[2020/03/24 09:23:32.059 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585042411960079655]&#xA;[2020/03/24 09:25:32.059 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585042531963640321]&#xA;[2020/03/24 09:28:32.060 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585042711960148191]&#xA;[2020/03/24 09:33:32.063 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043011960517655]&#xA;[2020/03/24 09:34:32.060 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043071959942937]&#xA;[2020/03/24 09:35:32.059 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043131978582964]&#xA;[2020/03/24 09:36:32.059 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043191960687755]&#xA;[2020/03/24 09:38:32.060 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043311959970737]&#xA;[2020/03/24 09:41:32.060 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043491959970502]&#xA;[2020/03/24 09:45:32.061 +00:00] [ERROR] [systime_mon.go:32] [&amp;quot;system time jump backward&amp;quot;] [last=1585043731961304629]&#xA;...&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ä»æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ŒPD å°±ä¼šæ£€æµ‹å‡ºç³»ç»Ÿæ—¶é—´ä¼šé€€çš„ä¿¡æ¯ï¼Œç”±æ­¤å¯ä»¥è¯´æ˜ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;TimeChaos ç”Ÿæ•ˆäº†&lt;/li&gt;&#xA;&lt;li&gt;PD å®ç°ä¸­è€ƒè™‘åˆ° Time skew çš„æƒ…å†µ&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;æœ€åé€šè¿‡ Chaos-Dashboard å†æ¬¡ç¡®è®¤ä¸€ä¸‹ TimeChaos å¯¹ TiDB çš„å½±å“:&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;../images/time-skew.png&#34; alt=&#34;pd TimeChaos&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä»ç›‘æ§ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¯éš” 1m ä¼šæ³¨å…¥ä¸€æ¬¡ TimeChaos å¹¶æŒç»­ 10sï¼Œ&lt;br&gt;&#xA;å¹¶ä¸”æ³¨å…¥çš„ TimeChaos å¯¹ TiDB å‡ ä¹æ— å½±å“ï¼Œbank ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸”æ€§èƒ½ä¹ŸåŸºæœ¬æ²¡æœ‰å˜åŒ–ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-2&#34;&gt;æœ€å&lt;/h2&gt;&#xA;&lt;p&gt;æœ€åè¯´ç‚¹å•¥å‘¢ï¼Ÿæ¬¢è¿å¤§å®¶å…¥å‘ &lt;a href=&#34;https://github.com/pingcap/chaos-mesh&#34;&gt;Chaos Mesh&lt;/a&gt;&lt;/p&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>TC - Linux æµé‡æ§åˆ¶å·¥å…·</title>
    <updated>2018-05-23T00:00:00Z</updated>
    <id>tag:int64.me,2018-05-23:/2018/TC - Linux æµé‡æ§åˆ¶å·¥å…·.html</id>
    <link href="http://int64.me/2018/TC - Linux æµé‡æ§åˆ¶å·¥å…·.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;æœ€è¿‘ä¸€ä¸ªæ–°ä»»åŠ¡ï¼Œéœ€è¦æ¨¡æ‹Ÿé™åˆ¶ä¸»æœºå¸¦å®½çš„åœºæ™¯ï¼Œä¹‹å‰åªæ˜¯çŸ¥é“ä½¿ç”¨ &lt;code&gt;tc&lt;/code&gt; æ˜¯å¯ä»¥åšåˆ°æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿã€ç½‘ç»œä¸¢åŒ…ç­‰æƒ…å†µï¼Œæ‰€æœ‰å°±æƒ³åº”è¯¥ &lt;code&gt;tc&lt;/code&gt; ä¹Ÿå¯ä»¥æå®šé™åˆ¶å¸¦å®½çš„æƒ…å†µï¼Œå°±åœ¨ç½‘ä¸Šæœäº†ä¸€æ³¢ï¼Œæœä¸å…¶ç„¶ &lt;code&gt;tc&lt;/code&gt; è¿˜æ˜¯å¼ºå¤§ï¼Œå¯æ˜¯å¯¹äºç”¨æ¥é™åˆ¶å¸¦å®½ï¼Œæ“ä½œèµ·æ¥è¿˜æ˜¯å¾ˆè›‹ç–¼ï¼Œè¸©äº†ä¸å°‘å‘..&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;ç®€å•è¯´ä¸€ä¸‹åŸç†&lt;/h2&gt;&#xA;&lt;p&gt;æœ¬æ¥æ‰“ç®—ç›´æ¥åˆ—ä¸€æ³¢ç”¨æ³•ï¼Œä½†æ˜¯æ€»è§‰å¾—ï¼Œä¸è®°å½•ä¸€ä¸‹åŸç†ï¼Œæ“ä½œèµ·æ¥ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼ã€‚&lt;br&gt;&#xA;TC é€šè¿‡å»ºç«‹å¤„ç†æ•°æ®åŒ…é˜Ÿåˆ—ï¼Œå¹¶å®šä¹‰é˜Ÿåˆ—ä¸­æ•°æ®åŒ…è¢«å‘é€çš„æ–¹å¼ï¼Œä»è€Œå®ç°è¿›è¡Œæµé‡æ§åˆ¶ã€‚TC æ¨¡æ‹Ÿå®ç°æµé‡æ§åˆ¶åŠŸèƒ½ä½¿ç”¨çš„é˜Ÿåˆ—åˆ†ä¸ºä¸¤ç±»ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ— ç±»é˜Ÿåˆ—ï¼ˆclsslessï¼‰: ä½¿ç”¨ classless é˜Ÿåˆ—ï¼ŒTC å¯¹è¿›å…¥ç½‘å¡çš„æµé‡ä¸åŠ ä»»ä½•åŒºåˆ†ï¼Œç»Ÿä¸€å¯¹å¾…, å¸¸ç”¨çš„æ— ç±»é˜Ÿåˆ—æœ‰ &lt;strong&gt;pfifo _fast (å…ˆè¿›ç°å‡º) ã€TBF ( ä»¤ç‰Œæ¡¶è¿‡æ»¤å™¨) ã€SFQ(éšæœºå…¬å¹³é˜Ÿåˆ—) ã€ID (å‰ å‘éšæœºä¸¢åŒ…)&lt;/strong&gt; ç­‰ç­‰ã€‚è¿™ç±»é˜Ÿåˆ—è§„å®šä½¿ç”¨çš„æµé‡æ•´å½¢æ‰‹æ®µä¸»è¦ æ˜¯æ’åºã€é™é€Ÿå’Œä¸¢åŒ…ã€‚&#xA;&lt;ul&gt;&#xA;&lt;li&gt;fifo, ä½¿ç”¨æœ€ç®€å•çš„ qdiscï¼ˆæ’é˜Ÿè§„åˆ™ï¼‰ï¼Œçº¯ç²¹çš„å…ˆè¿›å…ˆå‡ºã€‚åªæœ‰ä¸€ä¸ªå‚æ•°ï¼šlimit ï¼Œç”¨æ¥è®¾ç½®é˜Ÿåˆ—çš„é•¿åº¦ï¼Œpfifo æ˜¯ä»¥æ•°æ®åŒ…çš„ä¸ªæ•°ä¸ºå•ä½ï¼›bfifo æ˜¯ä»¥å­—èŠ‚æ•°ä¸ºå•ä½ã€‚&lt;/li&gt;&#xA;&lt;li&gt;pfifo_fastï¼Œåœ¨ç¼–è¯‘å†…æ ¸æ—¶ï¼Œå¦‚æœæ‰“å¼€äº†é«˜çº§è·¯ç”±å™¨ï¼ˆAdvanced Routerï¼‰ç¼–è¯‘é€‰é¡¹ï¼Œpfifo_fast å°±æ˜¯ç³»ç»Ÿçš„æ ‡å‡† qdisc(æ’é˜Ÿè§„åˆ™)ã€‚å®ƒçš„é˜Ÿåˆ—åŒ…æ‹¬ä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰ã€‚åœ¨æ¯ä¸ªæ³¢æ®µé‡Œé¢ï¼Œä½¿ç”¨å…ˆè¿›å…ˆå‡ºè§„åˆ™ã€‚è€Œä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰çš„ä¼˜å…ˆçº§ä¹Ÿä¸ç›¸åŒï¼Œband 0 çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œband 2 çš„æœ€ä½ã€‚å¦‚æœ band 0 é‡Œé¢æœ‰æ•°æ®åŒ…ï¼Œç³»ç»Ÿå°±ä¸ä¼šå¤„ç† band 1 é‡Œé¢çš„æ•°æ®åŒ…ï¼Œband 1 å’Œ band 2 ä¹‹é—´ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ•°æ®åŒ…æ˜¯æŒ‰ç…§æœåŠ¡ç±»å‹ï¼ˆType Of Serviceï¼ŒTOS ï¼‰è¢«åˆ†é…åˆ°ä¸‰ä¸ªæ³¢æ®µï¼ˆbandï¼‰é‡Œé¢çš„ã€‚&lt;/li&gt;&#xA;&lt;li&gt;redï¼Œred æ˜¯ Random Early Detectionï¼ˆéšæœºæ—©æœŸæ¢æµ‹ï¼‰çš„ç®€å†™ã€‚å¦‚æœä½¿ç”¨è¿™ç§ qdsicï¼Œå½“å¸¦å®½çš„å ç”¨æ¥è¿‘ä¸è§„å®šçš„å¸¦å®½æ—¶ï¼Œç³»ç»Ÿä¼šéšæœºçš„ä¸¢å¼ƒä¸€äº›æ•°æ®åŒ…ã€‚ä»–éå¸¸é€‚åˆé«˜å¸¦å®½çš„åº”ç”¨ã€‚&lt;/li&gt;&#xA;&lt;li&gt;sfqï¼Œsfq æ˜¯ Stochastic Fairness Queueing çš„ç®€å†™ã€‚å®ƒä¼šæŒ‰ç…§ä¼šè¯ï¼ˆsession -- å¯¹åº”ä¸æ¯ä¸ª TCP è¿æ¥æˆ–è€… UDP æµï¼‰ä¸ºæµé‡è¿›è¡Œæ’åºï¼Œç„¶åå¾ªç¯å‘é€æ¯ä¸ªä¼šè¯çš„æ•°æ®åŒ…ã€‚&lt;/li&gt;&#xA;&lt;li&gt;tbfï¼Œtbf æ˜¯ Token Bucket Filter çš„ç®€å†™ï¼Œé€‚ç”¨äºæŠŠæµé€Ÿé™ä½åˆ°æŸä¸ªå€¼ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;åˆ†ç±»é˜Ÿåˆ—ï¼ˆclassfulï¼‰ï¼šå½“ä½¿ç”¨ classful é˜Ÿåˆ—æ—¶ï¼ŒTC å¯¹è¿›è¡Œçš„ç½‘ç»œè®¾å¤‡çš„æ•°æ®åŒ…æ ¹æ®ä¸åŒçš„éœ€æ±‚è¿›è¡Œåˆ†ç±»å¤„ç†ã€‚TC ä½¿ç”¨è¿‡æ»¤å™¨è¿›è¡Œåˆ†ç±»ï¼ŒTC æ ¹æ®è¿‡æ»¤å™¨å®šä¹‰çš„è§„åˆ™åŒ¹é…ç›¸åº”çš„æ•°æ®åŒ…ï¼Œå‘é€åˆ°å¯¹åº”çš„åˆ†ç±»é˜Ÿåˆ—ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥å¯¹å­ç±»åœ¨æ¬¡ä½¿ç”¨è¿‡æ»¤å™¨è¿›è¡Œåˆ†ç±»ã€‚ç†è®ºä¸Šè¿™å¯ä»¥æ˜¯ä¸€ä¸ªæ— é™æ·±åº¦çš„æ ‘ã€‚&#xA;&lt;ul&gt;&#xA;&lt;li&gt;CBQï¼ŒCBQ æ˜¯ Class Based Queueingï¼ˆåŸºäºç±»åˆ«æ’é˜Ÿï¼‰çš„ç¼©å†™ã€‚å®ƒå®ç°äº†ä¸€ä¸ªä¸°å¯Œçš„è¿æ¥å…±äº«ç±»åˆ«ç»“æ„ï¼Œæ—¢æœ‰é™åˆ¶ï¼ˆshapingï¼‰å¸¦å®½çš„èƒ½åŠ›ï¼Œä¹Ÿå…·æœ‰å¸¦å®½ä¼˜å…ˆçº§åˆ«ç®¡ç†çš„èƒ½åŠ›ã€‚å¸¦å®½é™åˆ¶æ˜¯é€šè¿‡è®¡ç®—è¿æ¥çš„ç©ºé—²æ—¶é—´å®Œæˆçš„ã€‚ç©ºé—²æ—¶é—´çš„è®¡ç®—æ ‡å‡†æ˜¯æ•°æ®åŒ…ç¦»é˜Ÿäº‹ä»¶çš„é¢‘ç‡å’Œä¸‹å±‚è¿æ¥ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼‰çš„å¸¦å®½ã€‚&lt;/li&gt;&#xA;&lt;li&gt;HTBï¼ŒHTB æ˜¯ Hierarchy Token Bucket çš„ç¼©å†™ã€‚é€šè¿‡åœ¨å®è·µåŸºç¡€ä¸Šçš„æ”¹è¿›ï¼Œå®ƒå®ç°ä¸€ä¸ªä¸°å¯Œçš„è¿æ¥å…±äº«ç±»åˆ«ä½“ç³»ã€‚ä½¿ç”¨ HTB å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¿è¯æ¯ä¸ªç±»åˆ«çš„å¸¦å®½ï¼Œè™½ç„¶å®ƒä¹Ÿå…è®¸ç‰¹å®šçš„ç±»å¯ä»¥çªç ´å¸¦å®½ä¸Šé™ï¼Œå ç”¨åˆ«çš„ç±»çš„å¸¦å®½ã€‚HTB å¯ä»¥é€šè¿‡ TBFï¼ˆToken Bucket Filterï¼‰å®ç°å¸¦å®½é™åˆ¶ï¼Œä¹Ÿèƒ½å¤Ÿåˆ’åˆ†ç±»åˆ«çš„ä¼˜å…ˆçº§ã€‚&lt;/li&gt;&#xA;&lt;li&gt;PRIOï¼ŒPRIO qdisc ä¸èƒ½é™åˆ¶å¸¦å®½ï¼Œå› ä¸ºå±äºä¸åŒç±»åˆ«çš„æ•°æ®åŒ…æ˜¯é¡ºåºç¦»é˜Ÿçš„ã€‚ä½¿ç”¨ PRIO qdisc å¯ä»¥å¾ˆå®¹æ˜“å¯¹æµé‡è¿›è¡Œä¼˜å…ˆçº§ç®¡ç†ï¼Œåªæœ‰å±äºé«˜ä¼˜å…ˆçº§ç±»åˆ«çš„æ•°æ®åŒ…å…¨éƒ¨å‘é€å®Œæ¯•ï¼Œå‚ä¼šå‘é€å±äºä½ä¼˜å…ˆçº§ç±»åˆ«çš„æ•°æ®åŒ…ã€‚ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œéœ€è¦ä½¿ç”¨ iptables æˆ–è€… ipchains å¤„ç†æ•°æ®åŒ…çš„æœåŠ¡ç±»å‹ï¼ˆType Of Serviceï¼ŒTOSï¼‰ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;classful é˜Ÿåˆ—è§„å®šï¼ˆqdiscï¼‰, ç±»ï¼ˆclassï¼‰å’Œè¿‡æ»¤å™¨ï¼ˆfilterï¼‰è¿™ 3 ä¸ªç»„ä»¶ç»„æˆï¼Œç»˜å›¾ä¸­ä¸€èˆ¬ç”¨åœ†å½¢è¡¨ç¤ºé˜Ÿåˆ—è§„å®šï¼Œç”¨çŸ©å½¢è¡¨ç¤ºç±»ï¼Œå›¾ copy è‡ª &lt;a href=&#34;http://blog.51cto.com/professor/1570778&#34;&gt;Linux ä¸‹ TC ä»¥åŠ netem é˜Ÿåˆ—çš„ä½¿ç”¨&lt;/a&gt;&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/wKiom1RU0lKAEIb9AAFPHLlaSng303.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;çœ‹ä¸€å¼ å›¾è¯´æ˜ä¸€ä¸‹åŸºæœ¬åŸç†ï¼ˆç›´æ¥ copy è‡ª &lt;a href=&#34;http://www.ituring.com.cn/article/274014&#34;&gt;æµé‡æ§åˆ¶å·¥å…· TC è¯¦ç»†è¯´æ˜&lt;/a&gt;ï¼š&lt;br&gt;&#xA;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/image_1b6at6vf47qubm51vq69qvaod1g.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ¥æ”¶åŒ…ä»è¾“å…¥æ¥å£ï¼ˆInput Interfaceï¼‰è¿›æ¥åï¼Œç»è¿‡æµé‡é™åˆ¶ï¼ˆIngress Policingï¼‰ä¸¢å¼ƒä¸ç¬¦åˆè§„å®šçš„æ•°æ®åŒ…ï¼Œç”±è¾“å…¥å¤šè·¯åˆ†é…å™¨ï¼ˆInput De-Multiplexingï¼‰è¿›è¡Œåˆ¤æ–­é€‰æ‹©......&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœæ¥æ”¶åŒ…çš„ç›®çš„æ˜¯æœ¬ä¸»æœºï¼Œé‚£ä¹ˆå°†è¯¥åŒ…é€ç»™ä¸Šå±‚å¤„ç†ï¼›å¦åˆ™éœ€è¦è¿›è¡Œè½¬å‘ï¼Œå°†æ¥æ”¶åŒ…äº¤åˆ°è½¬å‘å—ï¼ˆForwarding Blockï¼‰å¤„ç†ã€‚è½¬å‘å—åŒæ—¶ä¹Ÿæ¥æ”¶æœ¬ä¸»æœºä¸Šå±‚ï¼ˆTCPã€UDP ç­‰ï¼‰äº§ç”Ÿçš„åŒ…ã€‚è½¬å‘å—é€šè¿‡æŸ¥çœ‹è·¯ç”±è¡¨ï¼Œå†³å®šæ‰€å¤„ç†åŒ…çš„ä¸‹ä¸€è·³ã€‚ç„¶åï¼Œå¯¹åŒ…è¿›è¡Œæ’åˆ—ä»¥ä¾¿å°†å®ƒä»¬ä¼ é€åˆ°è¾“å‡ºæ¥å£ï¼ˆOutput Interfaceï¼‰ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä¸€èˆ¬æˆ‘ä»¬åªèƒ½é™åˆ¶ç½‘å¡å‘é€çš„æ•°æ®åŒ…ï¼Œä¸èƒ½é™åˆ¶ç½‘å¡æ¥æ”¶çš„æ•°æ®åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æ”¹å˜å‘é€æ¬¡åºæ¥æ§åˆ¶ä¼ è¾“é€Ÿç‡ã€‚ï¼ˆæ§åˆ¶ç½‘å¡å…¥å£æµé‡ï¼Œéœ€è¦æŠŠæ•°æ®åŒ…é‡å®šå‘åˆ°è™šæ‹Ÿè®¾å¤‡ ifbï¼Œ åœ¨ ifb çš„è¾“å‡ºæ–¹å‘å¯ä»¥é…ç½®ï¼Œåé¢ä¼šè¯¦ç»†è¯´è¿™ä¸ªï¼‰&lt;/li&gt;&#xA;&lt;li&gt;Linux æµé‡æ§åˆ¶ä¸»è¦æ˜¯åœ¨è¾“å‡ºæ¥å£æ’åˆ—æ—¶è¿›è¡Œå¤„ç†å’Œå®ç°çš„ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;tc-&#34;&gt;TC åŸºç¡€&lt;/h2&gt;&#xA;&lt;h3 id=&#34;heading-1&#34;&gt;ç»“æ„&lt;/h3&gt;&#xA;&lt;p&gt;éƒ½æ˜¯ä»¥ä¸€ä¸ªæ ¹ qdisc å¼€å§‹çš„ï¼Œè‹¥æ ¹ qdisc æ˜¯ä¸åˆ†ç±»çš„é˜Ÿåˆ—è§„å®šï¼Œé‚£å®ƒå°±æ²¡æœ‰å­ç±»ï¼Œå› æ­¤ä¸å¯èƒ½åŒ…å«å…¶ä»–çš„å­å¯¹è±¡ï¼Œä¹Ÿä¸ä¼šæœ‰è¿‡æ»¤å™¨ä¸ä¹‹å…³è”ï¼Œå‘é€æ•°æ®æ—¶ï¼Œæ•°æ®åŒ…è¿›å…¥è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢æ’é˜Ÿï¼Œç„¶åæ ¹æ®è¯¥é˜Ÿåˆ—è§„å®šçš„å¤„ç†æ–¹å¼å°†æ•°æ®åŒ…å‘é€å‡ºå»ã€‚&lt;/p&gt;&#xA;&lt;p&gt;åˆ†ç±»çš„ qdisc å†…éƒ¨åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç±»ï¼Œè€Œæ¯ä¸ªç±»å¯ä»¥åŒ…å«ä¸€ä¸ªé˜Ÿåˆ—è§„å®šæˆ–è€…åŒ…å«è‹¥å¹²ä¸ªå­ç±»ï¼Œè¿™äº›å­ç±»å‹å¯ä»¥åŒ…å«åˆ†ç±»æˆ–è€…ä¸åˆ†ç±»çš„é˜Ÿåˆ—è§„å®šï¼Œå¦‚æ­¤é€’å½’ï¼Œå½¢æˆäº†ä¸€ä¸ªæ ‘ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¥æŸ„å·ï¼šqdisc å’Œç±»éƒ½ä½¿ç”¨ä¸€ä¸ªå¥æŸ„è¿›è¡Œæ ‡è¯†ï¼Œä¸”åœ¨ä¸€æ£µæ ‘ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œæ¯ä¸ªå¥æŸ„ç”±ä¸»å·ç å’Œæ¬¡å·ç ç»„æˆ qdisc çš„æ¬¡å·ç å¿…é¡»ä¸º 0ï¼ˆ0 é€šå¸¸å¯ä»¥çœç•¥ä¸å†™ï¼‰&lt;/p&gt;&#xA;&lt;p&gt;æ ¹ qdisc çš„å¥æŸ„ä¸º 1ï¼šï¼Œä¹Ÿå°±æ˜¯ 1ï¼š0ã€‚ç±»çš„å¥æŸ„çš„ä¸»å·ç ä¸å®ƒçš„çˆ¶è¾ˆç›¸åŒï¼ˆçˆ¶ç±»æˆ–è€…çˆ¶ qdiscï¼‰ï¼Œå¦‚ç±» 1ï¼š1 çš„ä¸»å·ç ä¸åŒ…å«ä»–çš„é˜Ÿåˆ—è§„å®š 1ï¼šçš„ä¸»å·ç ç›¸åŒï¼Œ1ï¼š10 å’Œ 1ï¼š11 ä¸ä»–ä»¬çš„çˆ¶ç±» 1ï¼š1 çš„ä¸»å·ç ç›¸åŒï¼Œä¹Ÿä¸º 1ã€‚&lt;/p&gt;&#xA;&lt;p&gt;æ–°å»ºä¸€ä¸ªç±»æ—¶ï¼Œé»˜è®¤å¸¦æœ‰ä¸€ä¸ª pfifo_fast ç±»å‹çš„ä¸åˆ†ç±»é˜Ÿåˆ—è§„å®šï¼Œå½“æ·»åŠ ä¸€ä¸ªå­ç±»æ—¶ï¼Œè¿™ä¸ªç±»å‹çš„ qdisc å°±ä¼šè¢«åˆ é™¤ï¼Œæ‰€ä»¥ï¼Œéå¶å­ç±»æ˜¯æ²¡æœ‰é˜Ÿåˆ—è§„å®šçš„ï¼Œæ•°æ®åŒ…æœ€ååªèƒ½åˆ°å¶å­ç±»çš„é˜Ÿåˆ—è§„å®šé‡Œé¢æ’é˜Ÿã€‚&lt;/p&gt;&#xA;&lt;p&gt;è‹¥ä¸€ä¸ªç±»æœ‰å­ç±»ï¼Œé‚£ä¹ˆå…è®¸è¿™äº›å­ç±»ç«äº‰çˆ¶ç±»çš„å¸¦å®½ï¼Œä½†æ˜¯ï¼Œä»¥é˜Ÿåˆ—è§„å®šä¸ºçˆ¶è¾ˆçš„ç±»ä¹‹é—´æ˜¯ä¸å…è®¸ç›¸äº’ç«äº‰å¸¦å®½çš„ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-2&#34;&gt;åŸºæœ¬å‘½ä»¤&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;add å‘½ä»¤ï¼šåœ¨ä¸€ä¸ªèŠ‚ç‚¹é‡ŒåŠ å…¥ä¸€ä¸ª qdiscï¼Œç±»æˆ–è€…è¿‡æ»¤å™¨ã€‚æ·»åŠ æ—¶ï¼Œéœ€è¦ä¼ é€’ä¸€ä¸ªç¥–å…ˆä½œä¸ºå‚æ•°ï¼Œä¼ é€’å‚æ•°æ—¶æ—¢å¯ä»¥ä½¿ç”¨ ID ä¹Ÿå¯ä»¥ç›´æ¥ä¼ é€’è®¾å¤‡çš„æ ¹ï¼Œè‹¥å»ºä¸€ä¸ª qdisc æˆ–è€… filterï¼Œå¯ä»¥ä½¿ç”¨å¥æŸ„æ¥å‘½åï¼Œè‹¥å»ºä¸€ä¸ªç±»ï¼Œä½¿ç”¨ç±»è¯†åˆ«ç¬¦æ¥å‘½åã€‚&lt;/li&gt;&#xA;&lt;li&gt;delï¼šåˆ é™¤ç”±æŸä¸ªå¥æŸ„æŒ‡å®šçš„ qdiscï¼Œæ ¹ qdisc ä¹Ÿå¯ä»¥è¢«åˆ é™¤ï¼Œè¢«åˆ é™¤çš„ qdisc ä¸Šçš„æ‰€æœ‰å­ç±»ä»¥åŠé™„å±äºå„ä¸ªç±»çš„è¿‡æ»¤å™¨éƒ½ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚&lt;/li&gt;&#xA;&lt;li&gt;changeï¼šä»¥æ›¿ä»£æ–¹å¼ä¿®æ”¹æŸäº›é¡¹ç›®ï¼Œå¥æŸ„å’Œç¥–å…ˆä¸èƒ½ä¿®æ”¹ï¼Œchange å’Œ add è¯­æ³•ç›¸åŒã€‚&lt;/li&gt;&#xA;&lt;li&gt;replaceï¼šå¯¹ä¸€ä¸ªç°æœ‰èŠ‚ç‚¹è¿›è¡Œè¿‘äºåŸå­æ“ä½œçš„åˆ é™¤ / æ·»åŠ ï¼Œå¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿™ä¸ªå‘½ä»¤å°±ä¼šå»ºç«‹èŠ‚ç‚¹ã€‚&lt;/li&gt;&#xA;&lt;li&gt;linkï¼šåªé€‚ç”¨äº qdiscï¼Œæ›¿ä»£ä¸€ä¸ªç°æœ‰çš„èŠ‚ç‚¹&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;-egress&#34;&gt;æ§åˆ¶å‡ºå£æµé‡ (egress)&lt;/h2&gt;&#xA;&lt;p&gt;é»˜è®¤ TC çš„ qdisc æ§åˆ¶å°±æ˜¯å‡ºå£æµé‡ï¼Œè¦ä½¿ç”¨ TC æ§åˆ¶å…¥å£ï¼Œéœ€è¦æŠŠæµé‡é‡å®šå‘åˆ° ifb ç½‘å¡ï¼Œå…¶å®å°±æ˜¯åŠ äº†ä¸€å±‚ï¼ŒåŸç†ä¸Šè¿˜æ˜¯æ§åˆ¶å‡ºå£ğŸ˜‚ ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;-classless-&#34;&gt;å…ˆè¯´ classless é˜Ÿåˆ—&lt;/h3&gt;&#xA;&lt;p&gt;ä¸ºä½•è¦å…ˆè¯´ classless é˜Ÿåˆ—ï¼Œæ¯•ç«Ÿè¿™ä¸ªç®€å•å˜›ï¼Œè¦å¿«é€Ÿä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå°±æ˜¯é¦–é€‰äº†ã€‚åŸºäº classless é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œæ•…éšœæ¨¡æ‹Ÿï¼Œä¹Ÿå¯ä»¥ç”¨æ¥é™åˆ¶å¸¦å®½ã€‚&lt;/p&gt;&#xA;&lt;p&gt;TC ä½¿ç”¨ linux network &lt;a href=&#34;https://wiki.linuxfoundation.org/networking/netem&#34;&gt;netem&lt;/a&gt; æ¨¡å—è¿›è¡Œç½‘ç»œæ•…éšœæ¨¡æ‹Ÿ&lt;/p&gt;&#xA;&lt;h4 id=&#34;heading-3&#34;&gt;æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ·»åŠ ä¸€ä¸ªå›ºå®šå»¶è¿Ÿåˆ°æœ¬åœ°ç½‘å¡ eth0&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;// delay: 100ms&#xA;tc qdisc add dev eth0 root netem delay 100ms&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç»™å»¶è¿ŸåŠ ä¸Šä¸Šä¸‹ 10ms çš„æ³¢åŠ¨&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem delay 100ms 10ms&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åŠ ä¸€ä¸ª 25% çš„ç›¸å…³æ¦‚ç‡&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;ç›¸å…³æ€§ï¼Œæ˜¯è¿™å½“å‰çš„å»¶è¿Ÿä¼šå’Œä¸Šä¸€æ¬¡æ•°æ®åŒ…çš„å»¶è¿Ÿæœ‰å…³ï¼ŒçŸ­æ—¶é—´é‡Œç›¸é‚»æŠ¥æ–‡çš„å»¶è¿Ÿåº”è¯¥æ˜¯è¿‘ä¼¼çš„è€Œä¸æ˜¯å®Œå…¨éšæœºçš„ã€‚è¿™ä¸ªå€¼æ˜¯ä¸ªç™¾åˆ†æ¯”ï¼Œå¦‚æœä¸º 100%ï¼Œå°±é€€åŒ–åˆ°å›ºå®šå»¶è¿Ÿçš„æƒ…å†µï¼›å¦‚æœæ˜¯ 0% åˆ™é€€åŒ–åˆ°éšæœºå»¶è¿Ÿçš„æƒ…å†µï¼Œ&lt;br&gt;&#xA;Pn = 25% Pn-1 + 75% Random&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem delay 100ms 10ms 25%&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è®©æ³¢åŠ¨å˜æˆæ­£æ€åˆ†å¸ƒçš„&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem delay 100ms 20ms distribution normal&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h4 id=&#34;heading-4&#34;&gt;æ¨¡æ‹Ÿç½‘ç»œä¸¢åŒ…&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è®¾ç½®ä¸¢åŒ…ç‡ä¸º 1%&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem loss 0.1%&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ·»åŠ ä¸€ä¸ªç›¸å…³æ€§å‚æ•°&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;è¿™ä¸ªå‚æ•°è¡¨ç¤ºå½“å‰ä¸¢åŒ…çš„æ¦‚ç‡ä¸ä¸Šä¸€æ¡æ•°æ®åŒ…ä¸¢åŒ…æ¦‚ç‡æœ‰ 25% çš„ç›¸å…³æ€§&lt;br&gt;&#xA;Pn = 25% Pn-1 + 75% Random&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem loss 0.1% 25%&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h4 id=&#34;heading-5&#34;&gt;æ¨¡æ‹Ÿæ•°æ®åŒ…é‡å¤&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;1% çš„æ•°æ®åŒ…é‡å¤&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem duplicate 1%&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h4 id=&#34;heading-6&#34;&gt;æ¨¡æ‹ŸåŒ…æŸå&lt;/h4&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;2% çš„åŒ…æŸå&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc add dev eth0 root netem corrupt 2%&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h4 id=&#34;heading-7&#34;&gt;æ¨¡æ‹ŸåŒ…ä¹±åº&lt;/h4&gt;&#xA;&lt;p&gt;ç½‘ç»œä¼ è¾“å¹¶ä¸èƒ½ä¿è¯é¡ºåºï¼Œä¼ è¾“å±‚ TCP ä¼šå¯¹æŠ¥æ–‡è¿›è¡Œé‡ç»„ä¿è¯é¡ºåºï¼Œæ‰€ä»¥æŠ¥æ–‡ä¹±åºå¯¹åº”ç”¨çš„å½±å“æ¯”ä¸Šé¢çš„å‡ ç§é—®é¢˜è¦å°ã€‚&lt;/p&gt;&#xA;&lt;p&gt;æŠ¥æ–‡ä¹±åºå¯å‰é¢çš„å‚æ•°ä¸å¤ªä¸€æ ·ï¼Œå› ä¸ºä¸Šé¢çš„æŠ¥æ–‡é—®é¢˜éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œé’ˆå¯¹å•ä¸ªæŠ¥æ–‡åšæ“ä½œå°±è¡Œï¼Œè€Œä¹±åºåˆ™ç‰µæ¶‰åˆ°å¤šä¸ªæŠ¥æ–‡çš„é‡ç»„ã€‚æ¨¡æ‹ŸæŠ¥ä¹±åºä¸€å®šä¼šç”¨åˆ°å»¶è¿Ÿï¼ˆå› ä¸ºæ¨¡æ‹Ÿä¹±åºçš„æœ¬è´¨å°±æ˜¯æŠŠä¸€äº›åŒ…å»¶è¿Ÿå‘é€ï¼‰ï¼Œnetem æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åšã€‚&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;ç¬¬ä¸€ç§æ˜¯å›ºå®šçš„æ¯éš”ä¸€å®šæ•°é‡çš„æŠ¥æ–‡å°±ä¹±åºä¸€æ¬¡ï¼š&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;æ¯ 5th (10th, 15th...) çš„åŒ…å»¶è¿Ÿ 10ms&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem gap 5 delay 10ms&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ol start=&#34;2&#34;&gt;&#xA;&lt;li&gt;ç¬¬äºŒç§æ–¹æ³•ä½¿ç”¨æ¦‚ç‡æ¥é€‰æ‹©ä¹±åºï¼Œç›¸å¯¹æ¥è¯´æ›´åå‘å®é™…æƒ…å†µä¸€äº›&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;25 % çš„ç«‹åˆ»å‘é€ï¼ˆ50% çš„ç›¸å…³æ€§ï¼‰ï¼Œå…¶ä½™çš„å»¶è¿Ÿ 10ms&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc change dev eth0 root netem delay 10ms reorder 25% 50%&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ol start=&#34;3&#34;&gt;&#xA;&lt;li&gt;åªä½¿ç”¨ delay ä¹Ÿå¯èƒ½é€ æˆæ•°æ®åŒ…çš„ä¹±åº&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;pre&gt;&lt;code&gt; tc qdisc change dev eth0 root netem delay 100ms 75ms&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ¯”å¦‚ first one random 100ms, second random 25msï¼Œè¿™æ ·å°±æ˜¯ä¼šé€ æˆç¬¬ä¸€ä¸ªåŒ…å…ˆäºç¬¬äºŒä¸ªåŒ…å‘é€&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h4 id=&#34;heading-8&#34;&gt;é™åˆ¶å‡ºå£å¸¦å®½&lt;/h4&gt;&#xA;&lt;p&gt;ä»¥ tbf (Token Bucket Filter) ä¸ºä¾‹ï¼Œ&lt;/p&gt;&#xA;&lt;p&gt;å‚æ•°è¯´æ˜ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc add tbf limit BYTES burst BYTES rate KBPS [mtu BYTES] [peakrate KBPS] [latency TIME] [overhead BYTES] [linklayer TYPE]&#xA;&#xA;rate æ˜¯ç¬¬ä¸€ä¸ªä»¤ç‰Œæ¡¶çš„å¡«å……é€Ÿç‡&#xA;peakrate æ˜¯ç¬¬äºŒä¸ªä»¤ç‰Œæ¡¶çš„å¡«å……é€Ÿç‡&#xA;peakrate&amp;gt;rate&#xA;burst æ˜¯ç¬¬ä¸€ä¸ªä»¤ç‰Œæ¡¶çš„å¤§å°&#xA;mtu æ˜¯ç¬¬äºŒä¸ªä»¤ç‰Œæ¡¶çš„å¤§å°&#xA;burst&amp;gt;mtu (æ­¤å¤„æ˜¯ä¸ªå‘ï¼Œä¸€å®šè¦ä¿è¯ burst &amp;gt; mtu, è¦ä¸ç„¶ä¸€ä¸ªåŒ…ä¹Ÿå‘ä¸å‡ºäº†)&#xA;è‹¥ä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œä¸å¤Ÿï¼Œæ•°æ®åŒ…å°±éœ€è¦ç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´ç”± latency å‚æ•°æ§åˆ¶ï¼Œå¦‚æœç­‰å¾…æ—¶é—´è¶…è¿‡ latencyï¼Œé‚£ä¹ˆè¿™ä¸ªåŒ…å°±ä¼šè¢«ä¸¢å¼ƒ&#xA;limit å‚æ•°æ˜¯è®¾ç½®æœ€å¤šå…è®¸å¤šå°‘æ•°æ®å¯ä»¥åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…&#xA;latency=max((limit-burst)/rate,(limit-mtu)/peakrate);&#xA;burst åº”è¯¥å¤§äº mtu å’Œ rate&#xA;overhead è¡¨ç¤º ADSL ç½‘ç»œå¯¹æ•°æ®åŒ…çš„å°è£…å¼€é”€&#xA;linklayer æŒ‡å®šäº†é“¾è·¯çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯ä»¥å¤ªç½‘æˆ–è€… ATM æˆ– ADSL&#xA;ATM å’Œ ADSL æŠ¥å¤´å¼€é”€å‡ä¸º 5 ä¸ªå­—èŠ‚ã€‚&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;exampleï¼š&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;é™åˆ¶ 100mbit&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc add dev ens33 root tbf rate 100mbit latency 50ms burst 1600&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;é™åˆ¶å»¶è¿Ÿ 100ms, æµé‡ 100mbit&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;tc qdisc add dev eth0 root handle 1:0 netem delay 100ms&#xA;tc qdisc add dev eth0 parent 1:1 handle 10: tbf rate 256kbit buffer 1600 limit 3000&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h3 id=&#34;classful-&#34;&gt;classful é˜Ÿåˆ—&lt;/h3&gt;&#xA;&lt;p&gt;è¿™ä¸ªå°±å¤æ‚ä¸€äº›ï¼ŒåŒæ ·ä¹Ÿç‰¹åˆ«çµæ´»ï¼Œå¯ä»¥é™åˆ¶ç‰¹å®šçš„ ip æˆ–è€…æœåŠ¡ç±»å‹ä»¥åŠç«¯å£&lt;/p&gt;&#xA;&lt;p&gt;ä»¥ä½¿ç”¨ htb ä¸ºä¾‹&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// ç»™ root æ·»åŠ  htb é˜Ÿåˆ— id: 1:0&#xA;tc qdi sc add dev eth0 root handle 1: htb default 20&#xA;// ç»™ htb é˜Ÿåˆ—æ·»åŠ ä¸€ä¸ª classï¼Œ clas id: 1:1&#xA;tc class add dev eth0 parent 1:0 classid 1:1 htb rate 100mbit burst 10k&#xA;// ç»™è¿™ä¸ª class 1:1 åŠ ä¸Šä¸€ä¸ª filter, æ­¤ filter åªæ˜¯å¯¹ ip åšäº†è¿‡æ»¤&#xA;tc filter add dev eth0 parent 1: protocol ip prio 16 u32  match ip dst 0.0.0.0/0 flowid 1:1&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h2 id=&#34;heading-9&#34;&gt;æ§åˆ¶å…¥å£æµé‡&lt;/h2&gt;&#xA;&lt;p&gt;ä½¿ç”¨ TC è¿›è¡Œå…¥å£é™æµï¼Œéœ€è¦æŠŠæµé‡é‡å®šå‘åˆ° ifb è™šæ‹Ÿç½‘å¡ï¼Œç„¶ååœ¨æ§åˆ¶ ifb çš„è¾“å‡ºæµé‡&lt;/p&gt;&#xA;&lt;p&gt;åŸç†å›¾ï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1354528849_1019.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// å¼€å¯ ifb è™šæ‹Ÿç½‘å¡&#xA;modprobe ifb numifbs=1&#xA;ip link set dev $IFB up&#xA;&#xA;// å°† eth0 æµé‡é‡å®šå‘åˆ° ifb0&#xA;tc qdisc add dev eth0 handle ffff: ingress&#xA;tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0&#xA;&#xA;// ç„¶åå°±æ˜¯é™åˆ¶ ifb0 çš„è¾“å‡ºå°±å¯ä»¥äº†&#xA;......&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h2 id=&#34;heading-10&#34;&gt;åœ¨è¯´å‡ å¥&lt;/h2&gt;&#xA;&lt;p&gt;TC è¿˜æœ‰å¾ˆå¤šç»†èŠ‚æ²¡æœ‰å»ç ”ç©¶åˆ°ï¼Œç›®å‰è¿™äº›åŸºæœ¬ä¸Šå¯ä»¥æ»¡è¶³ç›®å‰çš„éœ€æ±‚ï¼Œæœ€åè¿˜æƒ³åæ§½ä¸€å¥ï¼Œå½“ TC å‘½ä»¤å‡ºé”™çš„æ—¶å€™ï¼ŒTC çš„æŠ¥é”™ä¿¡æ¯å¤ªå°‘äº†ï¼Œè°ƒè¯•èµ·æ¥å¤ªå‘...&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;&lt;a href=&#34;https://github.com/magnific0/wondershaper&#34;&gt;wondershaper&lt;/a&gt; è¿™ä¸ªè„šæœ¬ç”¨èµ·æ¥è¿˜æ˜¯å¾ˆæ–¹ä¾¿&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;heading-11&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.tldp.org/HOWTO/html_single/Traffic-Control-HOWTO/&#34;&gt;Traffic Control HOWTO&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://wiki.linuxfoundation.org/networking/netem&#34;&gt;netem&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.ituring.com.cn/article/274015&#34;&gt;Linux æµé‡æ§åˆ¶å·¥å…· TC&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.ituring.com.cn/article/274014&#34;&gt;æµé‡æ§åˆ¶å·¥å…· TC è¯¦ç»†è¯´æ˜&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://blog.51cto.com/professor/1570778&#34;&gt;Linux ä¸‹ TC ä»¥åŠ netem é˜Ÿåˆ—çš„ä½¿ç”¨&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://blog.csdn.net/zhangskd/article/details/8240290&#34;&gt;è¾“å…¥æ–¹å‘çš„æµé‡æ§åˆ¶&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/magnific0/wondershaper&#34;&gt;wondershaper&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>æ¼æ¡¶ç®—æ³• &amp;&amp; ä»¤ç‰Œæ¡¶ç®—æ³•</title>
    <updated>2018-05-22T00:00:00Z</updated>
    <id>tag:int64.me,2018-05-22:/2018/æ¼æ¡¶ç®—æ³• &amp;&amp; ä»¤ç‰Œæ¡¶ç®—æ³•.html</id>
    <link href="http://int64.me/2018/æ¼æ¡¶ç®—æ³• &amp;&amp; ä»¤ç‰Œæ¡¶ç®—æ³•.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;åœ¨çœ‹ &lt;code&gt;TC&lt;/code&gt; æ–‡æ¡£çš„æ—¶å€™ï¼Œæ–‡æ¡£ä¸­æåˆ°äº† token bucketï¼ŒTC ä¸­å¯ä»¥ä½¿ç”¨è¿™ä¸ªç®—æ³•æ¥è¿›è¡Œæµé‡æ§åˆ¶ï¼Œæ¨¡ç³Šå°è±¡ä¸­å¬è¿‡è¿™ä¸ªç®—æ³•ï¼Œä½†æ˜¯å¹¶ä¸çŸ¥é“è¿™ä¸ªç®—æ³•å…·ä½“æ˜¯ä»€ä¹ˆï¼Œå°±å¥½å¥‡çš„å»ä¸€æ¢ç©¶ç«Ÿ...&lt;/p&gt;&#xA;&lt;h2 id=&#34;leaky-bucket&#34;&gt;å…ˆè¯´æ¼æ¡¶ï¼ˆLeaky bucketï¼‰&lt;/h2&gt;&#xA;&lt;p&gt;ä» wiki ä¸Šä»‹ç»ï¼ŒLeaky bucket ç®—æ³•æœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;as a meterï¼ˆä½œä¸ºè®¡é‡å·¥å…·ï¼‰&lt;/li&gt;&#xA;&lt;li&gt;as a queueï¼ˆä½œä¸ºè°ƒåº¦é˜Ÿåˆ—ï¼‰&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å…¶ä¸­ï¼Œç¬¬ä¸€ç§å«ä¹‰å’Œ Token Bucket æ˜¯ç­‰ä»·çš„ï¼ˆæ‰€æœ‰æˆ‘å°±æ²¡è¯¦ç»†çš„å»çœ‹ç‰ˆæœ¬ä¸€ï¼Œè€Œæ˜¯åé¢ç›´æ¥å»çœ‹ Token Bucket ç®—æ³•ï¼‰ï¼Œåªæ˜¯è¡¨è¿°çš„è§’åº¦ä¸åŒã€‚æ›´æœ‰è¶£çš„æ˜¯ï¼Œç¬¬äºŒç§å«ä¹‰å…¶å®æ˜¯ç¬¬ä¸€ç§çš„ç‰¹ä¾‹ã€‚è¿™äº›å¯¹æ¯”å’ŒåŒºåˆ«åœ¨åé¢å†è°ˆï¼Œå…ˆæ•´ä½“çœ‹ä¸€ä¸‹ Leaky Bucketã€‚&lt;/p&gt;&#xA;&lt;p&gt;å…ˆçœ‹ä¸€å¼ å›¾ï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Leaky_bucket_analogy.JPG&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;å…¶å®è¿™å›¾å·²ç»å¾ˆå¥½çš„å±•ç¤ºäº† leaky bucket çš„æŠ½è±¡æ¨¡å‹ï¼Œå°±æ˜¯ä¸€ä¸ªä¼šæ¼æ°´çš„æ¡¶ğŸ˜‚&lt;/p&gt;&#xA;&lt;p&gt;å¦‚å›¾æè¿°ï¼Œæ¡¶æœ‰ä¸€ä¸ªè¾“å…¥ä¸€ä¸ªè¾“å‡ºï¼Œè¾“å‡ºå°±æ˜¯æ¡¶çš„ä¸‹æ–¹æœ‰ä¸€ä¸ªæ’å®šé€Ÿåº¦çš„å¾€ä¸‹æ¼æ°´ï¼Œè¾“å…¥å°±æ˜¯ä»¥ä¸€ä¸ªå˜åŒ–çš„é€Ÿåº¦å¾€æ°´æ¡¶é‡Œè¿›æ°´ï¼Œä¸€æ—¦æ°´æ»¡äº†ï¼Œä¸Šæ–¹çš„æ°´å°±æ— æ³•åŠ å…¥ã€‚å¯¹äºå¦‚ä½•å¤„ç†æ¡¶æ»¡åçš„ä¸Šæ–¹æ¬²æµä¸‹çš„æ°´ï¼Œæœ‰æœ‰ä¸€ä¸‹ä¸¤ç§å¸¸è§çš„æ–¹å¼ï¼ˆå…¶å®è¿™å·²ç»ä¸æ˜¯ leaky bucket ç®—æ³•è€ƒè™‘çš„äº‹æƒ…äº†ï¼‰ã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Traffic_shaping&#34;&gt;Traffic Shaping&lt;/a&gt;: æš‚æ—¶æ‹¦æˆªä½ä¸Šæ–¹æ°´çš„å‘ä¸‹æµåŠ¨ï¼Œç­‰å¾…æ¡¶ä¸­çš„ä¸€éƒ¨åˆ†æ°´æ¼èµ°åï¼Œå†æ”¾è¡Œä¸Šæ–¹æ°´ã€‚&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Traffic_policing&#34;&gt;Traffic Policing&lt;/a&gt;: æº¢å‡ºçš„ä¸Šæ–¹æ°´ç›´æ¥æŠ›å¼ƒã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å…¶å®æ˜¯å°†æ°´çœ‹ä½œç½‘ç»œé€šä¿¡ä¸­æ•°æ®åŒ…çš„æŠ½è±¡ï¼ŒTraffic Shaping çš„æ ¸å¿ƒç†å¿µæ˜¯ â€œç­‰å¾…â€ï¼ŒTraffic Policing çš„æ ¸å¿ƒç†å¿µæ˜¯ â€œä¸¢å¼ƒâ€ã€‚å®ƒä»¬æ˜¯ä¸¤ç§å¸¸è§çš„æµé€Ÿæ§åˆ¶æ–¹æ³•ã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;as a meter&lt;/code&gt; ç‰ˆæœ¬çš„ leaky bucket å’Œ token bucket åªæ˜¯æ¢ä¸ªæè¿°è§’åº¦ï¼ŒåŸç†ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å°±æ²¡æœ‰åšè¿‡å¤šçš„ç ”ç©¶ã€‚å¯ä»¥çœ‹ä¸€ä¸‹ wiki ä¸Šä¸¤ç§ç®—æ³•çš„å¯¹æ¯”ï¼Œä½ å°±ä¼šå‘ç°å…¶å®æ˜¯ä¸€æ ·çš„ã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-05-22%20at%201.56.57%20PM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;h2 id=&#34;-token-bucket&#34;&gt;ä»¤ç‰Œæ¡¶ ï¼ˆToken Bucket)&lt;/h2&gt;&#xA;&lt;p&gt;è¿˜æ˜¯å…ˆä¸Šå›¾&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/token_bucket.JPG&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;æ¦‚è¿°ï¼šä»¤ç‰Œæ¡¶ç®—æ³•çš„åŸç†æ˜¯ç³»ç»Ÿä¼šä»¥ä¸€ä¸ªæ’å®šçš„é€Ÿåº¦å¾€æ¡¶é‡Œæ”¾å…¥ä»¤ç‰Œï¼Œè€Œå¦‚æœè¯·æ±‚éœ€è¦è¢«å¤„ç†ï¼Œåˆ™éœ€è¦å…ˆä»æ¡¶é‡Œè·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå½“æ¡¶é‡Œæ²¡æœ‰ä»¤ç‰Œå¯å–æ—¶ï¼Œåˆ™æ‹’ç»æœåŠ¡ã€‚&lt;br&gt;&#xA;ç®—æ³•åŸºæœ¬è¿‡ç¨‹ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å‡å¦‚ç”¨æˆ·é…ç½®çš„å¹³å‡å‘é€é€Ÿç‡ä¸º rï¼Œåˆ™æ¯éš” 1/r ç§’ä¸€ä¸ªä»¤ç‰Œè¢«åŠ å…¥åˆ°æ¡¶ä¸­ï¼›&lt;/li&gt;&#xA;&lt;li&gt;å‡è®¾æ¡¶æœ€å¤šå¯ä»¥å­˜å‘ b ä¸ªä»¤ç‰Œã€‚å¦‚æœä»¤ç‰Œåˆ°è¾¾æ—¶ä»¤ç‰Œæ¡¶å·²ç»æ»¡äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒï¼›&lt;/li&gt;&#xA;&lt;li&gt;å½“ä¸€ä¸ª n ä¸ªå­—èŠ‚çš„æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œå°±ä»ä»¤ç‰Œæ¡¶ä¸­åˆ é™¤ n ä¸ªä»¤ç‰Œï¼Œå¹¶ä¸”æ•°æ®åŒ…è¢«å‘é€åˆ°ç½‘ç»œï¼›&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœä»¤ç‰Œæ¡¶ä¸­å°‘äº n ä¸ªä»¤ç‰Œï¼Œé‚£ä¹ˆä¸ä¼šåˆ é™¤ä»¤ç‰Œï¼Œå¹¶ä¸”è®¤ä¸ºè¿™ä¸ªæ•°æ®åŒ…åœ¨æµé‡é™åˆ¶ä¹‹å¤–ï¼›&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;ç®—æ³•å…è®¸æœ€é•¿ b ä¸ªå­—èŠ‚çš„çªå‘ï¼Œä½†ä»é•¿æœŸè¿è¡Œç»“æœçœ‹ï¼Œæ•°æ®åŒ…çš„é€Ÿç‡è¢«é™åˆ¶æˆå¸¸é‡ rã€‚å¯¹äºåœ¨æµé‡é™åˆ¶å¤–çš„æ•°æ®åŒ…å¯ä»¥ä»¥ä¸åŒçš„æ–¹å¼å¤„ç†ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®ƒä»¬å¯ä»¥è¢«ä¸¢å¼ƒï¼›&lt;/li&gt;&#xA;&lt;li&gt;å®ƒä»¬å¯ä»¥æ’æ”¾åœ¨é˜Ÿåˆ—ä¸­ä»¥ä¾¿å½“ä»¤ç‰Œæ¡¶ä¸­ç´¯ç§¯äº†è¶³å¤Ÿå¤šçš„ä»¤ç‰Œæ—¶å†ä¼ è¾“ï¼›&lt;br&gt;&#xA;å®ƒä»¬å¯ä»¥ç»§ç»­å‘é€ï¼Œä½†éœ€è¦åšç‰¹æ®Šæ ‡è®°ï¼Œç½‘ç»œè¿‡è½½çš„æ—¶å€™å°†è¿™äº›ç‰¹æ®Šæ ‡è®°çš„åŒ…ä¸¢å¼ƒ&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;github å®ç°æºç :&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/rbarrois/throttle&#34;&gt;https://github.com/rbarrois/throttle&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/titan-web/rate-limit&#34;&gt;https://github.com/titan-web/rate-limit&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/yangwenmai/ratelimit&#34;&gt;https://github.com/yangwenmai/ratelimit&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;æ€»ç»“&lt;/h2&gt;&#xA;&lt;p&gt;å…¶å® &lt;code&gt;as a queue leaky bucket&lt;/code&gt; ç®—æ³•å°±æ˜¯ token bucket ç®—æ³•çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œå¹³æ—¶æˆ‘ä»¬å¤§å¤šæ•°è¯´çš„æ¼æ¡¶ç®—æ³•å°±æ˜¯æŒ‡ &lt;code&gt;as a queue leaky bucket&lt;/code&gt;ã€‚æ¼æ¡¶ç®—æ³•ä¸»è¦ç›®çš„æ˜¯æ§åˆ¶æ•°æ®æ³¨å…¥åˆ°ç½‘ç»œçš„é€Ÿç‡ï¼Œå¹³æ»‘ç½‘ç»œä¸Šçš„çªå‘æµé‡ã€‚æ¼æ¡¶ç®—æ³•æä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œé€šè¿‡å®ƒï¼Œçªå‘æµé‡å¯ä»¥è¢«æ•´å½¢ä»¥ä¾¿ä¸ºç½‘ç»œæä¾›ä¸€ä¸ªç¨³å®šçš„æµé‡ã€‚è€Œä»¤ç‰Œæ¡¶ç®—æ³•èƒ½å¤Ÿåœ¨é™åˆ¶æ•°æ®çš„å¹³å‡ä¼ è¾“é€Ÿç‡çš„åŒæ—¶è¿˜å…è®¸æŸç§ç¨‹åº¦çš„çªå‘ä¼ è¾“ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-1&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Token_bucket&#34;&gt;wiki Token Bucket&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/Leaky_bucket&#34;&gt;wiki Leaky Bucket&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://medium.com/smyte/rate-limiter-df3408325846&#34;&gt;High-performance rate limiting&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.cnblogs.com/LBSer/p/4083131.html&#34;&gt;æµé‡è°ƒæ•´å’Œé™æµæŠ€æœ¯&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://blog.51cto.com/leyew/860302&#34;&gt;æ¼æ¡¶ç®—æ³• Leaky Bucket ï¼ˆä»¤ç‰Œæ¡¶ç®—æ³• Token Bucketï¼‰å­¦ä¹ ç¬”è®°&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://caden16.github.io/python/python%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/&#34;&gt;python ç½‘é€Ÿæ§åˆ¶&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>TiDB æ€§èƒ½ä¼˜åŒ–ä¹‹ç„å­¦è°ƒä¼˜</title>
    <updated>2018-04-08T00:00:00Z</updated>
    <id>tag:int64.me,2018-04-08:/2018/TiDB æ€§èƒ½ä¼˜åŒ–ä¹‹ç„å­¦è°ƒä¼˜.html</id>
    <link href="http://int64.me/2018/TiDB æ€§èƒ½ä¼˜åŒ–ä¹‹ç„å­¦è°ƒä¼˜.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;TiDB ç„å­¦è°ƒä¼˜æ˜¯æˆ‘ä»¬è‡ªé»‘æ¯”è¾ƒç‹ çš„æ¢—ä¹‹ä¸€ï¼Œå½“åˆ TiKV é‡Œå¤§æŠŠçš„å‚æ•°è®©æˆ‘å¤´ç–¼äº†å¥½ä¹… ( TiKV çš„é…ç½®å‚æ•°å¤§å¤šæ•°æ˜¯å’Œ RocksDB ç›¸å…³ )ã€‚å¥½åœ¨ç°åœ¨å¾ˆå¤šå‚æ•°ç°åœ¨çš„é»˜è®¤å€¼å·²ç»å¾ˆç§‘å­¦å¤§å¤§çš„å‡å°‘äº†æˆ‘ä»¬ç„å­¦è°ƒä¼˜çš„éš¾åº¦ã€‚&lt;br&gt;&#xA;ä»¥ä¸‹æ˜¯æ˜¯æˆ‘å¹³æ—¶åœ¨æµ‹è¯• TiDB æ—¶å€™ï¼Œè¿›è¡Œç“¶é¢ˆå®šä½çš„è¿‡ç¨‹...&lt;/p&gt;&#xA;&lt;p&gt;æˆ‘ä»¬ä»¥ sysbench æµ‹è¯•ä¸ºä¾‹ï¼Œä½¿ç”¨çš„æµ‹è¯•è„šæœ¬ï¼šhttps://github.com/pingcap/tidb-bench/tree/master/sysbench&lt;br&gt;&#xA;å¯ç”¨æœºå™¨å…¬å…±å››å°ï¼Œæœºå™¨é…ç½®ï¼šCPU 16 æ ¸ / Mem 110 GB  / Disk 1024GB SSD&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;ç¡¬ä»¶æ€§èƒ½æµ‹è¯•&lt;/h2&gt;&#xA;&lt;p&gt;æµ‹è¯•ä¹‹å‰å…ˆè¿›è¡ŒåŸºæœ¬çš„ç¡¬ä»¶æµ‹è¯•ï¼Œæ¯”å¦‚ç£ç›˜ fio æµ‹è¯•ï¼Œç½‘ç»œå»¶è¿Ÿä»¥åŠç½‘é€Ÿçš„æµ‹è¯•ï¼Œè¿™äº›æµ‹è¯•æœ‰åˆ©äºæ’é™¤ä¸€äº›å¹²æ‰°å› ç´ ã€‚&lt;br&gt;&#xA;è¿™åœ°æ–¹å°±æä¾›å‡ æœ¬çš„æµ‹è¯•æ–¹æ³•ï¼Œä¹‹å‰å·²ç»æµ‹è¯•è¿‡äº†ï¼Œæ­¤å¤„å°±ä¸å®é™…æµ‹è¯•äº†ã€‚&lt;/p&gt;&#xA;&lt;p&gt;æµ‹è¯•ç£ç›˜ï¼šæ¨è fio ï¼ˆfio ä½¿ç”¨éœ€è°¨æ…ï¼Œä¸è¦ç›´æ¥å†™è£¸è®¾å¤‡ï¼Œç¬”è€…è¿ç»­å†™åå¥½å‡ å—ç›˜ï¼Œéƒ½æ˜¯è¡€æ³ªå•Šï¼‰ï¼Œddï¼Œsysbench...&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// fio&#xA;fio -ioengine=libaio -bs=32k -direct=1 -thread -rw=read  -size=10G -filename=test -name=&amp;quot;PingCAP max throughput&amp;quot; -iodepth=4 -runtime=60&#xA;&#xA;// dd&#xA;dd bs=4k count=250000 oflag=direct if=/dev/zero of=./dd_test.txt&#xA;&#xA;// sysbench&#xA;sysbench --test=fileio --file-num=16 --file-block-size=16384 --file-total-size=2G prepare&#xA;sysbench --test=fileio --file-num=16 --file-block-size=16384 --file-total-size=2G --num-threads=4 --max-requests=100000000 --max-time=180 --file-test-mode=seqwr --file-extra-flags=direct run&#xA;sysbench --test=fileio --file-num=16 --file-block-size=16384 --file-total-size=2G --num-threads=4 --max-requests=100000000 --max-time=180 --file-test-mode=seqwr --file-extra-flags=direct clean&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;æµ‹è¯•å»¶è¿Ÿï¼šç›´æ¥ ping æŸ¥çœ‹å»¶è¿Ÿä»¥åŠä¸¢åŒ…æƒ…å†µ&lt;/p&gt;&#xA;&lt;p&gt;æµ‹è¯•ç½‘é€Ÿ: æœ€ç®€å• dd + scpï¼Œdd + pv + nc , iperf&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// scp&#xA;dd if=/dev/zero bs=2M count=2048 of=./test // ç”Ÿæˆ 4 GB æ–‡ä»¶&#xA;scp ./test ip ip&#xA;&#xA;// dd + pv + nc&#xA;dd if=/dev/zero bs=1M count=1024 of=./test&#xA;pv test| nc 10.0.1.8 5433 // å‘é€&#xA;nc -vv -l -p 5433 &amp;gt; test  // æ¥æ”¶&#xA;&#xA;// iperf&#xA;iperf -s            // server&#xA;iperf -c 10.0.1.4   // client&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h2 id=&#34;sysbench-oltp-&#34;&gt;sysbench oltp æµ‹è¯•ç“¶é¢ˆå®šä½&lt;/h2&gt;&#xA;&lt;p&gt;è¿è¡Œ sysbench oltp æµ‹è¯•ï¼Œ sysbench é»˜è®¤ oltp ä¸€ä¸ªäº‹åŠ¡åŒ…å« 18 æ¡ SQL:&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;10 * point select&#xA;1 * simple range select&#xA;1 * sum range&#xA;1 * order range&#xA;1 * distinct range&#xA;1 * index update&#xA;1 * non index update&#xA;1 * insert&#xA;1 * delete&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ä»äº‹åŠ¡çš„ç»„åˆä¸Šæ¥çœ‹åº¦å å¤§éƒ¨åˆ†ï¼Œç»éªŒå‘Šè¯‰æˆ‘ä»¬æœ€å…ˆè¯»å¤šå±äº CPU å¯†é›†å‹çš„æ“ä½œï¼ŒTiDB çš„ CPU æœ€æœ‰å¯èƒ½æˆä¸ºç“¶é¢ˆï¼Œæˆ‘ä»¬å…ˆä½¿ç”¨ 1 TiDB + 3 TiKV çš„æ¶æ„è¿›è¡Œæµ‹è¯•ï¼Œå®é™…è§‚å¯Ÿä¸€ä¸‹è¿è¡Œæƒ…å†µã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä½¿ç”¨ &lt;a href=&#34;https://github.com/pingcap/tidb-ansible&#34;&gt;tidb-ansible&lt;/a&gt; éƒ¨ç½²é›†ç¾¤&lt;/p&gt;&#xA;&lt;p&gt;éƒ¨ç½²æ‹“æ‰‘ï¼š&lt;/p&gt;&#xA;&lt;table&gt;&#xA;&lt;thead&gt;&#xA;&lt;tr&gt;&#xA;&lt;th style=&#34;text-align:center&#34;&gt;ip&lt;/th&gt;&#xA;&lt;th style=&#34;text-align:center&#34;&gt;éƒ¨ç½²&lt;/th&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/thead&gt;&#xA;&lt;tbody&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;10.0.1.6&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;tidb / pd / sysbench&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;10.0.1.7&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;tikv&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;10.0.1.8&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;tikv&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;tr&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;10.0.1.9&lt;/td&gt;&#xA;&lt;td style=&#34;text-align:center&#34;&gt;tikv&lt;/td&gt;&#xA;&lt;/tr&gt;&#xA;&lt;/tbody&gt;&#xA;&lt;/table&gt;&#xA;&lt;p&gt;æµ‹è¯•æµç¨‹ï¼šprepare -&amp;gt; run&lt;/p&gt;&#xA;&lt;p&gt;è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œå…ˆè§‚å¯Ÿ tidb / tikv çš„ cpu ä½¿ç”¨æƒ…å†µï¼ˆä¸€èˆ¬æ¥è¯´ oltp æµ‹è¯•ï¼Œä¸»è¦ç“¶é¢ˆä¼šé›†ä¸­åœ¨ tidb çš„ cpu ä¸Šï¼Œè¦åˆé‡ç‚¹çš„å»æ’æŸ¥é—®é¢˜ï¼‰&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%2012.16.54%20AM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ° tidb çš„æœºå™¨çš„ load å·²ç»è¾¾åˆ°äº† 20+ï¼Œè¿™æ˜¯ä¸€å° 15 æ ¸çš„æœºå™¨ï¼Œæ„Ÿè§‰è¿™å°æœºå™¨çš„ cpu å‡ ä¹å·²ç»è¢«æ¦¨å¹²äº†ï¼Œæˆ‘ä»¬éƒ½ä¸éœ€è¦å»çœ‹åˆ«çš„ç“¶é¢ˆï¼Œè¿™ tidb çš„cpu å·²ç»é™åˆ¶äº†æ•´ä½“æ€§èƒ½ã€‚é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯è¦æŠŠè¿™ä¸ªç“¶é¢ˆå»æ‰ï¼Œ&lt;strong&gt;æœ€ç›´æ¥çš„æ–¹æ³•å°±æ˜¯å‡çº§ç¡¬ä»¶æˆ–æ˜¯åŠ æœºå™¨ï¼Œæˆ‘ä»¬å°è¯•å¢åŠ æœºå™¨ï¼ŒåŒæ—¶ä¸»è¦æ³¨æ„å¢åŠ å‹åŠ›&lt;/strong&gt;ã€‚ï¼ˆæ²¡æœ‰å¤šä½™çš„æœºå™¨å°±ä¸åšå®éªŒäº†ï¼‰ å½“æˆ‘ä»¬æŠŠ tidb æœºå™¨çš„æ•°é‡ä¹Ÿå¢åŠ åˆ° 3 å°æˆ–æ˜¯æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¼šå‘ç°ç“¶é¢ˆå‘ç”Ÿäº†è½¬ç§»ï¼Œè¿™ä¸ªæ—¶å€™ç“¶é¢ˆå°±ä¼šä» tidb è½¬ç§»åˆ°äº† tikvï¼Œtikv æœ‰ä¸ª end-point-concurrency è¿™æ ·ä¸€ä¸ªä¸œè¥¿ç”¨æ¥å¤„ç† tidb çš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨ top -H æ¥è§‚å¯Ÿä¸€ä¸‹&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%2012.31.58%20AM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;å¯¹åº” grafana ç›‘æ§ä¸Šçš„å°±æ˜¯&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%2012.34.02%20AM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;end-point-concurrency ä»€ä¹ˆæ—¶å€™ç®—æ˜¯å‡ºç°ç“¶é¢ˆå‘¢ï¼Ÿ é»˜è®¤ end-point-concurrency  æ˜¯ä½¿ç”¨ 4ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è¿™ä¹ˆè®¤ä¸ºï¼Œå½“ top -H çš„æ—¶å€™å‘ç°è¿™ä¸ªå››ä¸ªçº¿ç¨‹çš„ cpu ä½¿ç”¨éƒ½è¶…è¿‡äº† 90% ï¼Œé‚£ä¹ˆå°±å¯ä»¥è®¤ä¸º end-point-concurrency é™åˆ¶äº†æ•´ä¸ªç³»ç»Ÿçš„ååï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯å¦‚ä½•æ¥æŠŠè¿™ä¸ªç“¶é¢ˆç»™æ¶ˆé™¤æ‰ï¼Œå¦‚æœç›®å‰ tikv çš„æœºå™¨æ•´ä½“ cpu ä½¿ç”¨è¿˜æ˜¯å¾ˆé—²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±&lt;strong&gt;å¢åŠ è¿™ä¸ª end-point-concurrency çš„çº¿ç¨‹æ•°é‡&lt;/strong&gt;ï¼Œè¿™ä¸ªå°±è¦ä¿®æ”¹ tikv çš„å¯åŠ¨å‚æ•°äº†,è¿™ä¸ªå¯ä»¥å‚è€ƒæ–‡æ¡£ï¼šhttps://github.com/pingcap/docs-cn/blob/master/op-guide/tune-tikv.md ã€‚&lt;br&gt;&#xA;ï¼ˆgrpc çº¿ç¨‹ä¹Ÿæ˜¯ä¼šå‡ºç°ç“¶é¢ˆï¼Œæ”¹è¿›æ–¹æ³•å’Œ end-point-concurrency ç±»ä¼¼ï¼Œç›´æ¥å¢åŠ çº¿ç¨‹æ•°é‡ï¼‰&lt;/p&gt;&#xA;&lt;p&gt;å½“æˆ‘ä»¬è§£å†³æ‰ end-point-concurrencyï¼Œæˆ‘ä»¬ä¼šå‘ç°ç³»ç»Ÿçš„æ•´ä½“ååä¼šæœ‰æ‰€æé«˜ï¼Œä½†æ˜¯æ­¤æ—¶åˆä¼šå‡ºç°æ–°çš„ç“¶é¢ˆï¼Œä»¥æˆ‘å¾€å¸¸çš„ç»éªŒæ¥è¯´ï¼Œæ¥ä¸‹æ¥çš„ç“¶é¢ˆåº”è¯¥ä¼šå‡ºç°åœ¨  end-point-work è¿™ä¸ªçº¿ç¨‹ä¸Šï¼Œä¸ºå˜›ä¼šå‡ºç°åœ¨è¿™ä¸ªçº¿ç¨‹ä¸Šå‘¢ï¼Ÿå…¶å®è¦æ˜¯çŸ¥é“è¿™ä¸ªçº¿ç¨‹æ˜¯ç”¨æ¥å¹²å˜›çš„å°±å¾ˆå¥½ç†è§£äº†ï¼Œè¿™ä¸ªç°åœºæ˜¯ç”¨æ¥è°ƒåº¦ end-point-concurrency è¿™ä¸ªç©æ„æ‰ï¼Œå½“ end-point-concurrency çº¿ç¨‹å¤šäº†ï¼Œé‚£ä¹ˆè°ƒåº¦å°±ä¼šå‡ºç°ç“¶é¢ˆï¼Œé—æ†¾çš„æ˜¯ end-point-work æ˜¯å•çº¿ç¨‹ï¼Œæˆ‘ä»¬è¦è§£å†³è¿™ä¸ªçš„ç“¶é¢ˆï¼Œ&lt;strong&gt;åªèƒ½æå‡å•æ ¸ cpu çš„èƒ½åŠ›ï¼Œæˆ–æ˜¯å¢åŠ  tikv çš„æ•°é‡&lt;/strong&gt;ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;summary&#34;&gt;Summary&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç“¶é¢ˆ&#xA;&lt;ul&gt;&#xA;&lt;li&gt;TiDB CPU ä¸€èˆ¬ä¼šä¼˜å…ˆæˆä¸ºç“¶é¢ˆ&lt;/li&gt;&#xA;&lt;li&gt;TiKV çš„ endpoint çº¿ç¨‹&lt;/li&gt;&#xA;&lt;li&gt;grpc çº¿ç¨‹&lt;/li&gt;&#xA;&lt;li&gt;TiKV çš„ end-point-work çº¿ç¨‹&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;ä¼˜åŒ–&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åŠ  TiDB èŠ‚ç‚¹ï¼Œå¯ä»¥å°è¯•åœ¨ TiKV æœºå™¨ä¸Šæ·»åŠ ï¼ˆ TiKV CPUæ¯”è¾ƒå……è¶³ï¼‰&lt;/li&gt;&#xA;&lt;li&gt;è°ƒæ•´ end-point-concurrency å‚æ•°ï¼Œå¢å¤§ endpoint çº¿ç¨‹æ•°é‡&lt;/li&gt;&#xA;&lt;li&gt;è°ƒæ•´ grpc-concurrency å‚æ•°ï¼Œå¢åŠ  grpc çº¿ç¨‹æ•°é‡&lt;/li&gt;&#xA;&lt;li&gt;è°ƒå¤§ racksdb cache&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;sysbench oltp æ€§èƒ½ç“¶é¢ˆå®šä½å°±è¯´è¿™äº›ï¼Œå®é™…æƒ…å†µä¸­ tidb çš„ç“¶é¢ˆå¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå»ä¼˜åŒ–è°ƒæ•´ï¼Œè¦ä¸ç„¶å°±ä¸å«ç„å­¦äº†ğŸ˜„ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;sysbench-insert-&#34;&gt;sysbench insert æµ‹è¯•ç“¶é¢ˆå®šä½&lt;/h2&gt;&#xA;&lt;p&gt;sysbench insert è„šæœ¬å¾ˆç®€å•ï¼Œå°±æ˜¯é¡ºåºå†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆä» tikv åŸºæœ¬æ¦‚å¿µè€ƒè™‘ï¼Œtikv å†…çš„æœ€å°å‡ æœ¬å•å…ƒæ˜¯ region, å¹¶ä¸”æ˜¯æ¯ä¸ªè¡¨è‚¯å®šæ˜¯å¯¹åº”è¿™ä¸ªä¸åŒçš„ regionï¼Œé‚£ä¹ˆåŠ å…¥æˆ‘ä»¬çš„æµ‹è¯•åªæ­£å¯¹ä¸€ä¸ªè¡¨ insertï¼Œæˆ‘ä»¬æœ‰å†å¤šçš„ tikv ä¹Ÿæ˜¯æ²¡æœ‰åµç”¨ï¼Œï¼ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç›®å‰æœ‰ç›¸åº”çš„è§£å†³åŠæ³•ï¼Œå…·ä½“æˆ‘ä¹Ÿä¸æ˜¯å¤ªæ¸…æ¥šï¼‰æ‰€ä»¥æˆ‘ä»¬æµ‹è¯•è¦ä¿è¯è¡¨çš„æ•°é‡ä¸€å®šè¦å¤§äº tikv èŠ‚ç‚¹çš„æ•°é‡ï¼ˆå½“ç„¶è¶Šå¤šè¶Šå¥½äº†ï¼‰ï¼Œè¿™é‡Œå®éªŒçš„æ—¶å€™æˆ‘æ˜¯ä½¿ç”¨äº† 16ä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨é¢„å…ˆ prepare äº† 100w çš„æ•°æ®ã€‚&lt;/p&gt;&#xA;&lt;p&gt;è¿è¡Œ insert è„šæœ¬ï¼ŒåŒæ ·æˆ‘ä¼šå…ˆ top çœ‹ tidb ï¼ tikv ï¼pd çš„ cpu ä½¿ç”¨æƒ…å†µã€‚&lt;br&gt;&#xA;æˆ‘ä»¬ä¼šå¾ˆå®¹æ˜“çš„å‘ç° insert çš„æ—¶å€™æˆ‘ä»¬ TiDB çš„ CPU å¹¶ä¸ä¼šé¦–å…ˆæˆä¸ºç“¶é¢ˆï¼ˆå¹¶ä¸ç»å¯¹ï¼‰ï¼Œä½†æ˜¯å‘ç° TiKV çš„å‹åŠ›è¿˜æ˜¯å¾ˆå¤§çš„ï¼Œæˆ‘ä»¬å°±éœ€è¦å»å®šä½ TiKV çš„ç“¶é¢ˆï¼Œå¦‚æœ TiKV å‹åŠ›ä¹Ÿæ˜¯å¾ˆå°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯ç£ç›˜ IO å­˜åœ¨é—®é¢˜ï¼ŒæŸ¥çœ‹ç£ç›˜ IO ï¼Œæ­£å¸¸æ¥è¯´æŸ¥çœ‹ç£ç›˜æƒ…å†µæˆ‘ä½¿ç”¨ iostat&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-04-08%20at%209.58.10%20AM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;æˆ‘ä»¬å¯ä»¥çœ‹åˆ° sde ç›˜çš„ %util åœ¨ 70ï¼Œä¹Ÿå°±æ˜¯è¯´æŒºå¿™çš„ï¼Œä½†æ˜¯è¿˜å¯ä»¥è¿˜æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆï¼Œæ­£å¸¸æ¥è¯´è¶…è¿‡äº† 90 ä»¥ä¸Šï¼Œå°±å¯ä»¥è®¤ä¸ºè¿™å—ç›˜å·²ç»è¢«æˆ‘ä»¬å‹æ¦¨çš„å·®ä¸å¤šäº†ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;åˆ’æ°´äº†ï¼Œinsert æµ‹è¯•çš„è¯¦ç»†å®šä½è¿‡ç¨‹åé¢åœ¨å•ç‹¬å†™ä¸€ç¯‡å§&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h3 id=&#34;summary-1&#34;&gt;Summary&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç“¶é¢ˆ&#xA;&lt;ul&gt;&#xA;&lt;li&gt;TiKV raftstore çº¿ç¨‹&lt;/li&gt;&#xA;&lt;li&gt;ç£ç›˜ IO ï¼Œå‡ºç° stall æˆ–æ˜¯å‡ºç°å¾ˆå¤š IO wait&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;ä¼˜åŒ–&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœåœ¨ç£ç›˜æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆçš„å‰æä¸‹ï¼ŒTiKV æœºå™¨çš„ CPU è¿˜å¾ˆå¯Œè£•ï¼Œå¯ä»¥å•å°å¤šéƒ¨ç½²ï¼Œä¸€èˆ¬å•ä¸ª TiKV å®ä¾‹å¯¹åº”ä¸€å—ç›˜&lt;/li&gt;&#xA;&lt;li&gt;ç£ç›˜ IO å‡ºç°ç“¶é¢ˆï¼Œå¯ä»¥è°ƒæ•´å‹ç¼©æ–¹å¼ï¼Œç”¨ CPU èµ„æºæ¢å– IO èµ„æº&lt;/li&gt;&#xA;&lt;li&gt;å‘ç°ç³»ç»Ÿçš„ IO å‹åŠ›ä¸å¤§ï¼Œä½†æ˜¯ CPUèµ„æºå·²ç»åƒå…‰äº†ï¼Œtop -H å‘ç°æœ‰å¤§é‡çš„ bg å¼€å¤´çš„çº¿ç¨‹ï¼ˆRocksDB çš„ compaction çº¿ç¨‹ï¼‰åœ¨è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘å‡å°‘å‹ç¼©ç”¨ IO èµ„æºæ¢å– CPU èµ„æº&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;heading-1&#34;&gt;ä¸€ç‚¹å°æç¤º&lt;/h2&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Sysbench ç‰ˆæœ¬å»ºè®®ä½¿ç”¨ 1.0 åŠä»¥ä¸Šç‰ˆæœ¬&lt;/li&gt;&#xA;&lt;li&gt;å½“é›†ç¾¤ TiKV èŠ‚ç‚¹æ•°é‡å¤§äº 3 çš„æ—¶å€™ï¼Œåœ¨ prepare æ•°æ®å®Œæˆåï¼Œéœ€è¦ç­‰å¾… TiKV èŠ‚ç‚¹ä¸Šçš„ * leader ä»¥åŠ region æ•°é‡å‡åŒ€åˆ†å¸ƒåï¼Œåœ¨è¿›è¡Œå„ç§åŸºå‡†æµ‹è¯•ï¼Œå¯ä»¥é€šè¿‡pd-ctl æˆ–æ˜¯ http://hosts:port/pd/api/v1/stores æˆ–æ˜¯ Grafana ç›‘æ§æŸ¥çœ‹å„ä¸ª TiKV èŠ‚ç‚¹ä¸Š leader å’Œ region çš„åˆ†å¸ƒæƒ…å†µã€‚&lt;/li&gt;&#xA;&lt;li&gt;å½“è¿›è¡Œå¤šè½®æµ‹è¯•çš„æ—¶å€™ï¼Œå½“éœ€è¦æ¸…ç†æ•°æ®çš„æ—¶å€™ï¼Œä¸è¦æ‰§è¡Œ DROP æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ Ansible è¿›è¡Œç‰©ç†åˆ é™¤ï¼Œç„¶ååœ¨é‡å¯é›†ç¾¤ï¼Œé‡æ–° prepare æ•°æ®è¿›è¡Œæµ‹è¯•ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å½“ TiDB , TiKV éƒ½æ²¡æœ‰è¾¾åˆ°ç“¶é¢ˆçš„æ—¶å€™, å¯ä»¥ä¸æ–­å¢å¤§ Sysbench çº¿ç¨‹æ•°é‡&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;heading-2&#34;&gt;æœ€åè¯´ä¸€ç‚¹&lt;/h2&gt;&#xA;&lt;p&gt;ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªå°çš„ç¤ºä¾‹ï¼Œåœ¨è¿›è¡Œå®é™…æ€§èƒ½æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯ä¼šå‡ºç°å„ç§å„æ ·çš„æƒ…å†µï¼Œå‡ºç°çš„ç“¶é¢ˆçš„åœ°æ–¹ä¹Ÿä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œæˆ‘æ‰€è°“çš„ç„å­¦å¹¶ä¸æ˜¯æ²¡æœ‰æ ¹æ®çš„èƒ¡ä¹±è°ƒæ•´ï¼Œè€Œæ˜¯åˆ†ææµ‹è¯•å®é™…æƒ…å†µåŠ ä¸Šè‡ªå·±å¯¹ TiDB ç³»ç»Ÿçš„ç†è§£ï¼Œè¿›è¡Œåˆç†è°ƒæ•´éƒ¨ç½²æ‹“æ‰‘ä»¥åŠé…ç½®å‚æ•°ã€‚å½“ç„¶å¦‚æœå¯¹ TiDB / TiKV / PD ç¨‹åºçš„ä¼˜åŒ–æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆå¥½çš„åˆ©ç”¨å‹æµ‹ + Grafan ç›‘æ§ + Perf + &lt;a href=&#34;https://github.com/brendangregg/FlameGraph&#34;&gt;FlameGraph&lt;/a&gt; å®šä½ç¨‹åºå†…éƒ¨çš„ç“¶é¢ˆã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-3&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tangliu-tool-1/&#34;&gt;å·¥æ¬²æ€§èƒ½è°ƒä¼˜ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼ˆ1ï¼‰&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tangliu-tool-2/&#34;&gt;å·¥æ¬²æ€§èƒ½è°ƒä¼˜ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼ˆ2ï¼‰- ç«ç„°å›¾&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tidb-internal-1/&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´å­˜å‚¨&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://int64.me/2017/sysbench%E7%9A%84%E4%B8%80%E7%82%B9%E6%95%B4%E7%90%86.html&#34;&gt;sysbench çš„ä¸€ç‚¹æ•´ç†&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pingcap/docs-cn/blob/master/op-guide/tune-tikv.md&#34;&gt;TiKV æ€§èƒ½å‚æ•°è°ƒä¼˜&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>Percolator è®ºæ–‡ç¬”è®°</title>
    <updated>2018-02-28T00:00:00Z</updated>
    <id>tag:int64.me,2018-02-28:/2018/Percolator è®ºæ–‡ç¬”è®°.html</id>
    <link href="http://int64.me/2018/Percolator è®ºæ–‡ç¬”è®°.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;TiDB çš„äº‹åŠ¡æ¨¡å‹æ˜¯å‚è€ƒ Google Percolator äº‹åŠ¡æ¨¡å‹ï¼Œæƒ³å»ç ”ç©¶ TiDB çš„äº‹åŠ¡æ¨¡å‹ï¼Œå­¦ä¹ ä¸€ä¸‹ Google Percolator è®ºæ–‡å¿…ä¸å¯å°‘...&lt;/p&gt;&#xA;&lt;h2 id=&#34;percolator-&#34;&gt;Percolator ç®€ä»‹&lt;/h2&gt;&#xA;&lt;h3 id=&#34;heading&#34;&gt;èƒŒæ™¯&lt;/h3&gt;&#xA;&lt;p&gt;ç®€å•æ¥è¯´ Percolator äº‹åŠ¡æ¨¡å‹çš„å‡ºç°æ˜¯å› ä¸ºä¹‹å‰é‡‡ç”¨ MapReduce è®¾è®¡çš„æ‰¹é‡åˆ›å»ºç´¢å¼•çš„ç³»ç»Ÿä¸æ”¯æŒè·¨è¡Œäº‹åŠ¡ä»¥åŠä¸æ”¯æŒéšæœºå¢é‡æ›´æ–°ã€‚äºæ˜¯ä¹ Percolator å°±è¯ç”Ÿäº†ï¼ˆ Google è¿˜çœŸæ˜¯æƒ³å•¥æœ‰å•¥å•Šï¼Œå®åŠ›çœŸä¸æ˜¯ç›–çš„ ï¼‰ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-1&#34;&gt;ç‰¹æ€§&lt;/h3&gt;&#xA;&lt;p&gt;Percolatorçš„ç‰¹ç‚¹å¦‚ä¸‹&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ä¸ºå¢é‡å¤„ç†å®šåˆ¶&lt;/li&gt;&#xA;&lt;li&gt;å¤„ç†ç»“æœå¼ºä¸€è‡´&lt;/li&gt;&#xA;&lt;li&gt;é’ˆå¯¹å¤§æ•°æ®é‡ï¼ˆå°æ•°æ®é‡ç”¨ä¼ ç»Ÿçš„æ•°æ®åº“å³å¯ï¼‰&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Percolator ä¸ºå¯æ‰©å±•çš„å¢é‡å¤„ç†æä¾›äº†ä¸¤ä¸ªä¸»è¦æŠ½è±¡ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åŸºäºéšæœºå­˜å–åº“çš„ACIDäº‹åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;è§‚å¯Ÿè€…(observers)â€“ä¸€ç§ç”¨äºå¤„ç†å¢é‡è®¡ç®—çš„æ–¹å¼&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;heading-2&#34;&gt;å»¶è¿Ÿé—®é¢˜&lt;/h3&gt;&#xA;&lt;p&gt;ç”±äº Percolator åœ¨è®¾è®¡çš„æ—¶å€™è¿½æ±‚çš„æ˜¯å¤§æ•°æ®é‡è€Œå¯¹å»¶è¿Ÿæ²¡æœ‰ç‰¹å®šè¦æ±‚ï¼Œæ‰€æœ‰åŸºäº Percolator äº‹ç‰©æ¨¡å‹è®¾è®¡çš„ç³»ç»Ÿï¼Œå»¶è¿Ÿå’Œä¼ ç»Ÿ DBMS ç­‰æ•°æ®åº“ç³»ç»Ÿç›¸æ¯”è¿˜æ˜¯æœ‰å¾ˆå¤§çš„å·®è·çš„ã€‚ä¸»è¦åŸå› è¿˜æ˜¯é”çš„é—®é¢˜ã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Percolator ä½¿ç”¨ä¸€ä¸ª lazy çš„æ–¹æ³•å»æ¸…ç†é—ç•™ä¸‹æ¥çš„é”ï¼Œæ¯”å¦‚ä¸€ä¸ª transactions ç”±äºè¿è¡Œçš„æœºå™¨æŒ‚æ‰äº†ï¼Œè¿™ä¸ª transactions å¤±è´¥é—ç•™ä¸‹æ¥çš„é”å¯èƒ½ä¸ä¼šç«‹åˆ»æ¸…ç†ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€ä¸ªä½¿ç”¨åˆ°è¯¥æ•°æ®çš„é¥¿äº‹åŠ¡è´Ÿè´£æ¸…ç†&lt;/li&gt;&#xA;&lt;li&gt;ç¼ºå°‘å…¨å±€ deadlock æ£€æŸ¥ï¼Œè¿™æ ·å°±ä½¿äº¤æ˜“å†²çªçš„æƒ…å†µå¢å¤šï¼Œäº‹åŠ¡é‡è¯•çš„æ¬¡æ•°å°±ä¼šå˜å¤šï¼Œå»¶è¿Ÿå°±ä¼šéšä¹‹å¢å¤§ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;heading-3&#34;&gt;è®¾è®¡&lt;/h2&gt;&#xA;&lt;h3 id=&#34;bigtable-&#34;&gt;Bigtable æ¦‚è¿°&lt;/h3&gt;&#xA;&lt;p&gt;Percolator æ˜¯å»ºç«‹åœ¨ Bigtable åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸Šå±‚ï¼ŒBigtable&lt;br&gt;&#xA;æ˜¯ä¸€ä¸ªç¨€ç–çš„ã€åˆ†å¸ƒå¼çš„ã€æŒä¹…åŒ–å­˜å‚¨çš„å¤šç»´åº¦æ’åº Mapã€‚Map çš„ç´¢å¼•æ˜¯è¡Œå…³é”®å­—ã€åˆ—å…³é”®å­—ä»¥åŠæ—¶é—´æˆ³ï¼ŒBigtable ä»¥ SSTable æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œå¹¶ä¸”è¿™äº› SSTables æ˜¯è¢«å­˜å‚¨åœ¨ GFS ä¸Šã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-27%20at%2012.44.16%20AM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-4&#34;&gt;äº‹åŠ¡&lt;/h3&gt;&#xA;&lt;p&gt;Percolator æä¾›äº†è·¨è¡Œã€è·¨è¡¨çš„ã€åŸºäºå¿«ç…§éš”ç¦»çš„ACIDäº‹åŠ¡ã€‚&lt;/p&gt;&#xA;&lt;h4 id=&#34;snapshop-isolation&#34;&gt;Snapshop isolation&lt;/h4&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-27%20at%209.34.11%20AM.png&#34; alt=&#34;sanpshop isolation&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;å¦‚å›¾ï¼Œæ˜¯åŸºäº Snapshop isolation  çš„ä¸‰ä¸ª transactionsï¼Œæ¯ä¸ª Transaction éƒ½æ˜¯å¼€å§‹ä¸ a start timestamp, å¹¶ä¸”ç»“æŸä¸ a commit timestampã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å› ä¸º transaction 2 çš„ start timestamp æ˜¯åœ¨transaction 1 commit timestamp ä¹‹å‰çš„ï¼Œæ‰€ä»¥ transaction 2 ä¸èƒ½å¤Ÿè¯»åˆ° transaction 1 æäº¤çš„ä¿¡æ¯&lt;/li&gt;&#xA;&lt;li&gt;transaction 3 å¯ä»¥åŒæ—¶çœ‹åˆ° transaction 1 å’Œ transaction 2 çš„æäº¤ä¿¡æ¯&lt;/li&gt;&#xA;&lt;li&gt;transaction 1 å’Œ transaction 2 æ˜¯å¹¶å‘çš„æ‰§è¡Œï¼Œå¦‚æœä»–ä»¬å†™å…¥åŒä¸€é¡¹ï¼Œè¿™ä¸¤ä¸ªäº‹åŠ¡ä¸­è‡³å°‘åˆä¸€ä¸ªä¼šæ‰§è¡Œå¤±è´¥&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;lock&#34;&gt;Lock&lt;/h4&gt;&#xA;&lt;p&gt;Bigtable æœ¬èº«å¹¶æ²¡æœ‰æä¾›ä¾¿æ·çš„å†²çªè§£å†³å’Œé”ç®¡ç†ï¼ŒPercolator å¿…é¡»è‡ªå·±ç»´æŠ¤ä¸€å¥—ç‹¬ç«‹çš„é”çš„ç®¡ç†æœºåˆ¶ã€‚&lt;/p&gt;&#xA;&lt;p&gt;è¦æ±‚ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å®¹é”™ï¼Œå½“æœºå™¨å‡ºç°æ•…éšœçš„æ—¶å€™ä¸å½±å“æ­£ç¡®æ€§ï¼Œå¦‚æœåœ¨ä¸¤é˜¶æ®µæäº¤çš„è¿‡ç¨‹ä¸­é”å‡ºç°äº†ä¸¢å¤±ï¼Œå¯èƒ½å°†ä¸¤ä¸ªæœ‰å†²çªçš„äº‹ç‰©éƒ½æäº¤æˆåŠŸã€‚&lt;/li&gt;&#xA;&lt;li&gt;é«˜ååï¼Œä¸Šåƒå°æœºå™¨ä¼šåŒæ—¶è¯·æ±‚è·å–é”ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä½å»¶è¿Ÿ, æ¯ä¸ª Get() æ“ä½œéƒ½éœ€è¦è¯»å–ä¸€æ¬¡é”ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Percolator éœ€è¦åšåˆ°ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¤šå‰¯æœ¬ï¼Œå®¹é”™&lt;/li&gt;&#xA;&lt;li&gt;åˆ†å¸ƒå¼ä»¥åŠè´Ÿè½½å‡è¡¡ï¼Œå¤„ç†è´Ÿè½½&lt;/li&gt;&#xA;&lt;li&gt;æ•°æ®æŒä¹…åŒ–&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;BigTable èƒ½å¤Ÿæ»¡è¶³ä»¥ä¸Šæ‰€æœ‰è¦æ±‚ã€‚æ‰€ä»¥ Percolator åœ¨å®ç°æ—¶ï¼Œå°†å®é™…çš„æ•°æ®å­˜äºBigtableä¸­ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;columns-in-bigtable&#34;&gt;Columns in Bigtable&lt;/h3&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-27%20at%2011.32.55%20PM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;Percolator åœ¨ Bigtable ä¸ŠæŠ½è±¡äº† 5 Columns å»å­˜å‚¨æ•°æ®ï¼Œå¦‚ä¸Šå›¾ï¼Œå…¶ä¸­æœ‰ 3 å’Œäº‹åŠ¡ç›¸å…³ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;c:lock&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;äº‹åŠ¡äº§ç”Ÿçš„é”ï¼Œæœªæäº¤çš„äº‹åŠ¡ä¼šå†™æœ¬é¡¹ï¼Œä¼šåŒ…å« primary lock çš„ä½ç½®ã€‚å…¶æ˜ å°„å…³ç³»ä¸º&lt;/p&gt;&#xA;&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\({key,start_ts}=&gt;\)&lt;/span&gt;{primary_key,lock_type,..etc}&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;${key} æ•°æ®çš„key&#xA;${start_ts} äº‹åŠ¡å¼€å§‹æ—¶é—´&#xA;${primary} è¯¥äº‹åŠ¡çš„primaryçš„å¼•ç”¨. primaryæ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œä»å¾…ä¿®æ”¹çš„ keysä¸­ é€‰æ‹©ä¸€ä¸ªä½œä¸ºprimary,å…¶ä½™çš„åˆ™ä½œä¸ºsecondary.&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;c:write&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å·²æäº¤çš„æ•°æ®ä¿¡æ¯ï¼Œå­˜å‚¨æ•°æ®æ‰€å¯¹åº”çš„æ—¶é—´æˆ³ã€‚å…¶æ˜ å°„å…³ç³»ä¸º&lt;/p&gt;&#xA;&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\({key,commit_ts}=&gt;\)&lt;/span&gt;{start_ts}&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;${key} æ•°æ®çš„key&#xA;${commit_ts} äº‹åŠ¡çš„æäº¤æ—¶é—´&#xA;${start_ts} è¯¥äº‹åŠ¡çš„å¼€å§‹æ—¶é—´,æŒ‡å‘è¯¥æ•°æ®åœ¨dataä¸­çš„å®é™…å­˜å‚¨ä½ç½®ã€‚&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;c:data&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å…·ä½“å­˜å‚¨æ•°æ®é›†ï¼Œæ˜ å°„å…³ç³»ä¸º&lt;/p&gt;&#xA;&lt;p&gt;&lt;span class=&#34;math inline&#34;&gt;\({key,start_ts} =&gt; \)&lt;/span&gt;{value}&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;${key} çœŸå®çš„key&#xA;${start_ts} å¯¹åº”äº‹åŠ¡çš„å¼€å§‹æ—¶é—´&#xA;${value} çœŸå®çš„æ•°æ®å€¼&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;h3 id=&#34;-percolator-&#34;&gt;ç®€è¿° Percolator äº‹åŠ¡æµç¨‹&lt;/h3&gt;&#xA;&lt;p&gt;äº‹åŠ¡æäº¤é‡‡ç”¨ä¸¤é˜¶æ®µæäº¤ã€‚ä¸¤é˜¶æ®µæäº¤é€šè¿‡ client æ¥åè°ƒã€‚&lt;/p&gt;&#xA;&lt;h4 id=&#34;prewrite&#34;&gt;Prewrite&lt;/h4&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/prewrite.jpg&#34; alt=&#34;prewrite&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;åœ¨æäº¤çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼šå…¶ä» Oracle è·å–ä»£è¡¨å½“å‰ç‰©ç†æ—¶é—´çš„å…¨å±€å”¯ä¸€æ—¶é—´æˆ³ä½œä¸ºå½“å‰äº‹åŠ¡çš„ start_tsï¼Œæˆ‘ä»¬é¦–å…ˆè·å–æ‰€æœ‰éœ€è¦å†™å…¥çš„ cell çš„ lockï¼ˆè€ƒè™‘åˆ° client æ•…éšœæƒ…å†µï¼Œæˆ‘ä»¬ä¼šä»»æ„æŒ‡å®šä¸€ä¸ª lock ä¸º primaryï¼Œå…¶ä½™çš„ä½œä¸º secondaryï¼‰ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½ä¼šè¯»å– meta æ•°æ®æ¥æ£€æµ‹äº‹åŠ¡æ˜¯å¦å­˜åœ¨å†²çªã€‚&lt;/p&gt;&#xA;&lt;p&gt;æœ‰ä¸¤ç§å†²çªçš„æƒ…å†µï¼š&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;å¦‚æœä¸€ä¸ªäº‹åŠ¡ A çœ‹åˆ° cell çš„ write åˆ—ä¸­å·²ç»å­˜åœ¨ä¸€æ¡è®°å½•ï¼Œè®°å½•çš„æ—¶é—´æˆ³æ™šäºè¯¥äº‹åŠ¡å¼€å§‹çš„æ—¶é—´æˆ³ï¼Œé‚£ä¹ˆè¯´æ˜å­˜åœ¨å†™å†²çªï¼Œå³è¯´æ˜æœ‰ä¸€ä¸ªäº‹åŠ¡åœ¨ A å‘èµ·ä¹‹åæ›´æ–°äº† cell çš„å€¼ï¼Œäº‹åŠ¡ A éœ€è¦ abortedã€‚&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;li&gt;&#xA;&lt;p&gt;å¦‚æœäº‹åŠ¡çœ‹åˆ° cell çš„ lock åˆ—ä¸­å­˜åœ¨ä»»æ„ä¸€æ¡é”è®°å½•ï¼Œä¸ç®¡æ—¶é—´æˆ³ä¸ºå¤šå°‘ï¼Œç›´æ¥ abortedã€‚&lt;/p&gt;&#xA;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;å¦‚æœä¸¤ç§å†²çªéƒ½ä¸å­˜åœ¨ï¼Œå‘ lock åˆ—ä¸­å†™å…¥ä¸Šé”ä¿¡æ¯ï¼Œå¹¶æ›´æ–° data åˆ—æ•°æ®ã€‚&lt;/p&gt;&#xA;&lt;h4 id=&#34;commit&#34;&gt;Commit&lt;/h4&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/commit.jpg&#34; alt=&#34;commit&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;å¦‚æœæ²¡æœ‰ cell å†²çªï¼Œé‚£ä¹ˆè¯´æ˜äº‹åŠ¡å¯ä»¥æäº¤ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªé˜¶æ®µ commitï¼šé¦–å…ˆ client ä¼šå‘æ—¶é—´æœåŠ¡å™¨ç”³è¯·ä¸€ä¸ª timestamp ä½œä¸º commit_tsï¼Œè¡¨ç¤º commit çš„æ—¶é—´ã€‚ç„¶å client ä¼šé‡Šæ”¾äº‹åŠ¡ä¸­æ¶‰åŠçš„æ‰€æœ‰ cell çš„é”ï¼ˆæ¸…ç©º lock åˆ—ï¼‰ï¼Œé‡Šæ”¾é¡ºåºä» primary lockå¼€å§‹ã€‚&lt;/p&gt;&#xA;&lt;p&gt;é‡Šæ”¾é”ä¹‹åä¾¿æ›´æ–° write åˆ—æ¥ä½¿æ–°çš„ read èƒ½å¤Ÿè¯»åˆ°æœ¬æ¬¡äº‹åŠ¡çš„æ•°æ®ã€‚write åˆ—çš„æ•°æ®è¡¨ç¤ºï¼šæœ¬æ¬¡äº‹åŠ¡çš„æ•°æ®å·²ç»æˆåŠŸæ›´æ–°è‡³ cell ä¸­ï¼Œwrite åˆ—ä¸­çš„æ•°æ®åŒ…å«äº†ä¸€ä¸ª timestampï¼Œè¯¥ timestamp è¡¨ç¤ºæœ¬æ¬¡äº‹åŠ¡æ•°æ®çš„ timestampï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¯¥ timestamp æ¥æ‰¾åˆ°æ•°æ®ã€‚ä¸€æ—¦ primary é”å¯¹åº”è®°å½•çš„ write åˆ—æ•°æ®å¯è§äº†ï¼Œä»£è¡¨è¯¥äº‹åŠ¡ä¸€å®šå·²ç» commit äº†ï¼Œreader æ­¤æ—¶èƒ½çœ‹åˆ°è¯¥äº‹åŠ¡çš„æ•°æ®ã€‚&lt;/p&gt;&#xA;&lt;h4 id=&#34;get-operation&#34;&gt;Get operation&lt;/h4&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/get.jpg&#34; alt=&#34;get&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Get æ“ä½œé¦–å…ˆæ£€æŸ¥[0,start_ts]æ—¶é—´åŒºé—´å†…Lockæ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨ï¼Œè¯´æ˜å¯èƒ½æœ‰å…¶ä»– transaction æ­£åœ¨å†™è¿™ä¸ª cellï¼Œæ‰€ä»¥è¿™ä¸ªè¯» transaction éœ€è¦ç­‰å¾… lock é‡Šæ”¾æ‰ã€‚å¦‚æœä¸å­˜åœ¨æœ‰å†²çªçš„ lock,åˆ™è·å–åœ¨ write ä¸­åˆæ³•çš„æœ€æ–°æäº¤è®°å½•æŒ‡å‘çš„åœ¨ data ä¸­çš„ä½ç½®ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ä» data ä¸­è·å–åˆ°ç›¸åº”çš„æ•°æ®å¹¶è¿”å›ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h4 id=&#34;clean-lock&#34;&gt;clean lock&lt;/h4&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/rollback.jpg&#34; alt=&#34;clean lock&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å›¾ç‰‡ copy &lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;è‹¥å®¢æˆ·ç«¯åœ¨ Commit ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œå‡ºç°äº†å¼‚å¸¸ï¼ŒPrepare æ—¶äº§ç”Ÿçš„é”ä¼šè¢«ç•™ä¸‹ã€‚ä¸ºé¿å…å°†æ–°äº‹åŠ¡ hang ä½ï¼ŒPercolator å¿…é¡»æ¸…ç†è¿™äº›é”ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Percolator ç”¨ lazy æ–¹å¼å¤„ç†è¿™äº›é”ï¼šå½“äº‹åŠ¡ A åœ¨æ‰§è¡Œæ—¶ï¼Œå‘ç°äº‹åŠ¡ B é€ æˆçš„é”å†²çªï¼Œäº‹åŠ¡ A å°†å†³å®šäº‹åŠ¡ B æ˜¯å¦å¤±è´¥ï¼Œä»¥åŠæ¸…ç†äº‹åŠ¡ B çš„é‚£äº›é”ã€‚&lt;br&gt;&#xA;å¯¹äº‹åŠ¡ A è€Œè¨€ï¼Œèƒ½å‡†ç¡®åœ°åˆ¤æ–­äº‹åŠ¡ B æ˜¯å¦æˆåŠŸæ˜¯å…³é”®ã€‚Percolator ä¸ºæ¯ä¸ªäº‹åŠ¡è®¾è®¡äº†ä¸€ä¸ªå…ƒç´ cellä½œä¸ºäº‹åŠ¡æ˜¯å¦æˆåŠŸçš„åŒæ­¥æ ‡å‡†ï¼Œè¯¥å…ƒç´ äº§ç”Ÿçš„ lock å³ä¸º primary lockã€‚A å’Œ B äº‹åŠ¡éƒ½èƒ½ç¡®å®šäº‹åŠ¡ B çš„ primary lockï¼ˆå› ä¸ºè¿™ä¸ªpriarmy lockè¢«å†™å…¥äº†Bäº‹åŠ¡å…¶å®ƒæ‰€æœ‰æ¶‰åŠå…ƒç´ çš„locké‡Œé¢ï¼‰ã€‚æ‰§è¡Œä¸€ä¸ªæ¸…ç† clean up æˆ–è€…æäº¤ commit æ“ä½œéœ€è¦ä¿®æ”¹è¯¥primary lockï¼Œç”±äºè¿™äº›ä¿®æ”¹æ˜¯åŸºäº Bigtable å»åšï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªæ¸…ç†æˆ–æäº¤ä¼šæˆåŠŸã€‚æ³¨æ„ï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;åœ¨Bæäº¤ commit ä¹‹å‰,å®ƒä¼šå…ˆç¡®ä¿å…¶ primary lock è¢« write record æ‰€æ›¿ä»£ï¼ˆå³å¾€ primary çš„ write å†™æäº¤æ•°æ®ï¼Œå¹¶åˆ é™¤å¯¹åº”çš„ lockï¼‰ã€‚&lt;/li&gt;&#xA;&lt;li&gt;åœ¨ A æ¸…ç† B çš„é”ä¹‹å‰ï¼ŒA å¿…é¡»æ£€æŸ¥ B çš„ primary ä»¥ç¡®ä¿ B æœªè¢«æäº¤ï¼Œå¦‚æœ B çš„ primary å­˜åœ¨ï¼Œåˆ™ B çš„é”å¯ä»¥è¢«å®‰å…¨çš„æ¸…ç†æ‰ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å½“å®¢æˆ·ç«¯åœ¨æ‰§è¡Œä¸¤é˜¶æ®µæäº¤çš„ commit é˜¶æ®µå¤±è´¥æ—¶ï¼Œäº‹åŠ¡ä¾æ—§ä¼šç•™ä¸‹ä¸€ä¸ªæäº¤ç‚¹ commit point(è‡³å°‘ä¸€æ¡è®°å½•ä¼šè¢«å†™å…¥ write ä¸­)ï¼Œä½†å¯èƒ½ä¼šç•™ä¸‹ä¸€äº› lock æœªè¢«å¤„ç†æ‰ã€‚ä¸€ä¸ªäº‹åŠ¡èƒ½å¤Ÿä»å…¶ primary lock ä¸­è·å–åˆ°æ‰§è¡Œæƒ…å†µï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ priarmy lock å·²è¢« write æ‰€æ›¿ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥äº‹åŠ¡å·²è¢«æäº¤ï¼Œå¯ä»¥æ”¾å¿ƒçš„æ¸…ç† B äº‹åŠ¡çš„æ‰€æœ‰ lock&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœ primary lock å­˜åœ¨ï¼Œäº‹åŠ¡è¢« roll back (å› ä¸ºæˆ‘ä»¬æ€»æ˜¯æœ€å…ˆæäº¤ primary ,æ‰€ä»¥ primary æœªè¢«æäº¤æ—¶ï¼Œå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œå›æ»š)&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;heading-5&#34;&gt;æ¡ˆä¾‹&lt;/h3&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%2012.59.40%20AM.png&#34; alt=&#34;1&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;åˆå§‹çŠ¶æ€ä¸‹ï¼ŒBob çš„å¸æˆ·ä¸‹æœ‰ &lt;span class=&#34;math inline&#34;&gt;\(10ï¼ˆé¦–å…ˆæŸ¥è¯¢ column write è·å–æœ€æ–°æ—¶é—´æˆ³æ•°æ®,è·å–åˆ° data@5,ç„¶åä» column data é‡Œé¢è·å–æ—¶é—´æˆ³ä¸º5çš„æ•°æ®ï¼Œå³ \)&lt;/span&gt;10ï¼‰ï¼ŒJoe çš„å¸æˆ·ä¸‹æœ‰ $2ã€‚&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%2012.59.46%20AM.png&#34; alt=&#34;2&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;è½¬è´¦å¼€å§‹ï¼Œä½¿ç”¨ stat timestamp=7 ä½œä¸ºå½“å‰äº‹åŠ¡çš„å¼€å§‹æ—¶é—´æˆ³ï¼Œå°† Bob é€‰ä¸ºæœ¬äº‹åŠ¡çš„ primaryï¼Œé€šè¿‡å†™å…¥ Column Lock é”å®š Bob çš„å¸æˆ·ï¼ŒåŒæ—¶å°†æ•°æ® 7:$3 å†™å…¥åˆ° Column,data åˆ—ã€‚&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%2012.59.53%20AM.png&#34; alt=&#34;3&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;åŒæ ·çš„ï¼Œä½¿ç”¨ stat timestamp=7ï¼Œé”å®š Joe çš„å¸æˆ·ï¼Œå¹¶å°† Joe æ”¹å˜åçš„ä½™é¢å†™å…¥åˆ° Column,data ,å½“å‰é”ä½œä¸º secondary å¹¶å­˜å‚¨ä¸€ä¸ªæŒ‡å‘ primary çš„å¼•ç”¨ï¼ˆå½“å¤±è´¥æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ° primary é”ï¼Œå¹¶æ ¹æ®å…¶çŠ¶æ€å¼‚æ­¥æ¸…ç†ï¼‰&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%201.00.00%20AM.png&#34; alt=&#34;4&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;äº‹åŠ¡å¸¦ç€å½“å‰æ—¶é—´æˆ³ commit timestamp=8 è¿›å…¥ commit é˜¶æ®µï¼šåˆ é™¤ primary æ‰€åœ¨çš„ lockï¼Œå¹¶åœ¨ write åˆ—ä¸­å†™å…¥ä»æäº¤æ—¶é—´æˆ³æŒ‡å‘æ•°æ®å­˜å‚¨çš„ä¸€ä¸ªæŒ‡é’ˆ commit_ts=&amp;gt;data @7ã€‚è‡³æ­¤ï¼Œè¯»è¯·æ±‚è¿‡æ¥æ—¶å°†çœ‹åˆ° Bob çš„ä½™é¢ä¸º3ã€‚&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202018-02-28%20at%201.00.06%20AM.png&#34; alt=&#34;5&#34;&gt;&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;ä¾æ¬¡åœ¨ secondary é¡¹ä¸­å†™å…¥wirteå¹¶æ¸…ç†é”ï¼Œæ•´ä¸ªäº‹åŠ¡æäº¤ç»“æŸã€‚&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;heading-6&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.usenix.org/legacy/event/osdi10/tech/full_papers/Peng.pdf&#34;&gt;Large-scale Incremental Processing&lt;br&gt;&#xA;Using Distributed Transactions and Notifications&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://andremouche.github.io/transaction/percolator.html&#34;&gt;é›ªå§ blog: Google Percolator çš„äº‹åŠ¡æ¨¡å‹&lt;/a&gt; - å¾ˆå¤šæè¿°æ˜¯ä»é›ªå§ blog ç›´æ¥ copy è¿‡æ¥&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.jianshu.com/p/05194f4b29dd&#34;&gt;Percolatorç®€å•ç¿»è¯‘ä¸ä¸ªäººç†è§£&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>MVCC In TiKV</title>
    <updated>2017-11-28T00:00:00Z</updated>
    <id>tag:int64.me,2017-11-28:/2017/MVCC In TiKV.html</id>
    <link href="http://int64.me/2017/MVCC In TiKV.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;å¾ˆå¤šæ•°æ®åº“éƒ½ä¼šå®ç°å¤šç‰ˆæœ¬æ§åˆ¶ï¼ˆMVCCï¼‰ï¼ŒTiKV ä¹Ÿä¸ä¾‹å¤–ï¼Œåˆšå¥½æœ€è¿‘åœ¨çœ‹ TiKVï¼Œå¯¹äº MVCC ä»¥åŠ TiKV å†…æ˜¯å¦‚ä½•ä½¿ç”¨ MVCC çš„åšä¸ªç®€å•ç¬”è®°...&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;ä¹è§‚é”å’Œæ‚²è§‚é”&lt;/h2&gt;&#xA;&lt;h3 id=&#34;heading-1&#34;&gt;ä¹è§‚é”&lt;/h3&gt;&#xA;&lt;p&gt;ä¹è§‚é”å‘¢ï¼Œè¯»å†™äº‹åŠ¡ï¼Œåœ¨çœŸæ­£çš„æäº¤ä¹‹å‰ï¼Œä¸åŠ è¯»/å†™é”ï¼Œè€Œæ˜¯å…ˆçœ‹ä¸€ä¸‹æ•°æ®çš„ç‰ˆæœ¬/æ—¶é—´æˆ³ï¼Œç­‰åˆ°çœŸæ­£æäº¤çš„æ—¶å€™å†çœ‹ä¸€ä¸‹ç‰ˆæœ¬/æ—¶é—´æˆ³ï¼Œå¦‚æœä¸¤æ¬¡ç›¸åŒï¼Œè¯´æ˜åˆ«äººæœŸé—´æ²¡æœ‰å¯¹æ•°æ®è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ”¾å¿ƒæäº¤ã€‚ä¹è§‚ä½“ç°åœ¨ï¼Œè®¿é—®æ•°æ®æ—¶ä¸æå‰åŠ é”ã€‚åœ¨èµ„æºå†²çªä¸æ¿€çƒˆçš„åœºåˆï¼Œç”¨ä¹è§‚é”æ€§èƒ½è¾ƒå¥½ã€‚å¦‚æœèµ„æºå†²çªä¸¥é‡ï¼Œä¹è§‚é”çš„å®ç°ä¼šå¯¼è‡´äº‹åŠ¡æäº¤çš„æ—¶å€™ç»å¸¸çœ‹åˆ°åˆ«äººåœ¨ä»–ä¹‹å‰å·²ç»ä¿®æ”¹äº†æ•°æ®ï¼Œç„¶åè¦è¿›è¡Œå›æ»šæˆ–è€…é‡è¯•ï¼Œè¿˜ä¸å¦‚ä¸€ä¸Šæ¥å°±åŠ é”ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-2&#34;&gt;æ‚²è§‚é”&lt;/h3&gt;&#xA;&lt;p&gt;ä¸€ä¸ªè¯»å†™äº‹åŠ¡åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­åœ¨è®¿é—®æ•°æ®ä¹‹å‰å…ˆåŠ è¯»/å†™é”è¿™ç§å®ç°å«åšæ‚²è§‚é”ï¼Œæ‚²è§‚ä½“ç°åœ¨ï¼Œå…ˆåŠ é”ï¼Œç‹¬å æ•°æ®ï¼Œé˜²æ­¢åˆ«äººåŠ é”ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;å…³äºä¹è§‚é”æ‚²è§‚é”çš„è§£é‡Š copy è‡ªï¼š&lt;a href=&#34;https://www.zhihu.com/question/27876575/answer/73330077&#34;&gt;å´é•å¤§ç¥çŸ¥ä¹çš„å›ç­”&lt;/a&gt;, æ„Ÿè§‰å›ç­”çš„æœ€ç®€æ´è´´åˆ‡&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;heading-3&#34;&gt;å¹¶å‘æ§åˆ¶&lt;/h2&gt;&#xA;&lt;h3 id=&#34;heading-4&#34;&gt;å¯ä¸²è¡ŒåŒ–&lt;/h3&gt;&#xA;&lt;p&gt;å¤šä¸ªäº‹åŠ¡çš„å¹¶å‘æ‰§è¡Œæ˜¯æ­£ç¡®çš„ï¼Œå½“ä¸”ä»…å½“å…¶ç»“æœä¸æŒ‰æŸä¸€æ¬¡åºä¸²è¡Œåœ°æ‰§è¡Œå®ƒä»¬æ—¶çš„ç»“æœç›¸åŒã€‚æˆ‘ä»¬ç§°è¿™ç§è°ƒåº¦ç­–ç•¥ä¸ºå¯ä¸²è¡ŒåŒ–ï¼ˆSerializableï¼‰çš„è°ƒåº¦ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯ä¸²è¡Œæ€§æ˜¯å¹¶å‘äº‹åŠ¡æ­£ç¡®æ€§çš„å‡†åˆ™ã€‚æŒ‰è¿™ä¸ªå‡†åˆ™è§„å®šï¼Œä¸€ä¸ªç»™å®šçš„å¹¶å‘è°ƒåº¦ï¼Œå½“ä¸”ä»…å½“å®ƒæ˜¯å¯ä¸²è¡ŒåŒ–çš„ï¼Œæ‰è®¤ä¸ºæ˜¯æ­£ç¡®è°ƒåº¦ã€‚DBMSçš„å¹¶å‘æ§åˆ¶æœºåˆ¶å¿…é¡»æä¾›ä¸€å®šçš„æ‰‹æ®µæ¥ä¿è¯è°ƒåº¦æ˜¯å¯ä¸²è¡ŒåŒ–çš„ï¼Œç›®å‰DBMSæ™®éé‡‡ç”¨å°é”æ–¹æ³•å®ç°å¹¶å‘æ“ä½œè°ƒåº¦çš„å¯ä¸²è¡Œæ€§ï¼Œä»è€Œä¿è¯è°ƒåº¦çš„æ­£ç¡®æ€§ã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä¸¤æ®µé”ï¼ˆTwo-Phase Lockingï¼Œç®€ç§°2PLï¼‰åè®®å°±æ˜¯ä¿è¯å¹¶å‘è°ƒåº¦å¯ä¸²è¡Œæ€§çš„å°é”åè®®ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;2pl&#34;&gt;2PL&lt;/h3&gt;&#xA;&lt;p&gt;ä¸¤æ®µé”ï¼ˆTwo-Phase Lockingï¼Œç®€ç§°2PLï¼‰æ˜¯æŒ‡æ‰€æœ‰äº‹åŠ¡éƒ½å¿…é¡»åˆ†ä¸ºä¸¤é˜¶æ®µå¯¹æ•°æ®è¿›è¡ŒåŠ é”å’Œè§£é”ï¼š&lt;/p&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;å¯¹ä»»ä½•æ•°æ®è¿›è¡Œè¯»ã€å†™æ“ä½œä¹‹å‰ï¼Œé¦–å…ˆè¦å…ˆç”³è¯·å¹¶è·å¾—å¯¹è¯¥æ•°æ®çš„å°é”&lt;/li&gt;&#xA;&lt;li&gt;åœ¨é‡Šæ”¾ä¸€ä¸ªå°é”ä»¥åï¼Œäº‹åŠ¡ä¸å†è·å¾—ä»»ä½•å…¶ä»–å°é”&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;&lt;p&gt;åœ¨â€œä¸¤æ®µâ€é”åè®®ä¸­ï¼Œäº‹åŠ¡åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;ç¬¬ä¸€é˜¶æ®µæ˜¯è·å¾—å°é”ï¼Œä¹Ÿç§°ä¸ºæ‰©å±•é˜¶æ®µã€‚è¿™åœ¨é˜¶æ®µï¼Œäº‹åŠ¡å¯ä»¥ç”³è¯·è·å¾—ä»»ä½•æ•°æ®é¡¹ä¸Šçš„ä»»ä½•ç±»å‹çš„é”ï¼Œä½†æ˜¯ä¸èƒ½é‡Šæ”¾ä»»ä½•é”ã€‚&lt;/li&gt;&#xA;&lt;li&gt;ç¬¬äºŒé˜¶æ®µæ˜¯é‡Šæ”¾å°é”ï¼Œä¹Ÿç§°ä¸ºæ”¶ç¼©é˜¶æ®µã€‚åœ¨è¿™é˜¶æ®µï¼Œäº‹åŠ¡å¯ä»¥é‡Šæ”¾ä»»ä½•æ•°æ®é¡¹ä¸Šçš„ä»»ä½•ç±»å‹çš„çï¼Œä½†æ˜¯ä¸èƒ½å†ç”³è¯·ä»»ä½•çã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å¦‚å›¾ï¼š&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/Screen%20Shot%202017-11-27%20at%2011.44.23%20PM.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;h3 id=&#34;2pl-&#34;&gt;2PL ä¸€äº›ç¼ºç‚¹&lt;/h3&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è¯»é”å’Œå†™é”ä¼šç›¸äº’é˜»æ»ï¼ˆblockï¼‰ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å¤§éƒ¨åˆ†äº‹åŠ¡éƒ½æ˜¯åªè¯»ï¼ˆread-onlyï¼‰çš„ï¼Œæ‰€ä»¥ä»äº‹åŠ¡åºåˆ—ï¼ˆtransaction-orderingï¼‰çš„è§’åº¦æ¥çœ‹æ˜¯æ— å®³çš„ã€‚å¦‚æœä½¿ç”¨åŸºäºé”çš„éš”ç¦»æœºåˆ¶ï¼Œè€Œä¸”å¦‚æœæœ‰ä¸€æ®µå¾ˆé•¿çš„è¯»äº‹åŠ¡çš„è¯ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…è¿™ä¸ªå¯¹è±¡å°±æ— æ³•è¢«æ”¹å†™ï¼Œåé¢çš„äº‹åŠ¡å°±ä¼šè¢«é˜»å¡ç›´åˆ°è¿™ä¸ªäº‹åŠ¡å®Œæˆã€‚è¿™ç§æœºåˆ¶å¯¹äºå¹¶å‘æ€§èƒ½æ¥è¯´å½±å“å¾ˆå¤§ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h3 id=&#34;mvcc&#34;&gt;MVCC&lt;/h3&gt;&#xA;&lt;p&gt;MVCC - å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMulti-Version Concurrency Controlï¼‰, åœ¨ MVCC ä¸­ï¼Œæ¯å½“æƒ³è¦æ›´æ”¹æˆ–è€…åˆ é™¤æŸä¸ªæ•°æ®å¯¹è±¡æ—¶ï¼ŒDBMS ä¸ä¼šåœ¨åŸåœ°å»åˆ é™¤æˆ–è¿™ä¿®æ”¹è¿™ä¸ªå·²æœ‰çš„æ•°æ®å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªè¯¥æ•°æ®å¯¹è±¡çš„æ–°çš„ç‰ˆæœ¬ï¼Œè¿™æ ·çš„è¯åŒæ—¶å¹¶å‘çš„è¯»å–æ“ä½œä»æ—§å¯ä»¥è¯»å–è€ç‰ˆæœ¬çš„æ•°æ®ï¼Œè€Œå†™æ“ä½œå°±å¯ä»¥åŒæ—¶è¿›è¡Œã€‚è¿™ä¸ªæ¨¡å¼çš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥è®©è¯»å–æ“ä½œä¸å†é˜»å¡ï¼Œäº‹å®ä¸Šæ ¹æœ¬å°±ä¸éœ€è¦é”ã€‚è¿™æ˜¯ä¸€ç§éå¸¸è¯±äººçš„ç‰¹å‹ï¼Œä»¥è‡³äºåœ¨å¾ˆå¤šä¸»æµçš„æ•°æ®åº“ä¸­éƒ½é‡‡ç”¨äº† MVCC çš„å®ç°ï¼Œæ¯”å¦‚è¯´ PostgreSQLï¼ŒOracleï¼ŒMicrosoft SQL Server ç­‰ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ­¤å¤„ copy è‡ª&lt;a href=&#34;https://pingcap.com/blog-cn/MVCC-in-TiKV/&#34;&gt;TiKV çš„ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰æœºåˆ¶&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;mvcc-in-tikv&#34;&gt;MVCC in TiKV&lt;/h2&gt;&#xA;&lt;p&gt;TiKV ç›®å‰çš„åº•å±‚å­˜å‚¨è¿˜æ˜¯ä½¿ç”¨äº† rocksdbï¼Œ ä¹Ÿå°±æ˜¯ç›®å‰æˆ‘ä»¬çš„æ‰€æœ‰æ•°æ®ä¹Ÿå°±æ˜¯å­˜åœ¨ rocksdb å†…ã€‚ç›®å‰ TiKV ä¼šå¯åŠ¨ä¸¤ä¸ª rocksdb å®ä¾‹ï¼Œé»˜è®¤ rocksdb å®ä¾‹å°† KV æ•°æ®å­˜å‚¨åœ¨å†…éƒ¨çš„ defaultã€write å’Œ lock 3 ä¸ª CF å†…ã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;default CF å­˜å‚¨çš„æ˜¯çœŸæ­£çš„æ•°æ®ï¼›&lt;/li&gt;&#xA;&lt;li&gt;write CF å­˜å‚¨çš„æ˜¯æ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ˆMVCCï¼‰ä»¥åŠç´¢å¼•ç›¸å…³çš„æ•°æ®ï¼›&lt;/li&gt;&#xA;&lt;li&gt;lock CF å­˜å‚¨çš„æ˜¯é”ä¿¡æ¯ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Raft RocksDB å®ä¾‹å­˜å‚¨ Raft logã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;default CF ä¸»è¦å­˜å‚¨çš„æ˜¯ raft logã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;rocksdb çš„ cf æ˜¯ä¸€ä¸ªé€»è¾‘åˆ’åˆ†æ•°æ®åº“çš„èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯è¯´åšåˆ°äº†æƒ³å¤šéš”ç¦»çš„å­˜å‚¨ï¼Œä½†æ˜¯ rocksdb æä¾›è·¨ cf çš„åŸå­å†™æ“ä½œï¼Œä¸åŒçš„ cf å…±ç”¨åŒä¸€ä¸ª WALï¼Œä½†æ˜¯ä½¿ç”¨ä¸åŒ memtable å’Œ sslã€‚ï¼ˆå…·ä½“ rocksdb ç›¸å…³çš„çŸ¥è¯†å¯ä»¥æŸ¥é˜… rocksdb ç›¸å…³æ–‡æ¡£ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„ cf ç”¨æ¥å­˜å‚¨ MVCC çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚ TiKV çš„ MVCC å®ç°æ˜¯é€šè¿‡åœ¨ Key åé¢æ·»åŠ  Version æ¥å®ç°ï¼Œç®€å•æ¥è¯´ï¼Œæ²¡æœ‰ MVCC ä¹‹å‰ï¼Œå¯ä»¥æŠŠ TiKV çœ‹åšè¿™æ ·çš„ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;                Key1 -&amp;gt; Value&#xA;&#x9;            Key2 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&#x9;            KeyN -&amp;gt; Value&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;æœ‰äº† MVCC ä¹‹åï¼ŒTiKV çš„ Key æ’åˆ—æ˜¯è¿™æ ·çš„ï¼š&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;&#x9;            Key1-Version3 -&amp;gt; Value&#xA;&#x9;            Key1-Version2 -&amp;gt; Value&#xA;&#x9;            Key1-Version1 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&#x9;            Key2-Version4 -&amp;gt; Value&#xA;&#x9;            Key2-Version3 -&amp;gt; Value&#xA;&#x9;            Key2-Version2 -&amp;gt; Value&#xA;&#x9;            Key2-Version1 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&#x9;            KeyN-Version2 -&amp;gt; Value&#xA;&#x9;            KeyN-Version1 -&amp;gt; Value&#xA;&#x9;            â€¦â€¦&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;æ³¨æ„ï¼Œå¯¹äºåŒä¸€ä¸ª Key çš„å¤šä¸ªç‰ˆæœ¬ï¼Œæˆ‘ä»¬æŠŠç‰ˆæœ¬å·è¾ƒå¤§çš„æ”¾åœ¨å‰é¢ï¼Œç‰ˆæœ¬å·å°çš„æ”¾åœ¨åé¢ï¼Œè¿™æ ·å½“ç”¨æˆ·é€šè¿‡ä¸€ä¸ª Key + Version æ¥è·å– Value çš„æ—¶å€™ï¼Œå¯ä»¥å°† Key å’Œ Version æ„é€ å‡º MVCC çš„ Keyï¼Œä¹Ÿå°±æ˜¯ Key-Versionã€‚ç„¶åå¯ä»¥ç›´æ¥ Seek(Key-Version)ï¼Œå®šä½åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºè¿™ä¸ª Key-Version çš„ä½ç½®ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ­¤å¤„ copy è‡ªç”³æ å“¥æ–‡ç« &lt;a href=&#34;https://pingcap.com/blog-cn/tidb-internal-1/&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´å­˜å‚¨&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;ç°åœ¨ä»ä»£ç çœ‹èµ·ï¼š&lt;/p&gt;&#xA;&lt;p&gt;æˆ‘ä»¬æ¥çœ‹ TiKV çš„ Storage pkgï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ª pkg é‡Œé¢æœ‰ä¸ª MVCC pkgï¼Œæ²¡é”™å…·ä½“çš„ MVCC æ“ä½œå®ç°å°±æ˜¯å®šä¹‰åœ¨ MVCC è¿™ä¸ª pkg é‡Œé¢ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;-storage&#34;&gt;å…ˆçœ‹ Storage&lt;/h3&gt;&#xA;&lt;pre&gt;&lt;code&gt;pub struct Storage {&#xA;    engine: Box&amp;lt;Engine&amp;gt;,&#xA;    sendch: SyncSendCh&amp;lt;Msg&amp;gt;,&#xA;    handle: Arc&amp;lt;Mutex&amp;lt;StorageHandle&amp;gt;&amp;gt;,&#xA;    ...&#xA;}&#xA;impl Storage {&#xA; pub fn start(&amp;amp;mut self, config: &amp;amp;Config) -&amp;gt; Result&amp;lt;()&amp;gt; {&#xA;        let mut handle = self.handle.lock().unwrap();&#xA;        if handle.handle.is_some() {&#xA;            return Err(box_err!(&amp;quot;scheduler is already running&amp;quot;));&#xA;        }&#xA;&#xA;        let engine = self.engine.clone();&#xA;        let builder = thread::Builder::new().name(thd_name!(&amp;quot;storage-scheduler&amp;quot;));&#xA;        let rx = handle.receiver.take().unwrap();&#xA;        let sched_concurrency = config.scheduler_concurrency;&#xA;        let sched_worker_pool_size = config.scheduler_worker_pool_size;&#xA;        let sched_pending_write_threshold = config.scheduler_pending_write_threshold.0 as usize;&#xA;        let ch = self.sendch.clone();&#xA;        let h = builder.spawn(move || {&#xA;            let mut sched = Scheduler::new(&#xA;                engine,&#xA;                ch,&#xA;                sched_concurrency,&#xA;                sched_worker_pool_size,&#xA;                sched_pending_write_threshold,&#xA;            );&#xA;            if let Err(e) = sched.run(rx) {&#xA;                panic!(&amp;quot;scheduler run err:{:?}&amp;quot;, e);&#xA;            }&#xA;            info!(&amp;quot;scheduler stopped&amp;quot;);&#xA;        })?;&#xA;        handle.handle = Some(h);&#xA;&#xA;        Ok(())&#xA;    }&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å…¶å® Storage æ˜¯å®é™…æ¥å—å¤–éƒ¨æŒ‡ä»¤, Storage å†…åŒ…å«ä¸‰ä¸ªå­—æ®µï¼š&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Engineï¼Œæ•°æ®åº“æ“ä½œçš„æ¥å£ï¼Œraftkv ä»¥åŠ rocksdb å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°å¯ä»¥çœ‹ engine/raftkv.rs, engine/rocksdb.rs&lt;/li&gt;&#xA;&lt;li&gt;SyncSendCh, ä¸€ä¸ª channel å†…éƒ¨ç±»å‹æ˜¯ Msg, ç”¨æ¥å­˜å‚¨ scheduler event çš„ channel&lt;/li&gt;&#xA;&lt;li&gt;StorageHanle, æ˜¯å¤„ç†ä»sench æ¥å—åˆ°æŒ‡ä»¤ï¼Œé€šè¿‡ mio æ¥å¤„ç† IO&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ° Storage æœ€åå¯åŠ¨äº†è°ƒåº¦å™¨ï¼Œç„¶åä¸æ–­çš„æ¥å—å®¢æˆ·ç«¯æŒ‡ä»¤ï¼Œç„¶ååœ¨ä¼ ç»™ scheduler, ç„¶åè°ƒåº¦å™¨æ‰§è¡Œç›¸åº”çš„è¿‡ç¨‹æˆ–è€…è°ƒç”¨ç›¸åº”çš„å¼‚æ­¥å‡½æ•°ã€‚åœ¨è°ƒåº¦å™¨ä¸­æœ‰ä¸¤ç§æ“ä½œç±»å‹ï¼Œè¯»å’Œå†™ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;mvcc-mvccreader&#34;&gt;MVCC MVCCReader&lt;/h3&gt;&#xA;&lt;pre&gt;&lt;code&gt;pub struct MVCCReader {&#xA; ....&#xA;}&#xA;&#xA;impl MVCCReader{&#xA;    pub fn new() {...};&#xA;    pub fn get_statistics(&amp;amp;self) -&amp;gt; &amp;amp;Statistics {...}&#xA;    pub fn set_key_only(&amp;amp;mut self, key_only: bool) {...}&#xA;    pub fn load_data(&amp;amp;mut self, key: &amp;amp;Key, ts: u64) -&amp;gt; Result&amp;lt;Value&amp;gt; {...}&#xA;    pub fn load_lock(&amp;amp;mut self, key: &amp;amp;Key) -&amp;gt; Result&amp;lt;Option&amp;lt;Lock&amp;gt;&amp;gt; {...}&#xA;    pub fn get(&amp;amp;mut self, key: &amp;amp;Key, mut ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;Value&amp;gt;&amp;gt; {...}&#xA;    pub fn get_txn_commit_info(&#xA;        &amp;amp;mut self,&#xA;        key: &amp;amp;Key,&#xA;        start_ts: u64,&#xA;    ) -&amp;gt; Result&amp;lt;Option&amp;lt;(u64, WriteType)&amp;gt;&amp;gt; {...}&#xA;    pub fn seek_ts(&amp;amp;mut self, ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;Key&amp;gt;&amp;gt; {...}&#xA;    pub fn seek(&amp;amp;mut self, mut key: Key, ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;(Key, Value)&amp;gt;&amp;gt; {...}&#xA;    pub fn reverse_seek(&amp;amp;mut self, mut key: Key, ts: u64) -&amp;gt; Result&amp;lt;Option&amp;lt;(Key, Value)&amp;gt;&amp;gt; {...}&#xA;    ...&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;çœ‹ MVCCReader ç»“æ„å¾ˆå®¹æ˜“ç†è§£ï¼Œå„ç§è¯»çš„æ“ä½œã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;mvcctxn&#34;&gt;MVCCTxn&lt;/h3&gt;&#xA;&lt;pre&gt;&lt;code&gt;pub struct MVCCTxn {&#xA;    reader: MVCCReader,&#xA;    start_ts: u64,&#xA;    writes: Vec&amp;lt;Modify&amp;gt;,&#xA;    write_size: usize,&#xA;}&#xA;impl MVCCTxn {&#xA;    pub fn prewrite(&#xA;        &amp;amp;mut self,&#xA;        mutation: Mutation,&#xA;        primary: &amp;amp;[u8],&#xA;        options: &amp;amp;Options,&#xA;    ) -&amp;gt; Result&amp;lt;()&amp;gt; {...}&#xA;&#xA;    pub fn commit(&amp;amp;mut self, key: &amp;amp;Key, commit_ts: u64) -&amp;gt; Result&amp;lt;()&amp;gt; {...}&#xA;    pub fn rollback(&amp;amp;mut self, key: &amp;amp;Key) -&amp;gt; Result&amp;lt;()&amp;gt; {...}&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;MVCCTxn å®ç°äº†ä¸¤æ®µæäº¤ï¼ˆ2-Phase Commitï¼Œ2PCï¼‰ï¼Œæ•´ä¸ª TiKV äº‹åŠ¡æ¨¡å‹çš„æ ¸å¿ƒã€‚åœ¨ä¸€æ®µäº‹åŠ¡ä¸­ï¼Œç”±ä¸¤ä¸ªé˜¶æ®µç»„æˆã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Prewrite&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;é€‰æ‹©ä¸€ä¸ª row ä½œä¸º primary rowï¼Œ ä½™ä¸‹çš„ä½œä¸º secondary rowã€‚ å¯¹primary row ä¸Šé”. åœ¨ä¸Šé”ä¹‹å‰ï¼Œä¼šæ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–åŒæ­¥çš„é”å·²ç»ä¸Šåˆ°äº†è¿™ä¸ª row ä¸Š æˆ–è€…æ˜¯æ˜¯å¦ç»æœ‰åœ¨ startTS ä¹‹åçš„æäº¤æ“ä½œã€‚è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´å†²çªï¼Œä¸€æ—¦éƒ½å†²çªå‘ç”Ÿï¼Œå°±ä¼šå›æ»šï¼ˆrollbackï¼‰ã€‚ å¯¹äº secondary row é‡å¤ä»¥ä¸Šæ“ä½œã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Commit&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;Rollback åœ¨Prewrite è¿‡ç¨‹ä¸­å‡ºç°å†²çªçš„è¯å°±ä¼šè¢«è°ƒç”¨ã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Garbage Collector&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;å¾ˆå®¹æ˜“å‘ç°ï¼Œå¦‚æœæ²¡æœ‰åƒåœ¾æ”¶é›†å™¨ï¼ˆGabage Collectorï¼‰ æ¥ç§»é™¤æ— æ•ˆçš„ç‰ˆæœ¬çš„è¯ï¼Œæ•°æ®åº“ä¸­å°±ä¼šå­˜æœ‰è¶Šæ¥è¶Šå¤šçš„ MVCC ç‰ˆæœ¬ã€‚ä½†æ˜¯æˆ‘ä»¬åˆä¸èƒ½ä»…ä»…ç§»é™¤æŸä¸ª safe point ä¹‹å‰çš„æ‰€æœ‰ç‰ˆæœ¬ã€‚å› ä¸ºå¯¹äºæŸä¸ª key æ¥è¯´ï¼Œæœ‰å¯èƒ½åªå­˜åœ¨ä¸€ä¸ªç‰ˆæœ¬ï¼Œé‚£ä¹ˆè¿™ä¸ªç‰ˆæœ¬å°±å¿…é¡»è¢«ä¿å­˜ä¸‹æ¥ã€‚åœ¨TiKVä¸­ï¼Œå¦‚æœåœ¨ safe point å‰å­˜åœ¨Put æˆ–è€…Deleteï¼Œé‚£ä¹ˆè¯´æ˜ä¹‹åæ‰€æœ‰çš„ writes éƒ½æ˜¯å¯ä»¥è¢«ç§»é™¤çš„ï¼Œä¸ç„¶çš„è¯åªæœ‰Deleteï¼ŒRollbackå’ŒLock ä¼šè¢«åˆ é™¤ã€‚&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;æ­¤å¤„éƒ¨åˆ† copy è‡ª&lt;a href=&#34;https://pingcap.com/blog-cn/MVCC-in-TiKV/&#34;&gt;TiKV çš„ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰æœºåˆ¶&lt;/a&gt;&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h2 id=&#34;heading-5&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Two-phase_locking&#34;&gt;Two-phase locking&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://www.zhihu.com/question/60278698&#34;&gt;OCCå’ŒMVCCçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/tidb-internal-1/&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è¯´å­˜å‚¨&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-cn/MVCC-in-TiKV/&#34;&gt;TiKV çš„ MVCCï¼ˆMulti-Version Concurrency Controlï¼‰æœºåˆ¶&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>Spanner è®ºæ–‡ç¬”è®°</title>
    <updated>2017-11-05T00:00:00Z</updated>
    <id>tag:int64.me,2017-11-05:/2017/Spanner è®ºæ–‡ç¬”è®°.html</id>
    <link href="http://int64.me/2017/Spanner è®ºæ–‡ç¬”è®°.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;åˆšåˆ°å…¬å¸çš„æ—¶å€™ï¼Œè®°å¾—å¥‡å“¥å°±æ¨èäº†å‡ ç¯‡åŸºç¡€è®ºæ–‡ï¼ˆå°´å°¬ï¼Œç›®å‰æˆ‘è¿˜æ²¡æœ‰å®Œå…¨çœ‹å®Œï¼‰ï¼ŒSpanner è®ºæ–‡å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ï¼ŒåŒæ—¶ TiKV çš„è®¾è®¡æ¶æ„ä¹Ÿæ˜¯å—åˆ°äº† Spanner çš„å¯å‘ï¼Œåœ¨é˜…è¯» Spanner è®ºæ–‡çš„åŒæ—¶ï¼Œè®°å½•äº›ä¸œè¥¿ï¼Œæ–¹ä¾¿ä»¥åå›é¡¾å¤ä¹ ...&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;ç»“æ„&lt;/h2&gt;&#xA;&lt;p&gt;ä¸€å¥— Spanner ç³»ç»Ÿç§°ä¸ºä¸€ä¸ª universe, Spanner è®ºæ–‡ä¸Šè¯´ç›®å‰ google æ€»å…±éƒ¨ç½²äº†ä¸‰å¥—  Spannerï¼Œä¸€ä¸ªå¼€å‘ï¼Œä¸€ä¸ªæµ‹è¯•ï¼Œä¸€ä¸ªçº¿ä¸Šã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-8d4d85a54036697f.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä¸Šå›¾æ˜¯ Spanner è®ºæ–‡ä¸Šçš„ç»“æ„å›¾ï¼Œå¯ä»¥çœ‹å‡ºSpanner æ˜¯ç”±å¤šä¸ª zone ï¼ˆç®¡ç†éƒ¨ç½²çš„åŸºæœ¬å•å…ƒï¼‰ ç»„æˆï¼Œä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸­å¯ä»¥æœ‰å¤šä¸ª zoneã€‚ ä¸€ä¸ª zone åŒ…å«ä¸€ä¸ª zonemasterå’Œä¸€ç™¾æˆ–è€…å‡ åƒä¸ª spanserverã€‚zonemaster æŠŠæ•°æ®åˆ†é…ç»™ spanserverï¼Œspanserver æŠŠæ•°æ®æä¾›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä½¿ç”¨æ²¡ä¸ª zone ä¸Šçš„ location proxy æ¥å®šä½æä¾›æœåŠ¡çš„ spanserverï¼Œspanerver æä¾›å…·ä½“çš„æœåŠ¡ã€‚ï¼ˆTiDB çš„ PD ä¸ TiKV ä¹‹é—´çš„é…åˆè¿˜çœŸæ˜¯æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™å•Šï¼‰ã€‚Universe master ä¸»è¦æ˜¯ä¸€ä¸ªæ§åˆ¶å°ï¼Œå®ƒæ˜¾ç¤ºäº†å…³äº zone çš„å„ç§çŠ¶æ€ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºç›¸äº’ä¹‹é—´çš„è°ƒè¯•ã€‚Placement driver ä¼šå‘¨æœŸæ€§åœ°ä¸ spanserver è¿›è¡Œäº¤äº’ï¼Œæ¥å‘ç°é‚£äº›éœ€è¦è¢«è½¬ç§»çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯ä¸ºäº†æ»¡è¶³æ–°çš„å‰¯æœ¬çº¦æŸæ¡ä»¶ï¼Œæˆ–è€…æ˜¯ä¸ºäº†è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;spanserver-&#34;&gt;spanserver å®ç°&lt;/h3&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-b99c0dffe8361eb9.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯ä¸ª spanserver è´Ÿè½½ç®¡ç† 100 - 1000 ä¸ªç§°ä¸º tablet çš„æ•°æ®ç»“æ„çš„å®ä¾‹ã€‚ä¸€ä¸ª tablet å°±ç±»ä¼¼äº BigTable ä¸­çš„ tabletï¼Œä¹Ÿå®ç°äº†ä¸‹é¢çš„æ˜ å°„: &lt;code&gt;(key:string, timestamp:int64)-&amp;gt;string&lt;/code&gt; ã€‚&lt;/p&gt;&#xA;&lt;p&gt;spanserver ä¸åŒäº bigtable çš„åœ°æ–¹åœ¨äºï¼Œspanserver å…¶å®æ›´åƒä¸€ä¸ªå®Œæ•´å…³ç³»æ•°æ®åº“ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªçº¯ç²¹çš„é”®å€¼å­˜å‚¨ï¼Œspanserver ä¼šä¸ºæ¯ä¸€ä¸ªæ•°æ®åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ï¼ˆæœ‰ç‚¹ç±»ä¼¼ MVCCï¼‰ï¼Œtablet çš„çŠ¶æ€å­˜å‚¨åœ¨ç±»ä¼¼äº B-æ ‘çš„æ–‡ä»¶é›†åˆä»¥åŠ WALï¼ˆwrite-ahead-log)ä¸­ï¼Œå¹¶ä¸”éƒ½å­˜æ”¾åœ¨ GFS çš„å‡çº§ç‰ˆ Colossus æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šã€‚ï¼ˆæ„Ÿè§‰ç»“æ„æœ‰ç‚¹å¤æ‚å•Šï¼Œä¹Ÿå¯èƒ½æ˜¯æˆ‘å…ˆäº†è§£äº† TiKV çš„è®¾è®¡ï¼Œæœ‰ç‚¹å…ˆå…¥ä¸ºä¸»äº†ï¼‰ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å†è¯´ tablet çš„ä¸Šå±‚ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯ç”¨ Paxos çŠ¶æ€æœºæ¥åšå‰¯æœ¬ç®¡ç†ï¼ˆPaxos ç®—é¥­æ²¡æœ‰ä»”ç»†ç ”ç©¶è¿‡ï¼Œé’¥åŒ™åˆåœ°æ–¹æè¿°çš„æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£ï¼‰ã€‚è®ºæ–‡é‡Œé¢è®²åˆ°ï¼Œç›®å‰æ¯ä¸ª tablet ä¸Šå®ç°äº†ä¸€ä¸ª Paxos çŠ¶æ€æœºï¼Œæ¯æ¬¡å†™æ“ä½œçš„æ—¶å€™éƒ½éœ€è¦å†™ä¸¤ä»½æ•°æ®ï¼Œä¸€ä»½è½åˆ° tablet çš„æ—¥å¿—ä¸­ï¼Œä¸€ä»½æ˜¯å†™å…¥ï¼ŒPaxos çš„æ—¥å¿—ä¸­ï¼Œç›®å‰Paxos çš„ leader å®ç°äº†æ”¯æŒé•¿å¯¿å‘½çš„ leader ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä½¿ç”¨äº†ç§Ÿçº¦çš„æœºåˆ¶ï¼ˆlease TiKV ä¸­ Raft leader ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚å†™æ“ä½œå¿…é¡»åœ¨é¢†å¯¼è€…ä¸Šåˆå§‹åŒ– Paxos åè®®ï¼Œè¯»æ“ä½œå¯ä»¥ç›´æ¥ä»åº•å±‚çš„ä»»ä½•å‰¯æœ¬çš„ tablet ä¸­è®¿é—®çŠ¶æ€ä¿¡æ¯ï¼Œåªè¦è¿™ä¸ªå‰¯æœ¬è¶³å¤Ÿæ–°ã€‚å‰¯æœ¬çš„é›†åˆè¢«ç§°ä¸ºä¸€ä¸ª Paxos groupã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºæ¯ä¸ªæ˜¯é¢†å¯¼è€…çš„å‰¯æœ¬è€Œè¨€ï¼Œæ¯ä¸ª spanserver ä¼šå®ç°ä¸€ä¸ªé”è¡¨æ¥å®ç°å¹¶å‘æ§åˆ¶ã€‚è¿™ä¸ªé”è¡¨åŒ…å«äº†ä¸¤é˜¶æ®µé”æœºåˆ¶çš„çŠ¶æ€:å®ƒæŠŠé”®çš„å€¼åŸŸæ˜ å°„åˆ°é”çŠ¶æ€ä¸Šé¢ã€‚æ³¨æ„ï¼Œé‡‡ç”¨ä¸€ä¸ªé•¿å¯¿å‘½çš„ Paxos é¢†å¯¼è€…ï¼Œå¯¹äºæœ‰æ•ˆç®¡ç†é”è¡¨è€Œè¨€æ˜¯éå¸¸å…³é”®çš„ã€‚åœ¨ BigTable å’Œ Spanner ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¸“é—¨ä¸ºé•¿äº‹åŠ¡åšäº†è®¾è®¡ï¼Œæ¯”å¦‚ï¼Œå¯¹äºæŠ¥è¡¨æ“ä½œï¼Œå¯èƒ½è¦æŒç»­å‡ åˆ†é’Ÿï¼Œå½“å­˜åœ¨å†²çªæ—¶ï¼Œé‡‡ç”¨ä¹è§‚å¹¶å‘æ§åˆ¶æœºåˆ¶ä¼šè¡¨ç°å‡ºå¾ˆå·®çš„æ€§èƒ½ã€‚å¯¹äºé‚£äº›éœ€è¦åŒæ­¥çš„æ“ä½œï¼Œæ¯”å¦‚äº‹åŠ¡å‹çš„è¯»æ“ä½œï¼Œéœ€è¦è·å¾—é”è¡¨ä¸­çš„é”ï¼Œè€Œå…¶ä»–ç±»å‹çš„æ“ä½œåˆ™å¯ä»¥ä¸ç†ä¼šé”è¡¨ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºæ¯ä¸ªæ‰®æ¼”é¢†å¯¼è€…è§’è‰²çš„å‰¯æœ¬ï¼Œæ¯ä¸ª spanserver ä¹Ÿä¼šå®æ–½ä¸€ä¸ªäº‹åŠ¡ç®¡ç†å™¨æ¥æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ã€‚è¿™ä¸ªäº‹åŠ¡ç®¡ç†å™¨è¢«ç”¨æ¥å®ç°ä¸€ä¸ª participant leaderï¼Œè¯¥ç»„å†…çš„å…¶ä»–å‰¯æœ¬åˆ™æ˜¯ä½œä¸º participant slavesã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åªåŒ…å«ä¸€ä¸ª Paxos ç»„(å¯¹äºè®¸å¤šäº‹åŠ¡è€Œè¨€éƒ½æ˜¯å¦‚æ­¤)ï¼Œå®ƒå°±å¯ä»¥ç»•è¿‡äº‹åŠ¡ç®¡ç†å™¨ï¼Œå› ä¸ºé”è¡¨å’Œ Paxos äºŒè€…ä¸€èµ·å¯ä»¥ä¿è¯äº‹åŠ¡æ€§ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡åŒ…å«äº†å¤š äºä¸€ä¸ª Paxos ç»„ï¼Œé‚£äº›ç»„çš„é¢†å¯¼è€…ä¹‹é—´ä¼šå½¼æ­¤åè°ƒåˆä½œå®Œæˆä¸¤é˜¶æ®µæäº¤ã€‚å…¶ä¸­ä¸€ä¸ªå‚ä¸è€…ç»„ï¼Œä¼šè¢«é€‰ä¸ºåè°ƒè€…ï¼Œè¯¥ç»„çš„ participant leader è¢«ç§°ä¸º coordinator leaderï¼Œè¯¥ç»„çš„ participant slaves è¢«ç§°ä¸º coordinator slavesã€‚æ¯ä¸ªäº‹åŠ¡ç®¡ç†å™¨çš„çŠ¶æ€ï¼Œä¼šè¢«ä¿å­˜åˆ°åº•å±‚çš„ Paxos ç»„ã€‚ç›®å‰ TiKV çš„äº‹åŠ¡å¥½åƒéƒ½èµ°çš„æ˜¯ä¸¤é˜¶æ®µæäº¤ï¼Œä¸çŸ¥åˆ°è¦æ˜¯ä¹Ÿæä¸ªäº‹åŠ¡ç®¡ç†å™¨æ•ˆæœä¼šå¦‚ä½•ï¼Ÿ&lt;/p&gt;&#xA;&lt;h3 id=&#34;directory&#34;&gt;directory&lt;/h3&gt;&#xA;&lt;p&gt;Spanner å¯¹å…·æœ‰å…¬å…±å‰ç¼€çš„é”®åšäº†ä¸€ä¸ªæŠ½è±¡ï¼Œç§°ä¸º directoryã€‚ç›®å‰ä¸€ä¸ª directory æ˜¯æ•°æ®å­˜æ”¾çš„åŸºæœ¬å•ä½ã€‚ã€‚å±äºä¸€ä¸ªç›®å½•çš„æ‰€æœ‰æ•°æ®ï¼Œéƒ½å…·æœ‰ç›¸åŒçš„å‰¯æœ¬é…ç½®ã€‚ å½“æ•°æ®åœ¨ä¸åŒçš„ Paxos ç»„ä¹‹é—´è¿›è¡Œç§»åŠ¨æ—¶ï¼Œä¼šä¸€ä¸ªç›®å½•ä¸€ä¸ªç›®å½•åœ°è½¬ç§»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚Spanner å¯èƒ½ä¼šç§»åŠ¨ä¸€ä¸ªç›®å½•ä»è€Œå‡è½»ä¸€ä¸ª Paxos ç»„çš„è´Ÿæ‹…ï¼Œä¹Ÿå¯èƒ½ä¼šæŠŠé‚£äº›è¢«é¢‘ç¹åœ°ä¸€èµ·è®¿é—®çš„ç›®å½•éƒ½æ”¾ç½®åˆ°åŒä¸€ä¸ªç»„ä¸­ï¼Œæˆ–è€…ä¼šæŠŠä¸€ä¸ªç›®å½•è½¬ç§»åˆ°è·ç¦»è®¿é—®è€…æ›´è¿‘çš„åœ°æ–¹ã€‚å½“å®¢æˆ·ç«¯æ“ä½œæ­£åœ¨è¿›è¡Œæ—¶ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç›®å½•çš„è½¬ç§»ã€‚æˆ‘ä»¬å¯ä»¥é¢„æœŸåœ¨å‡ ç§’å†…è½¬ç§» 50MB çš„ç›®å½•ã€‚&lt;/p&gt;&#xA;&lt;p&gt;directory æ˜¯æ•°æ®å¤åˆ¶å’Œplacementé…ç½®çš„åŸºæœ¬å•ä½ã€‚spannerä¸­è´Ÿè½½å‡è¡¡çš„æœ€å°å•ä½ä¹Ÿæ˜¯ directoryï¼ŒåŒæ—¶æä¾›æ–¹æ³• MoveDir å¯ä»¥æ‰‹åŠ¨å°†ä¸€ä¸ª directory ç§»åŠ¨åˆ°æŒ‡å®šçš„zone&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-192ba58099b34f11.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-1&#34;&gt;æ•°æ®æ¨¡å‹&lt;/h2&gt;&#xA;&lt;p&gt;spannerçš„è¡Œæ¨¡å‹æ˜¯ &lt;code&gt;(key:string, timestamp:int64) -&amp;gt; row content&lt;/code&gt;ï¼Œå¯ä»¥çœ‹åˆ°è·Ÿbig tableçš„æ¨¡å‹æœ€å¤§çš„ä¸åŒæ˜¯è¿™é‡Œå¼ºåŒ–äº†rowçš„æ¦‚å¿µï¼Œä¸å†çªå‡ºcolumnï¼›è¿™æ ·spannerçš„timestampæ˜¯èµ‹ç»™æ•´è¡Œæ•°æ®çš„ï¼Œæ˜¯æœ‰ç‰©ç†æ„ä¹‰çš„ï¼Œè¿™ä½¿å¾—spanneræ›´åƒä¸€ä¸ªå®ç°å¤šç‰ˆæœ¬å¹¶å‘çš„æ•°æ®åº“ï¼Œè€Œåœ¨big tableä¸­ï¼Œtimestampä»…ä»…ç”¨äºä¿å­˜å¤šä¸ªç‰ˆæœ¬çš„key-valueï¼Œè·Ÿå¹¶å‘å®Œå…¨æ— å…³ï¼›æˆ‘è§‰å¾—è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆspannerç§°è‡ªå·±ä¸ºsemi-relational æ•°æ®åº“ï¼Œè€Œbig tableåªç§°è‡ªå·±æ˜¯semi-structure æ•°æ®åº“çš„åŸå› ã€‚&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-c784a00321761682.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;Spanner çš„æ•°æ®æ¨¡å‹ä¸æ˜¯çº¯ç²¹å…³ç³»å‹çš„ï¼Œå®ƒçš„è¡Œå¿…é¡»æœ‰åç§°ã€‚æ›´å‡†ç¡®åœ°è¯´ï¼Œæ¯ä¸ªè¡¨éƒ½éœ€ è¦æœ‰åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä¸»é”®åˆ—çš„æ’åºé›†åˆã€‚è¿™ç§éœ€æ±‚ï¼Œè®© Spanner çœ‹èµ·æ¥ä»ç„¶æœ‰ç‚¹åƒé”®å€¼å­˜å‚¨: ä¸»é”®å½¢æˆäº†ä¸€ä¸ªè¡Œçš„åç§°ï¼Œæ¯ä¸ªè¡¨éƒ½å®šä¹‰äº†ä»ä¸»é”®åˆ—åˆ°éä¸»é”®åˆ—çš„æ˜ å°„ã€‚å½“ä¸€ä¸ªè¡Œå­˜åœ¨æ—¶ï¼Œå¿…é¡»è¦æ±‚å·²ç»ç»™è¡Œçš„ä¸€äº›é”®å®šä¹‰äº†ä¸€äº›å€¼(å³ä½¿æ˜¯ NULL)ã€‚é‡‡ç”¨è¿™ç§ç»“æ„æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºè¿™å¯ä»¥è®©åº”ç”¨é€šè¿‡é€‰æ‹©é”®æ¥æ§åˆ¶æ•°æ®çš„å±€éƒ¨æ€§ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;truetime-api&#34;&gt;TrueTime API&lt;/h3&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-d1557f77c3323255.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;rueTime API æ˜¯ä¸€ä¸ªéå¸¸æœ‰åˆ›æ„çš„ä¸œè¥¿ï¼Œå¯ä»¥åŒæ­¥å…¨çƒçš„æ—¶é—´ã€‚TT.now()å¯ä»¥è·å¾—ä¸€ä¸ªç»å¯¹æ—¶é—´TTintervalï¼Œè¿™ä¸ªå€¼å’ŒUnixTimeæ˜¯ç›¸åŒçš„ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿå¾—åˆ°ä¸€ä¸ªè¯¯å·®eã€‚TT.after(t)å’ŒTT.before(t)æ˜¯åŸºäºTT.now()å®ç°çš„ã€‚é‚£è¿™ä¸ªTrueTime APIå®ç°é çš„æ˜¯GFSå’ŒåŸå­é’Ÿã€‚ä¹‹æ‰€ä»¥è¦ç”¨ä¸¤ç§æŠ€æœ¯æ¥å¤„ç†ï¼Œæ˜¯å› ä¸ºå¯¼è‡´è¿™ä¸¤ä¸ªæŠ€æœ¯çš„å¤±è´¥çš„åŸå› æ˜¯ä¸åŒçš„ã€‚GPSä¼šæœ‰ä¸€ä¸ªå¤©çº¿ï¼Œç”µæ³¢å¹²æ‰°ä¼šå¯¼è‡´å…¶å¤±çµã€‚åŸå­é’Ÿå¾ˆç¨³å®šã€‚å½“GPSå¤±çµçš„æ—¶å€™ï¼ŒåŸå­é’Ÿä»ç„¶èƒ½ä¿è¯åœ¨ç›¸å½“é•¿çš„æ—¶é—´å†…ï¼Œä¸ä¼šå‡ºç°åå·®ã€‚å®é™…éƒ¨ç½²çš„æ—¶å€™ã€‚æ¯ä¸ªæ•°æ®ä¸­å¿ƒéœ€è¦éƒ¨ç½²ä¸€äº›Masteræœºå™¨ï¼Œå…¶ä»–æœºå™¨ä¸Šéœ€è¦æœ‰ä¸€ä¸ªslaveè¿›ç¨‹æ¥ä»MasteråŒæ­¥ã€‚æœ‰çš„Masterç”¨GPSï¼Œæœ‰çš„Masterç”¨åŸå­é’Ÿã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-2&#34;&gt;å¹¶å‘æ§åˆ¶&lt;/h2&gt;&#xA;&lt;p&gt;Spannerä½¿ç”¨TrueTimeæ¥æ§åˆ¶å¹¶å‘ï¼Œå®ç°å¤–éƒ¨ä¸€è‡´æ€§ã€‚æ”¯æŒä»¥ä¸‹å‡ ç§äº‹åŠ¡ã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;è¯»å†™äº‹åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;åªè¯»äº‹åŠ¡&lt;/li&gt;&#xA;&lt;li&gt;å¿«ç…§è¯»ï¼Œå®¢æˆ·ç«¯æä¾›æ—¶é—´æˆ³&lt;/li&gt;&#xA;&lt;li&gt;å¿«ç…§è¯»ï¼Œå®¢æˆ·ç«¯æä¾›æ—¶é—´èŒƒå›´&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-91fa02b85deaedff.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;p&gt;ä¸Šè¡¨æ˜¯Spannerç°åœ¨æ”¯æŒçš„äº‹åŠ¡ã€‚å•ç‹¬çš„å†™æ“ä½œéƒ½è¢«å®ç°ä¸ºè¯»å†™äº‹åŠ¡ ï¼› å•ç‹¬çš„éå¿«ç…§è¢«å®ç°ä¸ºåªè¯»äº‹åŠ¡ã€‚äº‹åŠ¡æ€»æœ‰å¤±è´¥çš„æ—¶å€™ï¼Œå¦‚æœå¤±è´¥ï¼Œå¯¹äºè¿™ä¸¤ç§æ“ä½œä¼šè‡ªå·±é‡è¯•ï¼Œæ— éœ€åº”ç”¨è‡ªå·±å®ç°é‡è¯•å¾ªç¯ã€‚&lt;/p&gt;&#xA;&lt;p&gt;æ—¶é—´æˆ³çš„è®¾è®¡å¤§å¤§æé«˜äº†åªè¯»äº‹åŠ¡çš„æ€§èƒ½ã€‚äº‹åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œè¦å£°æ˜è¿™ä¸ªäº‹åŠ¡é‡Œæ²¡æœ‰å†™æ“ä½œï¼Œåªè¯»äº‹åŠ¡å¯ä¸æ˜¯ä¸€ä¸ªç®€å•çš„æ²¡æœ‰å†™æ“ä½œçš„è¯»å†™äº‹åŠ¡ã€‚å®ƒä¼šç”¨ä¸€ä¸ªç³»ç»Ÿæ—¶é—´æˆ³å»è¯»ï¼Œæ‰€ä»¥å¯¹äºåŒæ—¶çš„å…¶ä»–çš„å†™æ“ä½œæ˜¯æ²¡æœ‰Blockçš„ã€‚è€Œä¸”åªè¯»äº‹åŠ¡å¯ä»¥åœ¨ä»»æ„ä¸€å°å·²ç»æ›´æ–°è¿‡çš„replicaä¸Šé¢è¯»ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¯¹äºå¿«ç…§è¯»æ“ä½œï¼Œå¯ä»¥è¯»å–ä»¥å‰çš„æ•°æ®ï¼Œéœ€è¦å®¢æˆ·ç«¯æŒ‡å®šä¸€ä¸ªæ—¶é—´æˆ³æˆ–è€…ä¸€ä¸ªæ—¶é—´èŒƒå›´ã€‚Spannerä¼šæ‰¾åˆ°ä¸€ä¸ªå·²ç»å……åˆ†æ›´æ–°å¥½çš„replicaä¸Šè¯»å–ã€‚&lt;/p&gt;&#xA;&lt;p&gt;è¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§çš„æ˜¯ï¼Œå¯¹äºåªè¯»äº‹åŠ¡ï¼Œå¦‚æœæ‰§è¡Œåˆ°ä¸€åŠï¼Œè¯¥replicaå‡ºç°äº†é”™è¯¯ã€‚å®¢æˆ·ç«¯æ²¡æœ‰å¿…è¦åœ¨æœ¬åœ°ç¼“å­˜åˆšåˆšè¯»è¿‡çš„æ—¶é—´ï¼Œå› ä¸ºæ˜¯æ ¹æ®æ—¶é—´æˆ³è¯»å–çš„ã€‚åªè¦å†ç”¨åˆšåˆšçš„æ—¶é—´æˆ³è¯»å–ï¼Œå°±å¯ä»¥è·å¾—ä¸€æ ·çš„ç»“æœã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;paxos-&#34;&gt;Paxos é¢†å¯¼è€…ç§Ÿçº¦&lt;/h3&gt;&#xA;&lt;p&gt;Spanner çš„ Paxos å®ç°ä¸­ä½¿ç”¨äº†æ—¶é—´åŒ–çš„ç§Ÿçº¦ï¼Œæ¥å®ç°é•¿æ—¶é—´çš„é¢†å¯¼è€…åœ°ä½(é»˜è®¤æ˜¯ 10ç§’)ã€‚ä¸€ä¸ªæ½œåœ¨çš„é¢†å¯¼è€…ä¼šå‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚æ—¶é—´åŒ–çš„ç§Ÿçº¦æŠ•ç¥¨ï¼Œåœ¨æ”¶åˆ°æŒ‡å®šæ•°é‡çš„æŠ•ç¥¨åï¼Œè¿™ä¸ªé¢†å¯¼è€…å°±å¯ä»¥ç¡®å®šè‡ªå·±æ‹¥æœ‰äº†ä¸€ä¸ªç§Ÿçº¦ã€‚ä¸€ä¸ªå‰¯æœ¬åœ¨æˆåŠŸå®Œæˆä¸€ä¸ªå†™æ“ä½œåï¼Œä¼šéšå¼åœ°å»¶æœŸè‡ªå·±çš„ç§Ÿçº¦ã€‚å¯¹äºä¸€ä¸ªé¢†å¯¼è€…è€Œè¨€ï¼Œå¦‚æœå®ƒçš„ç§Ÿçº¦å¿«è¦åˆ°æœŸäº†ï¼Œå°±è¦æ˜¾ç¤ºåœ°è¯·æ±‚ç§Ÿçº¦å»¶æœŸã€‚å¦ä¸€ä¸ªé¢†å¯¼è€…çš„ç§Ÿçº¦æœ‰ä¸ªæ—¶é—´åŒºé—´ï¼Œè¿™ä¸ªæ—¶é—´åŒºé—´çš„èµ·ç‚¹å°±æ˜¯è¿™ä¸ªé¢†å¯¼è€…è·å¾—æŒ‡å®šæ•°é‡çš„æŠ•ç¥¨é‚£ä¸€åˆ»ï¼Œæ—¶é—´åŒºé—´çš„ç»ˆç‚¹å°±æ˜¯è¿™ä¸ªé¢†å¯¼è€…å¤±å»æŒ‡å®šæ•°é‡çš„æŠ•ç¥¨çš„é‚£ä¸€åˆ»(å› ä¸ºæœ‰äº›æŠ•ç¥¨å·²ç»è¿‡æœŸäº†)ã€‚Spanner ä¾èµ–äºä¸‹é¢è¿™äº›â€œä¸è¿è´¯æ€§â€:å¯¹äºæ¯ä¸ª Paxos ç»„ï¼Œæ¯ä¸ª Paxos é¢† å¯¼è€…çš„ç§Ÿçº¦æ—¶é—´åŒºé—´ï¼Œæ˜¯å’Œå…¶ä»–é¢†å¯¼è€…çš„æ—¶é—´åŒºé—´å®Œå…¨éš”ç¦»çš„ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Spanner å®ç°å…è®¸ä¸€ä¸ª Paxos é¢†å¯¼è€…é€šè¿‡æŠŠ slave ä»ç§Ÿçº¦æŠ•ç¥¨ä¸­é‡Šæ”¾å‡ºæ¥è¿™ç§æ–¹å¼ï¼Œå®ç°é¢†å¯¼è€…çš„é€€ä½ã€‚ä¸ºäº†ä¿æŒè¿™ç§å½¼æ­¤éš”ç¦»çš„ä¸è¿è´¯æ€§ï¼ŒSpanner ä¼šå¯¹ä»€ä¹ˆæ—¶å€™é€€ä½åšå‡ºé™åˆ¶ã€‚æŠŠ smax å®šä¹‰ä¸ºä¸€ä¸ªé¢†å¯¼è€…å¯ä»¥ä½¿ç”¨çš„æœ€å¤§çš„æ—¶é—´æˆ³ã€‚åœ¨é€€ä½ä¹‹å‰ï¼Œä¸€ä¸ªé¢†å¯¼è€…å¿…é¡»ç­‰åˆ° TT.after(smax)æ˜¯çœŸã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-3&#34;&gt;ä¸ºè¯»å†™äº‹åŠ¡åˆ†é…æ—¶é—´æˆ³&lt;/h3&gt;&#xA;&lt;p&gt;äº‹åŠ¡è¯»å’Œå†™é‡‡ç”¨ä¸¤æ®µé”åè®®ã€‚å½“æ‰€æœ‰çš„é”éƒ½å·²ç»è·å¾—ä»¥åï¼Œåœ¨ä»»ä½•é”è¢«é‡Šæ”¾ä¹‹å‰ï¼Œå°±å¯ä»¥ç»™äº‹åŠ¡åˆ†é…æ—¶é—´æˆ³ã€‚å¯¹äºä¸€ä¸ªç»™å®šçš„äº‹åŠ¡ï¼ŒSpanner ä¼šä¸ºäº‹åŠ¡åˆ†é…æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³æ˜¯ Paxos åˆ†é…ç»™ Paxos å†™æ“ä½œçš„ï¼Œå®ƒä»£è¡¨äº†äº‹åŠ¡æäº¤çš„æ—¶é—´ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Spanner ä¾èµ–ä¸‹é¢è¿™äº›å•è°ƒæ€§:åœ¨æ¯ä¸ª Paxos ç»„å†…ï¼ŒSpanner ä¼šä»¥å•è°ƒå¢åŠ çš„é¡ºåºç»™æ¯ä¸ª Paxos å†™æ“ä½œåˆ†é…æ—¶é—´æˆ³ï¼Œå³ä½¿åœ¨è·¨è¶Šå¤šä¸ªé¢†å¯¼è€…æ—¶ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸€ä¸ªå•ä¸ªçš„é¢†å¯¼è€…å‰¯æœ¬ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°ä»¥å•è°ƒå¢åŠ çš„æ–¹å¼åˆ†é…æ—¶é—´æˆ³ã€‚åœ¨å¤šä¸ªé¢†å¯¼è€…ä¹‹é—´å°±ä¼šå¼ºåˆ¶å®ç°å½¼æ­¤éš”ç¦»çš„ä¸è¿ è´¯:ä¸€ä¸ªé¢†å¯¼è€…å¿…é¡»åªèƒ½åˆ†é…å±äºå®ƒè‡ªå·±ç§Ÿçº¦æ—¶é—´åŒºé—´å†…çš„æ—¶é—´æˆ³ã€‚è¦æ³¨æ„åˆ°ï¼Œä¸€æ—¦ä¸€ä¸ªæ—¶é—´æˆ³ s è¢«åˆ†é…ï¼Œsmax å°±ä¼šè¢«å¢åŠ åˆ° sï¼Œä»è€Œä¿è¯å½¼æ­¤éš”ç¦»æ€§(ä¸è¿è´¯æ€§)ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Spanner ä¹Ÿä¼šå®ç°ä¸‹é¢çš„å¤–éƒ¨ä¸€è‡´æ€§:å¦‚æœä¸€ä¸ªäº‹åŠ¡ T2 åœ¨äº‹åŠ¡ T1 æäº¤ä»¥åå¼€å§‹æ‰§è¡Œï¼Œ é‚£ä¹ˆï¼Œäº‹åŠ¡ T2 çš„æ—¶é—´æˆ³ä¸€å®šæ¯”äº‹åŠ¡ T1 çš„æ—¶é—´æˆ³å¤§ã€‚å¯¹äºä¸€ä¸ªäº‹åŠ¡ Ti è€Œè¨€ï¼Œå®šä¹‰å¼€å§‹å’Œæäº¤äº‹ä»¶eistartå’Œeicommitï¼Œäº‹åŠ¡æäº¤æ—¶é—´ä¸ºsiã€‚å¯¹å¤–éƒ¨ä¸€è‡´æ€§çš„è¦æ±‚å°±å˜æˆäº†:&lt;br&gt;&#xA;tabs(e1commit )&amp;lt;tabs(e2start ) s1&amp;lt;s2ã€‚æ‰§è¡Œäº‹åŠ¡çš„åè®®å’Œåˆ†é…æ—¶é—´æˆ³çš„åè®®ï¼Œéµå®ˆä¸¤æ¡è§„åˆ™ï¼ŒäºŒè€…ä¸€èµ·ä¿è¯å¤–éƒ¨ä¸€è‡´æ€§ã€‚å¯¹äºä¸€ä¸ªå†™æ“ä½œ Ti è€Œè¨€ï¼Œæ‹…ä»»åè°ƒè€…çš„é¢†å¯¼è€…å‘å‡ºçš„æäº¤è¯·æ±‚çš„äº‹ä»¶ä¸ºeiserver ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Start. ä¸ºä¸€ä¸ªäº‹åŠ¡ Ti æ‹…ä»»åè°ƒè€…çš„é¢†å¯¼è€…åˆ†é…ä¸€ä¸ªæäº¤æ—¶é—´æˆ³ siï¼Œä¸ä¼šå°äº TT.now().latest çš„å€¼ï¼ŒTT.now().latestçš„å€¼æ˜¯åœ¨esierveräº‹ä»¶ä¹‹åè®¡ç®—å¾—åˆ°çš„ã€‚è¦æ³¨æ„ï¼Œæ‹…ä»»å‚ä¸è€…çš„é¢†å¯¼è€…ï¼Œ åœ¨è¿™é‡Œä¸èµ·ä½œç”¨ã€‚ç¬¬ 4.2.1 èŠ‚æè¿°äº†è¿™äº›æ‹…ä»»å‚ä¸è€…çš„é¢†å¯¼è€…æ˜¯å¦‚ä½•å‚ä¸ä¸‹ä¸€æ¡è§„åˆ™çš„å®ç°çš„ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Commit Wait. æ‹…ä»»åè°ƒè€…çš„é¢†å¯¼è€…ï¼Œå¿…é¡»ç¡®ä¿å®¢æˆ·ç«¯ä¸èƒ½çœ‹åˆ°ä»»ä½•è¢« Ti æäº¤çš„æ•°æ®ï¼Œç›´åˆ° TT.after(si)ä¸ºçœŸã€‚æäº¤ç­‰å¾…ï¼Œå°±æ˜¯è¦ç¡®ä¿ si ä¼šæ¯” Ti çš„ç»å¯¹æäº¤æ—¶é—´å°ã€‚è¯æ˜å¦‚ä¸‹:&lt;/p&gt;&#xA;&lt;p&gt;&lt;img src=&#34;http://7xnp02.com1.z0.glb.clouddn.com/1752522-fff83c4dbdc512f1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-4&#34;&gt;è¯»å†™äº‹åŠ¡&lt;/h3&gt;&#xA;&lt;p&gt;æ­£å¦‚BigTableä¸€æ ·ï¼ŒSpannerçš„äº‹åŠ¡æ˜¯ä¼šå°†æ‰€æœ‰çš„å†™æ“ä½œå…ˆç¼“å­˜èµ·æ¥ï¼Œåœ¨Commitçš„æ—¶å€™ä¸€æ¬¡æäº¤ã€‚è¿™æ ·çš„è¯ï¼Œå°±è¯»ä¸å‡ºåœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å†™çš„æ•°æ®äº†ã€‚ä¸è¿‡è¿™æ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºSpannerçš„æ•°æ®éƒ½æ˜¯æœ‰ç‰ˆæœ¬çš„ã€‚&lt;/p&gt;&#xA;&lt;p&gt;åœ¨è¯»å†™äº‹åŠ¡ä¸­ä½¿ç”¨wound-waitç®—æ³•æ¥é¿å…æ­»é”ã€‚å½“å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªè¯»å†™äº‹åŠ¡çš„æ—¶å€™ï¼Œé¦–å…ˆæ˜¯è¯»æ“ä½œï¼Œä»–å…ˆæ‰¾åˆ°ç›¸å…³æ•°æ®çš„leader replicaï¼Œç„¶ååŠ ä¸Šè¯»é”ï¼Œè¯»å–æœ€è¿‘çš„æ•°æ®ã€‚åœ¨å®¢æˆ·ç«¯äº‹åŠ¡å­˜æ´»çš„æ—¶å€™ä¼šä¸æ–­çš„å‘leaderå‘å¿ƒè·³ï¼Œé˜²æ­¢è¶…æ—¶ã€‚å½“å®¢æˆ·ç«¯å®Œæˆäº†æ‰€æœ‰çš„è¯»æ“ä½œï¼Œå¹¶ä¸”ç¼“å­˜äº†æ‰€æœ‰çš„å†™æ“ä½œï¼Œå°±å¼€å§‹äº†ä¸¤é˜¶æ®µæäº¤ã€‚å®¢æˆ·ç«¯é—²ç½®ä¸€ä¸ªcoordinator groupï¼Œå¹¶ç»™æ¯ä¸€ä¸ªleaderå‘é€coordinatorçš„idå’Œç¼“å­˜çš„å†™æ•°æ®ã€‚&lt;/p&gt;&#xA;&lt;p&gt;leaderé¦–å…ˆä¼šä¸Šä¸€ä¸ªå†™é”ï¼Œä»–è¦æ‰¾ä¸€ä¸ªæ¯”ç°æœ‰äº‹åŠ¡æ™šçš„æ—¶é—´æˆ³ã€‚é€šè¿‡Paxosè®°å½•ã€‚æ¯ä¸€ä¸ªç›¸å…³çš„éƒ½è¦ç»™coordinatorå‘é€ä»–è‡ªå·±å‡†å¤‡çš„é‚£ä¸ªæ—¶é—´æˆ³ã€‚&lt;/p&gt;&#xA;&lt;p&gt;Coordinatorleaderä¸€å¼€å§‹ä¹Ÿä¼šä¸Šä¸ªå†™é”ï¼Œå½“å¤§å®¶å‘é€æ—¶é—´æˆ³ç»™ä»–ä¹‹åï¼Œä»–å°±é€‰æ‹©ä¸€ä¸ªæäº¤æ—¶é—´æˆ³ã€‚è¿™ä¸ªæäº¤çš„æ—¶é—´æˆ³ï¼Œå¿…é¡»æ¯”åˆšåˆšçš„æ‰€æœ‰æ—¶é—´æˆ³æ™šï¼Œè€Œä¸”è¿˜è¦æ¯”TT.now()+è¯¯å·®æ—¶é—´ è¿˜æœ‰æ™šã€‚è¿™ä¸ªCoordinatorå°†è¿™ä¸ªä¿¡æ¯è®°å½•åˆ°Paxosã€‚&lt;/p&gt;&#xA;&lt;p&gt;åœ¨è®©replicaå†™å…¥æ•°æ®ç”Ÿæ•ˆä¹‹å‰ï¼Œcoordinatorè¿˜æœ‰å†ç­‰ä¸€ä¼šã€‚éœ€è¦ç­‰ä¸¤å€æ—¶é—´è¯¯å·®ã€‚è¿™æ®µæ—¶é—´ä¹Ÿåˆšå¥½è®©Paxosæ¥åŒæ­¥ã€‚å› ä¸ºç­‰å¾…ä¹‹åï¼Œåœ¨ä»»æ„æœºå™¨ä¸Šå‘èµ·çš„ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„å¼€å§‹æ—¶é—´ï¼Œéƒ½æ¯”å¦‚ä¸ä¼šæ¯”è¿™ä¸ªäº‹åŠ¡çš„ç»“æŸæ—¶é—´æ—©äº†ã€‚ç„¶åcoordinatorå°†æäº¤æ—¶é—´æˆ³å‘é€ç»™å®¢æˆ·ç«¯è¿˜æœ‰å…¶ä»–çš„replicaã€‚ä»–ä»¬è®°å½•æ—¥å¿—ï¼Œå†™å…¥ç”Ÿæ•ˆï¼Œé‡Šæ”¾é”ã€‚&lt;/p&gt;&#xA;&lt;h3 id=&#34;heading-5&#34;&gt;åªè¯»äº‹åŠ¡&lt;/h3&gt;&#xA;&lt;p&gt;å¯¹äºåªè¯»äº‹åŠ¡ï¼ŒSpanneré¦–å…ˆè¦æŒ‡å®šä¸€ä¸ªè¯»äº‹åŠ¡æ—¶é—´æˆ³ã€‚è¿˜éœ€è¦äº†è§£åœ¨è¿™ä¸ªè¯»æ“ä½œä¸­ï¼Œéœ€è¦è®¿é—®çš„æ‰€æœ‰çš„è¯»çš„Keyã€‚Spannerå¯ä»¥è‡ªåŠ¨ç¡®å®šKeyçš„èŒƒå›´ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¦‚æœKeyçš„èŒƒå›´åœ¨ä¸€ä¸ªPaxos groupå†…ã€‚å®¢æˆ·ç«¯å¯ä»¥å‘èµ·ä¸€ä¸ªåªè¯»è¯·æ±‚ç»™group leaderã€‚leaderé€‰ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³è¦æ¯”ä¸Šä¸€ä¸ªäº‹åŠ¡çš„ç»“æŸæ—¶é—´è¦å¤§ã€‚ç„¶åè¯»å–ç›¸åº”çš„æ•°æ®ã€‚è¿™ä¸ªäº‹åŠ¡å¯ä»¥æ»¡è¶³å¤–éƒ¨ä¸€è‡´æ€§ï¼Œè¯»å‡ºçš„ç»“æœæ˜¯æœ€åä¸€æ¬¡å†™çš„ç»“æœï¼Œå¹¶ä¸”ä¸ä¼šæœ‰ä¸ä¸€è‡´çš„æ•°æ®ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å¦‚æœKeyçš„èŒƒå›´åœ¨å¤šä¸ªPaxos groupå†…ï¼Œå°±ç›¸å¯¹å¤æ‚ä¸€äº›ã€‚å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ä¾‹å­æ˜¯ï¼Œå¯ä»¥éå†æ‰€æœ‰çš„group leadersï¼Œå¯»æ‰¾æœ€è¿‘çš„äº‹åŠ¡å‘ç”Ÿçš„æ—¶é—´ï¼Œå¹¶è¯»å–ã€‚å®¢æˆ·ç«¯åªè¦æ—¶é—´æˆ³åœ¨TT.now().latestä¹‹åå°±å¯ä»¥æ»¡è¶³è¦æ±‚äº†ã€‚&lt;/p&gt;&#xA;&lt;h2 id=&#34;heading-6&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/spanner-osdi2012.pdf&#34;&gt;Spanner: Googleâ€™s Globally-Distributed Database&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://linbingdong.com/2017/02/10/%E5%85%A8%E7%90%83%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%9AGoogle%20Spanner%EF%BC%88%E8%AE%BA%E6%96%87%E7%BF%BB%E8%AF%91%EF%BC%89/&#34;&gt;spnner è®ºæ–‡ä¸­æ–‡ç‰ˆ&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://www.voidcn.com/article/p-wxiysjtf-ho.html&#34;&gt;spannerä¸bigtable&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;http://blog.jobbole.com/28096/&#34;&gt;Googleå…¨çƒçº§åˆ†å¸ƒå¼æ•°æ®åº“SpanneråŸç†&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
  <entry>
    <title>Leader Transfer In TiKV</title>
    <updated>2017-10-28T00:00:00Z</updated>
    <id>tag:int64.me,2017-10-28:/2017/Leader Transfer In TiKV.html</id>
    <link href="http://int64.me/2017/Leader Transfer In TiKV.html" rel="alternate"></link>
    <summary type="html">&lt;p&gt;åœ¨ TiKV ä¸­ï¼ŒPD å½“å‘ç° TiKV å®ä¾‹ä¸Š region å‡ºç° leader ä¸å‡åŒ€çš„æ—¶å€™ï¼Œä¼šå°è¯•å°† leader ä»æ•°é‡æ¯”è¾ƒå¤šçš„åœ°æ–¹ transfer åˆ°å…¶åœ°æ–¹ï¼Œå…·ä½“è°ƒåº¦æŒ‡ä»¤ç”± PD å‘å‡ºï¼ŒTiKV æ¥æ”¶åˆ° PD çš„ transfer leader æŒ‡ä»¤ï¼Œè°ƒç”¨ raft æ“ä½œæ‰§è¡ŒçœŸæ­£æ“ä½œ...&lt;/p&gt;&#xA;&lt;h2 id=&#34;-pd&#34;&gt;å…ˆçœ‹ PD&lt;/h2&gt;&#xA;&lt;p&gt;PDï¼ˆPlacement Driverï¼‰åœ¨ TiDB é›†ç¾¤é‡Œé¢ä¸»è¦è´Ÿè´£ meta ä¿¡æ¯å­˜å‚¨ï¼Œä»¥åŠç®¡ç†å’Œè°ƒåº¦ TiKV é›†ç¾¤ï¼Œ æ‰€æœ‰å¯ä»¥æƒ³è±¡ Transfer Leader çš„å‘½ä»¤æ˜¾ç„¶æ˜¯æœ‰ PD å‘é€åˆ° TiKVã€‚&lt;/p&gt;&#xA;&lt;p&gt;PD ç»™ TiKV å‘é€ Transfer Leader å‘½ä»¤ï¼Œå¯ä»¥åˆ†ä¸ºä¸€ä¸‹ä¸¤ç±»&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;äººä¸ºå¹²é¢„è°ƒåº¦&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;PD æä¾› pd-ctl å‘½ä»¤è¡Œå·¥å…·ï¼Œæˆ–æ˜¯é€šè¿‡ api æ¥å£æ˜¾ç¤ºçš„å°†ä¸€ä¸ª region çš„ leader è°ƒåº¦åˆ°æŸä¸€ä¸ª store ä¸Šã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;&amp;gt;&amp;gt; operator add transfer-leader 1 2         // æŠŠ region 1 çš„ leader è°ƒåº¦åˆ° store 2&#xA;&amp;gt;&amp;gt; operator add transfer-region 1 2 3 4     // æŠŠ region 1 è°ƒåº¦åˆ° store 2,3,4&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;pd-ctl å®é™…ä¸Šä¹Ÿæ˜¯è¯·æ±‚ PD çš„apiï¼Œå…·ä½“è¯·æ±‚è¿‡ç¨‹ç•¥ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ PD çš„æºç ã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// pd/server/coordinator.go&#xA;func (c *coordinator) sendScheduleCommand(region *core.RegionInfo, step schedule.OperatorStep) {&#xA;        log.Infof(&amp;quot;[region %v] send schedule command: %s&amp;quot;, region.GetId(), step)&#xA;        switch s := step.(type) {&#xA;        case schedule.TransferLeader:&#xA;                cmd := &amp;amp;pdpb.RegionHeartbeatResponse{&#xA;                        TransferLeader: &amp;amp;pdpb.TransferLeader{&#xA;                                Peer: region.GetStorePeer(s.ToStore),&#xA;                        },&#xA;                }&#xA;        .....&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;ä»ä¸Šè¾¹ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œå…¶å® PD çš„è°ƒåº¦å‘½ä»¤æ˜¯é€šè¿‡ heartbeat æ¥è¿›è¡Œä¼ é€’çš„ï¼ŒPD å’Œ TiKV ä¹‹é—´æ˜¯é€šè¿‡ grpc é€šä¿¡ï¼Œå½“æ”¶åˆ°åˆ°è¿™ä¸ªæ“ä½œæŒ‡ä»¤çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨ grpc çš„send æ–¹æ³•ï¼Œå°†è¯·æ±‚å‘é€ç»™ TiKVã€‚&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;Leader åˆ†å¸ƒä¸å‡åŒ€æˆ–æ˜¯çƒ­ç‚¹è¿‡äºé›†ä¸­ï¼ŒPD è‡ªèº«è°ƒåº¦&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;p&gt;PD çš„ä¸»è¦ä½œç”¨å°±æ˜¯è´Ÿè´£ç®¡ç†å’Œè°ƒåº¦ TiKVï¼Œ å¦‚æœ TiKV å„ä¸ªèŠ‚ç‚¹ä¸Šå‡ºç°äº† leader åˆ†å¸ƒè¡¥å‡åŒ€æˆ–æ˜¯çƒ­ç‚¹ leader è¿‡äºé›†ä¸­åœ¨æŸä¸€ä¸ª TiKV èŠ‚ç‚¹ä¸Šçš„æ—¶å€™ï¼Œè¿™æ—¶å€™ PD å°±ä¼šä½œå‡ºå¹²é¢„ï¼Œè¿›è¡Œ transfer leader ç­‰æ“ä½œã€‚PD æ˜¯æ ¹æ®æ¯ä¸ª store æˆ–æ˜¯ leader peer å‘é€è¿‡æ¥çš„å¿ƒè·³åŒ…ï¼Œæ¥ä½œç»Ÿè®¡å¹¶å†³å®šæ‰§è¡Œå“ªäº›æ“ä½œï¼Œæ¯æ¬¡æ”¶åˆ° Region Leader å‘æ¥çš„å¿ƒè·³åŒ…æ—¶ï¼ŒPD éƒ½ä¼šæ£€æŸ¥æ˜¯å¦æœ‰å¯¹è¿™ä¸ª Region å¾…è¿›è¡Œçš„æ“ä½œï¼Œé€šè¿‡å¿ƒè·³åŒ…çš„å›å¤æ¶ˆæ¯ï¼Œå°†éœ€è¦è¿›è¡Œçš„æ“ä½œè¿”å›ç»™ Region Leaderï¼Œå¹¶åœ¨åé¢çš„å¿ƒè·³åŒ…ä¸­ç›‘æµ‹æ‰§è¡Œç»“æœã€‚æ³¨æ„è¿™é‡Œçš„æ“ä½œåªæ˜¯ç»™ Region Leader çš„å»ºè®®ï¼Œå¹¶ä¸ä¿è¯ä¸€å®šèƒ½å¾—åˆ°æ‰§è¡Œï¼Œå…·ä½“æ˜¯å¦ä¼šæ‰§è¡Œä»¥åŠä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œç”± Region Leader è‡ªå·±æ ¹æ®å½“å‰è‡ªèº«çŠ¶æ€æ¥å®šã€‚ï¼ˆåé¢ä¸¤å¥è¯ç›´æ¥ copy è‡ª &lt;a href=&#34;https://pingcap.com/blog-tidb-internal-3-zh&#34;&gt;https://pingcap.com/blog-tidb-internal-3-zh&lt;/a&gt;ï¼‰ã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;// HandleRegionHeartbeat processes RegionInfo reports from client.&#xA;func (c *RaftCluster) HandleRegionHeartbeat(region *core.RegionInfo) error {&#xA;        if err := c.cachedCluster.handleRegionHeartbeat(region); err != nil {&#xA;                return errors.Trace(err)&#xA;        }&#xA;&#xA;        // If the region peer count is 0, then we should not handle this.&#xA;        if len(region.GetPeers()) == 0 {&#xA;                log.Warnf(&amp;quot;invalid region, zero region peer count - %v&amp;quot;, region)&#xA;                return errors.Errorf(&amp;quot;invalid region, zero region peer count - %v&amp;quot;, region)&#xA;        }&#xA;&#xA;        c.coordinator.dispatch(region)&#xA;        return nil&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;è¿™ä¸ªå‡½æ•°å¤„ç†æ¥è‡ª leader peer çš„heartbeatï¼Œ &lt;code&gt;handleRegionHeartbeat&lt;/code&gt; ä¸»è¦è´Ÿè´£æ›´ç›¸å…³region çš„ä¿¡æ¯ï¼Œ æˆ‘ä»¬ä¸»è¦è¿˜æ˜¯å…³ç³» å¦‚ä½•å‘é€æ“ä½œæŒ‡ä»¤ï¼Œæƒ³å½“ç„¶å°±æ˜¯ &lt;code&gt;c.coordinator.dispatch(region) &lt;/code&gt; è¿™ä¸ªå‡½æ•°å¹²çš„äº‹æƒ…äº†ã€‚&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;func (c *coordinator) dispatch(region *core.RegionInfo) {&#xA;       // Check existed operator.&#xA;       if op := c.getOperator(region.GetId()); op != nil {&#xA;               timeout := op.IsTimeout()&#xA;               if step := op.Check(region); step != nil &amp;amp;&amp;amp; !timeout {&#xA;                       operatorCounter.WithLabelValues(op.Desc(), &amp;quot;check&amp;quot;).Inc()&#xA;                       c.sendScheduleCommand(region, step)&#xA;                       return&#xA;               }&#xA;               if op.IsFinish() {&#xA;                       log.Infof(&amp;quot;[region %v] operator finish: %s&amp;quot;, region.GetId(), op)&#xA;                       operatorCounter.WithLabelValues(op.Desc(), &amp;quot;finish&amp;quot;).Inc()&#xA;                       c.removeOperator(op)&#xA;               } else if timeout {&#xA;                       log.Infof(&amp;quot;[region %v] operator timeout: %s&amp;quot;, region.GetId(), op)&#xA;                       operatorCounter.WithLabelValues(op.Desc(), &amp;quot;timeout&amp;quot;).Inc()&#xA;                       c.removeOperator(op)&#xA;               }&#xA;       }&#xA;    ....&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²æœ‰çš„æ“ä½œï¼Œè¿™ä¸ª operator å¯ä»¥æœ‰å¥½å¤šç§ï¼Œæ¯”å¦‚ &lt;code&gt;AddReplicaã€RemoveReplicaã€TransferLeader&lt;/code&gt;,&lt;br&gt;&#xA;å¦‚æœå­˜åœ¨æ£€æŸ¥è¿™ä¸ªæ“ä½œæ˜¾ç¤ºæ˜¯åˆ°å“ªä¸€æ­¥äº†ï¼Œå¦‚æœæ˜¯æ²¡æœ‰ç»“æŸå¹¶ä¸”æ²¡æœ‰è¶…æ—¶ï¼Œå°±ä¼šä½¿ç”¨ &lt;code&gt;sendScheduleCommand&lt;/code&gt; é€šè¿‡ grpc å‘è¿™ä¸ªregion åœ¨æ­¤å‘é€æ­¤æ¬¡æ“ä½œã€‚ è¦æ˜¯ä»¥åŠå®Œæˆæˆ–æ˜¯è¶…æ—¶åˆ†åˆ«é”™å¤„å“åº”çš„å¤„ç†å¹¶åˆ é™¤è¿™ä¸ªæ“ä½œã€‚&lt;/p&gt;&#xA;&lt;p&gt;åœ¨çœ‹ PD å¦‚ä½•å°† Transfer leader è¿™ä¸ª opertor åŠ åˆ° &lt;code&gt;c.operators&lt;/code&gt; é‡Œé¢çš„&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;func (l *balanceLeaderScheduler) Schedule(cluster schedule.Cluster) *schedule.Operator {&#xA;        schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;schedule&amp;quot;).Inc()&#xA;        region, newLeader := scheduleTransferLeader(cluster, l.GetName(), l.selector)&#xA;        if region == nil {&#xA;                return nil&#xA;        }&#xA;&#xA;        // Skip hot regions.&#xA;        if cluster.IsRegionHot(region.GetId()) {&#xA;                schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;region_hot&amp;quot;).Inc()&#xA;                return nil&#xA;        }&#xA;&#xA;        source := cluster.GetStore(region.Leader.GetStoreId())&#xA;        target := cluster.GetStore(newLeader.GetStoreId())&#xA;        if !shouldBalance(source, target, core.LeaderKind) {&#xA;                schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;skip&amp;quot;).Inc()&#xA;                return nil&#xA;        }&#xA;        l.limit = adjustBalanceLimit(cluster, core.LeaderKind)&#xA;        schedulerCounter.WithLabelValues(l.GetName(), &amp;quot;new_opeartor&amp;quot;).Inc()&#xA;        step := schedule.TransferLeader{FromStore: region.Leader.GetStoreId(), ToStore: newLeader.GetStoreId()}&#xA;        return schedule.NewOperator(&amp;quot;balance-leader&amp;quot;, region.GetId(), core.LeaderKind, step)&#xA;}&#xA;&#xA;...&#xA;func (c *coordinator) runScheduler(s *scheduleController) {&#xA;        defer c.wg.Done()&#xA;        defer s.Cleanup(c.cluster)&#xA;&#xA;        timer := time.NewTimer(s.GetInterval())&#xA;        defer timer.Stop()&#xA;&#xA;        for {&#xA;                select {&#xA;                case &amp;lt;-timer.C:&#xA;                        timer.Reset(s.GetInterval())&#xA;                        if !s.AllowSchedule() {&#xA;                                continue&#xA;                        }&#xA;                        if op := s.Schedule(c.cluster); op != nil {&#xA;                                c.addOperator(op)&#xA;                        }&#xA;&#xA;                case &amp;lt;-s.Ctx().Done():&#xA;                        log.Infof(&amp;quot;%v stopped: %v&amp;quot;, s.GetName(), s.Ctx().Err())&#xA;                        return&#xA;                }&#xA;        }&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;å¯ä»¥çœ‹åˆ°&lt;code&gt;Schedule&lt;/code&gt;è¿™ä¸ªå‡½æ•°æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ª &lt;code&gt;operator&lt;/code&gt; , &lt;code&gt;runScheduler&lt;/code&gt; è°ƒç”¨ &lt;code&gt; c.addOperator&lt;/code&gt; å°†è¿™ä¸ª&lt;code&gt;operator&lt;/code&gt; åŠ åˆ°&lt;code&gt;c.operators&lt;/code&gt;&lt;/p&gt;&#xA;&lt;h2 id=&#34;-tikv&#34;&gt;åœ¨çœ‹ TiKV&lt;/h2&gt;&#xA;&lt;p&gt;æ¥ç€çœ‹ TiKV ä» PD æ”¶åˆ° transfer leader æŒ‡ä»¤åä¼šåšå“ªäº›æ“ä½œã€‚(åˆšå…¥å‘ Rustï¼Œçœ‹ TiKV è¿˜æœ‰ç‚¹è´¹åŠ²ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹ç†è§£çš„æœ‰é—®é¢˜ï¼Œè¿˜æœ›æŒ‡å‡ºæ¥)&lt;/p&gt;&#xA;&lt;p&gt;TiKV é¦–å…ˆæ˜¯è¦æ¥å—åˆ° PD å‘é€çš„å‘½ä»¤ï¼Œæ¥çœ‹ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å¤„ç† PD å‘é€çš„å‘½ä»¤&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;fn schedule_heartbeat_receiver(&amp;amp;mut self, handle: &amp;amp;Handle) {&#xA;        let ch = self.ch.clone();&#xA;        let store_id = self.store_id;&#xA;        let f = self.pd_client&#xA;            .handle_region_heartbeat_response(self.store_id, move |mut resp| {&#xA;                let region_id = resp.get_region_id();&#xA;                let epoch = resp.take_region_epoch();&#xA;                let peer = resp.take_target_peer();&#xA;&#xA;                if resp.has_change_peer() {&#xA;                   // more&#xA;                } else if resp.has_transfer_leader() {&#xA;                    PD_HEARTBEAT_COUNTER_VEC&#xA;                        .with_label_values(&amp;amp;[&amp;quot;transfer leader&amp;quot;])&#xA;                        .inc();&#xA;&#xA;                    let mut transfer_leader = resp.take_transfer_leader();&#xA;                    info!(&#xA;                        &amp;quot;[region {}] try to transfer leader from {:?} to {:?}&amp;quot;,&#xA;                        region_id,&#xA;                        peer,&#xA;                        transfer_leader.get_peer()&#xA;                    );&#xA;                    let req = new_transfer_leader_request(transfer_leader.take_peer());&#xA;                   send_admin_request(&amp;amp;ch, region_id, epoch, peer, req, None)&#xA;                } else {&#xA;                    PD_HEARTBEAT_COUNTER_VEC.with_label_values(&amp;amp;[&amp;quot;noop&amp;quot;]).inc();&#xA;                }&#xA;            })&#xA;    // more&#xA;}&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;è¿™æ®µä»£ç å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯å…ˆä» resp ä¸­è¯»å–åˆ° &lt;code&gt;region_id&lt;/code&gt;ã€&lt;code&gt;peer&lt;/code&gt;ï¼Œç„¶ååœ¨åˆ¤æ–­è¦æ‰§è¡Œçš„æ“ä½œæ˜¯ä»€ä¹ˆï¼Œå½“æ‰§è¡Œçš„æ“ä½œæ˜¯ &lt;code&gt;transfer_leader&lt;/code&gt;çš„æ—¶å€™ï¼Œå…ˆæ˜¯æ›´æ–°ä¸€ä¸‹ç›‘æ§ï¼Œç„¶ååœ¨ä» resp ä¸­è·å–åˆ° &lt;code&gt;leader&lt;/code&gt; è¯¥ &lt;code&gt;transfer&lt;/code&gt; åˆ°ä»€ä¹ˆåœ°æ–¹, åœ¨ç„¶åå‘¢ï¼Œå°±æ˜¯å‘é€è¿™ä¸ªå‘½ä»¤å»æ‰§è¡Œäº†ã€‚&lt;/p&gt;&#xA;&lt;p&gt;å…ˆçœ‹å¯åŠ¨ å¯åŠ¨ &lt;code&gt;transfer_leader&lt;/code&gt; å‡½æ•°&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;pub fn transfer_leader(&amp;amp;mut self, transferee: u64) {&#xA;     let mut m = Message::new();&#xA;     m.set_msg_type(MessageType::MsgTransferLeader);&#xA;     m.set_from(transferee);&#xA;     self.raft.step(m).is_ok();&#xA; }&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;è¿™ä¸ªå‡½æ•°å…¶å®å¾ˆç®€å•ï¼Œå…ˆè®¾ç½®ä¸€ä¸‹æ¶ˆæ¯ç±»å‹ï¼Œç„¶åè·å–åˆ°ç›®æ ‡ &lt;code&gt;leader&lt;/code&gt;ï¼Œ&lt;code&gt;transferee&lt;/code&gt; å°±æ˜¯ç›®æ ‡&lt;code&gt;leader&lt;/code&gt;ï¼Œå½“ç„¶è‡ªå·±å°±æ˜¯å½“å‰ &lt;code&gt;leader&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&lt;p&gt;åœ¨çœ‹å¤„ç†è¿‡ç¨‹&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;fn handle_transfer_leader(&amp;amp;mut self, m: &amp;amp;Message) {&#xA;    let lead_transferee = m.get_from();&#xA;    let last_lead_transferee = self.lead_transferee;&#xA;    if last_lead_transferee.is_some() {&#xA;        if last_lead_transferee.unwrap() == lead_transferee {&#xA;            info!(&#xA;                &amp;quot;{} [term {}] transfer leadership to {} is in progress, ignores request \&#xA;                 to same node {}&amp;quot;,&#xA;                self.tag,&#xA;                self.term,&#xA;                lead_transferee,&#xA;                lead_transferee&#xA;            );&#xA;            return;&#xA;        }&#xA;        self.abort_leader_transfer();&#xA;        info!(&#xA;            &amp;quot;{} [term {}] abort previous transferring leadership to {}&amp;quot;,&#xA;            self.tag,&#xA;            self.term,&#xA;            last_lead_transferee.unwrap()&#xA;        );&#xA;    }&#xA;    if lead_transferee == self.id {&#xA;        debug!(&#xA;            &amp;quot;{} is already leader. Ignored transferring leadership to self&amp;quot;,&#xA;            self.tag&#xA;        );&#xA;        return;&#xA;    }&#xA;    // Transfer leadership to third party.&#xA;    info!(&#xA;        &amp;quot;{} [term {}] starts to transfer leadership to {}&amp;quot;,&#xA;        self.tag,&#xA;        self.term,&#xA;        lead_transferee&#xA;    );&#xA;    // Transfer leadership should be finished in one electionTimeout&#xA;    // so reset r.electionElapsed.&#xA;    self.election_elapsed = 0;&#xA;    self.lead_transferee = Some(lead_transferee);&#xA;    if self.prs[&amp;amp;m.get_from()].matched == self.raft_log.last_index() {&#xA;        self.send_timeout_now(lead_transferee);&#xA;        info!(&#xA;            &amp;quot;{} sends MsgTimeoutNow to {} immediately as {} already has up-to-date log&amp;quot;,&#xA;            self.tag,&#xA;            lead_transferee,&#xA;            lead_transferee&#xA;        );&#xA;    } else {&#xA;        self.send_append(lead_transferee);&#xA;    }&#xA;}&#xA;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;è¿™æ®µä»£ç ç¨æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ­¥ä¸€æ­¥çš„æ¥çœ‹ï¼Œ é¦–å…ˆæ˜¯è¿›è¡Œä¸€äº›æ£€æŸ¥ï¼Œç¬¬ä¸€æ­¥æ˜¯æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ &lt;code&gt;transfer leader&lt;/code&gt; åœ¨æ‰§è¡Œï¼Œå¦‚æœå·²ç»æ­£åœ¨  &lt;code&gt;transfer leader&lt;/code&gt; å¹¶ä¸”ç›®æ ‡ &lt;code&gt;leader&lt;/code&gt; ç›¸åŒçš„è¯ï¼Œå°±é€€å‡ºè¿™æ¬¡æ“ä½œï¼Œå¦‚æœç›®æ ‡ä¸åŒçš„è¯ï¼Œé‚£å°± è°ƒç”¨&lt;code&gt; self.abort_leader_transfer();&lt;/code&gt; è¿™ä¸ªå‡½æ•°æ”¾å¼ƒä¸Šä¸€æ¬¡æ­£åœ¨æ‰§è¡Œçš„ &lt;code&gt;transfer leader&lt;/code&gt;  æ“ä½œã€‚ ç´§æ¥å°±æ˜¯åˆ¤æ–­ ç›®æ ‡ &lt;code&gt;leader&lt;/code&gt;æ˜¯ä¸æ˜¯è‡ªå·±ï¼Œè¦æ˜¯è‡ªå·±é‚£å°±ç›´æ¥é€€å‡ºå°±å¥½äº†ï¼Œå› ä¸ºä¸éœ€è¦&lt;code&gt;transfer leader&lt;/code&gt;ã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä¸‹ä¸€æ­¥å°±æ˜¯å°†ç›®æ ‡leaderä¿å­˜åœ¨&lt;code&gt;leadTransferee&lt;/code&gt;ä¸­ï¼Œæ ‡ç¤ºç€æœ‰&lt;code&gt;transfer&lt;/code&gt;æ­£åœ¨è¿›è¡Œï¼Œåç»­å¦‚æœæœ‰è¯·æ±‚&lt;code&gt;propose&lt;/code&gt;è¿›æ¥ï¼Œä¼šæ£€æŸ¥è¿™ä¸ª&lt;code&gt;lead_transferee&lt;/code&gt; æ˜¯ä¸æ˜¯å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå…¶ä»–æ“ä½œå°±æ— æ³•æˆåŠŸï¼Œä¹Ÿå°±æ˜¯æ— æ³•è¿›è¡Œå†™æ“ä½œã€‚&lt;/p&gt;&#xA;&lt;p&gt;ä¸‹ä¸€æ­¥å°±æ˜¯æ£€æŸ¥ &lt;code&gt;transferee&lt;/code&gt; å’Œ&lt;code&gt;leader&lt;/code&gt;çš„&lt;code&gt;log&lt;/code&gt;æ˜¯å¦ä¸€æ ·æ–°&lt;/p&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;å¦‚æœ&lt;code&gt;log&lt;/code&gt; ä¸€è‡´çš„è¯å°±ä¼šç»™&lt;code&gt;transferee&lt;/code&gt;å‘é€&lt;code&gt;MsgTimeoutNow&lt;/code&gt;ç±»å‹çš„æ¶ˆæ¯ï¼Œå‘Šè¯‰&lt;code&gt;transferee&lt;/code&gt;å¯ä»¥ç«‹å³é€‰ä¸»ï¼Œä¸éœ€è¦ç­‰åˆ°&lt;code&gt;election timeout&lt;/code&gt;ã€‚&lt;/li&gt;&#xA;&lt;li&gt;å¦‚æœ &lt;code&gt;log&lt;/code&gt; ä¸ä¸€è‡´ï¼Œå°±ä¼šç»™ &lt;code&gt;lead_transferee&lt;/code&gt;  å‘é€ä¸€ä¸ª&lt;code&gt;append&lt;/code&gt; çš„è¯·æ±‚ï¼Œè¿½åŠ  &lt;code&gt;log&lt;/code&gt;ã€‚ ï¼Œleaderåœ¨æ”¶åˆ°å“åº” &lt;code&gt;MsgAppResp&lt;/code&gt;å,å¦‚æœå‘ç°ç›®å‰æ­£å¤„äº&lt;code&gt;transfer leader&lt;/code&gt; è¿‡ç¨‹ä¸­å¹¶ä¸” &lt;code&gt;transferee&lt;/code&gt;å·²ç»æ—¥å¿—æœ€æ–°ï¼Œåˆ™åŒæ ·ï¼Œç»™&lt;code&gt;transferee&lt;/code&gt;å‘é€&lt;code&gt;MsgTimeoutNow&lt;/code&gt;ã€‚&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;h2 id=&#34;heading&#34;&gt;å‚è€ƒ&lt;/h2&gt;&#xA;&lt;ol&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6/blog-placement-driver-zh&#34;&gt;TiKV æºç è§£æç³»åˆ— - Placement Driver&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://pingcap.com/blog-tidb-internal-3-zh&#34;&gt;ä¸‰ç¯‡æ–‡ç« äº†è§£ TiDB æŠ€æœ¯å†…å¹• - è°ˆè°ƒåº¦&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://zhuanlan.zhihu.com/p/27895034&#34;&gt;etcd raftå¦‚ä½•å®ç°leadership transfer&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pingcap/pd&#34;&gt;PD&lt;/a&gt;&lt;/li&gt;&#xA;&lt;li&gt;&lt;a href=&#34;https://github.com/pingcap/tikv&#34;&gt;TiKV&lt;/a&gt;&lt;/li&gt;&#xA;&lt;/ol&gt;&#xA;</summary>
    <author>
      <name>cwen</name>
    </author>
  </entry>
</feed>