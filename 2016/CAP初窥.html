<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>CAP初窥</title>

    
    <link href="/static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="/static/css/clean-blog.css" rel="stylesheet">

    
    <link href="/static/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">


</head>


<body>
 
 <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
     <div class="container-fluid">
         
         <div class="navbar-header page-scroll">
             <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                 <span class="sr-only">Toggle navigation</span>
                 Menu <i class="fa fa-bars"></i>
             </button>
             <a class="navbar-brand" href="http://int64.me/index.html">cwen&#39;s blog</a>
         </div>

         
         <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
             <ul class="nav navbar-nav navbar-right">
                 <li>
                     <a href="http://int64.me/index.html">Home</a>
                 </li>
                 <li>
                     <a href="http://int64.me/archive.html">Archive</a>
                 </li>
                 <li>
                     <a href="http://int64.me/about.html">About</a>
                 </li>
                 <li>
                     <a href="http://int64.me/atom.xml">RSS</a>
                 </li>
             </ul>
         </div>
         
     </div>
     
 </nav>


    
    
    <header class="intro-header" style="background-image: url('/static/img/post-bg.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>CAP初窥</h1>
                        <span class="meta">Posted by <a href="#">cwen</a> 2016-11-21</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                 
                    <a href="http://int64.me/tags/CAP.html"><span class='glyphicon glyphicon-tags tags' aria-hidden="true" ></span>&nbsp;<span>CAP</span></a>
                
                    <a href="http://int64.me/tags/%e5%88%86%e5%b8%83%e5%bc%8f.html"><span class='glyphicon glyphicon-tags tags' aria-hidden="true" ></span>&nbsp;<span>分布式</span></a>
                
                </div>
            </div>
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <p>初入 pingcap ，我这枚小菜鸟对分布式理论却一窍不通，表示很是捉急，借我司 CTO 为新员工科普分布式系统知识之际，自己也花点时间学习学习, 首先先从 <code>CAP</code> 定理入手&hellip;</p>

<h2>ACID</h2>

<p>传统数据库设计思想, 追求强一致性</p>

<ul>
<li>A: Atomicity (原子性)</li>
</ul>

<p>事务里的操作要么全部执行要不全部不执行</p>

<ul>
<li>C: Consistency(一致性)</li>
</ul>

<p>事务前后的数据都符合业务里的不变性约束</p>

<ul>
<li>I: isolation(隔离性)</li>
</ul>

<p>表示并发事务之间读数据互相影响的程度</p>

<ul>
<li>D: durability(持久性)</li>
</ul>

<p>事务提交后就进行了持久化, 不在丢失</p>

<h2>BASE</h2>

<p>大多数 nosql 数据库的设计思路, 追求高可用</p>

<ul>
<li>BA: Basically Available(基本可用)</li>
</ul>

<p>基本可用是指分布式系统在出现故障的时候，允许损失部分可用性，即保证核心可用</p>

<ul>
<li>S: Soft Stat(软状态)</li>
</ul>

<p>允许事务的一些状态暴露出来, 即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时</p>

<ul>
<li>E: Eventually consistent(最终一致性)</li>
</ul>

<p>最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况</p>

<p>ACID和BASE代表了两种截然相反的设计哲学，分处一致性-可用性分布图谱的两极</p>

<h2>CAP</h2>

<p>柏克莱加州大学（University of California, Berkeley）的计算机科学家埃里克·布鲁尔在2000年的分布式计算原则研讨会（Symposium on Principles of Distributed Computing（PODC））上提出的这个猜想 在2002年，麻省理工学院（MIT）的赛斯·吉尔伯特和南希·林奇发表了布鲁尔猜想的证明，使之成为一个定理。
它指出对于一个分布式计算系统来说，不可能同时满足以下三点：</p>

<ul>
<li>一致性(Consistency)</li>
</ul>

<p>向分布式系统给发送请求,一定返回最新的数据</p>

<ul>
<li>可用性(Availablity)</li>
</ul>

<p>向分布式系统写、读等请求的时候，一定会得到合理的响应，这个响应不应该是错误也不应该是请求超时</p>

<ul>
<li>网络分区容忍性(Partition tolerance)</li>
</ul>

<p>分布式系统中，当部分节点无法互通出现网络分区现象，但是整个系统还是可以对外提供服务</p>

<p>由于当前的网络硬件肯定
会出现延迟丢包等问题，所以分区容忍性是我们必须需要实现的。
以实际效果而言，分区相当于对通信的时限要求。系统如果不能在时限内达成数据一致性，就意味着发生了分区的情况，必须就当前操作在C和A之间做出选择
根据定理，分布式系统只能满足三项中的两项而不可能满足全部三项。理解CAP理论的最简单方式是想象两个节点分处分区两侧。允许至少一个节点更新状态会导致数据不一致，即丧失了C性质。如果为了保证数据一致性，将分区一侧的节点设置为不可用，那么又丧失了A性质。除非两个节点可以互相通信，才能既保证C又保证A，这又会导致丧失性质。(from wiki)
具体选择AP,还是CP 都是由具体场景来做决择。</p>

<h2>CP 栗子: 2PC(两阶段提交)</h2>

<p>两阶段提交, ACID 思想在分布式系统中的延伸，保证数据的强一致性。</p>

<ul>
<li>阶段一: 请求阶段
在请求阶段，协调者将通知事务参与者准备提交或取消事务，然后进入表决过程。在表决过程中，参与者将告知协调者自己的决策：同意（事务参与者本地作业执行成功）或取消（本地作业执行故障）。</li>
<li>阶段二: 提交阶段
在该阶段，协调者将基于第一个阶段的投票结果进行决策：提交或取消。当且仅当所有的参与者同意提交事务协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者取消事务。参与者在接收到协调者发来的消息后将执行响应的操作。</li>
</ul>

<p>2PC协议存在许多明细的问题, 如参与者挂了，或是协调者挂了等,今晚好困, 2PC问题可待我仔细思考学习一下，还有我司 CTO 提到的拜占庭问题&hellip;</p>

<h2>AP 栗子: BASE</h2>

<p>BASE理论是对CAP理论的延伸，核心思想是即使无法做到强一致性，但应用可以采用适合的方式达到最终一致性,
BASE是指基本可用（Basically Available）、软状态（ Soft State）、最终一致性（ Eventual Consistency）。大多数的 nosql 数据库就是基于BASE设计的，如redis、mongodb等</p>

<h2>Last But Not Least</h2>

<p>CAP 定理告诉我们, &ldquo;在分区存在的情况下, 呈现完美的数据一致性和可用性&rdquo; 是不可能的, 分区在很多情况下并不是经常出现的, 在没有分区的情况下, 我们应该尽量保证CA，在发生分区的时候, 我们应该具体场景具体分析，选择CP or CA&hellip;&hellip;</p>

<h2>参考</h2>

<ol>
<li><a href="https://zh.wikipedia.org/wiki/CAP%E5%AE%9A%E7%90%86">weiki</a></li>
<li><a href="https://www.infoq.com/articles/cap-twelve-years-later-how-the-rules-have-changed">CAP Twelve Years Later: How the &ldquo;Rules&rdquo; Have Changed</a></li>
<li><a href="https://www.youtube.com/watch?v=gLtO0vY_M78">CAP Theorem Distributed Systems in One Lesson</a></li>
</ol>

                </div>
            </div>

             <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                   <div id="disqus_thread"></div>
<script>
(function() { 
    var d = document, s = d.createElement('script');
    s.src = '//int64.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

                </div>
            </div>
        </div>
    </article>
    
    <hr>
 
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    
                    
                    <li>
                        <a href="https://github.com/cwen0">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">Powered by <a href="https://github.com/cwen-coder/ljgo">ljgo</a> &nbsp;  </a> &copy; 2016 &nbsp;<a href="http://int64.me">cwen&#39;s blog</p>
            </div>
        </div>
    </div>
</footer>

<script src="/static/vendor/jquery/jquery.min.js"></script>


<script src="/static/vendor/bootstrap/js/bootstrap.min.js"></script>


<script src="/static/js/jqBootstrapValidation.js"></script>
<script src="/static/js/contact_me.js"></script>


<script src="/static/js/clean-blog.js"></script>


</body>

</html>
